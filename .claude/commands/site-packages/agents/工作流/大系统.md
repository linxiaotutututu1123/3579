name: ultimate-perfection-workflow


  世界顶级完美工作流系统 - 终极版
  这是一个将需求、架构、任务、代码、评估五大Agent完美融合的超级工作流。
  采用多层质量保障、智能决策、自适应执行的设计理念。
version: 2.0.0
author: AI Workflow Master
---

# 🌟 终极完美工作流系统

## 核心设计理念


  ╔══════════════════════════════════════════════════════════════════════════════╗
║                           完美工作流的灵魂                                    ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  "完美不是无可添加，而是无可删减。"                                           ║
║                                                                              ║
║  ┌─────────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                         │ ║
║  │   ⭐ 五大Agent协同原则                                                   │ ║
║  │                                                                         │ ║
║  │   1. 需求是源头 - spec-requirements 定义一切的起点                       │ ║
║  │   2. 架构是骨架 - spec-design 决定系统的灵魂                             │ ║
║  │   3. 任务是路径 - spec-tasks 规划完美的执行路线                          │ ║
║  │   4. 代码是血肉 - spec-impl 实现卓越的功能                               │ ║
║  │   5. 评估是镜子 - spec-judge 确保每一步都完美                            │ ║
║  │                                                                         │ ║
║  └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                              ║
║  ┌─────────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                         │ ║
║  │   🎯 质量金字塔                                                          │ ║
║  │                                                                         │ ║
║  │                        ╱╲                                               │ ║
║  │                       ╱  ╲                                              │ ║
║  │                      ╱完美╲      ← 用户满意度 100%                       │ ║
║  │                     ╱──────╲                                            │ ║
║  │                    ╱ 卓越   ╲     ← 代码质量 A+                          │ ║
║  │                   ╱──────────╲                                          │ ║
║  │                  ╱   优秀     ╲    ← 测试覆盖 >90%                       │ ║
║  │                 ╱──────────────╲                                        │ ║
║  │                ╱     合格       ╲   ← 功能完整                           │ ║
║  │               ╱──────────────────╲                                      │ ║
║  │                                                                         │ ║
║  └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝ 复制代码  
## 🌐 工作流全景架构

  ┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│                           🏛️ 终极完美工作流架构                                      │
│                                                                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌─────────────────────────────────────────────────────────────────────────┐     │
│    │                         🎮 工作流控制中心                                 │     │
│    │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │     │
│    │  │ 状态管理  │  │ 决策引擎  │  │ 调度器   │  │ 监控器   │  │ 报告器   │  │     │
│    │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │     │
│    └─────────────────────────────────────────────────────────────────────────┘     │
│                                        │                                           │
│                                        ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────────┐     │
│    │                         📋 Agent 协作层                                   │     │
│    │                                                                         │     │
│    │   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐            │     │
│    │   │   📋    │───▶│   🏗️    │───▶│   📝    │───▶│   💻    │            │     │
│    │   │ 需求    │    │ 架构    │    │ 任务    │    │ 代码    │            │     │
│    │   │ Agent   │    │ Agent   │    │ Agent   │    │ Agent   │            │     │
│    │   └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘            │     │
│    │        │              │              │              │                  │     │
│    │        └──────────────┴──────────────┴──────────────┘                  │     │
│    │                                 │                                       │     │
│    │                                 ▼                                       │     │
│    │                          ┌─────────┐                                   │     │
│    │                          │   ⚖️    │                                   │     │
│    │                          │ 评估    │  ← 全程质量守护                    │     │
│    │                          │ Agent   │                                   │     │
│    │                          └─────────┘                                   │     │
│    └─────────────────────────────────────────────────────────────────────────┘     │
│                                        │                                           │
│                                        ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────────┐     │
│    │                         💾 产出物层                                       │     │
│    │                                                                         │     │
│    │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │     │
│    │   │requirements │  │  design.md  │  │  tasks.md   │  │ 源代码+测试  │  │     │
│    │   │    .md      │  │             │  │             │  │             │  │     │
│    │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │     │
│    │                                                                         │     │
│    │   ┌─────────────────────────────────────────────────────────────────┐  │     │
│    │   │                    📊 质量报告 & 追溯矩阵                         │  │     │
│    │   └─────────────────────────────────────────────────────────────────┘  │     │
│    └─────────────────────────────────────────────────────────────────────────┘     │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘ 复制代码  
## 📊 工作流执行引擎

```mermaid
flowchart TB
    subgraph "🚀 启动层"
        START([🌟 开始]) --> INIT[初始化工作流]
        INIT --> LOAD_CONFIG[加载配置]
        LOAD_CONFIG --> VALIDATE_INPUT[验证输入]
        VALIDATE_INPUT --> CREATE_WORKSPACE[创建工作空间]
    end
    
    subgraph "📋 需求层 - Phase 1"
        CREATE_WORKSPACE --> REQ_START[启动需求Agent]
        REQ_START --> REQ_ANALYZE[深度需求分析]
        REQ_ANALYZE --> REQ_DRAFT[生成需求草案]
        REQ_DRAFT --> REQ_JUDGE{评估Agent评审}
        REQ_JUDGE -->|分数<80| REQ_IMPROVE[改进需求]
        REQ_IMPROVE --> REQ_DRAFT
        REQ_JUDGE -->|分数≥80| REQ_USER{用户评审}
        REQ_USER -->|需修改| REQ_REFINE[精化需求]
        REQ_REFINE --> REQ_DRAFT
        REQ_USER -->|通过| REQ_FINAL[✅ 需求定稿]
    end
    
    subgraph "🏗️ 架构层 - Phase 2"
        REQ_FINAL --> DESIGN_START[启动架构Agent]
        DESIGN_START --> DESIGN_ANALYZE[分析需求]
        DESIGN_ANALYZE --> DESIGN_RESEARCH[技术调研]
        DESIGN_RESEARCH --> DESIGN_DRAFT[生成设计草案]
        DESIGN_DRAFT --> DESIGN_JUDGE{评估Agent评审}
        DESIGN_JUDGE -->|分数<85| DESIGN_IMPROVE[改进设计]
        DESIGN_IMPROVE --> DESIGN_DRAFT
        DESIGN_JUDGE -->|分数≥85| DESIGN_USER{用户评审}
        DESIGN_USER -->|需修改| DESIGN_REFINE[精化设计]
        DESIGN_REFINE --> DESIGN_DRAFT
        DESIGN_USER -->|通过| DESIGN_FINAL[✅ 设计定稿]
    end
    
    subgraph "📝 任务层 - Phase 3"
        DESIGN_FINAL --> TASK_START[启动任务Agent]
        TASK_START --> TASK_DECOMPOSE[任务分解]
        TASK_DECOMPOSE --> TASK_DEPS[依赖分析]
        TASK_DEPS --> TASK_SEQUENCE[排序任务]
        TASK_SEQUENCE --> TASK_DRAFT[生成任务清单]
        TASK_DRAFT --> TASK_JUDGE{评估Agent评审}
        TASK_JUDGE -->|分数<90| TASK_IMPROVE[改进任务]
        TASK_IMPROVE --> TASK_DECOMPOSE
        TASK_JUDGE -->|分数≥90| TASK_USER{用户评审}
        TASK_USER -->|需修改| TASK_REFINE[精化任务]
        TASK_REFINE --> TASK_DRAFT
        TASK_USER -->|通过| TASK_FINAL[✅ 任务定稿]
    end
    
    subgraph "💻 实现层 - Phase 4"
        TASK_FINAL --> IMPL_START[启动实现循环]
        IMPL_START --> IMPL_SELECT[选择下一任务]
        IMPL_SELECT --> IMPL_CHECK{有未完成任务?}
        IMPL_CHECK -->|是| IMPL_EXEC[代码Agent执行]
        IMPL_EXEC --> IMPL_TEST[运行测试]
        IMPL_TEST --> IMPL_REVIEW{代码评审}
        IMPL_REVIEW -->|不通过| IMPL_FIX[修复代码]
        IMPL_FIX --> IMPL_EXEC
        IMPL_REVIEW -->|通过| IMPL_COMMIT[提交代码]
        IMPL_COMMIT --> IMPL_UPDATE[更新任务状态]
        IMPL_UPDATE --> IMPL_SELECT
        IMPL_CHECK -->|否| IMPL_COMPLETE[✅ 实现完成]
    end
    
    subgraph "🎉 完成层"
        IMPL_COMPLETE --> FINAL_REPORT[生成最终报告]
        FINAL_REPORT --> QUALITY_SUMMARY[质量总结]
        QUALITY_SUMMARY --> FINISH([🏆 完美完成])
    end
    
    style START fill:#4CAF50,color:#fff
    style REQ_FINAL fill:#2196F3,color:#fff
    style DESIGN_FINAL fill:#FF9800,color:#fff
    style TASK_FINAL fill:#9C27B0,color:#fff
    style IMPL_COMPLETE fill:#E91E63,color:#fff
    style FINISH fill:#FFD700,color:#000
  🔧 完整配置定义 yaml 复制代码  # ═══════════════════════════════════════════════════════════════════════════════
# 终极完美工作流配置 - 完整版
# ═══════════════════════════════════════════════════════════════════════════════

workflow:
  name: "ultimate-perfection-workflow"
  version: "2.0.0"
  description: "世界顶级完美工作流 - 五大Agent协同作战"
  
  # ═══════════════════════════════════════════════════════════════════════════
  # 全局配置
  # ═══════════════════════════════════════════════════════════════════════════
  global:
    language_preference: "中文"
    workspace_base: ".claude/specs"
    max_iterations_per_phase: 5
    auto_save: true
    verbose_logging: true
    
    # 质量标准
    quality_standards:
      requirements_min_score: 80
      design_min_score: 85
      tasks_min_score: 90
      code_min_score: 85
      overall_min_score: 85
    
    # 超时配置
    timeouts:
      phase_timeout: "2h"
      agent_timeout: "30m"
      review_timeout: "15m"
    
    # 通知配置
    notifications:
      on_phase_complete: true
      on_quality_gate_fail: true
      on_user_action_required: true
      on_workflow_complete: true

  # ═══════════════════════════════════════════════════════════════════════════
  # Phase 1: 需求阶段
  # ═══════════════════════════════════════════════════════════════════════════
  phases:
    requirements:
      name: "需求分析阶段"
      icon: "📋"
      agent: "spec-requirements"
      
      # 输入参数
      inputs:
        task_type: "create"
        feature_name: "${workflow.input.feature_name}"
        feature_description: "${workflow.input.feature_description}"
        spec_base_path: "${global.workspace_base}"
        requirements_depth: "详尽"  # 概要/标准/详尽
      
      # 执行步骤
      steps:
        - id: "req-001"
          name: "需求理解"
          action: "analyze_feature_description"
          description: "深度理解用户需求，识别显性和隐性需求"
          
        - id: "req-002"
          name: "用户角色识别"
          action: "identify_user_roles"
          description: "识别所有用户角色及其目标"
          
        - id: "req-003"
          name: "场景分析"
          action: "analyze_scenarios"
          description: "分析正常场景、异常场景、边界场景"
          
        - id: "req-004"
          name: "非功能需求"
          action: "identify_nfr"
          description: "识别性能、安全、可用性等非功能需求"
          
        - id: "req-005"
          name: "生成需求文档"
          action: "generate_requirements"
          description: "使用EARS格式生成完整需求文档"
          output: "requirements.md"
      
      # 质量门禁
      quality_gates:
        - id: "qg-req-001"
          name: "需求完整性"
          criteria:
            - name: "用户故事覆盖"
              check: "all_user_roles_have_stories"
              weight: 25
            - name: "EARS格式规范"
              check: "ears_format_compliance"
              weight: 25
            - name: "验收标准明确"
              check: "acceptance_criteria_defined"
              weight: 25
            - name: "边界条件考虑"
              check: "boundary_conditions_covered"
              weight: 25
          min_score: 80
          
        - id: "qg-req-002"
          name: "需求质量"
          criteria:
            - name: "无歧义表达"
              check: "no_ambiguous_terms"
              weight: 30
            - name: "可测试性"
              check: "requirements_testable"
              weight: 30
            - name: "一致性"
              check: "no_conflicts"
              weight: 20
            - name: "可追溯性"
              check: "traceable_to_goals"
              weight: 20
          min_score: 85
      
      # 评估配置
      evaluation:
        agent: "spec-judge"
        mode: "strict"
        evaluation_type: "requirements"
        generate_report: true
        
      # 用户审批
      approval:
        required: true
        prompt: "需求文档是否满意？如果满意，我们将进入设计阶段。"
        on_reject: "refine"
        max_refinements: 3
      
      # 输出物
      outputs:
        - name: "requirements.md"
          description: "完整的EARS格式需求文档"
          required: true
        - name: "requirements_evaluation.md"
          description: "需求评估报告"
          required: false
      
      # 成功条件
      success_criteria:
        - "质量门禁全部通过"
        - "用户明确批准"
        - "需求文档已创建"
      
      # 失败处理
      on_failure:
        max_retries: 3
        actions:
          - "记录失败原因"
          - "生成问题报告"
          - "请求用户指导"

    # ═══════════════════════════════════════════════════════════════════════════
    # Phase 2: 设计阶段
    # ═══════════════════════════════════════════════════════════════════════════
    design:
      name: "架构设计阶段"
      icon: "🏗️"
      agent: "spec-design"
      depends_on: ["requirements"]
      
      # 输入参数
      inputs:
        task_type: "create"
        feature_name: "${workflow.input.feature_name}"
        spec_base_path: "${global.workspace_base}"
        design_depth: "完整"  # 概要/详细/完整/极致
        architecture_style: "六边形"  # 分层/微服务/事件驱动/六边形/整洁架构
        quality_focus: "均衡"  # 性能优先/可用性优先/安全优先/均衡
      
      # 前置检查
      preconditions:
        - check: "requirements_approved"
          message: "需求文档必须已获批准"
        - check: "requirements_file_exists"
          path: "${phases.requirements.outputs.requirements.md}"
      
      # 执行步骤
      steps:
        - id: "des-001"
          name: "需求映射"
          action: "map_requirements"
          description: "将需求映射到设计元素"
          
        - id: "des-002"
          name: "技术调研"
          action: "technical_research"
          description: "调研技术选型和最佳实践"
          
        - id: "des-003"
          name: "架构设计"
          action: "design_architecture"
          description: "设计C4模型三层架构图"
          sub_steps:
            - "系统上下文图 (C4 Level 1)"
            - "容器图 (C4 Level 2)"
            - "组件图 (C4 Level 3)"
            - "数据流图"
          
        - id: "des-004"
          name: "组件设计"
          action: "design_components"
          description: "详细设计每个组件"
          sub_steps:
            - "组件职责定义"
            - "接口设计"
            - "依赖关系"
            - "交互矩阵"
          
        - id: "des-005"
          name: "数据模型设计"
          action: "design_data_model"
          description: "设计领域模型和数据库模型"
          sub_steps:
            - "领域模型 (类图)"
            - "数据库模型 (ER图)"
            - "状态机定义"
            - "DTO设计"
          
        - id: "des-006"
          name: "API设计"
          action: "design_api"
          description: "设计API契约"
          sub_steps:
            - "端点清单"
            - "OpenAPI规范"
            - "错误码定义"
          
        - id: "des-007"
          name: "非功能设计"
          action: "design_nfr"
          description: "设计非功能方面"
          sub_steps:
            - "安全设计 (STRIDE)"
            - "性能设计"
            - "可观测性设计"
            - "错误处理设计"
          
        - id: "des-008"
          name: "ADR编写"
          action: "write_adr"
          description: "记录关键架构决策"
          
        - id: "des-009"
          name: "生成设计文档"
          action: "generate_design"
          description: "生成完整设计文档"
          output: "design.md"
      
      # 质量门禁
      quality_gates:
        - id: "qg-des-001"
          name: "架构完整性"
          criteria:
            - name: "C4模型完整"
              check: "c4_diagrams_complete"
              weight: 20
            - name: "需求全覆盖"
              check: "all_requirements_covered"
              weight: 25
            - name: "接口定义完整"
              check: "interfaces_defined"
              weight: 20
            - name: "数据模型完整"
              check: "data_models_complete"
              weight: 20
            - name: "ADR记录"
              check: "adr_documented"
              weight: 15
          min_score: 85
          
        - id: "qg-des-002"
          name: "架构质量"
          criteria:
            - name: "SOLID遵循"
              check: "solid_principles"
              weight: 25
            - name: "关注点分离"
              check: "separation_of_concerns"
              weight: 25
            - name: "安全设计"
              check: "security_design"
              weight: 25
            - name: "可扩展性"
              check: "scalability_design"
              weight: 25
          min_score: 85
      
      # 评估配置
      evaluation:
        agent: "spec-judge"
        mode: "strict"
        evaluation_type: "design"
        generate_report: true
        
      # 用户审批
      approval:
        required: true
        prompt: "设计文档是否满意？如果满意，我们将进入任务规划阶段。"
        on_reject: "refine"
        max_refinements: 3
        
        # 支持返回上一阶段
        allow_back:
          enabled: true
          target_phase: "requirements"
          prompt: "是否需要返回修改需求？"
      
      # 输出物
      outputs:
        - name: "design.md"
          description: "完整的架构设计文档"
          required: true
        - name: "design_evaluation.md"
          description: "设计评估报告"
          required: false
      
      # 成功条件
      success_criteria:
        - "质量门禁全部通过"
        - "用户明确批准"
        - "设计文档已创建"

    # ═══════════════════════════════════════════════════════════════════════════
    # Phase 3: 任务阶段
    # ═══════════════════════════════════════════════════════════════════════════
    tasks:
      name: "任务规划阶段"
      icon: "📝"
      agent: "spec-tasks"
      depends_on: ["requirements", "design"]
      
      # 输入参数
      inputs:
        task_type: "create"
        feature_name: "${workflow.input.feature_name}"
        spec_base_path: "${global.workspace_base}"
        planning_mode: "详细"  # 标准/详细/精简
        tdd_level: "推荐"  # 严格/推荐/可选
      
      # 前置检查
      preconditions:
        - check: "requirements_approved"
          message: "需求文档必须已获批准"
        - check: "design_approved"
          message: "设计文档必须已获批准"
        - check: "design_file_exists"
          path: "${phases.design.outputs.design.md}"
      
      # 执行步骤
      steps:
        - id: "task-001"
          name: "加载规范"
          action: "load_specifications"
          description: "加载需求和设计文档"
          
        - id: "task-002"
          name: "组件分析"
          action: "analyze_components"
          description: "分析设计中的所有组件"
          
        - id: "task-003"
          name: "任务分解"
          action: "decompose_tasks"
          description: "将组件分解为可执行任务"
          rules:
            - "任务粒度: 2-4小时"
            - "只包含编码任务"
            - "TDD模式: 先测试后实现"
          
        - id: "task-004"
          name: "依赖分析"
          action: "analyze_dependencies"
          description: "分析任务间依赖关系"
          
        - id: "task-005"
          name: "任务排序"
          action: "sequence_tasks"
          description: "按依赖关系排序任务"
          
        - id: "task-006"
          name: "生成依赖图"
          action: "generate_dependency_graph"
          description: "生成Mermaid格式依赖图"
          
        - id: "task-007"
          name: "需求追溯"
          action: "create_traceability"
          description: "创建需求追溯矩阵"
          
        - id: "task-008"
          name: "生成任务清单"
          action: "generate_tasks"
          description: "生成完整任务清单"
          output: "tasks.md"
      
      # 质量门禁
      quality_gates:
        - id: "qg-task-001"
          name: "任务完整性"
          criteria:
            - name: "需求全覆盖"
              check: "all_requirements_have_tasks"
              weight: 30
            - name: "设计全覆盖"
              check: "all_components_have_tasks"
              weight: 30
            - name: "依赖关系清晰"
              check: "dependencies_clear"
              weight: 20
            - name: "追溯矩阵完整"
              check: "traceability_complete"
              weight: 20
          min_score: 90
          
        - id: "qg-task-002"
          name: "任务可执行性"
          criteria:
            - name: "任务描述明确"
              check: "tasks_actionable"
              weight: 30
            - name: "粒度合适"
              check: "task_granularity"
              weight: 25
            - name: "只包含编码任务"
              check: "coding_tasks_only"
              weight: 25
            - name: "测试任务包含"
              check: "test_tasks_included"
              weight: 20
          min_score: 90
      
      # 评估配置
      evaluation:
        agent: "spec-judge"
        mode: "strict"
        evaluation_type: "tasks"
        generate_report: true
        
      # 用户审批
      approval:
        required: true
        prompt: "任务清单是否满意？如果满意，我们将开始代码实现。"
        on_reject: "refine"
        max_refinements: 3
        
        allow_back:
          enabled: true
         targets:
            - phase: "design"
              prompt: "是否需要返回修改设计？"
            - phase: "requirements"
              prompt: "是否需要返回修改需求？"
      
      # 输出物
      outputs:
        - name: "tasks.md"
          description: "完整的任务清单"
          required: true
        - name: "tasks_evaluation.md"
          description: "任务评估报告"
          required: false
      
      # 成功条件
      success_criteria:
        - "质量门禁全部通过"
        - "用户明确批准"
        - "任务清单已创建"

    # ═══════════════════════════════════════════════════════════════════════════
    # Phase 4: 实现阶段
    # ═══════════════════════════════════════════════════════════════════════════
    implementation:
      name: "代码实现阶段"
      icon: "💻"
      agent: "spec-impl"
      depends_on: ["requirements", "design", "tasks"]
      mode: "iterative"  # 迭代执行每个任务
      
      # 输入参数
      inputs:
        feature_name: "${workflow.input.feature_name}"
        spec_base_path: "${global.workspace_base}"
        implementation_mode: "标准"  # 极致/标准/快速原型
        test_requirement: "完整测试"  # 包含单测/仅实现/完整测试
      
      # 前置检查
      preconditions:
        - check: "all_phases_approved"
          phases: ["requirements", "design", "tasks"]
          message: "所有前置阶段必须已获批准"
        - check: "tasks_file_exists"
          path: "${phases.tasks.outputs.tasks.md}"
      
      # 任务执行循环
      task_execution:
        # 任务选择策略
        selection:
          strategy: "dependency_order"  # 按依赖顺序
          allow_parallel: false  # 是否允许并行
          skip_completed: true  # 跳过已完成
        
        # 每个任务的执行流程
        per_task:
          steps:
            - id: "impl-001"
              name: "任务准备"
              action: "prepare_task"
              description: "加载任务上下文和依赖"
              
            - id: "impl-002"
              name: "代码实现"
              action: "implement_code"
              description: "根据设计实现代码"
              sub_steps:
                - "创建/修改文件"
                - "实现核心逻辑"
                - "实现错误处理"
                - "添加日志和注释"
              
            - id: "impl-003"
              name: "编写测试"
              action: "write_tests"
              description: "编写单元测试"
              sub_steps:
                - "正常路径测试"
                - "边界条件测试"
                - "异常路径测试"
              
            - id: "impl-004"
              name: "代码自检"
              action: "self_review"
              description: "执行代码自检清单"
              checklist:
                - "功能完整性"
                - "边界条件处理"
                - "错误处理"
                - "代码规范"
                - "性能考量"
                - "安全考量"
                - "可测试性"
              
            - id: "impl-005"
              name: "运行测试"
              action: "run_tests"
              description: "运行所有测试"
              
            - id: "impl-006"
              name: "更新状态"
              action: "update_task_status"
              description: "更新任务状态为完成"
          
          # 任务级质量门禁
          quality_gates:
            - id: "qg-impl-task"
              name: "任务代码质量"
              criteria:
                - name: "与设计一致"
                  check: "matches_design"
                  weight: 25
                - name: "测试通过"
                  check: "tests_pass"
                  weight: 30
                - name: "代码规范"
                  check: "code_quality"
                  weight: 25
                - name: "自检通过"
                  check: "self_review_pass"
                  weight: 20
              min_score: 85
          
          # 任务完成回调
          on_complete:
            - action: "mark_task_complete"
            - action: "generate_task_report"
            - action: "log_progress"
          
          # 任务失败处理
          on_failure:
            max_retries: 2
            actions:
              - "记录错误"
              - "尝试修复"
              - "如果仍失败，请求用户指导"
      
      # 整体质量门禁
      quality_gates:
        - id: "qg-impl-overall"
          name: "整体实现质量"
          criteria:
            - name: "所有任务完成"
              check: "all_tasks_complete"
              weight: 30
            - name: "所有测试通过"
              check: "all_tests_pass"
              weight: 30
            - name: "代码覆盖率"
              check: "coverage_threshold"
              threshold: 85
              weight: 20
            - name: "需求全覆盖"
              check: "requirements_coverage"
              weight: 20
          min_score: 90
      
      # 输出物
      outputs:
        - name: "源代码"
          description: "所有实现的源代码文件"
          required: true
        - name: "测试代码"
          description: "所有测试文件"
          required: true
        - name: "implementation_report.md"
          description: "实现报告"
          required: true
      
      # 成功条件
      success_criteria:
        - "所有任务完成"
        - "所有测试通过"
        - "代码覆盖率≥85%"
        - "质量门禁通过"

  # ═══════════════════════════════════════════════════════════════════════════
  # 评估Agent配置 - 贯穿全流程的质量守护者
  # ═══════════════════════════════════════════════════════════════════════════
  evaluation:
    agent: "spec-judge"
    
    # 评估时机
    triggers:
      - phase: "requirements"
        when: "before_user_approval"
        mode: "strict"
      - phase: "design"
        when: "before_user_approval"
        mode: "strict"
      - phase: "tasks"
        when: "before_user_approval"
        mode: "strict"
      - phase: "implementation"
        when: "after_each_task"
        mode: "standard"
      - phase: "implementation"
        when: "after_all_complete"
        mode: "strict"
    
    # 评估维度权重
    dimensions:
      requirements:
        completeness: 25
        clarity: 25
        feasibility: 25
        consistency: 15
        maintainability: 10
      design:
        completeness: 25
        clarity: 25
        feasibility: 25
        consistency: 15
        maintainability: 10
      tasks:
        completeness: 30
        clarity: 25
        feasibility: 25
        consistency: 20
      code:
        correctness: 30
        quality: 25
        testability: 25
        maintainability: 20
    
    # 多版本评估
    multi_version:
      enabled: true
      max_versions: 3
      merge_strategy: "auto"  # auto/best/manual
    
    # 报告生成
    reports:
      generate_per_phase: true
      generate_final_summary: true
      include_recommendations: true

  # ═══════════════════════════════════════════════════════════════════════════
  # 工作流完成配置
  # ═══════════════════════════════════════════════════════════════════════════
  completion:
    # 最终报告
    final_report:
      generate: true
      sections:
        - name: "执行摘要"
          content: "workflow_summary"
        - name: "阶段完成情况"
          content: "phase_completion"
        - name: "质量得分"
          content: "quality_scores"
        - name: "产出物清单"
          content: "deliverables"
        - name: "需求追溯"
          content: "traceability_matrix"
        - name: "改进建议"
          content: "recommendations"
    
    # 产出物验证
    deliverables_validation:
      - file: "requirements.md"
        required: true
      - file: "design.md"
        required: true
      - file: "tasks.md"
        required: true
      - file: "源代码"
        required: true
      - file: "测试代码"
        required: true
    
    # 完成通知
    notifications:
      on_complete:
        message: "🎉 恭喜！工作流已完美完成！"
        include_summary: true

  # ═══════════════════════════════════════════════════════════════════════════
  # 异常处理和回滚
  # ═══════════════════════════════════════════════════════════════════════════
  error_handling:
    # 全局错误处理
    global:
      on_error:
        - "记录错误详情"
        - "保存当前状态"
        - "通知用户"
      max_global_retries: 3
    
    # 阶段回滚
    rollback:
      enabled: true
      auto_rollback_on_critical: true
      preserve_artifacts: true
    
    # 恢复策略
    recovery:
      checkpoint_interval: "per_step"
      resume_from_checkpoint: true

  # ═══════════════════════════════════════════════════════════════════════════
  # 监控和日志
  # ═══════════════════════════════════════════════════════════════════════════
  monitoring:
    # 进度追踪
    progress:
      track_phases: true
      track_tasks: true
      show_percentage: true
    
    # 日志配置
    logging:
      level: "INFO"
      include_timestamps: true
      log_to_file: true
      log_file: "${global.workspace_base}/workflow.log"
    
    # 性能指标
    metrics:
      track_duration: true
      track_iterations: true
      track_quality_scores: true
  🎯 Agent协作时序图 复制代码  sequenceDiagram
    autonumber
    
    participant User as 👤 用户
    participant WF as 🎮 工作流控制器
    participant REQ as 📋 需求Agent
    participant DES as 🏗️ 架构Agent
    participant TASK as 📝 任务Agent
    participant IMPL as 💻 代码Agent
    participant JUDGE as ⚖️ 评估Agent
    
    Note over User,JUDGE: 🚀 Phase 1: 需求阶段
    
    User->>WF: 启动工作流(功能描述)
    WF->>REQ: 创建需求文档
    
    loop 需求迭代
        REQ->>REQ: 分析需求
        REQ->>REQ: 生成EARS格式文档
        REQ->>JUDGE: 请求评估
        JUDGE->>JUDGE: 评估需求质量
        JUDGE-->>REQ: 评估报告(分数)
        
        alt 分数 < 80
            REQ->>REQ: 改进需求
        else 分数 >= 80
            REQ->>User: 请求审批
            alt 用户需要修改
                User-->>REQ: 修改意见
            else 用户批准
                User-->>WF: ✅ 需求批准
            end
        end
    end
    
    Note over User,JUDGE: 🏗️ Phase 2: 设计阶段
    
    WF->>DES: 创建设计文档(需求)
    
    loop 设计迭代
        DES->>DES: 分析需求
        DES->>DES: 技术调研
        DES->>DES: 生成架构设计
        DES->>JUDGE: 请求评估
        JUDGE->>JUDGE: 评估设计质量
        JUDGE-->>DES: 评估报告(分数)
        
        alt 分数 < 85
            DES->>DES: 改进设计
        else 分数 >= 85
            DES->>User: 请求审批
            alt 用户需要修改
                User-->>DES: 修改意见
            else 用户需要改需求
                User-->>WF: 返回需求阶段
                WF->>REQ: 重新处理需求
            else 用户批准
                User-->>WF: ✅ 设计批准
            end
        end
    end
    
    Note over User,JUDGE: 📝 Phase 3: 任务阶段
    
    WF->>TASK: 创建任务清单(需求+设计)
    
    loop 任务迭代
        TASK->>TASK: 分解任务
        TASK->>TASK: 分析依赖
        TASK->>TASK: 生成任务清单
        TASK->>JUDGE: 请求评估
        JUDGE->>JUDGE: 评估任务质量
        JUDGE-->>TASK: 评估报告(分数)
        
        alt 分数 < 90
            TASK->>TASK: 改进任务
        else 分数 >= 90
            TASK->>User: 请求审批
            alt 用户批准
                User-->>WF: ✅ 任务批准
            end
        end
    end
    
    Note over User,JUDGE: 💻 Phase 4: 实现阶段
    
    WF->>IMPL: 开始实现任务
    
    loop 每个任务
        IMPL->>IMPL: 加载任务上下文
        IMPL->>IMPL: 实现代码
        IMPL->>IMPL: 编写测试
        IMPL->>IMPL: 代码自检
        IMPL->>JUDGE: 请求代码评审
        
        alt 评审通过
            IMPL->>IMPL: 更新任务状态 ✅
        else 评审不通过
            IMPL->>IMPL: 修复问题
        end
    end
    
    IMPL-->>WF: 所有任务完成
    
    Note over User,JUDGE: 🎉 完成阶段
    
    WF->>JUDGE: 最终质量评估
    JUDGE->>JUDGE: 生成最终报告
    JUDGE-->>WF: 质量报告
    WF->>WF: 生成交付物清单
    WF-->>User: 🏆 工作流完成！
  📊 质量仪表盘 复制代码  ┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│                            🏆 工作流质量仪表盘                                       │
│                                                                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   📋 需求阶段                    🏗️ 设计阶段                                         │
│   ┌─────────────────────┐       ┌─────────────────────┐                            │
│   │ 完整性    ████████░░ 85%│   │ 完整性    █████████░ 92%│                        │
│   │ 清晰性    █████████░ 90%│   │ 清晰性    █████████░ 90%│                        │
│   │ 可行性    ████████░░ 82%│   │ 可行性    ████████░░ 88%│                        │
│   │ 一致性    █████████░ 88%│   │ 一致性    █████████░ 91%│                        │
│   │ ─────────────────── │       │ ─────────────────── │                            │
│   │ 总分      ████████░░ 86%│   │ 总分      █████████░ 90%│                        │
│   └─────────────────────┘       └─────────────────────┘                            │
│                                                                                     │
│   📝 任务阶段                    💻 实现阶段                                         │
│   ┌─────────────────────┐       ┌─────────────────────┐                            │
│   │ 完整性    █████████░ 95%│   │ 正确性    █████████░ 92%│                        │
│   │ 可执行性  █████████░ 93%│   │ 质量      █████████░ 90%│                        │
│   │ 依赖清晰  █████████░ 91%│   │ 测试覆盖  ████████░░ 87%│                        │
│   │ 追溯完整  █████████░ 94%│   │ 可维护性  █████████░ 89%│                        │
│   │ ─────────────────── │       │ ─────────────────── │                            │
│   │ 总分      █████████░ 93%│   │ 总分      █████████░ 90%│                        │
│   └─────────────────────┘       └─────────────────────┘                            │
│                                                                                     │
│   ═══════════════════════════════════════════════════════════════════════════════  │
│                                                                                     │
│                              🎯 整体质量得分                                         │
│                                                                                     │
│                    ┌─────────────────────────────────┐                             │
│                    │                                 │                             │
│                    │      ██████████████████░░       │                             │
│                    │           90/100                │                             │
│                    │          A级 (优秀)              │                             │
│                    │                                 │                             │
│                    └─────────────────────────────────┘                             │
│                                                                                     │
│   📈 阶段完成进度                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────┐     │
│   │ 需求 ████████████████████ 100%  ✅                                      │     │
│   │ 设计 ████████████████████ 100%  ✅                                      │     │
│   │ 任务 ████████████████████ 100%  ✅                                      │     │
│   │ 实现 ██████████████████░░  92%  🔄                                      │     │
│   └─────────────────────────────────────────────────────────────────────────┘     │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
  🔄 工作流启动命令 typescript 复制代码  // ═══════════════════════════════════════════════════════════════════════════════
// 工作流启动器
// ═══════════════════════════════════════════════════════════════════════════════

interface WorkflowInput {
  feature_name: string;
  feature_description: string;
  options?: {
    design_depth?: 'summary' | 'detailed' | 'complete' | 'ultimate';
    architecture_style?: 'layered' | 'microservices' | 'event-driven' | 'hexagonal' | 'clean';
    implementation_mode?: 'ultimate' | 'standard' | 'rapid';
    test_level?: 'strict' | 'recommended' | 'optional';
  };
}

async function startPerfectWorkflow(input: WorkflowInput): Promise<WorkflowResult> {
  console.log('🚀 启动终极完美工作流...');
  console.log(`📦 功能: ${input.feature_name}`);
  
  const workflow = new UltimatePerfectionWorkflow(input);
  
  // Phase 1: 需求
  console.log('\n📋 Phase 1: 需求分析...');
  const requirements = await workflow.executePhase('requirements');
  console.log(`✅ 需求完成 - 得分: ${requirements.score}`);
  
  // Phase 2: 设计
  console.log('\n🏗️ Phase 2: 架构设计...');
  const design = await workflow.executePhase('design');
  console.log(`✅ 设计完成 - 得分: ${design.score}`);
  
  // Phase 3: 任务
  console.log('\n📝 Phase 3: 任务规划...');
  const tasks = await workflow.executePhase('tasks');
  console.log(`✅ 任务完成 - 得分: ${tasks.score}`);
  
  // Phase 4: 实现
  console.log('\n💻 Phase 4: 代码实现...');
  const implementation = await workflow.executePhase('implementation');
  console.log(`✅ 实现完成 - 得分: ${implementation.score}`);
  
  // 生成最终报告
  const finalReport = await workflow.generateFinalReport();
  
  console.log('\n🏆 工作流完成！');
  console.log(`📊 整体得分: ${finalReport.overallScore}`);
  console.log(`📁 产出物: ${finalReport.deliverables.join(', ')}`);
  
  return {
    success: true,
    phases: { requirements, design, tasks, implementation },
    report: finalReport,
  };
}

// 使用示例
await startPerfectWorkflow({
  feature_name: 'order-management-system',
  feature_description: '实现完整的订单生命周期管理，包括创建、支付、配送、退款等功能',
  options: {
    design_depth: 'complete',
    architecture_style: 'hexagonal',
    implementation_mode: 'standard',
    test_level: 'strict',
  },
});
  📋 使用说明 复制代码  ┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│                            📖 完美工作流使用指南                                     │
│                                                                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   🚀 启动工作流                                                                     │
│   ─────────────────────────────────────────────────────────────────────────────    │
│   1. 准备功能描述                                                                   │
│   2. 选择配置选项（设计深度、架构风格、实现模式）                                    │
│   3. 启动工作流                                                                     │
│                                                                                     │
│   📋 需求阶段                                                                       │
│   ─────────────────────────────────────────────────────────────────────────────    │
│   • spec-requirements Agent 自动生成需求文档                                        │
│   • spec-judge Agent 评估需求质量                                                   │
│   • 等待您的审批，可提出修改意见                                                    │
│   • 批准后进入下一阶段                                                              │
│                                                                                     │
│   🏗️ 设计阶段                                                                       │
│   ─────────────────────────────────────────────────────────────────────────────    │
│   • spec-design Agent 基于需求生成设计文档                                          │
│   • 包含C4架构图、组件设计、数据模型等                                              │
│   • spec-judge Agent 评估设计质量                                                   │
│   • 等待您的审批，可返回修改需求                                                    │
│                                                                                     │
│   📝 任务阶段                                                                       │
│   ─────────────────────────────────────────────────────────────────────────────    │
│   • spec-tasks Agent 分解任务并排序                                                 │
│   • 生成依赖关系图和追溯矩阵                                                        │
│   • spec-judge Agent 评估任务质量                                                   │
│   • 等待您的审批，可返回修改设计                                                    │
│                                                                                     │
│   💻 实现阶段                                                                       │
│   ─────────────────────────────────────────────────────────────────────────────    │
│   • spec-impl Agent 按顺序执行每个任务                                              │
│   • 每个任务包含代码实现和测试                                                      │
│   • 自动更新任务状态                                                                │
│   • 完成后生成实现报告                                                              │
│                                                                                     │
│   🎉 完成                                                                           │
│   ─────────────────────────────────────────────────────────────────────────────    │
│   • 生成最终质量报告                                                                │
│   • 输出完整产出物清单                                                              │
│   • 提供改进建议                                                                    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
    🎯 完美工作流的核心保障 复制代码  ╔══════════════════════════════════════════════════════════════════════════════════════╗
║                                                                                      ║
║                           🛡️ 完美工作流的七层保障                                    ║
║                                                                                      ║
╠══════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                      ║
║   Layer 1: Agent专业性保障                                                           ║
║   ├── 每个Agent都是该领域的世界级专家                                                ║
║   ├── 20+年经验的方法论沉淀                                                          ║
║   └── 顶级最佳实践的融合                                                             ║
║                                                                                      ║
║   Layer 2: 流程标准化保障                                                            ║
║   ├── 严格的阶段划分                                                                 ║
║   ├── 明确的输入输出                                                                 ║
║   └── 清晰的依赖关系                                                                 ║
║                                                                                      ║
║   Layer 3: 质量门禁保障                                                              ║
║   ├── 每个阶段多维度质量检查                                                         ║
║   ├── 量化评分标准                                                                   ║
║   └── 不达标不放行                                                                   ║
║                                                                                      ║
║   Layer 4: 评估Agent保障                                                             ║
║   ├── 全程独立评估                                                                   ║
║   ├── 多版本择优                                                                     ║
║   └── 智能融合最佳方案                                                               ║
║                                                                                      ║
║   Layer 5: 用户审批保障                                                              ║
║   ├── 每个阶段用户审批                                                               ║
║   ├── 支持修改意见                                                                   ║
║   └── 支持返回上一阶段                                                               ║
║                                                                                      ║
║   Layer 6: 追溯性保障                                                                ║
║   ├── 需求到代码全程追溯                                                             ║
║   ├── 完整的追溯矩阵                                                                 ║
║   └── 变更影响分析                                                                   ║
║                                                                                      ║
║   Layer 7: 容错恢复保障                                                              ║
║   ├── 检查点自动保存                                                                 ║
║   ├── 失败自动重试                                                                   ║
║   └── 支持断点续传                                                                   ║
║                                                                                      ║
╚══════════════════════════════════════════════════════════════════════════════════════╝
          