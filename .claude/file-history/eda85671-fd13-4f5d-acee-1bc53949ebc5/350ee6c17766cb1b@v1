# V4PRO 新成员入门指南

> **版本**: v4.0.0 军规级
> **阅读时间**: 10分钟
> **目标**: 让新成员快速理解V4PRO架构并开始贡献代码

---

## 欢迎加入V4PRO军规级国家工程！

本指南将帮助你在10分钟内理解V4PRO中国期货量化交易系统的架构和开发流程。

---

## 1. 系统架构 (3分钟)

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        V4PRO 中国期货量化交易系统                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   market/   │───▶│  strategy/  │───▶│  execution/ │───▶│   broker/   │  │
│  │   行情层    │    │   策略层    │    │   执行层    │    │  Broker层   │  │
│  │   (M3)     │    │  (M4,M9)   │    │   (M1)     │    │   (M8)     │  │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│         │                 │                  │                  │          │
│         ▼                 ▼                  ▼                  ▼          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         audit/ 审计层 (M3,M7)                        │   │
│  │                    JSONL + fsync + run_id/exec_id                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                 │                  │                  │          │
│         ▼                 ▼                  ▼                  ▼          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         risk/ 风控层 (M6,M16)                        │   │
│  │                    VaR + 熔断 + 保证金监控                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 数据流向

```
行情数据 ──▶ market/ ──▶ strategy/ ──▶ execution/ ──▶ broker/
                │            │              │            │
                ▼            ▼              ▼            ▼
            audit/ ◀──────────────────────────────────────
                │
                ▼
            replay/ (回放验证M7)
```

### 1.3 核心模块说明

| 模块 | 目录 | 职责 | 军规覆盖 |
|------|------|------|----------|
| 行情层 | `src/market/` | 行情订阅、交易所配置、夜盘日历 | M3,M15,M20 |
| 策略层 | `src/strategy/` | 策略框架、降级管理、套利策略 | M4,M9,M18 |
| 执行层 | `src/execution/` | 订单执行、保护层 | M1,M4,M13 |
| 审计层 | `src/audit/` | JSONL审计日志、回放数据 | M3,M7 |
| 风控层 | `src/risk/` | VaR计算、熔断保护、保证金监控 | M6,M16,M19 |
| 守护层 | `src/guardian/` | 实时监控、中国触发器 | M6,M13,M15,M16 |
| 成本层 | `src/cost/` | 手续费计算、成本估算 | M5,M14 |
| 合规层 | `src/compliance/` | 程序化交易合规、报撤单节流 | M12,M17 |
| 交易控制 | `src/trading/` | CI门禁、CHECK_MODE、退出码 | M1-M9 |

---

## 2. 军规速查 (2分钟)

### 2.1 核心军规 M1-M20

| 军规 | 名称 | 一句话描述 | 违规后果 |
|------|------|------------|----------|
| **M1** | 单一信号源 | 一个信号只能来自一个策略 | 重复下单 |
| **M3** | 完整审计 | 所有决策必须有日志 | 监管风险 |
| **M4** | 降级兜底 | 策略异常必须有降级路径 | 系统瘫痪 |
| **M5** | 成本先行 | 边际收益必须大于成本 | 亏损交易 |
| **M6** | 熔断保护 | 触发风控必须立即停止 | 巨额亏损 |
| **M7** | 回放一致 | 相同输入必须相同输出 | 策略失效 |
| **M13** | 涨跌停感知 | 订单价格必须检查涨跌停 | 废单 |
| **M16** | 保证金监控 | 保证金使用率实时计算 | 强平风险 |
| **M17** | 程序化合规 | 报撤单频率必须合规 | 监管处罚 |

### 2.2 退出码系统

| 退出码 | 含义 | 处理方式 |
|--------|------|----------|
| 0 | SUCCESS | 正常 |
| 2 | FORMAT_LINT_FAIL | 运行 `ruff format .` |
| 3 | TYPE_CHECK_FAIL | 修复类型错误 |
| 4 | TEST_FAIL | 修复测试 |
| 5 | COVERAGE_FAIL | 添加测试覆盖 |
| 6 | RISK_CONFIG_FAIL | 检查风控配置 |
| 12 | POLICY_VIOLATION | 军法处置级别！|

---

## 3. 开发环境配置 (2分钟)

### 3.1 环境要求

- Python 3.11+
- Windows (推荐) / Linux / macOS

### 3.2 快速启动

```powershell
# 1. 克隆仓库
git clone <repo-url>
cd 3579

# 2. 创建虚拟环境
python -m venv .venv
.venv\Scripts\activate

# 3. 安装依赖
pip install -r requirements.txt
pip install -r requirements-dev.txt

# 4. 运行测试验证环境
.venv\Scripts\python.exe -m pytest tests/ -q
```

### 3.3 CI门禁检查 (提交前必须运行)

```powershell
# 格式检查
.venv\Scripts\python.exe -m ruff format --check .

# Lint检查
.venv\Scripts\python.exe -m ruff check .

# 类型检查
.venv\Scripts\python.exe -m mypy src

# 测试 (覆盖率≥85%)
.venv\Scripts\python.exe -m pytest tests/ -q --cov=src --cov-fail-under=85

# 策略验证
.venv\Scripts\python.exe scripts/validate_policy.py --all
```

---

## 4. 目录结构 (2分钟)

```
3579/
├── src/                    # 源代码
│   ├── trading/           # CI门禁、CHECK_MODE
│   ├── strategy/          # 策略框架
│   ├── audit/             # 审计日志
│   ├── market/            # 行情层
│   ├── execution/         # 执行层
│   ├── risk/              # 风控层
│   ├── guardian/          # 守护层
│   ├── cost/              # 成本层
│   ├── compliance/        # 合规层
│   ├── portfolio/         # 组合管理
│   ├── monitoring/        # 监控层
│   └── replay/            # 回放层
│
├── tests/                  # 测试 (与src/一一对应)
│   ├── trading/
│   ├── strategy/
│   ├── audit/
│   ├── market/
│   ├── execution/
│   ├── risk/
│   ├── guardian/
│   ├── cost/
│   ├── compliance/
│   ├── portfolio/
│   ├── monitoring/
│   ├── replay/
│   ├── integration/       # 集成测试
│   └── brokers/
│
├── config/                 # 配置文件
│   ├── environments/      # 环境配置 (dev/sim/live)
│   ├── exchanges/         # 六大交易所配置
│   ├── risk/              # 风控配置
│   └── strategies/        # 策略配置
│
├── docs/                   # 文档
│   ├── V4PRO_UPGRADE_PLAN_SUPREME_DIRECTIVE.md  # 最高指示文件
│   └── 新成员入门指南.md   # 本文件
│
├── scripts/                # 脚本
│   ├── validate_policy.py # 策略验证
│   └── validate_scenarios.py # 场景验证
│
├── scenarios/              # 测试场景 (165个)
│
└── artifacts/              # CI产物
    ├── check/             # CI报告
    ├── replay/            # 回放报告
    └── sim/               # 仿真报告
```

---

## 5. 核心代码示例 (1分钟)

### 5.1 使用CHECK_MODE

```python
from src.trading import enable_check_mode, is_check_mode

# CI/仿真环境必须启用
enable_check_mode()

# 检查当前模式
if is_check_mode():
    print("当前为检查模式，禁止实盘操作")
```

### 5.2 审计日志

```python
from src.audit import AuditWriter

# 创建审计写入器 (fsync=True 必须！)
writer = AuditWriter("artifacts/audit.jsonl", fsync=True)

# 写入决策事件
writer.write_decision({
    "run_id": "R001",
    "exec_id": "E001",
    "action": "BUY",
    "symbol": "rb2405",
})
```

### 5.3 策略降级

```python
from src.strategy import FallbackManager

# 降级链: 主策略 → 降级1 → 降级2 → 全平
manager = FallbackManager([
    "calendar_arb",
    "linear_ai",
    "simple_ai",
    "flat_all"
])

# 获取决策 (自动降级)
decision = manager.get_decision(market_data)
```

---

## 6. 常见问题 FAQ

### Q1: CI门禁失败怎么办？

查看退出码，对应修复：
- Exit 2: 运行 `ruff format .` 自动格式化
- Exit 3: 检查mypy错误，添加类型注解
- Exit 4: 修复失败的测试用例
- Exit 5: 添加测试覆盖率

### Q2: 如何添加新策略？

1. 在 `src/strategy/` 创建策略文件
2. 继承 `Strategy` 基类
3. 实现 `on_tick()` 和 `generate_signal()` 方法
4. 在 `tests/strategy/` 添加测试
5. 配置降级链 (M4)

### Q3: 在哪里找到详细文档？

- **最高指示文件**: `docs/V4PRO_UPGRADE_PLAN_SUPREME_DIRECTIVE.md`
- **退出码说明**: `docs/V4PROEXIT_CODES.md`
- **验收矩阵**: `docs/V4PRO_ACCEPTANCE_MATRIX_SUPREME.md`

---

## 7. 开发规范

### 7.1 代码规范

- 全程使用**中文注释和docstring**
- 遵循 Ruff 格式化规则
- 所有函数必须有类型注解
- 测试覆盖率 ≥ 85%

### 7.2 提交规范

```
提交前必须通过:
1. ruff format --check .
2. ruff check .
3. mypy src
4. pytest tests/ --cov=src --cov-fail-under=85
```

### 7.3 分支规范

- `main`: 主分支，CI必须100%通过
- `feat/*`: 功能分支
- `fix/*`: 修复分支

---

## 8. 联系方式

如有问题，请联系项目负责人或查阅 `docs/` 目录下的详细文档。

---

**军规级别国家伟大工程 - 新成员培训规范**

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│           欢迎加入V4PRO军规级中国期货量化交易系统团队！              │
│                                                                     │
│                       为国家金融市场贡献力量！                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```
