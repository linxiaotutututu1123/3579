"""
K线数据模型
"""

from pydantic import BaseModel, Field, field_validator, ConfigDict
from datetime import datetime
from decimal import Decimal
from typing import Optional, Dict, Any, List
from enum import Enum

class KLinePeriod(Enum):
    """K线周期枚举"""
    MINUTE_1 = 1
    MINUTE_5 = 5
    MINUTE_15 = 15
    MINUTE_30 = 30
    HOUR_1 = 60
    HOUR_4 = 240
    DAY_1 = 1440
    WEEK_1 = 10080

class KLineData(BaseModel):
    """K线数据模型"""

    # 合约基本信息
    symbol: str = Field(..., description="合约代码，如'rb2401'")
    exchange: str = Field(..., description="交易所代码，如'SHFE'")
    period: KLinePeriod = Field(..., description="K线周期")

    # 时间戳信息
    datetime: datetime = Field(..., description="K线时间戳（开盘时间）")
    open_datetime: datetime = Field(..., description="开盘时间")
    close_datetime: datetime = Field(..., description="收盘时间")

    # 价格信息
    open_price: Decimal = Field(..., description="开盘价")
    high_price: Decimal = Field(..., description="最高价")
    low_price: Decimal = Field(..., description="最低价")
    close_price: Decimal = Field(..., description="收盘价")

    # 成交信息
    volume: int = Field(..., description="成交量")
    turnover: Decimal = Field(..., description="成交额")
    open_interest: int = Field(..., description="持仓量变化")

    # 数据质量信息
    source: str = Field(default="generated", description="数据来源")
    is_valid: bool = Field(default=True, description="数据是否有效")
    validation_errors: Optional[List[str]] = Field(default=None, description="验证错误信息")

    model_config = ConfigDict()

    @field_validator('open_price', 'high_price', 'low_price', 'close_price', mode='before')
    @classmethod
    def validate_price(cls, v):
        """验证价格有效性"""
        if v is None:
            return v
        # 价格必须为正数
        if isinstance(v, (int, float, Decimal)) and v <= 0:
            raise ValueError("价格必须为正数")
        return Decimal(str(v))

    @field_validator('volume', 'open_interest', mode='before')
    @classmethod
    def validate_volume(cls, v):
        """验证成交量有效性"""
        if v is None:
            return v
        # 成交量不能为负数
        if isinstance(v, int) and v < 0:
            raise ValueError("成交量不能为负数")
        return v

    @field_validator('datetime', 'open_datetime', 'close_datetime', mode='before')
    @classmethod
    def validate_datetime(cls, v):
        """验证时间戳有效性"""
        if isinstance(v, str):
            try:
                return datetime.fromisoformat(v)
            except ValueError:
                raise ValueError("时间戳格式无效")
        return v

    def to_dict(self) -> Dict[str, Any]:
        """转换为字典格式，便于序列化"""
        return self.model_dump()

    @property
    def price_change(self) -> Decimal:
        """价格变化"""
        return self.close_price - self.open_price

    @property
    def price_change_rate(self) -> Decimal:
        """价格变化率"""
        if self.open_price == 0:
            return Decimal('0')
        return (self.price_change / self.open_price) * 100

    @property
    def is_bullish(self) -> bool:
        """是否阳线"""
        return self.close_price > self.open_price

    @property
    def is_bearish(self) -> bool:
        """是否阴线"""
        return self.close_price < self.open_price

__all__ = ['KLineData', 'KLinePeriod']