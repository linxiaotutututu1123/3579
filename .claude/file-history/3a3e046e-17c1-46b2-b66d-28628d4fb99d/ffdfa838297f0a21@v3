"""
pytest配置文件

提供全局测试配置和共享fixtures。
"""

import sys
import os
from decimal import Decimal
from datetime import datetime
from typing import Dict, Any, List

import pytest
from unittest.mock import Mock, AsyncMock

# 添加src目录到Python路径
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

# pytest-asyncio 配置
pytest_plugins = ('pytest_asyncio',)


def pytest_configure(config):
    """pytest配置钩子"""
    config.addinivalue_line(
        "markers", "benchmark: mark test as a benchmark test"
    )
    config.addinivalue_line(
        "markers", "slow: mark test as slow running"
    )
    config.addinivalue_line(
        "markers", "integration: mark test as integration test"
    )


# ==================== 测试常量 ====================

TEST_SYMBOL = "rb2401"
TEST_EXCHANGE = "SHFE"
TEST_PRICE = Decimal("3000.0")
TEST_VOLUME = 1000
TEST_BROKER_ID = "9999"
TEST_USER_ID = "test_user"
TEST_PASSWORD = "test_password"
TEST_FRONT_ADDR = "tcp://180.168.146.187:10131"


# ==================== 配置 Fixtures ====================

@pytest.fixture
def ctp_config() -> Dict[str, Any]:
    """CTP连接配置fixture"""
    return {
        "front_addr": TEST_FRONT_ADDR,
        "broker_id": TEST_BROKER_ID,
        "user_id": TEST_USER_ID,
        "password": TEST_PASSWORD,
        "connect_timeout": 10,
        "heartbeat_interval": 30
    }


@pytest.fixture
def gateway_config(ctp_config) -> Dict[str, Any]:
    """网关配置fixture"""
    return {
        "name": "TestGateway",
        "type": "ctp",
        "enabled": True,
        "ctp": ctp_config,
        "max_reconnect_attempts": 3,
        "max_backoff_seconds": 60,
        "initial_backoff_seconds": 1,
        "max_subscriptions": 1000,
        "subscription_timeout": 5,
        "cache_duration_seconds": 30,
        "max_cache_size": 10000,
        "price_deviation_threshold": 0.1,
        "timestamp_tolerance_hours": 1,
        "max_ticks_per_second": 5000,
        "batch_size": 100,
        "redis_host": "localhost",
        "redis_port": 6379,
        "redis_db": 0,
        "clickhouse_host": "localhost",
        "clickhouse_port": 9000,
        "clickhouse_database": "market_data",
        "clickhouse_table": "tick_data"
    }


# ==================== 数据 Fixtures ====================

@pytest.fixture
def sample_ctp_tick_data() -> Dict[str, Any]:
    """模拟CTP格式的Tick数据fixture"""
    return {
        "InstrumentID": TEST_SYMBOL,
        "ExchangeID": TEST_EXCHANGE,
        "LastPrice": float(TEST_PRICE),
        "Volume": TEST_VOLUME,
        "Turnover": 3000000.0,
        "OpenInterest": 5000,
        "BidPrice1": float(TEST_PRICE - Decimal("1.0")),
        "AskPrice1": float(TEST_PRICE + Decimal("1.0")),
        "BidVolume1": 10,
        "AskVolume1": 15,
        "UpperLimitPrice": 3200.0,
        "LowerLimitPrice": 2800.0,
        "UpdateTime": "15:00:00",
        "UpdateMillisec": 500,
        "TradingDay": datetime.now().strftime("%Y%m%d"),
        "ActionDay": datetime.now().strftime("%Y%m%d"),
        "OpenPrice": 2990.0,
        "HighestPrice": 3010.0,
        "LowestPrice": 2980.0,
        "PreClosePrice": 2985.0,
        "PreSettlementPrice": 2988.0
    }


@pytest.fixture
def sample_tick_data() -> Dict[str, Any]:
    """标准化Tick数据fixture"""
    now = datetime.now()
    return {
        "symbol": TEST_SYMBOL,
        "exchange": TEST_EXCHANGE,
        "datetime": now,
        "local_datetime": now,
        "last_price": TEST_PRICE,
        "volume": TEST_VOLUME,
        "turnover": Decimal("3000000.0"),
        "open_interest": 5000,
        "bid_price_1": TEST_PRICE - Decimal("1.0"),
        "ask_price_1": TEST_PRICE + Decimal("1.0"),
        "bid_volume_1": 10,
        "ask_volume_1": 15,
    }


@pytest.fixture
def sample_kline_data() -> Dict[str, Any]:
    """K线数据fixture"""
    from src.models.kline_data import KLinePeriod
    now = datetime.now()
    return {
        "symbol": TEST_SYMBOL,
        "exchange": TEST_EXCHANGE,
        "period": KLinePeriod.MINUTE_1,
        "open_time": now,
        "close_time": now,
        "open_price": Decimal("3000.0"),
        "high_price": Decimal("3010.0"),
        "low_price": Decimal("2990.0"),
        "close_price": Decimal("3005.0"),
        "volume": 1000,
        "turnover": Decimal("3000000.0"),
        "open_interest": 5000,
    }


@pytest.fixture
def invalid_tick_data_negative_price() -> Dict[str, Any]:
    """无效Tick数据（负价格）fixture"""
    return {
        "InstrumentID": TEST_SYMBOL,
        "ExchangeID": TEST_EXCHANGE,
        "LastPrice": -1,
        "Volume": TEST_VOLUME,
        "Turnover": 3000000.0,
        "OpenInterest": 5000,
        "UpdateTime": "15:00:00",
        "UpdateMillisec": 500,
        "TradingDay": datetime.now().strftime("%Y%m%d"),
        "ActionDay": datetime.now().strftime("%Y%m%d")
    }


@pytest.fixture
def invalid_tick_data_missing_fields() -> Dict[str, Any]:
    """无效Tick数据（缺少必要字段）fixture"""
    return {
        "InstrumentID": TEST_SYMBOL,
        "ExchangeID": TEST_EXCHANGE,
        # 缺少 LastPrice
        "Volume": TEST_VOLUME,
        "Turnover": 3000000.0,
        "OpenInterest": 5000,
        "UpdateTime": "15:00:00",
        "UpdateMillisec": 500,
        "TradingDay": datetime.now().strftime("%Y%m%d"),
        "ActionDay": datetime.now().strftime("%Y%m%d")
    }


# ==================== Mock Fixtures ====================

@pytest.fixture
def mock_ctp_api():
    """模拟CTP API fixture"""
    api = Mock()
    api.SubscribeMarketData = Mock(return_value=True)
    api.UnSubscribeMarketData = Mock(return_value=True)
    api.ReqUserLogin = Mock(return_value=0)
    api.ReqUserLogout = Mock(return_value=0)
    api.Init = Mock()
    api.Release = Mock()
    api.RegisterSpi = Mock()
    api.RegisterFront = Mock()
    return api


@pytest.fixture
def mock_redis_client():
    """模拟Redis客户端fixture"""
    client = AsyncMock()
    client.ping = AsyncMock(return_value=True)
    client.set = AsyncMock(return_value=True)
    client.get = AsyncMock(return_value=None)
    client.publish = AsyncMock(return_value=1)
    client.close = AsyncMock()
    return client


@pytest.fixture
def mock_clickhouse_client():
    """模拟ClickHouse客户端fixture"""
    client = Mock()
    client.execute = Mock(return_value=None)
    client.disconnect = Mock()
    return client


# ==================== 网关 Fixtures ====================

@pytest.fixture
def mock_gateway(gateway_config, mock_ctp_api):
    """模拟网关实例fixture"""
    from src.market_gateway.ctp_gateway import CtpMarketGateway

    gateway = CtpMarketGateway(gateway_config)
    gateway.api = mock_ctp_api

    yield gateway


@pytest.fixture
async def connected_gateway(mock_gateway):
    """已连接的网关fixture"""
    mock_gateway.connected = True
    mock_gateway.logged_in = True
    from src.market_gateway.base import GatewayStatus
    mock_gateway.status = GatewayStatus.CONNECTED

    yield mock_gateway


# ==================== 辅助函数 ====================

def create_tick_batch(count: int, base_price: Decimal = TEST_PRICE) -> List[Dict[str, Any]]:
    """创建批量Tick数据

    Args:
        count: 数量
        base_price: 基础价格

    Returns:
        List[Dict[str, Any]]: Tick数据列表
    """
    ticks = []
    for i in range(count):
        ticks.append({
            "InstrumentID": TEST_SYMBOL,
            "ExchangeID": TEST_EXCHANGE,
            "LastPrice": float(base_price + Decimal(str(i * 0.1))),
            "Volume": TEST_VOLUME + i,
            "Turnover": 3000000.0 + i * 1000,
            "OpenInterest": 5000,
            "BidPrice1": float(base_price - Decimal("1.0")),
            "AskPrice1": float(base_price + Decimal("1.0")),
            "BidVolume1": 10,
            "AskVolume1": 15,
            "UpdateTime": f"15:00:{i:02d}",
            "UpdateMillisec": 500,
            "TradingDay": datetime.now().strftime("%Y%m%d"),
            "ActionDay": datetime.now().strftime("%Y%m%d")
        })
    return ticks


# 导出辅助函数供测试使用
__all__ = [
    'TEST_SYMBOL',
    'TEST_EXCHANGE',
    'TEST_PRICE',
    'TEST_VOLUME',
    'TEST_BROKER_ID',
    'TEST_USER_ID',
    'TEST_PASSWORD',
    'TEST_FRONT_ADDR',
    'create_tick_batch',
]
