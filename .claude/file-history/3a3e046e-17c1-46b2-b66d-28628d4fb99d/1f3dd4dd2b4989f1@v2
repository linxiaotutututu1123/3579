"""网关工厂测试模块

测试GatewayFactory类的功能，包括：
1. 创建不同类型网关的能力
2. 配置验证和错误处理
3. 动态注册新网关类型
4. 辅助方法测试
"""

import pytest
from typing import Dict, List, Any

from src.market_gateway.factory import GatewayFactory
from src.market_gateway.base import MarketGateway, GatewayStatus
from src.market_gateway.ctp_gateway import CtpMarketGateway
from src.market_gateway.exceptions import ConfigError

# 测试常量定义
# RISK: 测试配置应保持最小化且具有代表性，避免包含真实凭据
VALID_CTP_CONFIG = {
    "name": "TestCTPGateway",
    "type": "ctp",
    "enabled": True,
    "ctp": {
        "front_addr": "tcp://180.168.146.187:10131",
        "broker_id": "9999",
        "user_id": "test_user",
        "password": "test_password",
        "connect_timeout": 10,
        "heartbeat_interval": 30
    },
    "max_reconnect_attempts": 3,
    "max_backoff_seconds": 60,
    "initial_backoff_seconds": 1
}

# 测试用符号常量
TEST_SYMBOLS = ["rb2401", "cu2401"]  # 测试用期货合约代码
MOCK_ATTRIBUTE_VALUE = "mock_value"  # 模拟网关属性值
ANOTHER_MOCK_VALUE = "another_value"  # 另一个模拟网关属性值


class MockGateway(MarketGateway):
    """用于测试的模拟网关类
    
    模拟真实的网关行为以便进行单元测试，避免依赖外部系统。
    """

    def __init__(self, config: Dict[str, Any]):
        """初始化模拟网关
        
        Args:
            config: 网关配置字典
        """
        # 调用父类初始化以确保基础功能正常 # REVIEW: 保持继承链完整性
        super().__init__(config)
        self.mock_attribute = MOCK_ATTRIBUTE_VALUE

    async def connect(self) -> bool:
        """模拟连接操作
        
        Returns:
            bool: 连接是否成功
        """
        # 模拟连接成功的状态变化 # REVIEW: 提供可预测的行为用于测试
        self.status = GatewayStatus.CONNECTED
        return True

    async def disconnect(self) -> None:
        """模拟断开连接操作"""
        # 模拟断开连接的状态变化 # REVIEW: 提供可预测的行为用于测试
        self.status = GatewayStatus.DISCONNECTED

    async def subscribe(self, symbols: List[str]) -> Dict[str, bool]:
        """模拟订阅操作
        
        Args:
            symbols: 要订阅的符号列表
            
        Returns:
            Dict[str, bool]: 订阅结果映射
        """
        result = {}
        # 模拟订阅过程 # REVIEW: 提供可预测的行为用于测试
        for symbol in symbols:
            self.subscribed_symbols.add(symbol)
            result[symbol] = True
        return result

    async def unsubscribe(self, symbols: List[str]) -> Dict[str, bool]:
        """模拟取消订阅操作
        
        Args:
            symbols: 要取消订阅的符号列表
            
        Returns:
            Dict[str, bool]: 取消订阅结果映射
        """
        result = {}
        # 模拟取消订阅过程 # REVIEW: 提供可预测的行为用于测试
        for symbol in symbols:
            self.subscribed_symbols.discard(symbol)
            result[symbol] = True
        return result


class TestGatewayFactory:
    """网关工厂测试类"""

    @pytest.fixture(autouse=True)
    def cleanup_registered_types(self):
        """每个测试后清理注册的测试类型
        
        确保测试之间的隔离性，防止状态污染。
        """
        yield
        # 清理测试中注册的类型 # REVIEW: 保持测试环境清洁
        GatewayFactory.unregister_gateway_type("mock")
        GatewayFactory.unregister_gateway_type("test")

    def test_create_ctp_gateway_success(self):
        """测试成功创建CTP网关

        测试目的：验证工厂能够正确创建CTP网关实例
        
        Arrange: 准备有效的CTP配置
        Act: 调用工厂创建网关
        Assert: 验证返回的网关实例类型和属性
        """
        # Act - 执行创建操作
        gateway = GatewayFactory.create_gateway(VALID_CTP_CONFIG)

        # Assert - 验证结果
        assert gateway is not None, "网关实例不应为None"
        assert isinstance(gateway, CtpMarketGateway), "应创建CTP网关实例"
        assert isinstance(gateway, MarketGateway), "应继承自基础网关类"
        assert gateway.gateway_config.name == "TestCTPGateway", "网关名称应匹配配置"

    def test_create_gateway_missing_type_field(self):
        """测试创建网关时缺少type字段

        测试目的：验证工厂在缺少必需字段时能正确抛出异常
        
        Arrange: 准备缺少type字段的配置
        Act: 调用工厂创建网关
        Assert: 验证抛出ValueError异常
        """
        # Arrange - 准备无效配置
        config_without_type = {
            "name": "InvalidGateway",
            "enabled": True,
            "ctp": {
                "front_addr": "tcp://180.168.146.187:10131",
                "broker_id": "9999",
                "user_id": "test_user",
                "password": "test_password"
            }
        }

        # Act & Assert - 验证异常
        with pytest.raises(ValueError) as exc_info:
            GatewayFactory.create_gateway(config_without_type)

        # 验证错误消息内容 # REVIEW: 确保错误信息具有描述性
        assert "must include 'type' field" in str(exc_info.value)

    def test_create_gateway_unsupported_type(self):
        """测试创建不支持的网关类型

        测试目的：验证工厂在遇到不支持的类型时能正确处理
        
        Arrange: 准备不支持的网关类型配置
        Act: 调用工厂创建网关
        Assert: 验证抛出ValueError异常并包含支持的类型列表
        """
        # Arrange - 准备不支持的类型配置
        unsupported_config = {
            **VALID_CTP_CONFIG,
            "type": "unsupported_type"
        }

        # Act & Assert - 验证异常
        with pytest.raises(ValueError) as exc_info:
            GatewayFactory.create_gateway(unsupported_config)

        # 验证错误消息内容 # REVIEW: 确保错误信息具有描述性且包含有用信息
        error_msg = str(exc_info.value)
        assert "Unsupported gateway type" in error_msg
        assert "unsupported_type" in error_msg
        assert "Supported types" in error_msg

    def test_create_gateway_invalid_config(self):
        """测试创建网关时传入无效配置

        测试目的：验证工厂在配置无效时能正确处理
        
        Arrange: 准备无效的CTP配置（无效的front_addr格式）
        Act: 调用工厂创建网关
        Assert: 验证抛出ConfigError异常
        """
        # Arrange - 准备无效配置
        invalid_config = {
            **VALID_CTP_CONFIG,
            "ctp": {
                "front_addr": "invalid_address",  # 无效地址格式
                "broker_id": "9999",
                "user_id": "test_user",
                "password": "test_password"
            }
        }

        # Act & Assert - 验证异常
        with pytest.raises(ConfigError):
            GatewayFactory.create_gateway(invalid_config)

    def test_register_new_gateway_type(self):
        """测试注册新的网关类型

        测试目的：验证工厂支持动态注册新的网关类型
        
        Arrange: 创建模拟网关类
        Act: 注册新类型并尝试创建实例
        Assert: 验证新类型能被正确创建
        """
        # Act - 注册新类型并创建实例
        GatewayFactory.register_gateway_type("mock", MockGateway)

        config = {
            **VALID_CTP_CONFIG,
            "name": "MockGateway",
            "type": "mock"
        }

        gateway = GatewayFactory.create_gateway(config)

        # Assert - 验证结果
        assert gateway is not None, "网关实例不应为None"
        assert isinstance(gateway, MockGateway), "应创建模拟网关实例"
        assert hasattr(gateway, 'mock_attribute'), "应具有模拟属性"
        assert gateway.mock_attribute == MOCK_ATTRIBUTE_VALUE, "模拟属性值应匹配"

    def test_register_invalid_gateway_class(self):
        """测试注册无效的网关类

        测试目的：验证工厂在注册无效类时能正确抛出异常
        
        Arrange: 准备一个非MarketGateway子类
        Act: 尝试注册
        Assert: 验证抛出TypeError
        """

        class NotAGateway:
            """非网关类，用于测试错误处理"""
            pass

        # Act & Assert - 验证异常
        with pytest.raises(TypeError) as exc_info:
            GatewayFactory.register_gateway_type("invalid", NotAGateway)

        assert "must be a subclass of MarketGateway" in str(exc_info.value)

    def test_register_empty_gateway_type(self):
        """测试注册空的网关类型名称

        Act: 尝试注册空字符串类型
        Assert: 验证抛出ValueError
        """
        with pytest.raises(ValueError) as exc_info:
            GatewayFactory.register_gateway_type("", MockGateway)

        assert "cannot be empty" in str(exc_info.value)

    def test_create_gateway_case_insensitive_type(self):
        """测试网关类型大小写不敏感

        Arrange: 使用大写的网关类型
        Act: 尝试创建网关
        Assert: 验证能成功创建
        """
        # Arrange - 使用各种大小写组合
        configs = [
            {**VALID_CTP_CONFIG, "type": "CTP"},
            {**VALID_CTP_CONFIG, "type": "Ctp"},
            {**VALID_CTP_CONFIG, "type": "cTp"},
        ]

        # Act & Assert
        for config in configs:
            gateway = GatewayFactory.create_gateway(config)
            assert gateway is not None
            assert isinstance(gateway, CtpMarketGateway)

    def test_get_supported_types(self):
        """测试获取支持的网关类型列表"""
        # Act
        supported_types = GatewayFactory.get_supported_types()

        # Assert
        assert isinstance(supported_types, list)
        assert "ctp" in supported_types

    def test_is_type_supported(self):
        """测试检查网关类型是否支持"""
        # Assert
        assert GatewayFactory.is_type_supported("ctp") is True
        assert GatewayFactory.is_type_supported("CTP") is True  # 大小写不敏感
        assert GatewayFactory.is_type_supported("nonexistent") is False

    def test_get_gateway_class(self):
        """测试获取网关类"""
        # Act
        ctp_class = GatewayFactory.get_gateway_class("ctp")
        none_class = GatewayFactory.get_gateway_class("nonexistent")

        # Assert
        assert ctp_class is CtpMarketGateway
        assert none_class is None

    def test_unregister_gateway_type(self):
        """测试取消注册网关类型"""
        # Arrange
        GatewayFactory.register_gateway_type("test", MockGateway)
        assert GatewayFactory.is_type_supported("test")

        # Act
        result = GatewayFactory.unregister_gateway_type("test")

        # Assert
        assert result is True
        assert GatewayFactory.is_type_supported("test") is False

    def test_unregister_nonexistent_type(self):
        """测试取消注册不存在的类型"""
        # Act
        result = GatewayFactory.unregister_gateway_type("nonexistent")

        # Assert
        assert result is False

    def test_register_overwrites_existing_type(self):
        """测试注册已存在的类型会覆盖"""
        # Arrange
        GatewayFactory.register_gateway_type("mock", MockGateway)

        class AnotherMockGateway(MockGateway):
            def __init__(self, config: Dict[str, Any]):
                super().__init__(config)
                self.mock_attribute = "another_value"

        # Act
        GatewayFactory.register_gateway_type("mock", AnotherMockGateway)

        # Assert
        gateway_class = GatewayFactory.get_gateway_class("mock")
        assert gateway_class is AnotherMockGateway


class TestGatewayFactoryAsync:
    """网关工厂异步功能测试"""

    @pytest.fixture(autouse=True)
    def cleanup_registered_types(self):
        """每个测试后清理注册的测试类型"""
        yield
        GatewayFactory.unregister_gateway_type("mock")

    @pytest.mark.asyncio
    async def test_created_gateway_can_connect(self):
        """测试创建的网关可以正常连接"""
        # Arrange
        GatewayFactory.register_gateway_type("mock", MockGateway)
        config = {
            **VALID_CTP_CONFIG,
            "type": "mock"
        }

        # Act
        gateway = GatewayFactory.create_gateway(config)
        result = await gateway.connect()

        # Assert
        assert result is True
        assert gateway.status == GatewayStatus.CONNECTED

    @pytest.mark.asyncio
    async def test_created_gateway_can_subscribe(self):
        """测试创建的网关可以正常订阅"""
        # Arrange
        GatewayFactory.register_gateway_type("mock", MockGateway)
        config = {
            **VALID_CTP_CONFIG,
            "type": "mock"
        }
        symbols = ["rb2401", "cu2401"]

        # Act
        gateway = GatewayFactory.create_gateway(config)
        await gateway.connect()
        result = await gateway.subscribe(symbols)

        # Assert
        assert all(result.values())
        assert all(s in gateway.subscribed_symbols for s in symbols)


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
