# Quant System - 量化交易系统

一个基于 Python 的量化交易系统框架，提供行情网关、数据模型、风险管理和策略开发等核心功能。

## 特性

- **行情网关**: 支持 CTP 等多种行情接口，提供统一的数据接入层
- **数据模型**: 标准化的 Tick 和 K 线数据模型，基于 Pydantic V2 进行数据验证
- **事件系统**: 异步事件驱动架构，支持多种事件类型
- **风险管理**: 内置风险控制模块，支持持仓限制、回撤控制等
- **策略框架**: 灵活的策略基类，支持快速开发交易策略

## 项目结构

```
quant_system/
├── src/
│   ├── config/           # 配置管理
│   │   └── gateway_config.py
│   ├── market_gateway/   # 行情网关
│   │   ├── base.py       # 网关基类
│   │   ├── ctp_gateway.py # CTP实现
│   │   ├── events.py     # 事件定义
│   │   ├── exceptions.py # 异常定义
│   │   └── factory.py    # 网关工厂
│   ├── models/           # 数据模型
│   │   ├── tick_data.py  # Tick数据
│   │   └── kline_data.py # K线数据
│   ├── risk/             # 风险管理
│   │   └── __init__.py
│   └── strategy/         # 策略模块
│       └── __init__.py
├── tests/                # 测试文件
├── main.py               # 入口文件
├── pyproject.toml        # 项目配置
├── requirements.txt      # 依赖列表
└── README.md
```

## 安装

### 基础安装

```bash
# 克隆项目
git clone <repository_url>
cd quant_system

# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
# Windows:
.venv\Scripts\activate
# Linux/macOS:
source .venv/bin/activate

# 安装依赖
pip install -e .
```

### 开发环境安装

```bash
pip install -e ".[dev]"
```

### 完整安装（包含生产依赖）

```bash
pip install -e ".[all]"
```

## 快速开始

### 运行测试模式

```bash
python main.py --test
```

### 运行演示

```bash
python main.py --demo
```

### 运行单元测试

```bash
pytest tests/ -v
```

### 运行测试并生成覆盖率报告

```bash
pytest tests/ --cov=src --cov-report=html
```

## 使用示例

### 创建行情网关

```python
from src import GatewayFactory

config = {
    "name": "MyGateway",
    "type": "ctp",
    "ctp": {
        "front_addr": "tcp://180.168.146.187:10131",
        "broker_id": "9999",
        "user_id": "your_user_id",
        "password": "your_password"
    }
}

gateway = GatewayFactory.create_gateway(config)
await gateway.connect()
await gateway.subscribe(["rb2401", "cu2401"])
```

### 使用风险管理器

```python
from src import RiskManager
from decimal import Decimal

risk_manager = RiskManager(
    max_position_value=Decimal("500000"),
    max_drawdown_pct=Decimal("0.05")
)

# 检查订单风险
allowed, reason = risk_manager.check_order_risk(
    symbol="rb2401",
    direction="buy",
    price=Decimal("3500"),
    volume=10
)
```

### 开发交易策略

```python
from src import BaseStrategy, Signal, SignalType, StrategyParams
from decimal import Decimal

class MyStrategy(BaseStrategy):
    def on_tick(self, tick_data):
        # 处理Tick数据
        pass

    def on_bar(self, bar_data):
        # 基于K线生成信号
        close_price = Decimal(str(bar_data.get("close", 0)))

        if some_condition:
            return Signal(
                signal_type=SignalType.BUY,
                symbol=bar_data["symbol"],
                price=close_price,
                volume=1
            )
        return None

# 使用策略
params = StrategyParams(name="MyStrategy", symbols=["rb2401"])
strategy = MyStrategy(params)
strategy.start()
```

## 测试

项目使用 pytest 进行测试，当前测试覆盖：

- 数据模型测试（TickData, KLineData）
- 行情网关测试（CTP Gateway）
- 事件系统测试
- 异常处理测试
- 工厂模式测试

运行测试：

```bash
# 运行所有测试
pytest

# 运行带详细输出
pytest -v

# 运行特定测试文件
pytest tests/models/test_tick_data.py

# 运行性能基准测试
pytest -v -m benchmark
```

## 配置

### 网关配置示例

```yaml
name: CTPGateway
type: ctp
enabled: true
ctp:
  front_addr: tcp://180.168.146.187:10131
  broker_id: "9999"
  user_id: your_user_id
  password: your_password
  connect_timeout: 10
  heartbeat_interval: 30
max_subscriptions: 1000
max_reconnect_attempts: 0  # 0表示无限重连
```

## 开发

### 代码风格

项目使用以下工具保证代码质量：

- **black**: 代码格式化
- **isort**: 导入排序
- **ruff**: 代码检查
- **mypy**: 类型检查

运行代码检查：

```bash
# 格式化代码
black src/ tests/

# 排序导入
isort src/ tests/

# 代码检查
ruff check src/ tests/

# 类型检查
mypy src/
```

### 提交规范

建议使用语义化的提交信息：

- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `test`: 测试相关
- `refactor`: 代码重构
- `chore`: 其他改动

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request。

## 更新日志

### v0.1.0

- 初始版本
- 实现 CTP 行情网关
- 实现 Tick 和 K 线数据模型
- 实现事件系统
- 实现风险管理模块
- 实现策略框架
