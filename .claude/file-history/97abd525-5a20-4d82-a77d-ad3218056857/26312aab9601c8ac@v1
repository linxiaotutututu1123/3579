"""
risk_control/models.py
风控数据模型定义。

模型：
- Position: 持仓信息
- Order: 订单信息
- Account: 账户信息
- RiskEvent: 风控事件

# RISK: 持仓数据不一致可能导致风控失效
# 缓解措施: 定期与交易所同步校验

Author: AI Quant Team
Version: 1.0.0
"""

from __future__ import annotations

from dataclasses import dataclass, field
from datetime import datetime, timezone
from decimal import Decimal
from enum import Enum
from typing import Final

__all__: list[str] = [
    "Direction",
    "OrderStatus",
    "OrderType",
    "RiskLevel",
    "Position",
    "Order",
    "Account",
    "RiskEvent",
]


class Direction(str, Enum):
    """交易方向。"""
    LONG = "long"    # 多头/买入
    SHORT = "short"  # 空头/卖出


class OrderStatus(str, Enum):
    """订单状态。"""
    PENDING = "pending"        # 待发送
    SUBMITTED = "submitted"    # 已提交
    PARTIAL = "partial"        # 部分成交
    FILLED = "filled"          # 全部成交
    CANCELLED = "cancelled"    # 已撤销
    REJECTED = "rejected"      # 已拒绝


class OrderType(str, Enum):
    """订单类型。"""
    LIMIT = "limit"    # 限价单
    MARKET = "market"  # 市价单
    STOP = "stop"      # 止损单
    FAK = "fak"        # Fill and Kill
    FOK = "fok"        # Fill or Kill


class RiskLevel(str, Enum):
    """风险等级。"""
    INFO = "info"          # 信息
    WARNING = "warning"    # 警告
    CRITICAL = "critical"  # 严重
    EMERGENCY = "emergency"  # 紧急（触发强平）


# WHY: 常量定义，便于调整
DEFAULT_MULTIPLIER: Final[int] = 10  # 默认合约乘数


@dataclass
class Position:
    """
    持仓信息。

    # WHY: 使用 dataclass 而非 Pydantic，性能更好
    # 风控系统需要高频访问持仓数据

    Attributes:
        symbol: 合约代码
        direction: 持仓方向
        volume: 持仓数量（手）
        avg_price: 持仓均价
        margin: 占用保证金
        unrealized_pnl: 浮动盈亏
        realized_pnl: 已实现盈亏
    """

    symbol: str
    direction: Direction
    volume: int = 0
    avg_price: Decimal = Decimal("0")
    margin: Decimal = Decimal("0")
    unrealized_pnl: Decimal = Decimal("0")
    realized_pnl: Decimal = Decimal("0")
    # WHY: 记录开仓时间，用于持仓时长限制
    open_time: datetime = field(default_factory=lambda: datetime.now(timezone.utc))
    # WHY: 合约乘数，用于计算盈亏
    multiplier: int = DEFAULT_MULTIPLIER

    @property
    def market_value(self) -> Decimal:
        """持仓市值。"""
        return self.avg_price * self.volume * self.multiplier

    @property
    def total_pnl(self) -> Decimal:
        """总盈亏。"""
        return self.unrealized_pnl + self.realized_pnl

    def update_pnl(self, current_price: Decimal) -> None:
        """
        更新浮动盈亏。

        Args:
            current_price: 当前价格
        """
        # WHY: 多头盈亏 = (现价 - 成本) * 数量 * 乘数
        # WHY: 空头盈亏 = (成本 - 现价) * 数量 * 乘数
        price_diff = current_price - self.avg_price
        if self.direction == Direction.SHORT:
            price_diff = -price_diff
        self.unrealized_pnl = price_diff * self.volume * self.multiplier

    def __repr__(self) -> str:
        return (
            f"Position({self.symbol}, {self.direction.value}, "
            f"vol={self.volume}, pnl={self.total_pnl})"
        )


@dataclass
class Order:
    """
    订单信息。

    Attributes:
        order_id: 订单ID（本地生成）
        symbol: 合约代码
        direction: 交易方向
        order_type: 订单类型
        price: 委托价格
        volume: 委托数量
        filled_volume: 成交数量
        status: 订单状态
    """

    order_id: str
    symbol: str
    direction: Direction
    order_type: OrderType
    price: Decimal
    volume: int
    filled_volume: int = 0
    status: OrderStatus = OrderStatus.PENDING
    # WHY: 时间戳用于超时检测
    create_time: datetime = field(default_factory=lambda: datetime.now(timezone.utc))
    update_time: datetime = field(default_factory=lambda: datetime.now(timezone.utc))
    # WHY: 错误信息记录
    error_msg: str = ""
    # WHY: 交易所订单号
    exchange_order_id: str = ""

    @property
    def is_active(self) -> bool:
        """是否为活动订单（可撤销）。"""
        return self.status in (
            OrderStatus.PENDING,
            OrderStatus.SUBMITTED,
            OrderStatus.PARTIAL,
        )

    @property
    def unfilled_volume(self) -> int:
        """未成交数量。"""
        return self.volume - self.filled_volume

    def __repr__(self) -> str:
        return (
            f"Order({self.order_id}, {self.symbol}, "
            f"{self.direction.value}, {self.status.value})"
        )


@dataclass
class Account:
    """
    账户信息。

    # WHY: 实时监控账户状态，触发资金风控

    Attributes:
        balance: 账户余额
        available: 可用资金
        margin: 占用保证金
        frozen: 冻结资金
        unrealized_pnl: 浮动盈亏
        realized_pnl: 已实现盈亏
    """

    balance: Decimal = Decimal("0")
    available: Decimal = Decimal("0")
    margin: Decimal = Decimal("0")
    frozen: Decimal = Decimal("0")
    unrealized_pnl: Decimal = Decimal("0")
    realized_pnl: Decimal = Decimal("0")
    # WHY: 记录更新时间，用于检测数据过期
    update_time: datetime = field(default_factory=lambda: datetime.now(timezone.utc))

    @property
    def equity(self) -> Decimal:
        """动态权益 = 余额 + 浮动盈亏。"""
        return self.balance + self.unrealized_pnl

    @property
    def margin_ratio(self) -> Decimal:
        """保证金占用比例。"""
        if self.equity == 0:
            return Decimal("0")
        return self.margin / self.equity

    @property
    def risk_degree(self) -> Decimal:
        """
        风险度 = 保证金 / 动态权益 * 100%。

        # WHY: 期货公司通常在风险度 > 100% 时强平
        """
        if self.equity <= 0:
            return Decimal("999")  # 极高风险
        return (self.margin / self.equity) * 100

    def __repr__(self) -> str:
        return (
            f"Account(equity={self.equity}, "
            f"available={self.available}, risk={self.risk_degree:.1f}%)"
        )


@dataclass
class RiskEvent:
    """
    风控事件。

    # WHY: 记录所有风控触发事件，用于审计和分析

    Attributes:
        event_type: 事件类型
        level: 风险等级
        message: 事件描述
        symbol: 相关合约（可选）
        action_taken: 采取的动作
    """

    event_type: str
    level: RiskLevel
    message: str
    symbol: str = ""
    action_taken: str = ""
    timestamp: datetime = field(default_factory=lambda: datetime.now(timezone.utc))
    # WHY: 关联数据，用于追溯
    context: dict = field(default_factory=dict)

    def __repr__(self) -> str:
        return f"RiskEvent({self.event_type}, {self.level.value}, {self.message})"
