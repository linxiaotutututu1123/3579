"""
risk_control/limits.py
风控限制配置模型。

核心限制：
- StopLossConfig: 止损配置 (#15)
- PositionLimitConfig: 持仓限制配置 (#16)
- AccountLimitConfig: 资金监控配置 (#17)

# RISK: 配置过于宽松可能导致风控失效
# 缓解措施: 设置合理的默认值，必填校验

Author: AI Quant Team
Version: 1.0.0
"""

from __future__ import annotations

from decimal import Decimal
from typing import Final

from pydantic import BaseModel, Field, field_validator

__all__: list[str] = [
    "StopLossConfig",
    "PositionLimitConfig",
    "AccountLimitConfig",
    "RiskControlConfig",
    "SymbolRiskConfig",
]

# =============================================================================
# 默认值常量
# =============================================================================

# WHY: 用户要求年回撤 ≤ 8%，单日止损设为 2% 较为合理
DEFAULT_MAX_DAILY_LOSS_PCT: Final[Decimal] = Decimal("2.0")
# WHY: 单笔止损 0.5%，控制单笔交易风险
DEFAULT_MAX_SINGLE_LOSS_PCT: Final[Decimal] = Decimal("0.5")
# WHY: 总回撤 8%，达到后停止交易
DEFAULT_MAX_TOTAL_DRAWDOWN_PCT: Final[Decimal] = Decimal("8.0")

# WHY: 单合约最大持仓，防止集中风险
DEFAULT_MAX_POSITION_PER_SYMBOL: Final[int] = 100
# WHY: 总持仓限制
DEFAULT_MAX_TOTAL_POSITION: Final[int] = 500
# WHY: 单方向持仓限制（多/空）
DEFAULT_MAX_DIRECTION_POSITION: Final[int] = 300

# WHY: 保证金占用警戒线
DEFAULT_MARGIN_WARNING_PCT: Final[Decimal] = Decimal("70.0")
# WHY: 保证金占用强平线
DEFAULT_MARGIN_FORCE_CLOSE_PCT: Final[Decimal] = Decimal("90.0")
# WHY: 最低可用资金
DEFAULT_MIN_AVAILABLE: Final[Decimal] = Decimal("50000")


class StopLossConfig(BaseModel):
    """
    止损配置 (#15 无止损保护)。

    三级止损机制：
    1. 单笔止损：单笔交易亏损达到阈值，平仓该笔
    2. 日内止损：日内累计亏损达到阈值，当日停止交易
    3. 总回撤止损：总回撤达到阈值，停止所有交易并告警

    Attributes:
        max_single_loss_pct: 单笔最大亏损（占账户百分比）
        max_daily_loss_pct: 单日最大亏损（占账户百分比）
        max_total_drawdown_pct: 最大总回撤（占账户百分比）
        enable_trailing_stop: 是否启用移动止损
        trailing_stop_pct: 移动止损比例
    """

    max_single_loss_pct: Decimal = Field(
        default=DEFAULT_MAX_SINGLE_LOSS_PCT,
        ge=Decimal("0.1"),
        le=Decimal("5.0"),
        description="单笔最大亏损百分比",
    )
    max_daily_loss_pct: Decimal = Field(
        default=DEFAULT_MAX_DAILY_LOSS_PCT,
        ge=Decimal("0.5"),
        le=Decimal("10.0"),
        description="单日最大亏损百分比",
    )
    # WHY: 用户要求 ≤ 8% 年回撤
    max_total_drawdown_pct: Decimal = Field(
        default=DEFAULT_MAX_TOTAL_DRAWDOWN_PCT,
        ge=Decimal("1.0"),
        le=Decimal("20.0"),
        description="最大总回撤百分比",
    )
    # WHY: 移动止损可以保护浮盈
    enable_trailing_stop: bool = Field(
        default=True,
        description="是否启用移动止损",
    )
    trailing_stop_pct: Decimal = Field(
        default=Decimal("1.0"),
        ge=Decimal("0.1"),
        le=Decimal("5.0"),
        description="移动止损触发比例",
    )
    # WHY: 止损后冷却时间，防止情绪化交易
    cooldown_minutes: int = Field(
        default=30,
        ge=0,
        le=1440,
        description="止损后冷却时间（分钟）",
    )

    def __repr__(self) -> str:
        return (
            f"StopLossConfig(single={self.max_single_loss_pct}%, "
            f"daily={self.max_daily_loss_pct}%, "
            f"total={self.max_total_drawdown_pct}%)"
        )


class PositionLimitConfig(BaseModel):
    """
    持仓限制配置 (#16 无持仓限制)。

    限制维度：
    1. 单合约持仓限制
    2. 单方向（多/空）持仓限制
    3. 总持仓限制
    4. 单笔下单数量限制

    Attributes:
        max_position_per_symbol: 单合约最大持仓（手）
        max_total_position: 总持仓上限（手）
        max_long_position: 多头总持仓上限（手）
        max_short_position: 空头总持仓上限（手）
        max_order_volume: 单笔最大下单量（手）
    """

    max_position_per_symbol: int = Field(
        default=DEFAULT_MAX_POSITION_PER_SYMBOL,
        ge=1,
        le=10000,
        description="单合约最大持仓",
    )
    max_total_position: int = Field(
        default=DEFAULT_MAX_TOTAL_POSITION,
        ge=1,
        le=50000,
        description="总持仓上限",
    )
    max_long_position: int = Field(
        default=DEFAULT_MAX_DIRECTION_POSITION,
        ge=1,
        le=50000,
        description="多头总持仓上限",
    )
    max_short_position: int = Field(
        default=DEFAULT_MAX_DIRECTION_POSITION,
        ge=1,
        le=50000,
        description="空头总持仓上限",
    )
    # WHY: 单笔下单限制，防止乌龙指
    max_order_volume: int = Field(
        default=50,
        ge=1,
        le=1000,
        description="单笔最大下单量",
    )
    # WHY: 同合约未成交订单数量限制
    max_pending_orders_per_symbol: int = Field(
        default=5,
        ge=1,
        le=100,
        description="单合约最大挂单数",
    )

    def __repr__(self) -> str:
        return (
            f"PositionLimitConfig(per_symbol={self.max_position_per_symbol}, "
            f"total={self.max_total_position})"
        )


class AccountLimitConfig(BaseModel):
    """
    资金监控配置 (#17 无资金监控)。

    监控维度：
    1. 保证金占用比例
    2. 可用资金下限
    3. 风险度预警

    Attributes:
        margin_warning_pct: 保证金占用警戒线（%）
        margin_force_close_pct: 保证金占用强平线（%）
        min_available: 最低可用资金
        enable_auto_reduce: 是否自动减仓
    """

    margin_warning_pct: Decimal = Field(
        default=DEFAULT_MARGIN_WARNING_PCT,
        ge=Decimal("50.0"),
        le=Decimal("95.0"),
        description="保证金占用警戒线",
    )
    margin_force_close_pct: Decimal = Field(
        default=DEFAULT_MARGIN_FORCE_CLOSE_PCT,
        ge=Decimal("60.0"),
        le=Decimal("100.0"),
        description="保证金占用强平线",
    )
    min_available: Decimal = Field(
        default=DEFAULT_MIN_AVAILABLE,
        ge=Decimal("0"),
        description="最低可用资金",
    )
    # WHY: 自动减仓可以避免被期货公司强平
    enable_auto_reduce: bool = Field(
        default=True,
        description="是否在触发警戒线时自动减仓",
    )
    # WHY: 自动减仓比例
    auto_reduce_pct: Decimal = Field(
        default=Decimal("20.0"),
        ge=Decimal("10.0"),
        le=Decimal("50.0"),
        description="自动减仓比例",
    )

    @field_validator("margin_force_close_pct")
    @classmethod
    def validate_force_close(cls, v: Decimal, info) -> Decimal:
        """强平线必须高于警戒线。"""
        warning = info.data.get("margin_warning_pct", DEFAULT_MARGIN_WARNING_PCT)
        if v <= warning:
            raise ValueError(f"强平线({v})必须高于警戒线({warning})")
        return v

    def __repr__(self) -> str:
        return (
            f"AccountLimitConfig(warning={self.margin_warning_pct}%, "
            f"force_close={self.margin_force_close_pct}%)"
        )


class SymbolRiskConfig(BaseModel):
    """
    单合约风控配置（可覆盖全局配置）。

    # WHY: 不同合约风险特性不同，需要个性化配置
    # 例：股指期货波动大，需要更严格的止损

    Attributes:
        symbol: 合约代码（支持通配符）
        max_position: 最大持仓（覆盖全局）
        max_order_volume: 单笔最大下单量
        price_limit_pct: 价格偏离限制（相对现价）
    """

    symbol: str = Field(..., min_length=1, description="合约代码")
    max_position: int | None = Field(
        default=None,
        ge=1,
        description="最大持仓（覆盖全局）",
    )
    max_order_volume: int | None = Field(
        default=None,
        ge=1,
        description="单笔最大下单量",
    )
    # WHY: 价格偏离限制，防止乌龙指
    price_limit_pct: Decimal = Field(
        default=Decimal("2.0"),
        ge=Decimal("0.1"),
        le=Decimal("10.0"),
        description="价格偏离限制百分比",
    )
    # WHY: 是否禁止交易该合约
    disabled: bool = Field(
        default=False,
        description="是否禁止交易",
    )


class RiskControlConfig(BaseModel):
    """
    风控主配置。

    整合所有风控子配置。

    Example:
        >>> config = RiskControlConfig(
        ...     stop_loss=StopLossConfig(max_daily_loss_pct=Decimal("1.5")),
        ...     position_limit=PositionLimitConfig(max_total_position=300),
        ... )
    """

    stop_loss: StopLossConfig = Field(
        default_factory=StopLossConfig,
        description="止损配置",
    )
    position_limit: PositionLimitConfig = Field(
        default_factory=PositionLimitConfig,
        description="持仓限制配置",
    )
    account_limit: AccountLimitConfig = Field(
        default_factory=AccountLimitConfig,
        description="资金监控配置",
    )
    # WHY: 合约级别配置，覆盖全局
    symbol_configs: list[SymbolRiskConfig] = Field(
        default_factory=list,
        description="合约级别风控配置",
    )
    # WHY: 全局开关
    enabled: bool = Field(
        default=True,
        description="是否启用风控",
    )
    # WHY: 模拟模式下记录但不阻断
    dry_run: bool = Field(
        default=False,
        description="模拟模式（只记录不阻断）",
    )

    def get_symbol_config(self, symbol: str) -> SymbolRiskConfig | None:
        """获取合约级别配置。"""
        import fnmatch
        for cfg in self.symbol_configs:
            if fnmatch.fnmatch(symbol, cfg.symbol):
                return cfg
        return None

    def __repr__(self) -> str:
        return (
            f"RiskControlConfig(enabled={self.enabled}, "
            f"dry_run={self.dry_run})"
        )
