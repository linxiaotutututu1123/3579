"""
risk_control/trading_session.py
交易时段控制模块 (#18 无交易时段控制)。

功能：
- 交易所交易时段定义
- 合约交易时段查询
- 非交易时段订单拦截

# RISK: 交易所调整交易时间未及时更新
# 缓解措施: 配置化 + 定期检查交易所公告

Author: AI Quant Team
Version: 1.0.0
"""

from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime, time, timedelta
from enum import Enum
from typing import Final
from zoneinfo import ZoneInfo

__all__: list[str] = [
    "Exchange",
    "TradingSession",
    "TradingCalendar",
    "is_trading_time",
    "get_next_trading_time",
]

# WHY: 中国期货使用北京时间
CHINA_TZ: Final[ZoneInfo] = ZoneInfo("Asia/Shanghai")


class Exchange(str, Enum):
    """交易所枚举。"""
    CFFEX = "CFFEX"  # 中金所（股指期货、国债期货）
    SHFE = "SHFE"    # 上期所（铜、铝、锌、螺纹钢等）
    DCE = "DCE"      # 大商所（豆粕、铁矿石等）
    CZCE = "CZCE"    # 郑商所（白糖、棉花等）
    INE = "INE"      # 上期能源（原油、低硫燃料油）
    GFEX = "GFEX"    # 广期所（工业硅等）


@dataclass(frozen=True)
class TradingSession:
    """
    交易时段定义。

    Attributes:
        start: 开始时间
        end: 结束时间
        name: 时段名称
    """
    start: time
    end: time
    name: str = ""

    def contains(self, t: time) -> bool:
        """判断时间是否在此时段内。"""
        # WHY: 处理跨日时段（如夜盘 21:00-02:30）
        if self.start <= self.end:
            return self.start <= t <= self.end
        else:
            # 跨日：21:00-02:30 分解为 21:00-23:59 和 00:00-02:30
            return t >= self.start or t <= self.end


# =============================================================================
# 交易时段定义
# =============================================================================

# WHY: 中金所交易时段（股指期货、国债期货）
# 无夜盘
CFFEX_SESSIONS: Final[list[TradingSession]] = [
    TradingSession(time(9, 30), time(11, 30), "上午盘"),
    TradingSession(time(13, 0), time(15, 0), "下午盘"),
]

# WHY: 上期所/大商所/郑商所 通用时段
# 有夜盘（不同品种夜盘结束时间不同）
COMMODITY_DAY_SESSIONS: Final[list[TradingSession]] = [
    TradingSession(time(9, 0), time(10, 15), "上午第一节"),
    TradingSession(time(10, 30), time(11, 30), "上午第二节"),
    TradingSession(time(13, 30), time(15, 0), "下午盘"),
]

# WHY: 夜盘时段（按结束时间分类）
NIGHT_SESSION_2300: Final[TradingSession] = TradingSession(
    time(21, 0), time(23, 0), "夜盘(23:00)"
)
NIGHT_SESSION_0100: Final[TradingSession] = TradingSession(
    time(21, 0), time(1, 0), "夜盘(01:00)"
)
NIGHT_SESSION_0230: Final[TradingSession] = TradingSession(
    time(21, 0), time(2, 30), "夜盘(02:30)"
)

# WHY: 品种夜盘分类
# 23:00 收盘：螺纹、热卷、沥青等
# 01:00 收盘：铜、铝、锌、铅、镍、锡
# 02:30 收盘：黄金、白银、原油
NIGHT_SESSION_MAP: Final[dict[str, TradingSession]] = {
    # 上期所
    "CU": NIGHT_SESSION_0100,  # 铜
    "AL": NIGHT_SESSION_0100,  # 铝
    "ZN": NIGHT_SESSION_0100,  # 锌
    "PB": NIGHT_SESSION_0100,  # 铅
    "NI": NIGHT_SESSION_0100,  # 镍
    "SN": NIGHT_SESSION_0100,  # 锡
    "AU": NIGHT_SESSION_0230,  # 黄金
    "AG": NIGHT_SESSION_0230,  # 白银
    "RB": NIGHT_SESSION_2300,  # 螺纹钢
    "HC": NIGHT_SESSION_2300,  # 热卷
    "BU": NIGHT_SESSION_2300,  # 沥青
    "RU": NIGHT_SESSION_2300,  # 橡胶
    "FU": NIGHT_SESSION_2300,  # 燃料油
    "SP": NIGHT_SESSION_2300,  # 纸浆
    # 上期能源
    "SC": NIGHT_SESSION_0230,  # 原油
    "LU": NIGHT_SESSION_2300,  # 低硫燃料油
    "BC": NIGHT_SESSION_0100,  # 国际铜
    # 大商所
    "I": NIGHT_SESSION_2300,   # 铁矿石
    "J": NIGHT_SESSION_2300,   # 焦炭
    "JM": NIGHT_SESSION_2300,  # 焦煤
    "M": NIGHT_SESSION_2300,   # 豆粕
    "Y": NIGHT_SESSION_2300,   # 豆油
    "P": NIGHT_SESSION_2300,   # 棕榈油
    "A": NIGHT_SESSION_2300,   # 豆一
    "B": NIGHT_SESSION_2300,   # 豆二
    "C": NIGHT_SESSION_2300,   # 玉米
    "EG": NIGHT_SESSION_2300,  # 乙二醇
    "PG": NIGHT_SESSION_2300,  # LPG
    # 郑商所
    "TA": NIGHT_SESSION_2300,  # PTA
    "MA": NIGHT_SESSION_2300,  # 甲醇
    "SR": NIGHT_SESSION_2300,  # 白糖
    "CF": NIGHT_SESSION_2300,  # 棉花
    "OI": NIGHT_SESSION_2300,  # 菜油
    "RM": NIGHT_SESSION_2300,  # 菜粕
    "ZC": NIGHT_SESSION_2300,  # 动力煤
    "FG": NIGHT_SESSION_2300,  # 玻璃
    "SA": NIGHT_SESSION_2300,  # 纯碱
}


class TradingCalendar:
    """
    交易日历。

    # WHY: 封装交易时段判断逻辑，支持合约级别查询

    Example:
        >>> calendar = TradingCalendar()
        >>> calendar.is_trading_time("IF2401")
        True
        >>> calendar.is_trading_time("CU2401")
        False  # 凌晨 3 点
    """

    def __init__(self) -> None:
        """初始化交易日历。"""
        # WHY: 缓存节假日列表（需要外部更新）
        self._holidays: set[str] = set()

    def add_holiday(self, date_str: str) -> None:
        """
        添加节假日。

        Args:
            date_str: 日期字符串，格式 YYYYMMDD
        """
        self._holidays.add(date_str)

    def is_holiday(self, dt: datetime | None = None) -> bool:
        """判断是否为节假日。"""
        if dt is None:
            dt = datetime.now(CHINA_TZ)
        date_str = dt.strftime("%Y%m%d")
        # WHY: 周末 + 节假日
        if dt.weekday() >= 5:  # 周六=5, 周日=6
            return True
        return date_str in self._holidays

    def get_exchange(self, symbol: str) -> Exchange:
        """
        根据合约代码推断交易所。

        # WHY: 合约代码前缀规则
        # IF/IC/IH/IM -> CFFEX（股指）
        # T/TF/TS -> CFFEX（国债）
        # SC/LU/BC -> INE
        # SI/LC -> GFEX
        """
        prefix = "".join(c for c in symbol if c.isalpha()).upper()

        # WHY: 中金所品种
        if prefix in ("IF", "IC", "IH", "IM", "T", "TF", "TS"):
            return Exchange.CFFEX

        # WHY: 上期能源
        if prefix in ("SC", "LU", "BC", "NR"):
            return Exchange.INE

        # WHY: 广期所
        if prefix in ("SI", "LC"):
            return Exchange.GFEX

        # WHY: 郑商所品种（通常为2字母）
        czce_symbols = {
            "TA", "MA", "SR", "CF", "OI", "RM", "ZC", "FG", "SA",
            "AP", "CJ", "PK", "UR", "PF", "SF", "SM",
        }
        if prefix in czce_symbols:
            return Exchange.CZCE

        # WHY: 大商所品种
        dce_symbols = {
            "I", "J", "JM", "M", "Y", "P", "A", "B", "C", "CS",
            "EG", "PG", "LH", "V", "L", "PP", "EB", "RR",
        }
        if prefix in dce_symbols:
            return Exchange.DCE

        # WHY: 默认上期所
        return Exchange.SHFE

    def get_sessions(self, symbol: str) -> list[TradingSession]:
        """
        获取合约的交易时段。

        Args:
            symbol: 合约代码

        Returns:
            交易时段列表
        """
        exchange = self.get_exchange(symbol)
        prefix = "".join(c for c in symbol if c.isalpha()).upper()

        # WHY: 中金所无夜盘
        if exchange == Exchange.CFFEX:
            return CFFEX_SESSIONS

        # WHY: 其他交易所有夜盘
        sessions = list(COMMODITY_DAY_SESSIONS)

        # WHY: 添加夜盘时段
        night_session = NIGHT_SESSION_MAP.get(prefix)
        if night_session:
            sessions.append(night_session)

        return sessions

    def is_trading_time(
        self,
        symbol: str,
        dt: datetime | None = None,
    ) -> bool:
        """
        判断指定时间是否在交易时段内。

        Args:
            symbol: 合约代码
            dt: 检查时间，默认当前时间

        Returns:
            是否在交易时段内

        Example:
            >>> calendar = TradingCalendar()
            >>> calendar.is_trading_time("IF2401")  # 股指期货
            True  # 如果在 9:30-15:00 之间
        """
        if dt is None:
            dt = datetime.now(CHINA_TZ)
        elif dt.tzinfo is None:
            dt = dt.replace(tzinfo=CHINA_TZ)

        # WHY: 节假日不交易
        if self.is_holiday(dt):
            return False

        t = dt.time()
        sessions = self.get_sessions(symbol)

        for session in sessions:
            if session.contains(t):
                return True

        return False

    def get_next_trading_time(
        self,
        symbol: str,
        dt: datetime | None = None,
    ) -> datetime | None:
        """
        获取下一个交易时段开始时间。

        # WHY: 用于定时任务调度

        Args:
            symbol: 合约代码
            dt: 参考时间

        Returns:
            下一个交易时段开始时间，无法确定返回 None
        """
        if dt is None:
            dt = datetime.now(CHINA_TZ)

        sessions = self.get_sessions(symbol)
        if not sessions:
            return None

        # WHY: 查找下一个开始时间
        current_time = dt.time()

        for session in sessions:
            if session.start > current_time:
                # WHY: 今天还有交易时段
                return dt.replace(
                    hour=session.start.hour,
                    minute=session.start.minute,
                    second=0,
                    microsecond=0,
                )

        # WHY: 今天没有了，返回明天第一个时段
        tomorrow = dt + timedelta(days=1)
        first_session = sessions[0]
        return tomorrow.replace(
            hour=first_session.start.hour,
            minute=first_session.start.minute,
            second=0,
            microsecond=0,
        )


# =============================================================================
# 便捷函数
# =============================================================================

# WHY: 全局日历实例
_calendar: TradingCalendar | None = None


def get_calendar() -> TradingCalendar:
    """获取全局交易日历实例。"""
    global _calendar
    if _calendar is None:
        _calendar = TradingCalendar()
    return _calendar


def is_trading_time(symbol: str, dt: datetime | None = None) -> bool:
    """判断是否在交易时段（便捷函数）。"""
    return get_calendar().is_trading_time(symbol, dt)


def get_next_trading_time(
    symbol: str,
    dt: datetime | None = None,
) -> datetime | None:
    """获取下一个交易时段开始时间（便捷函数）。"""
    return get_calendar().get_next_trading_time(symbol, dt)
