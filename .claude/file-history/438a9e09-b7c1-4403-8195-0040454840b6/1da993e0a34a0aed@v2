# Phase 1: 基础设施层实现计划

## 概述

| 项目 | 值 |
|------|-----|
| **目标** | 实现 V2 SPEC 第 6、7 章 + 成本模型 |
| **新增目录** | `src/audit/`, `src/cost/`, `src/guardian/` |
| **新增文件** | 15 个 |
| **Required Scenarios** | 29 条 |
| **前置依赖** | Phase 0 (已完成) |

---

## 1. 文件清单

### 1.1 src/audit/ (7 个文件)

| 序号 | 文件 | 职责 |
|------|------|------|
| 1 | `__init__.py` | 模块导出 |
| 2 | `writer.py` | JSONL 事件写入器 |
| 3 | `decision_log.py` | DecisionEvent 定义 |
| 4 | `order_trail.py` | OrderStateEvent/ExecEvent/TradeEvent |
| 5 | `guardian_log.py` | GuardianEvent 定义 |
| 6 | `pnl_attribution.py` | PnL 归因 |
| 7 | `replay_verifier.py` | 回放哈希验证 |

### 1.2 src/cost/ (2 个文件)

| 序号 | 文件 | 职责 |
|------|------|------|
| 8 | `__init__.py` | 模块导出 |
| 9 | `estimator.py` | 手续费/滑点/冲击估计 |

### 1.3 src/guardian/ (6 个文件)

| 序号 | 文件 | 职责 |
|------|------|------|
| 10 | `__init__.py` | 模块导出 |
| 11 | `monitor.py` | 守护主循环 |
| 12 | `state_machine.py` | Guardian FSM |
| 13 | `triggers.py` | 异常检测器 |
| 14 | `actions.py` | 动作执行 |
| 15 | `recovery.py` | 冷启动恢复 |

---

## 2. Required Scenarios (29 条)

### 2.1 Guardian Scenarios (10 条)

| rule_id | component | 描述 |
|---------|-----------|------|
| `GUARD.FSM.TRANSITIONS` | guardian.state_machine | 状态机转移覆盖 |
| `GUARD.DETECT.QUOTE_STALE` | guardian.triggers | 行情 stale 检测 |
| `GUARD.DETECT.ORDER_STUCK` | guardian.triggers | 订单卡住检测 |
| `GUARD.DETECT.POSITION_DRIFT` | guardian.triggers | 持仓漂移检测 |
| `GUARD.DETECT.LEG_IMBALANCE` | guardian.triggers | 腿不平衡检测 |
| `GUARD.ACTION.SET_MODE` | guardian.actions | set_mode 动作 |
| `GUARD.ACTION.CANCEL_ALL` | guardian.actions | cancel_all 动作 |
| `GUARD.ACTION.FLATTEN_ALL` | guardian.actions | flatten_all 动作 |
| `GUARD.RECOVERY.COLD_START` | guardian.recovery | 冷启动恢复 |
| `GUARD.MODE.REDUCE_ONLY_EFFECT` | guardian.monitor | reduce_only 禁开仓 |

### 2.2 Audit Scenarios (5 条)

| rule_id | component | 描述 |
|---------|-----------|------|
| `AUDIT.EVENT.STRUCTURE` | audit.writer | 事件结构完整 |
| `AUDIT.JSONL.FORMAT` | audit.writer | JSONL 格式正确 |
| `AUDIT.CORRELATION.RUN_EXEC` | audit.writer | run_id/exec_id 关联 |
| `REPLAY.DETERMINISTIC.DECISION` | audit.replay_verifier | 决策确定性 |
| `REPLAY.DETERMINISTIC.GUARDIAN` | audit.replay_verifier | Guardian 确定性 |

### 2.3 Cost Scenarios (4 条)

| rule_id | component | 描述 |
|---------|-----------|------|
| `COST.MODEL.FEE_ESTIMATE` | cost.estimator | 手续费估计 |
| `COST.MODEL.SLIPPAGE_ESTIMATE` | cost.estimator | 滑点估计 |
| `COST.MODEL.IMPACT_ESTIMATE` | cost.estimator | 市场冲击估计 |
| `COST.GATE.EDGE_CHECK` | cost.estimator | edge gate 检查 |

### 2.4 Platform Universal Scenarios (10 条)

| rule_id | component | 描述 |
|---------|-----------|------|
| `STRAT.AUDIT.DECISION_EVENT_PRESENT` | audit.decision_log | DecisionEvent 存在 |
| `STRAT.AUDIT.DECISION_HAS_RUN_ID` | audit.decision_log | 包含 run_id |
| `STRAT.AUDIT.DECISION_HAS_EXEC_ID` | audit.decision_log | 包含 exec_id |
| `STRAT.AUDIT.DECISION_HAS_STRATEGY_ID` | audit.decision_log | 包含 strategy_id |
| `STRAT.AUDIT.DECISION_HAS_VERSION` | audit.decision_log | 包含 version |
| `STRAT.AUDIT.DECISION_HAS_FEATURE_HASH` | audit.decision_log | 包含 feature_hash |
| `STRAT.DEGRADE.REDUCE_ONLY_NO_OPEN` | guardian.monitor | REDUCE_ONLY 禁开仓 |
| `STRAT.DEGRADE.HALTED_OUTPUT_ZERO` | guardian.monitor | HALTED 输出零 |
| `STRAT.DEGRADE.MODE_TRANSITION_AUDIT` | audit.guardian_log | 模式切换审计 |
| `AUDIT.PNL.ATTRIBUTION` | audit.pnl_attribution | PnL 归因 |

---

## 3. 实现顺序

### Step 1: src/audit/ (基础事件层)

**顺序**: writer → decision_log → order_trail → guardian_log → pnl_attribution → replay_verifier

1. **writer.py** - JSONL 事件写入器
   - `AuditWriter` 类
   - 原子化写入 (append mode)
   - 必备字段: ts, event_type, run_id, exec_id
   - 测试: AUDIT.EVENT.STRUCTURE, AUDIT.JSONL.FORMAT, AUDIT.CORRELATION.RUN_EXEC

2. **decision_log.py** - DecisionEvent
   - `DecisionEvent` dataclass
   - 字段: strategy_id, strategy_version, feature_hash, target_portfolio
   - 测试: STRAT.AUDIT.DECISION_* (6 条)

3. **order_trail.py** - 订单事件
   - `OrderStateEvent`, `ExecEvent`, `TradeEvent` dataclass
   - 参考 src/execution/events.py 模式

4. **guardian_log.py** - 守护事件
   - `GuardianEvent` dataclass
   - 字段: mode_from, mode_to, trigger, details
   - 测试: STRAT.DEGRADE.MODE_TRANSITION_AUDIT

5. **pnl_attribution.py** - PnL 归因
   - `PnLAttribution` 类
   - 按策略/品种/时段归因
   - 测试: AUDIT.PNL.ATTRIBUTION

6. **replay_verifier.py** - 回放验证
   - `ReplayVerifier` 类
   - 输入哈希、输出哈希比对
   - 测试: REPLAY.DETERMINISTIC.*

### Step 2: src/cost/ (成本估计)

1. **estimator.py** - CostEstimator
   - `fee_estimate(symbol, notional, is_close_today)` - 手续费
   - `slippage_estimate(symbol, qty, depth)` - 滑点
   - `impact_estimate(symbol, qty, adv)` - 市场冲击
   - `edge_gate(signal_edge, total_cost)` - 交易门槛
   - 测试: COST.* (4 条)

### Step 3: src/guardian/ (守护层)

**顺序**: state_machine → triggers → actions → recovery → monitor

1. **state_machine.py** - Guardian FSM
   ```python
   class GuardianMode(Enum):
       INIT = 0
       RUNNING = 1
       REDUCE_ONLY = 2
       HALTED = 3
       MANUAL = 4
   ```
   - 状态转移表实现
   - 测试: GUARD.FSM.TRANSITIONS

2. **triggers.py** - 异常检测器
   - `QuoteStaleTrigger` - 行情过期检测
   - `OrderStuckTrigger` - 订单卡住检测
   - `PositionDriftTrigger` - 持仓漂移检测
   - `LegImbalanceTrigger` - 腿不平衡检测
   - 测试: GUARD.DETECT.* (4 条)

3. **actions.py** - 动作执行
   - `set_mode(mode)` - 模式切换
   - `cancel_all()` - 撤销所有订单
   - `flatten_all()` - 全部平仓
   - 测试: GUARD.ACTION.* (3 条)

4. **recovery.py** - 冷启动恢复
   - `ColdStartRecovery` 类
   - 持仓查询、订单查询、状态恢复
   - 测试: GUARD.RECOVERY.COLD_START

5. **monitor.py** - 守护主循环
   - `GuardianMonitor` 类
   - 整合 FSM + Triggers + Actions
   - REDUCE_ONLY 模式下禁止开仓逻辑
   - 测试: GUARD.MODE.REDUCE_ONLY_EFFECT, STRAT.DEGRADE.*

---

## 4. 关键接口设计

### 4.1 AuditWriter

```python
class AuditWriter:
    def __init__(self, path: Path, run_id: str) -> None: ...
    def write(self, event: AuditEvent) -> None: ...
    def close(self) -> None: ...
```

### 4.2 CostEstimator

```python
class CostEstimator:
    def __init__(self, instrument_cache: InstrumentCache) -> None: ...
    def fee_estimate(self, symbol: str, notional: float, is_close_today: bool = False) -> float: ...
    def slippage_estimate(self, symbol: str, qty: int, depth: int) -> float: ...
    def impact_estimate(self, symbol: str, qty: int, adv: float) -> float: ...
    def total_cost(self, symbol: str, qty: int, notional: float, depth: int, adv: float) -> float: ...
    def edge_gate(self, signal_edge: float, total_cost: float) -> bool: ...
```

### 4.3 GuardianMonitor

```python
class GuardianMonitor:
    def __init__(self, fsm: GuardianFSM, triggers: list[Trigger], actions: GuardianActions) -> None: ...
    @property
    def mode(self) -> GuardianMode: ...
    def check(self, state: MarketState) -> list[GuardianEvent]: ...
    def can_open_position(self) -> bool: ...
```

---

## 5. 测试文件

| 测试文件 | 覆盖模块 |
|----------|----------|
| `tests/test_audit_writer.py` | audit.writer |
| `tests/test_audit_decision_log.py` | audit.decision_log |
| `tests/test_audit_guardian_log.py` | audit.guardian_log |
| `tests/test_audit_pnl_attribution.py` | audit.pnl_attribution |
| `tests/test_audit_replay_verifier.py` | audit.replay_verifier |
| `tests/test_cost_estimator.py` | cost.estimator |
| `tests/test_guardian_state_machine.py` | guardian.state_machine |
| `tests/test_guardian_triggers.py` | guardian.triggers |
| `tests/test_guardian_actions.py` | guardian.actions |
| `tests/test_guardian_recovery.py` | guardian.recovery |
| `tests/test_guardian_monitor.py` | guardian.monitor |

---

## 6. 门禁检查点

```powershell
# Phase 1 完成标准
.\scripts\make.ps1 ci-json                                     # PASS
python .\scripts\coverage_gate.py                              # core=100%, overall>=85%
python .\scripts\validate_policy.py --all --strict-scenarios   # 40 条 scenarios PASS (11+29)
python -c "from src.audit import AuditWriter"                  # 导入成功
python -c "from src.cost import CostEstimator"                 # 导入成功
python -c "from src.guardian import GuardianMonitor"           # 导入成功
```

---

## 7. 依赖关系

```
src/market/ (Phase 0, 已完成)
    │
    ▼
src/audit/ ◄──────┐
    │             │
    ▼             │
src/cost/ ────────┤
    │             │
    ▼             │
src/guardian/ ────┘
```

- `cost.estimator` 依赖 `market.InstrumentCache` (获取合约信息)
- `guardian.triggers` 依赖 `market.QuoteCache` (检测行情 stale)
- `guardian.monitor` 使用 `audit.AuditWriter` (写入 GuardianEvent)

---

## 8. 实施时间表

| Step | 模块 | 文件数 | 场景数 |
|------|------|--------|--------|
| 1 | src/audit/ | 7 | 15 |
| 2 | src/cost/ | 2 | 4 |
| 3 | src/guardian/ | 6 | 10 |
| **总计** | - | **15** | **29** |

---

## 9. 军规遵守检查

- [ ] M2: 每个场景有对应测试
- [ ] M3: 最小实现，无空壳
- [ ] M5: rule_id/component/evidence 追溯
- [ ] M7: 禁止空壳代码
- [ ] M8: 审计完整
