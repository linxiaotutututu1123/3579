#!/bin/bash
# ==================== TREA项目自动化设置脚本 ====================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 打印带颜色的消息
print_message() {
    echo -e "${GREEN}[TREA]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 检查命令是否存在
check_command() {
    if ! command -v $1 &> /dev/null; then
        print_error "$1 未安装"
        return 1
    fi
    return 0
}

# 设置项目
setup_project() {
    PROJECT_NAME=$1
    PROJECT_TYPE=${2:-python}

    print_message "设置项目: $PROJECT_NAME (类型: $PROJECT_TYPE)"

    # 创建项目目录
    mkdir -p "$PROJECT_NAME"
    cd "$PROJECT_NAME"

    # 创建基本目录结构
    mkdir -p src tests docs config scripts

    # 创建.gitignore
    cat > .gitignore << EOF
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/

# Virtual Environment
venv/
env/
ENV/

# IDE
.vscode/settings.json
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log

# Environment variables
.env
.env.local
.env.*.local
EOF

    # 创建README.md
    cat > README.md << EOF
# $PROJECT_NAME

## 项目描述

这是一个使用TREA创建的$PROJECT_TYPE项目。

## 快速开始

1. 安装依赖
2. 运行项目
3. 开始开发

## 功能特性

- 功能1
- 功能2
- 功能3

## 作者

创建日期: $(date +%Y-%m-%d)
EOF

    # 根据项目类型创建特定文件
    if [ "$PROJECT_TYPE" = "python" ]; then
        # 创建requirements.txt
        cat > requirements.txt << EOF
requests>=2.26.0
numpy>=1.21.0
pandas>=1.3.0
matplotlib>=3.4.0
pytest>=6.2.0
black>=21.6.0
flake8>=3.9.0
EOF

        # 创建main.py
        cat > src/main.py << EOF
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
主程序入口
"""

def main():
    print(f"Hello from {__file__}!")

if __name__ == "__main__":
    main()
EOF

        # 创建虚拟环境
        print_message "创建Python虚拟环境..."
        python3 -m venv venv

        # 激活虚拟环境
        source venv/bin/activate

        # 安装依赖
        print_message "安装Python依赖..."
        pip install -r requirements.txt

    elif [ "$PROJECT_TYPE" = "javascript" ]; then
        # 创建package.json
        cat > package.json << EOF
{
  "name": "$PROJECT_NAME",
  "version": "1.0.0",
  "description": "",
  "main": "src/index.js",
  "scripts": {
    "start": "node src/index.js",
    "dev": "nodemon src/index.js",
    "test": "jest"
  },
  "dependencies": {},
  "devDependencies": {
    "nodemon": "^2.0.12",
    "jest": "^27.0.6"
  }
}
EOF

        # 创建index.js
        cat > src/index.js << EOF
/**
 * 主程序入口
 */
console.log('Hello from TREA!');
EOF

        # 安装依赖
        print_message "安装Node.js依赖..."
        npm install
    fi

    # 初始化Git
    print_message "初始化Git仓库..."
    git init
    git add .
    git commit -m "Initial commit"

    # 在TREA中打开
    print_message "在TREA中打开项目..."
    code .

    print_message "项目设置完成！"
}

# 分析代码
analyze_code() {
    FILE_PATH=$1
    AI_ASSISTANT=${2:-claude}

    print_message "使用 $AI_ASSISTANT 分析代码: $FILE_PATH"

    if [ ! -f "$FILE_PATH" ]; then
        print_error "文件不存在: $FILE_PATH"
        exit 1
    fi

    if [ "$AI_ASSISTANT" = "claude" ]; then
        CLAUDE_PATH="$HOME/.trae-cn/extensions/anthropic.claude-code-2.0.61-win32-x64/resources/native-binary/claude.exe"
        if [ -f "$CLAUDE_PATH" ]; then
            "$CLAUDE_PATH" -p "请分析这个文件的代码质量、性能和改进建议: $FILE_PATH"
        else
            print_error "Claude未找到"
        fi
    fi
}

# 批量处理
batch_process() {
    DIRECTORY=$1
    OPERATION=${2:-format}

    print_message "批量处理目录: $DIRECTORY, 操作: $OPERATION"

    case $OPERATION in
        format)
            print_message "格式化Python文件..."
            find "$DIRECTORY" -name "*.py" -exec black {} \;
            find "$DIRECTORY" -name "*.py" -exec isort {} \;
            ;;
        lint)
            print_message "检查Python文件..."
            find "$DIRECTORY" -name "*.py" -exec pylint {} \; > lint_report.txt 2>&1
            ;;
        analyze)
            print_message "使用AI分析文件..."
            for file in "$DIRECTORY"/*.py; do
                if [ -f "$file" ]; then
                    echo "分析文件: $file"
                    analyze_code "$file" claude
                fi
            done
            ;;
    esac

    print_message "批量处理完成"
}

# 创建备份
create_backup() {
    SOURCE=$1
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_NAME="${SOURCE}_backup_$TIMESTAMP"

    print_message "创建备份: $SOURCE -> $BACKUP_NAME"

    if [ -d "$SOURCE" ]; then
        cp -r "$SOURCE" "$BACKUP_NAME"
    elif [ -f "$SOURCE" ]; then
        cp "$SOURCE" "$BACKUP_NAME"
    else
        print_error "源路径不存在: $SOURCE"
        exit 1
    fi

    print_message "备份创建完成: $BACKUP_NAME"
}

# 主菜单
main_menu() {
    while true; do
        echo "==================================="
        echo "       TREA 自动化工具"
        echo "==================================="
        echo "1. 创建新项目"
        echo "2. 分析代码文件"
        echo "3. 批量处理文件"
        echo "4. 创建项目备份"
        echo "5. 运行钻石评估系统"
        echo "6. 系统检查"
        echo "0. 退出"
        echo ""

        read -p "请选择操作 (0-6): " choice

        case $choice in
            1)
                read -p "项目名称: " name
                read -p "项目类型 (python/javascript/web/data-science) [默认: python]: " type
                setup_project "$name" "${type:-python}"
                ;;
            2)
                read -p "文件路径: " path
                analyze_code "$path"
                ;;
            3)
                read -p "目录路径: " dir
                echo "操作类型:"
                echo "1. 格式化"
                echo "2. 代码检查"
                echo "3. AI分析"
                read -p "选择 (1-3): " op
                case $op in
                    1) operation="format" ;;
                    2) operation="lint" ;;
                    3) operation="analyze" ;;
                    *) operation="format" ;;
                esac
                batch_process "$dir" "$operation"
                ;;
            4)
                read -p "要备份的路径: " path
                create_backup "$path"
                ;;
            5)
                print_message "启动钻石评估系统..."
                python "Desktop/火山方舟大模型体验中心-火山引擎_files/QL钻石光学能量化系统_终极修复版-完美运行版.py"
                ;;
            6)
                print_message "系统检查..."
                echo "TREA路径: $HOME/.trae-cn"
                echo "VS Code版本:"
                code --version
                echo "Python版本:"
                python --version
                echo "Node.js版本:"
                node --version
                echo "Git版本:"
                git --version
                ;;
            0)
                print_message "退出程序"
                exit 0
                ;;
            *)
                print_warning "无效选择"
                ;;
        esac

        echo ""
        read -p "按Enter继续..."
    done
}

# 检查系统
check_system() {
    print_message "检查系统环境..."

    check_command code || print_warning "VS Code未安装"
    check_command python || print_warning "Python未安装"
    check_command node || print_warning "Node.js未安装"
    check_command git || print_warning "Git未安装"

    # 检查TREA
    if [ -d "$HOME/.trae-cn" ]; then
        print_message "TREA已安装"
    else
        print_warning "TREA未安装"
    fi

    # 检查AI助手
    CLAUDE_PATH="$HOME/.trae-cn/extensions/anthropic.claude-code-2.0.61-win32-x64/resources/native-binary/claude.exe"
    if [ -f "$CLAUDE_PATH" ]; then
        print_message "Claude已安装"
    else
        print_warning "Claude未安装"
    fi
}

# 主函数
main() {
    # 检查系统
    check_system

    # 如果有参数，直接执行
    if [ $# -gt 0 ]; then
        case $1 in
            setup)
                setup_project "$2" "$3"
                ;;
            analyze)
                analyze_code "$2" "$3"
                ;;
            batch)
                batch_process "$2" "$3"
                ;;
            backup)
                create_backup "$2"
                ;;
            *)
                print_error "未知命令: $1"
                exit 1
                ;;
        esac
    else
        # 显示主菜单
        main_menu
    fi
}

# 运行主函数
main "$@"