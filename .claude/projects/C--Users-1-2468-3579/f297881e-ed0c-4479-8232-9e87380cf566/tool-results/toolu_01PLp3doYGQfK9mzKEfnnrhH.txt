     1→"""
     2→保证金监控模块 - MarginMonitor (军规级 v4.0).
     3→
     4→V4PRO Platform Component - Phase 7 中国期货市场特化
     5→V4 SPEC: §19 保证金制度
     6→V4 Scenarios: CHINA.MARGIN.RATIO_CHECK, CHINA.MARGIN.USAGE_MONITOR, CHINA.MARGIN.WARNING_LEVEL
     7→
     8→军规 M16: 保证金实时监控 - 保证金使用率必须实时计算
     9→
    10→功能特性:
    11→- 实时监控保证金使用率
    12→- 五级预警机制 (SAFE/NORMAL/WARNING/DANGER/CRITICAL)
    13→- 开仓前保证金检查
    14→- 追加保证金告警生成
    15→- 强平风险预警
    16→- 历史快照记录
    17→
    18→保证金使用率等级 (2025年):
    19→- SAFE: < 50% (安全)
    20→- NORMAL: 50% - 70% (正常)
    21→- WARNING: 70% - 85% (预警)
    22→- DANGER: 85% - 100% (危险)
    23→- CRITICAL: >= 100% (临界, 触发强平)
    24→
    25→示例:
    26→    >>> monitor = MarginMonitor()
    27→    >>> level = monitor.update(equity=100000.0, margin_used=60000.0)
    28→    >>> print(f"保证金使用率: {monitor.usage_ratio:.1%}, 等级: {level.value}")
    29→    保证金使用率: 60.0%, 等级: 正常
    30→
    31→    >>> can_open, msg = monitor.can_open_position(required_margin=30000.0)
    32→    >>> if not can_open:
    33→    ...     print(f"无法开仓: {msg}")
    34→"""
    35→
    36→from __future__ import annotations
    37→
    38→from collections import deque
    39→from dataclasses import dataclass
    40→from datetime import datetime
    41→from enum import Enum
    42→from typing import ClassVar
    43→
    44→
    45→class MarginLevel(Enum):
    46→    """保证金使用率等级枚举.
    47→
    48→    根据最高指示文件§19保证金制度定义的五级预警机制。
    49→    """
    50→
    51→    SAFE = "安全"  # < 50%
    52→    NORMAL = "正常"  # 50% - 70%
    53→    WARNING = "预警"  # 70% - 85%
    54→    DANGER = "危险"  # 85% - 100%
    55→    CRITICAL = "临界"  # >= 100% (触发强平)
    56→
    57→
    58→class MarginStatus(Enum):
    59→    """保证金状态枚举."""
    60→
    61→    HEALTHY = "HEALTHY"  # 健康状态, 可正常交易
    62→    RESTRICTED = "RESTRICTED"  # 受限状态, 只能减仓
    63→    FROZEN = "FROZEN"  # 冻结状态, 禁止交易
    64→    MARGIN_CALL = "MARGIN_CALL"  # 追保状态, 需追加保证金
    65→    FORCE_LIQUIDATION = "FORCE_LIQUIDATION"  # 强平状态
    66→
    67→
    68→@dataclass(frozen=True)
    69→class MarginConfig:
    70→    """保证金监控配置.
    71→
    72→    属性:
    73→        safe_threshold: 安全阈值 (默认 0.5, 即 50%)
    74→        normal_threshold: 正常阈值 (默认 0.7, 即 70%)
    75→        warning_threshold: 预警阈值 (默认 0.85, 即 85%)
    76→        danger_threshold: 危险阈值 (默认 1.0, 即 100%)
    77→        min_available_margin: 最小可用保证金 (默认 10000)
    78→        max_snapshot_history: 最大历史快照数量 (默认 1000)
    79→        margin_buffer_pct: 保证金缓冲比例 (默认 0.1, 即 10%)
    80→    """
    81→
    82→    safe_threshold: float = 0.5
    83→    normal_threshold: float = 0.7
    84→    warning_threshold: float = 0.85
    85→    danger_threshold: float = 1.0
    86→    min_available_margin: float = 10000.0
    87→    max_snapshot_history: int = 1000
    88→    margin_buffer_pct: float = 0.1
    89→
    90→
    91→@dataclass
    92→class MarginSnapshot:
    93→    """保证金快照.
    94→
    95→    属性:
    96→        timestamp: 快照时间戳
    97→        equity: 账户权益
    98→        margin_used: 已用保证金
    99→        margin_available: 可用保证金
   100→        usage_ratio: 保证金使用率
   101→        level: 保证金等级
   102→        status: 保证金状态
   103→    """
   104→
   105→    timestamp: datetime
   106→    equity: float
   107→    margin_used: float
   108→    margin_available: float
   109→    usage_ratio: float
   110→    level: MarginLevel
   111→    status: MarginStatus
   112→
   113→    def to_dict(self) -> dict[str, object]:
   114→        """转换为字典格式."""
   115→        return {
   116→            "timestamp": self.timestamp.isoformat(),
   117→            "equity": self.equity,
   118→            "margin_used": self.margin_used,
   119→            "margin_available": self.margin_available,
   120→            "usage_ratio": self.usage_ratio,
   121→            "level": self.level.value,
   122→            "status": self.status.value,
   123→        }
   124→
   125→
   126→@dataclass
   127→class MarginAlert:
   128→    """保证金告警.
   129→
   130→    属性:
   131→        timestamp: 告警时间戳
   132→        level: 告警等级
   133→        previous_level: 之前等级
   134→        message: 告警消息
   135→        usage_ratio: 当前使用率
   136→        equity: 当前权益
   137→        margin_used: 当前已用保证金
   138→        action_required: 需要采取的行动
   139→    """
   140→
   141→    timestamp: datetime
   142→    level: MarginLevel
   143→    previous_level: MarginLevel
   144→    message: str
   145→    usage_ratio: float
   146→    equity: float
   147→    margin_used: float
   148→    action_required: str
   149→
   150→    def to_dict(self) -> dict[str, object]:
   151→        """转换为字典格式."""
   152→        return {
   153→            "timestamp": self.timestamp.isoformat(),
   154→            "level": self.level.value,
   155→            "previous_level": self.previous_level.value,
   156→            "message": self.message,
   157→            "usage_ratio": self.usage_ratio,
   158→            "equity": self.equity,
   159→            "margin_used": self.margin_used,
   160→            "action_required": self.action_required,
   161→        }
   162→
   163→
   164→@dataclass
   165→class OpenPositionCheckResult:
   166→    """开仓检查结果.
   167→
   168→    属性:
   169→        can_open: 是否可以开仓
   170→        reason: 原因说明
   171→        required_margin: 所需保证金
   172→        available_margin: 可用保证金
   173→        projected_usage_ratio: 预计使用率 (开仓后)
   174→        projected_level: 预计等级 (开仓后)
   175→    """
   176→
   177→    can_open: bool
   178→    reason: str
   179→    required_margin: float
   180→    available_margin: float
   181→    projected_usage_ratio: float
   182→    projected_level: MarginLevel
   183→
   184→
   185→class MarginMonitor:
   186→    """保证金监控器 (军规 M16).
   187→
   188→    实时监控保证金使用情况, 提供五级预警机制, 支持开仓检查和告警生成。
   189→
   190→    属性:
   191→        config: 保证金配置
   192→        usage_ratio: 当前保证金使用率
   193→        level: 当前保证金等级
   194→        status: 当前保证金状态
   195→        equity: 当前账户权益
   196→        margin_used: 当前已用保证金
   197→        margin_available: 当前可用保证金
   198→
   199→    示例:
   200→        >>> monitor = MarginMonitor()
   201→        >>> level = monitor.update(equity=100000.0, margin_used=60000.0)
   202→        >>> print(level)  # MarginLevel.NORMAL
   203→    """
   204→
   205→    # 类级别常量
   206→    LEVEL_THRESHOLDS: ClassVar[list[tuple[float, MarginLevel]]] = [
   207→        (0.5, MarginLevel.SAFE),
   208→        (0.7, MarginLevel.NORMAL),
   209→        (0.85, MarginLevel.WARNING),
   210→        (1.0, MarginLevel.DANGER),
   211→    ]
   212→
   213→    LEVEL_ACTIONS: ClassVar[dict[MarginLevel, str]] = {
   214→        MarginLevel.SAFE: "正常交易",
   215→        MarginLevel.NORMAL: "正常交易, 注意仓位控制",
   216→        MarginLevel.WARNING: "建议减仓, 避免新开仓",
   217→        MarginLevel.DANGER: "立即减仓, 禁止开仓",
   218→        MarginLevel.CRITICAL: "触发强平, 紧急平仓",
   219→    }
   220→
   221→    def __init__(self, config: MarginConfig | None = None) -> None:
   222→        """初始化保证金监控器.
   223→
   224→        参数:
   225→            config: 保证金配置, 默认使用 MarginConfig()
   226→        """
   227→        self.config = config or MarginConfig()
   228→        self._equity: float = 0.0
   229→        self._margin_used: float = 0.0
   230→        self._margin_available: float = 0.0
   231→        self._usage_ratio: float = 0.0
   232→        self._level: MarginLevel = MarginLevel.SAFE
   233→        self._status: MarginStatus = MarginStatus.HEALTHY
   234→        self._previous_level: MarginLevel = MarginLevel.SAFE
   235→        self._snapshots: deque[MarginSnapshot] = deque(maxlen=self.config.max_snapshot_history)
   236→        self._alerts: deque[MarginAlert] = deque(maxlen=100)
   237→        self._last_update: datetime | None = None
   238→
   239→    @property
   240→    def usage_ratio(self) -> float:
   241→        """获取当前保证金使用率."""
   242→        return self._usage_ratio
   243→
   244→    @property
   245→    def level(self) -> MarginLevel:
   246→        """获取当前保证金等级."""
   247→        return self._level
   248→
   249→    @property
   250→    def status(self) -> MarginStatus:
   251→        """获取当前保证金状态."""
   252→        return self._status
   253→
   254→    @property
   255→    def equity(self) -> float:
   256→        """获取当前账户权益."""
   257→        return self._equity
   258→
   259→    @property
   260→    def margin_used(self) -> float:
   261→        """获取当前已用保证金."""
   262→        return self._margin_used
   263→
   264→    @property
   265→    def margin_available(self) -> float:
   266→        """获取当前可用保证金."""
   267→        return self._margin_available
   268→
   269→    @property
   270→    def previous_level(self) -> MarginLevel:
   271→        """获取之前的保证金等级."""
   272→        return self._previous_level
   273→
   274→    @property
   275→    def snapshots(self) -> list[MarginSnapshot]:
   276→        """获取历史快照列表."""
   277→        return list(self._snapshots)
   278→
   279→    @property
   280→    def alerts(self) -> list[MarginAlert]:
   281→        """获取告警列表."""
   282→        return list(self._alerts)
   283→
   284→    @property
   285→    def last_update(self) -> datetime | None:
   286→        """获取最后更新时间."""
   287→        return self._last_update
   288→
   289→    def update(
   290→        self,
   291→        equity: float,
   292→        margin_used: float,
   293→        timestamp: datetime | None = None,
   294→    ) -> MarginLevel:
   295→        """更新保证金使用率.
   296→
   297→        参数:
   298→            equity: 账户权益
   299→            margin_used: 已用保证金
   300→            timestamp: 时间戳, 默认当前时间
   301→
   302→        返回:
   303→            当前保证金等级
   304→        """
   305→        if timestamp is None:
   306→            timestamp = datetime.now()  # noqa: DTZ005
   307→
   308→        # 保存之前的等级
   309→        self._previous_level = self._level
   310→
   311→        # 更新基础数据
   312→        self._equity = max(0.0, equity)
   313→        self._margin_used = max(0.0, margin_used)
   314→        self._margin_available = max(0.0, self._equity - self._margin_used)
   315→
   316→        # 计算使用率
   317→        if self._equity > 0:
   318→            self._usage_ratio = self._margin_used / self._equity
   319→        else:
   320→            # 权益为0或负数, 视为临界状态
   321→            self._usage_ratio = 1.0 if self._margin_used > 0 else 0.0
   322→
   323→        # 计算等级
   324→        self._level = self._calculate_level()
   325→
   326→        # 计算状态
   327→        self._status = self._calculate_status()
   328→
   329→        # 记录快照
   330→        snapshot = MarginSnapshot(
   331→            timestamp=timestamp,
   332→            equity=self._equity,
   333→            margin_used=self._margin_used,
   334→            margin_available=self._margin_available,
   335→            usage_ratio=self._usage_ratio,
   336→            level=self._level,
   337→            status=self._status,
   338→        )
   339→        self._snapshots.append(snapshot)
   340→
   341→        # 检查是否需要生成告警
   342→        if self._level != self._previous_level:
   343→            self._generate_alert(timestamp)
   344→
   345→        self._last_update = timestamp
   346→        return self._level
   347→
   348→    def _calculate_level(self) -> MarginLevel:
   349→        """计算保证金等级.
   350→
   351→        根据最高指示文件§19定义的阈值计算等级。
   352→        """
   353→        if self._usage_ratio < self.config.safe_threshold:
   354→            return MarginLevel.SAFE
   355→        if self._usage_ratio < self.config.normal_threshold:
   356→            return MarginLevel.NORMAL
   357→        if self._usage_ratio < self.config.warning_threshold:
   358→            return MarginLevel.WARNING
   359→        if self._usage_ratio < self.config.danger_threshold:
   360→            return MarginLevel.DANGER
   361→        return MarginLevel.CRITICAL
   362→
   363→    def _calculate_status(self) -> MarginStatus:
   364→        """计算保证金状态."""
   365→        if self._level == MarginLevel.CRITICAL:
   366→            return MarginStatus.FORCE_LIQUIDATION
   367→        if self._level == MarginLevel.DANGER:
   368→            return MarginStatus.MARGIN_CALL
   369→        if self._level == MarginLevel.WARNING:
   370→            return MarginStatus.RESTRICTED
   371→        return MarginStatus.HEALTHY
   372→
   373→    def _generate_alert(self, timestamp: datetime) -> None:
   374→        """生成保证金告警.
   375→
   376→        参数:
   377→            timestamp: 告警时间戳
   378→        """
   379→        # 判断等级变化方向
   380→        level_order = [
   381→            MarginLevel.SAFE,
   382→            MarginLevel.NORMAL,
   383→            MarginLevel.WARNING,
   384→            MarginLevel.DANGER,
   385→            MarginLevel.CRITICAL,
   386→        ]
   387→        current_idx = level_order.index(self._level)
   388→        previous_idx = level_order.index(self._previous_level)
   389→
   390→        direction = "升级" if current_idx > previous_idx else "降级"
   391→
   392→        message = (
   393→            f"保证金等级{direction}: {self._previous_level.value} → {self._level.value}, "
   394→            f"使用率: {self._usage_ratio:.1%}"
   395→        )
   396→
   397→        alert = MarginAlert(
   398→            timestamp=timestamp,
   399→            level=self._level,
   400→            previous_level=self._previous_level,
   401→            message=message,
   402→            usage_ratio=self._usage_ratio,
   403→            equity=self._equity,
   404→            margin_used=self._margin_used,
   405→            action_required=self.LEVEL_ACTIONS[self._level],
   406→        )
   407→        self._alerts.append(alert)
   408→
   409→    def can_open_position(
   410→        self,
   411→        required_margin: float,
   412→    ) -> OpenPositionCheckResult:
   413→        """检查是否可以开仓.
   414→
   415→        参数:
   416→            required_margin: 开仓所需保证金
   417→
   418→        返回:
   419→            OpenPositionCheckResult 包含检查结果和详细信息
   420→        """
   421→        # 检查是否处于可交易状态
   422→        if self._status in (
   423→            MarginStatus.FROZEN,
   424→            MarginStatus.FORCE_LIQUIDATION,
   425→        ):
   426→            return OpenPositionCheckResult(
   427→                can_open=False,
   428→                reason=f"当前状态 {self._status.value} 禁止开仓",
   429→                required_margin=required_margin,
   430→                available_margin=self._margin_available,
   431→                projected_usage_ratio=self._usage_ratio,
   432→                projected_level=self._level,
   433→            )
   434→
   435→        # 检查是否处于受限状态
   436→        if self._status == MarginStatus.MARGIN_CALL:
   437→            return OpenPositionCheckResult(
   438→                can_open=False,
   439→                reason="当前处于追保状态, 禁止开仓, 请追加保证金",
   440→                required_margin=required_margin,
   441→                available_margin=self._margin_available,
   442→                projected_usage_ratio=self._usage_ratio,
   443→                projected_level=self._level,
   444→            )
   445→
   446→        if self._status == MarginStatus.RESTRICTED:
   447→            return OpenPositionCheckResult(
   448→                can_open=False,
   449→                reason="当前处于受限状态, 建议减仓而非开仓",
   450→                required_margin=required_margin,
   451→                available_margin=self._margin_available,
   452→                projected_usage_ratio=self._usage_ratio,
   453→                projected_level=self._level,
   454→            )
   455→
   456→        # 计算开仓后的保证金使用率
   457→        projected_margin_used = self._margin_used + required_margin
   458→        projected_usage_ratio = projected_margin_used / self._equity if self._equity > 0 else 1.0
   459→
   460→        # 计算开仓后的等级
   461→        projected_level = self._calculate_projected_level(projected_usage_ratio)
   462→
   463→        # 添加缓冲区检查 - 确保有足够的保证金缓冲
   464→        buffer_margin = required_margin * self.config.margin_buffer_pct
   465→        required_with_buffer = required_margin + buffer_margin
   466→
   467→        # 检查可用保证金是否足够
   468→        if self._margin_available < required_with_buffer:
   469→            return OpenPositionCheckResult(
   470→                can_open=False,
   471→                reason=(
   472→                    f"可用保证金不足, 需要 {required_with_buffer:.2f} "
   473→                    f"(含 {self.config.margin_buffer_pct:.0%} 缓冲), "
   474→                    f"当前可用 {self._margin_available:.2f}"
   475→                ),
   476→                required_margin=required_margin,
   477→                available_margin=self._margin_available,
   478→                projected_usage_ratio=projected_usage_ratio,
   479→                projected_level=projected_level,
   480→            )
   481→
   482→        # 检查最小可用保证金
   483→        remaining = self._margin_available - required_margin
   484→        if remaining < self.config.min_available_margin:
   485→            return OpenPositionCheckResult(
   486→                can_open=False,
   487→                reason=(
   488→                    f"开仓后可用保证金 {remaining:.2f} "
   489→                    f"低于最小要求 {self.config.min_available_margin:.2f}"
   490→                ),
   491→                required_margin=required_margin,
   492→                available_margin=self._margin_available,
   493→                projected_usage_ratio=projected_usage_ratio,
   494→                projected_level=projected_level,
   495→            )
   496→
   497→        # 检查开仓后是否会进入危险等级
   498→        if projected_level in (MarginLevel.DANGER, MarginLevel.CRITICAL):
   499→            return OpenPositionCheckResult(
   500→                can_open=False,
   501→                reason=(
   502→                    f"开仓后保证金使用率 {projected_usage_ratio:.1%} "
   503→                    f"将进入 {projected_level.value} 等级"
   504→                ),
   505→                required_margin=required_margin,
   506→                available_margin=self._margin_available,
   507→                projected_usage_ratio=projected_usage_ratio,
   508→                projected_level=projected_level,
   509→            )
   510→
   511→        # 检查开仓后是否会进入预警等级 (允许但警告)
   512→        if projected_level == MarginLevel.WARNING:
   513→            return OpenPositionCheckResult(
   514→                can_open=True,
   515→                reason=(
   516→                    f"警告: 开仓后保证金使用率 {projected_usage_ratio:.1%} "
   517→                    f"将进入 {projected_level.value} 等级, 请谨慎操作"
   518→                ),
   519→                required_margin=required_margin,
   520→                available_margin=self._margin_available,
   521→                projected_usage_ratio=projected_usage_ratio,
   522→                projected_level=projected_level,
   523→            )
   524→
   525→        # 正常情况 - 可以开仓
   526→        return OpenPositionCheckResult(
   527→            can_open=True,
   528→            reason="保证金检查通过",
   529→            required_margin=required_margin,
   530→            available_margin=self._margin_available,
   531→            projected_usage_ratio=projected_usage_ratio,
   532→            projected_level=projected_level,
   533→        )
   534→
   535→    def _calculate_projected_level(self, usage_ratio: float) -> MarginLevel:
   536→        """计算预计的保证金等级.
   537→
   538→        参数:
   539→            usage_ratio: 预计使用率
   540→
   541→        返回:
   542→            预计的保证金等级
   543→        """
   544→        if usage_ratio < self.config.safe_threshold:
   545→            return MarginLevel.SAFE
   546→        if usage_ratio < self.config.normal_threshold:
   547→            return MarginLevel.NORMAL
   548→        if usage_ratio < self.config.warning_threshold:
   549→            return MarginLevel.WARNING
   550→        if usage_ratio < self.config.danger_threshold:
   551→            return MarginLevel.DANGER
   552→        return MarginLevel.CRITICAL
   553→
   554→    def get_available_margin(self) -> float:
   555→        """获取可用保证金.
   556→
   557→        返回:
   558→            可用保证金金额
   559→        """
   560→        return self._margin_available
   561→
   562→    def get_margin_summary(self) -> dict[str, object]:
   563→        """获取保证金摘要信息.
   564→
   565→        返回:
   566→            包含保证金详细信息的字典
   567→        """
   568→        return {
   569→            "equity": self._equity,
   570→            "margin_used": self._margin_used,
   571→            "margin_available": self._margin_available,
   572→            "usage_ratio": self._usage_ratio,
   573→            "usage_ratio_pct": f"{self._usage_ratio:.1%}",
   574→            "level": self._level.value,
   575→            "status": self._status.value,
   576→            "action_required": self.LEVEL_ACTIONS[self._level],
   577→            "last_update": (self._last_update.isoformat() if self._last_update else None),
   578→            "alert_count": len(self._alerts),
   579→        }
   580→
   581→    def get_risk_indicator(self) -> float:
   582→        """获取风险指标 (0-1).
   583→
   584→        将保证金使用率映射到 0-1 的风险指标。
   585→
   586→        返回:
   587→            风险指标, 0表示最安全, 1表示最危险
   588→        """
   589→        # 将使用率映射到 0-1, 超过100%时截断为1
   590→        return min(1.0, self._usage_ratio)
   591→
   592→    def should_reduce_position(self) -> tuple[bool, str]:
   593→        """判断是否应该减仓.
   594→
   595→        返回:
   596→            (是否应该减仓, 原因说明)
   597→        """
   598→        if self._level == MarginLevel.CRITICAL:
   599→            return True, "保证金已临界, 必须立即减仓"
   600→        if self._level == MarginLevel.DANGER:
   601→            return True, "保证金危险, 强烈建议减仓"
   602→        if self._level == MarginLevel.WARNING:
   603→            return True, "保证金预警, 建议适当减仓"
   604→        return False, "保证金充足, 无需减仓"
   605→
   606→    def get_recommended_reduce_pct(self) -> float:
   607→        """获取建议减仓比例.
   608→
   609→        根据当前保证金等级计算建议减仓比例。
   610→
   611→        返回:
   612→            建议减仓比例 (0-1)
   613→        """
   614→        if self._level == MarginLevel.CRITICAL:
   615→            # 紧急情况, 减仓到安全水平
   616→            target_ratio = self.config.safe_threshold
   617→            excess = self._usage_ratio - target_ratio
   618→            return min(1.0, excess / self._usage_ratio) if self._usage_ratio > 0 else 0.5
   619→        if self._level == MarginLevel.DANGER:
   620→            # 危险等级, 减仓到正常水平
   621→            target_ratio = self.config.normal_threshold
   622→            excess = self._usage_ratio - target_ratio
   623→            return min(0.5, excess / self._usage_ratio) if self._usage_ratio > 0 else 0.3
   624→        if self._level == MarginLevel.WARNING:
   625→            # 预警等级, 减仓到安全水平
   626→            target_ratio = self.config.safe_threshold
   627→            excess = self._usage_ratio - target_ratio
   628→            return min(0.3, excess / self._usage_ratio) if self._usage_ratio > 0 else 0.2
   629→        return 0.0
   630→
   631→    def reset(self) -> None:
   632→        """重置监控器状态."""
   633→        self._equity = 0.0
   634→        self._margin_used = 0.0
   635→        self._margin_available = 0.0
   636→        self._usage_ratio = 0.0
   637→        self._level = MarginLevel.SAFE
   638→        self._status = MarginStatus.HEALTHY
   639→        self._previous_level = MarginLevel.SAFE
   640→        self._snapshots.clear()
   641→        self._alerts.clear()
   642→        self._last_update = None
   643→
   644→    def clear_alerts(self) -> int:
   645→        """清除所有告警.
   646→
   647→        返回:
   648→            清除的告警数量
   649→        """
   650→        count = len(self._alerts)
   651→        self._alerts.clear()
   652→        return count
   653→
   654→
   655→# ============================================================
   656→# 模块级便捷函数
   657→# ============================================================
   658→
   659→# 默认监控器单例
   660→_default_monitor: MarginMonitor | None = None
   661→
   662→
   663→def get_default_monitor() -> MarginMonitor:
   664→    """获取默认保证金监控器 (单例模式).
   665→
   666→    返回:
   667→        默认的 MarginMonitor 实例
   668→    """
   669→    global _default_monitor
   670→    if _default_monitor is None:
   671→        _default_monitor = MarginMonitor()
   672→    return _default_monitor
   673→
   674→
   675→def check_margin(
   676→    equity: float,
   677→    margin_used: float,
   678→) -> tuple[MarginLevel, str]:
   679→    """检查保证金使用情况 (便捷函数).
   680→
   681→    参数:
   682→        equity: 账户权益
   683→        margin_used: 已用保证金
   684→
   685→    返回:
   686→        (保证金等级, 建议行动)
   687→    """
   688→    monitor = get_default_monitor()
   689→    level = monitor.update(equity=equity, margin_used=margin_used)
   690→    action = MarginMonitor.LEVEL_ACTIONS[level]
   691→    return level, action
   692→
   693→
   694→def can_open(
   695→    required_margin: float,
   696→    equity: float | None = None,
   697→    margin_used: float | None = None,
   698→) -> tuple[bool, str]:
   699→    """检查是否可以开仓 (便捷函数).
   700→
   701→    参数:
   702→        required_margin: 开仓所需保证金
   703→        equity: 账户权益 (可选, 若提供则先更新)
   704→        margin_used: 已用保证金 (可选, 若提供则先更新)
   705→
   706→    返回:
   707→        (是否可以开仓, 原因说明)
   708→    """
   709→    monitor = get_default_monitor()
   710→
   711→    # 如果提供了权益和保证金, 先更新
   712→    if equity is not None and margin_used is not None:
   713→        monitor.update(equity=equity, margin_used=margin_used)
   714→
   715→    result = monitor.can_open_position(required_margin=required_margin)
   716→    return result.can_open, result.reason
   717→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
