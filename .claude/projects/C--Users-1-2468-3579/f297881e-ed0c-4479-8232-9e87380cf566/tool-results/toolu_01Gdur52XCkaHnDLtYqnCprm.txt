     1→"""中国期货市场手续费计算器模块 (军规级 v4.0).
     2→
     3→本模块提供中国期货市场的精确手续费计算功能，支持：
     4→- 按手收费（固定金额/手）
     5→- 按金额收费（成交金额×费率）
     6→- 混合收费模式
     7→- 平今手续费（CFFEX平今费率极高）
     8→- 平昨手续费
     9→- 交易所差异化费率
    10→
    11→军规覆盖:
    12→- M5: 成本先行 - 精确计算交易成本
    13→- M14: 平今平昨分离 - 区分平今/平昨手续费
    14→
    15→场景覆盖:
    16→- CHINA.FEE.BY_VOLUME_CALC: 按手收费计算
    17→- CHINA.FEE.BY_VALUE_CALC: 按金额收费计算
    18→- CHINA.FEE.CLOSE_TODAY_CALC: 平今手续费计算
    19→
    20→示例:
    21→    >>> from src.cost.china_fee_calculator import ChinaFeeCalculator
    22→    >>> calc = ChinaFeeCalculator()
    23→    >>> # 螺纹钢按手收费
    24→    >>> fee = calc.calculate("rb2501", 3500, 10, "open")
    25→    >>> print(fee)
    26→    FeeResult(fee=35.0, fee_type=FeeType.FIXED, ...)
    27→"""
    28→
    29→from __future__ import annotations
    30→
    31→from dataclasses import dataclass, field
    32→from enum import Enum
    33→from typing import ClassVar
    34→
    35→from src.market.exchange_config import Exchange, get_exchange_for_product
    36→
    37→
    38→class FeeType(Enum):
    39→    """手续费类型枚举.
    40→
    41→    属性:
    42→        FIXED: 按手收费（固定金额/手）
    43→        RATIO: 按金额收费（成交金额×费率）
    44→        MIXED: 混合收费（按手+按金额）
    45→    """
    46→
    47→    FIXED = "按手"
    48→    RATIO = "按金额"
    49→    MIXED = "混合"
    50→
    51→
    52→class TradeDirection(Enum):
    53→    """交易方向枚举.
    54→
    55→    属性:
    56→        OPEN: 开仓
    57→        CLOSE: 平仓（平昨）
    58→        CLOSE_TODAY: 平今
    59→    """
    60→
    61→    OPEN = "开仓"
    62→    CLOSE = "平仓"
    63→    CLOSE_TODAY = "平今"
    64→
    65→
    66→@dataclass(frozen=True)
    67→class FeeConfig:
    68→    """手续费配置.
    69→
    70→    属性:
    71→        fee_type: 手续费类型
    72→        open_ratio: 开仓费率（按金额）
    73→        close_ratio: 平仓费率（按金额）
    74→        close_today_ratio: 平今费率（按金额）
    75→        open_fixed: 开仓固定费（按手）
    76→        close_fixed: 平仓固定费（按手）
    77→        close_today_fixed: 平今固定费（按手）
    78→        multiplier: 合约乘数
    79→    """
    80→
    81→    fee_type: FeeType
    82→    open_ratio: float = 0.0
    83→    close_ratio: float = 0.0
    84→    close_today_ratio: float = 0.0
    85→    open_fixed: float = 0.0
    86→    close_fixed: float = 0.0
    87→    close_today_fixed: float = 0.0
    88→    multiplier: int = 1
    89→
    90→
    91→@dataclass
    92→class FeeResult:
    93→    """手续费计算结果.
    94→
    95→    属性:
    96→        fee: 手续费金额
    97→        fee_type: 手续费类型
    98→        direction: 交易方向
    99→        volume: 交易手数
   100→        price: 成交价格
   101→        value: 成交金额
   102→        product: 品种代码
   103→        exchange: 交易所
   104→    """
   105→
   106→    fee: float
   107→    fee_type: FeeType
   108→    direction: TradeDirection
   109→    volume: int
   110→    price: float
   111→    value: float
   112→    product: str
   113→    exchange: Exchange | None = None
   114→
   115→
   116→# ============================================================================
   117→# 中国期货市场手续费配置（2025年主要品种）
   118→# 注意：实际费率可能随时调整，需定期更新
   119→# ============================================================================
   120→
   121→# 上期所品种费率配置
   122→SHFE_FEE_CONFIGS: dict[str, FeeConfig] = {
   123→    # 有色金属 - 按金额收费
   124→    "cu": FeeConfig(FeeType.RATIO, 0.00005, 0.00005, 0.00005, multiplier=5),
   125→    "al": FeeConfig(
   126→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=5
   127→    ),
   128→    "zn": FeeConfig(
   129→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=5
   130→    ),
   131→    "pb": FeeConfig(
   132→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=5
   133→    ),
   134→    "ni": FeeConfig(
   135→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=3.0, multiplier=1
   136→    ),
   137→    "sn": FeeConfig(
   138→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=1
   139→    ),
   140→    # 贵金属 - 按金额收费
   141→    "au": FeeConfig(FeeType.RATIO, 0.00002, 0.00002, 0.00002, multiplier=1000),
   142→    "ag": FeeConfig(FeeType.RATIO, 0.00005, 0.00005, 0.00005, multiplier=15),
   143→    # 黑色系 - 按手收费
   144→    "rb": FeeConfig(FeeType.RATIO, 0.0001, 0.0001, 0.0001, multiplier=10),
   145→    "hc": FeeConfig(FeeType.RATIO, 0.0001, 0.0001, 0.0001, multiplier=10),
   146→    "ss": FeeConfig(
   147→        FeeType.FIXED, open_fixed=2.0, close_fixed=2.0, close_today_fixed=0.0, multiplier=5
   148→    ),
   149→    # 能源化工
   150→    "bu": FeeConfig(FeeType.RATIO, 0.0001, 0.0001, 0.0001, multiplier=10),
   151→    "ru": FeeConfig(
   152→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=10
   153→    ),
   154→    "sp": FeeConfig(
   155→        FeeType.FIXED, open_fixed=0.5, close_fixed=0.5, close_today_fixed=0.0, multiplier=10
   156→    ),
   157→    "fu": FeeConfig(FeeType.RATIO, 0.00005, 0.00005, 0.00005, multiplier=10),
   158→}
   159→
   160→# 大商所品种费率配置
   161→DCE_FEE_CONFIGS: dict[str, FeeConfig] = {
   162→    # 农产品
   163→    "c": FeeConfig(
   164→        FeeType.FIXED, open_fixed=1.2, close_fixed=1.2, close_today_fixed=1.2, multiplier=10
   165→    ),
   166→    "cs": FeeConfig(
   167→        FeeType.FIXED, open_fixed=1.5, close_fixed=1.5, close_today_fixed=1.5, multiplier=10
   168→    ),
   169→    "a": FeeConfig(
   170→        FeeType.FIXED, open_fixed=2.0, close_fixed=2.0, close_today_fixed=2.0, multiplier=10
   171→    ),
   172→    "b": FeeConfig(
   173→        FeeType.FIXED, open_fixed=1.0, close_fixed=1.0, close_today_fixed=1.0, multiplier=10
   174→    ),
   175→    "m": FeeConfig(
   176→        FeeType.FIXED, open_fixed=1.5, close_fixed=1.5, close_today_fixed=1.5, multiplier=10
   177→    ),
   178→    "y": FeeConfig(
   179→        FeeType.FIXED, open_fixed=2.5, close_fixed=2.5, close_today_fixed=2.5, multiplier=10
   180→    ),
   181→    "p": FeeConfig(
   182→        FeeType.FIXED, open_fixed=2.5, close_fixed=2.5, close_today_fixed=2.5, multiplier=10
   183→    ),
   184→    "jd": FeeConfig(FeeType.RATIO, 0.00015, 0.00015, 0.00015, multiplier=10),
   185→    "lh": FeeConfig(FeeType.RATIO, 0.0002, 0.0002, 0.0002, multiplier=16),
   186→    # 黑色系
   187→    "i": FeeConfig(FeeType.RATIO, 0.0001, 0.0001, 0.0001, multiplier=100),
   188→    "j": FeeConfig(FeeType.RATIO, 0.0001, 0.0001, 0.00014, multiplier=100),
   189→    "jm": FeeConfig(FeeType.RATIO, 0.0001, 0.0001, 0.00014, multiplier=60),
   190→    # 化工
   191→    "l": FeeConfig(
   192→        FeeType.FIXED, open_fixed=1.0, close_fixed=1.0, close_today_fixed=1.0, multiplier=5
   193→    ),
   194→    "v": FeeConfig(
   195→        FeeType.FIXED, open_fixed=1.0, close_fixed=1.0, close_today_fixed=1.0, multiplier=5
   196→    ),
   197→    "pp": FeeConfig(
   198→        FeeType.FIXED, open_fixed=1.0, close_fixed=1.0, close_today_fixed=1.0, multiplier=5
   199→    ),
   200→    "eg": FeeConfig(
   201→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=3.0, multiplier=10
   202→    ),
   203→    "eb": FeeConfig(
   204→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=3.0, multiplier=5
   205→    ),
   206→    "pg": FeeConfig(
   207→        FeeType.FIXED, open_fixed=6.0, close_fixed=6.0, close_today_fixed=6.0, multiplier=20
   208→    ),
   209→}
   210→
   211→# 郑商所品种费率配置
   212→CZCE_FEE_CONFIGS: dict[str, FeeConfig] = {
   213→    # 农产品
   214→    "CF": FeeConfig(
   215→        FeeType.FIXED, open_fixed=4.3, close_fixed=4.3, close_today_fixed=0.0, multiplier=5
   216→    ),
   217→    "SR": FeeConfig(
   218→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=10
   219→    ),
   220→    "OI": FeeConfig(
   221→        FeeType.FIXED, open_fixed=2.0, close_fixed=2.0, close_today_fixed=0.0, multiplier=10
   222→    ),
   223→    "RM": FeeConfig(
   224→        FeeType.FIXED, open_fixed=1.5, close_fixed=1.5, close_today_fixed=1.5, multiplier=10
   225→    ),
   226→    "AP": FeeConfig(
   227→        FeeType.FIXED, open_fixed=5.0, close_fixed=5.0, close_today_fixed=20.0, multiplier=10
   228→    ),
   229→    "CJ": FeeConfig(
   230→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=3.0, multiplier=5
   231→    ),
   232→    "PK": FeeConfig(
   233→        FeeType.FIXED, open_fixed=4.0, close_fixed=4.0, close_today_fixed=4.0, multiplier=5
   234→    ),
   235→    # 化工
   236→    "MA": FeeConfig(
   237→        FeeType.FIXED, open_fixed=2.0, close_fixed=2.0, close_today_fixed=6.0, multiplier=10
   238→    ),
   239→    "TA": FeeConfig(
   240→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=5
   241→    ),
   242→    "SA": FeeConfig(
   243→        FeeType.FIXED, open_fixed=3.5, close_fixed=3.5, close_today_fixed=3.5, multiplier=20
   244→    ),
   245→    "UR": FeeConfig(
   246→        FeeType.FIXED, open_fixed=5.0, close_fixed=5.0, close_today_fixed=5.0, multiplier=20
   247→    ),
   248→    "FG": FeeConfig(
   249→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=6.0, multiplier=20
   250→    ),
   251→    # 其他
   252→    "SM": FeeConfig(
   253→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=3.0, multiplier=5
   254→    ),
   255→    "SF": FeeConfig(
   256→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=3.0, multiplier=5
   257→    ),
   258→}
   259→
   260→# 中金所品种费率配置（平今费率极高！）
   261→CFFEX_FEE_CONFIGS: dict[str, FeeConfig] = {
   262→    # 股指期货 - 按金额收费，平今费率是开仓的15倍！
   263→    "IF": FeeConfig(FeeType.RATIO, 0.000023, 0.000023, 0.000345, multiplier=300),
   264→    "IH": FeeConfig(FeeType.RATIO, 0.000023, 0.000023, 0.000345, multiplier=300),
   265→    "IC": FeeConfig(FeeType.RATIO, 0.000023, 0.000023, 0.000345, multiplier=200),
   266→    "IM": FeeConfig(FeeType.RATIO, 0.000023, 0.000023, 0.000345, multiplier=200),
   267→    # 国债期货 - 按手收费
   268→    "T": FeeConfig(
   269→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=10000
   270→    ),
   271→    "TF": FeeConfig(
   272→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=10000
   273→    ),
   274→    "TS": FeeConfig(
   275→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=20000
   276→    ),
   277→    "TL": FeeConfig(
   278→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=10000
   279→    ),
   280→}
   281→
   282→# 广期所品种费率配置
   283→GFEX_FEE_CONFIGS: dict[str, FeeConfig] = {
   284→    "lc": FeeConfig(FeeType.RATIO, 0.00004, 0.00004, 0.00008, multiplier=1),
   285→    "si": FeeConfig(
   286→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=3.0, multiplier=5
   287→    ),
   288→}
   289→
   290→# 能源中心品种费率配置
   291→INE_FEE_CONFIGS: dict[str, FeeConfig] = {
   292→    "sc": FeeConfig(
   293→        FeeType.FIXED, open_fixed=20.0, close_fixed=20.0, close_today_fixed=0.0, multiplier=1000
   294→    ),
   295→    "lu": FeeConfig(
   296→        FeeType.FIXED, open_fixed=1.0, close_fixed=1.0, close_today_fixed=0.0, multiplier=10
   297→    ),
   298→    "bc": FeeConfig(FeeType.RATIO, 0.00005, 0.00005, 0.00005, multiplier=5),
   299→    "nr": FeeConfig(
   300→        FeeType.FIXED, open_fixed=3.0, close_fixed=3.0, close_today_fixed=0.0, multiplier=10
   301→    ),
   302→}
   303→
   304→
   305→# 合并所有费率配置
   306→ALL_FEE_CONFIGS: dict[str, FeeConfig] = {
   307→    **SHFE_FEE_CONFIGS,
   308→    **DCE_FEE_CONFIGS,
   309→    **CZCE_FEE_CONFIGS,
   310→    **CFFEX_FEE_CONFIGS,
   311→    **GFEX_FEE_CONFIGS,
   312→    **INE_FEE_CONFIGS,
   313→}
   314→
   315→
   316→@dataclass
   317→class ChinaFeeCalculator:
   318→    """中国期货市场手续费计算器.
   319→
   320→    提供精确的手续费计算功能。
   321→
   322→    属性:
   323→        configs: 费率配置字典
   324→        default_ratio: 默认按金额费率
   325→        default_fixed: 默认按手费用
   326→
   327→    示例:
   328→        >>> calc = ChinaFeeCalculator()
   329→        >>> result = calc.calculate("rb2501", 3500, 10, "open")
   330→        >>> print(f"手续费: {result.fee:.2f}")
   331→    """
   332→
   333→    configs: dict[str, FeeConfig] = field(default_factory=lambda: ALL_FEE_CONFIGS.copy())
   334→    default_ratio: float = 0.0001  # 默认万分之一
   335→    default_fixed: float = 10.0  # 默认10元/手
   336→
   337→    # 默认合约乘数
   338→    DEFAULT_MULTIPLIER: ClassVar[int] = 10
   339→
   340→    def get_config(self, product: str) -> FeeConfig | None:
   341→        """获取品种的费率配置.
   342→
   343→        参数:
   344→            product: 品种代码（如 "rb", "IF"）
   345→
   346→        返回:
   347→            费率配置，未找到返回None
   348→        """
   349→        # 先尝试原始代码
   350→        if product in self.configs:
   351→            return self.configs[product]
   352→        # 尝试小写
   353→        if product.lower() in self.configs:
   354→            return self.configs[product.lower()]
   355→        # 尝试大写
   356→        if product.upper() in self.configs:
   357→            return self.configs[product.upper()]
   358→        return None
   359→
   360→    def calculate(
   361→        self,
   362→        instrument: str,
   363→        price: float,
   364→        volume: int,
   365→        direction: str | TradeDirection,
   366→        multiplier: int | None = None,
   367→    ) -> FeeResult:
   368→        """计算手续费.
   369→
   370→        参数:
   371→            instrument: 合约代码（如 "rb2501", "IF2501"）
   372→            price: 成交价格
   373→            volume: 成交手数
   374→            direction: 交易方向（"open"/"close"/"close_today" 或 TradeDirection枚举）
   375→            multiplier: 合约乘数（可选，默认从配置获取）
   376→
   377→        返回:
   378→            手续费计算结果
   379→
   380→        示例:
   381→            >>> calc.calculate("rb2501", 3500, 10, "open")
   382→            >>> calc.calculate("IF2501", 4000, 2, TradeDirection.CLOSE_TODAY)
   383→        """
   384→        # 解析品种代码
   385→        product = self._extract_product(instrument)
   386→
   387→        # 转换方向
   388→        if isinstance(direction, str):
   389→            direction = self._parse_direction(direction)
   390→
   391→        # 获取费率配置
   392→        config = self.get_config(product)
   393→
   394→        # 获取合约乘数
   395→        if multiplier is None:
   396→            multiplier = config.multiplier if config else self.DEFAULT_MULTIPLIER
   397→
   398→        # 计算成交金额
   399→        value = price * volume * multiplier
   400→
   401→        # 计算手续费
   402→        if config is None:
   403→            # 使用默认费率
   404→            fee = self._calc_default(price, volume, multiplier, direction)
   405→            fee_type = FeeType.RATIO
   406→        elif config.fee_type == FeeType.RATIO:
   407→            fee = self._calc_by_ratio(config, value, direction)
   408→            fee_type = FeeType.RATIO
   409→        elif config.fee_type == FeeType.FIXED:
   410→            fee = self._calc_by_fixed(config, volume, direction)
   411→            fee_type = FeeType.FIXED
   412→        else:  # MIXED
   413→            fee = self._calc_by_ratio(config, value, direction) + self._calc_by_fixed(
   414→                config, volume, direction
   415→            )
   416→            fee_type = FeeType.MIXED
   417→
   418→        # 获取交易所
   419→        exchange = get_exchange_for_product(product)
   420→
   421→        return FeeResult(
   422→            fee=round(fee, 2),
   423→            fee_type=fee_type,
   424→            direction=direction,
   425→            volume=volume,
   426→            price=price,
   427→            value=value,
   428→            product=product,
   429→            exchange=exchange,
   430→        )
   431→
   432→    def _extract_product(self, instrument: str) -> str:
   433→        """从合约代码提取品种代码.
   434→
   435→        参数:
   436→            instrument: 合约代码（如 "rb2501", "IF2501"）
   437→
   438→        返回:
   439→            品种代码（如 "rb", "IF"）
   440→        """
   441→        # 移除数字后缀
   442→        result = ""
   443→        for char in instrument:
   444→            if char.isalpha():
   445→                result += char
   446→            else:
   447→                break
   448→        return result if result else instrument
   449→
   450→    def _parse_direction(self, direction: str) -> TradeDirection:
   451→        """解析交易方向字符串.
   452→
   453→        参数:
   454→            direction: 交易方向字符串
   455→
   456→        返回:
   457→            TradeDirection枚举
   458→        """
   459→        direction_lower = direction.lower()
   460→        if direction_lower in ("open", "开仓", "buy", "sell"):
   461→            return TradeDirection.OPEN
   462→        if direction_lower in ("close_today", "平今", "closetoday"):
   463→            return TradeDirection.CLOSE_TODAY
   464→        return TradeDirection.CLOSE
   465→
   466→    def _calc_default(
   467→        self,
   468→        price: float,
   469→        volume: int,
   470→        multiplier: int,
   471→        direction: TradeDirection,
   472→    ) -> float:
   473→        """使用默认费率计算手续费.
   474→
   475→        参数:
   476→            price: 成交价格
   477→            volume: 成交手数
   478→            multiplier: 合约乘数
   479→            direction: 交易方向
   480→
   481→        返回:
   482→            手续费金额
   483→        """
   484→        value = price * volume * multiplier
   485→        ratio = self.default_ratio
   486→        # 平今加收（默认3倍）
   487→        if direction == TradeDirection.CLOSE_TODAY:
   488→            ratio *= 3
   489→        return value * ratio
   490→
   491→    def _calc_by_ratio(
   492→        self,
   493→        config: FeeConfig,
   494→        value: float,
   495→        direction: TradeDirection,
   496→    ) -> float:
   497→        """按金额计算手续费.
   498→
   499→        参数:
   500→            config: 费率配置
   501→            value: 成交金额
   502→            direction: 交易方向
   503→
   504→        返回:
   505→            手续费金额
   506→        """
   507→        if direction == TradeDirection.OPEN:
   508→            return value * config.open_ratio
   509→        if direction == TradeDirection.CLOSE_TODAY:
   510→            return value * config.close_today_ratio
   511→        return value * config.close_ratio
   512→
   513→    def _calc_by_fixed(
   514→        self,
   515→        config: FeeConfig,
   516→        volume: int,
   517→        direction: TradeDirection,
   518→    ) -> float:
   519→        """按手计算手续费.
   520→
   521→        参数:
   522→            config: 费率配置
   523→            volume: 成交手数
   524→            direction: 交易方向
   525→
   526→        返回:
   527→            手续费金额
   528→        """
   529→        if direction == TradeDirection.OPEN:
   530→            return volume * config.open_fixed
   531→        if direction == TradeDirection.CLOSE_TODAY:
   532→            return volume * config.close_today_fixed
   533→        return volume * config.close_fixed
   534→
   535→    def estimate_round_trip(
   536→        self,
   537→        instrument: str,
   538→        price: float,
   539→        volume: int,
   540→        multiplier: int | None = None,
   541→        is_intraday: bool = True,
   542→    ) -> float:
   543→        """估算往返交易手续费（开仓+平仓）.
   544→
   545→        参数:
   546→            instrument: 合约代码
   547→            price: 成交价格
   548→            volume: 成交手数
   549→            multiplier: 合约乘数
   550→            is_intraday: 是否为日内交易（True=平今，False=平昨）
   551→
   552→        返回:
   553→            往返手续费总额
   554→        """
   555→        open_result = self.calculate(instrument, price, volume, "open", multiplier)
   556→        close_direction = "close_today" if is_intraday else "close"
   557→        close_result = self.calculate(instrument, price, volume, close_direction, multiplier)
   558→        return open_result.fee + close_result.fee
   559→
   560→    def get_fee_rate_info(self, product: str) -> dict[str, object]:
   561→        """获取品种的费率信息摘要.
   562→
   563→        参数:
   564→            product: 品种代码
   565→
   566→        返回:
   567→            费率信息字典
   568→        """
   569→        config = self.get_config(product)
   570→        if config is None:
   571→            return {
   572→                "product": product,
   573→                "fee_type": "默认",
   574→                "open_rate": self.default_ratio,
   575→                "close_rate": self.default_ratio,
   576→                "close_today_rate": self.default_ratio * 3,
   577→                "multiplier": self.DEFAULT_MULTIPLIER,
   578→            }
   579→
   580→        return {
   581→            "product": product,
   582→            "fee_type": config.fee_type.value,
   583→            "open_rate": config.open_ratio if config.open_ratio else config.open_fixed,
   584→            "close_rate": (config.close_ratio if config.close_ratio else config.close_fixed),
   585→            "close_today_rate": (
   586→                config.close_today_ratio if config.close_today_ratio else config.close_today_fixed
   587→            ),
   588→            "multiplier": config.multiplier,
   589→        }
   590→
   591→
   592→# ============================================================================
   593→# 便捷函数
   594→# ============================================================================
   595→_default_calculator: ChinaFeeCalculator | None = None
   596→
   597→
   598→def get_default_calculator() -> ChinaFeeCalculator:
   599→    """获取默认手续费计算器实例.
   600→
   601→    返回:
   602→        默认计算器实例
   603→    """
   604→    global _default_calculator
   605→    if _default_calculator is None:
   606→        _default_calculator = ChinaFeeCalculator()
   607→    return _default_calculator
   608→
   609→
   610→def calculate_fee(
   611→    instrument: str,
   612→    price: float,
   613→    volume: int,
   614→    direction: str = "open",
   615→    multiplier: int | None = None,
   616→) -> float:
   617→    """计算手续费（便捷函数）.
   618→
   619→    参数:
   620→        instrument: 合约代码
   621→        price: 成交价格
   622→        volume: 成交手数
   623→        direction: 交易方向
   624→        multiplier: 合约乘数
   625→
   626→    返回:
   627→        手续费金额
   628→    """
   629→    result = get_default_calculator().calculate(instrument, price, volume, direction, multiplier)
   630→    return result.fee
   631→
   632→
   633→def estimate_cost(
   634→    instrument: str,
   635→    price: float,
   636→    volume: int,
   637→    is_intraday: bool = True,
   638→) -> float:
   639→    """估算往返交易成本（便捷函数）.
   640→
   641→    参数:
   642→        instrument: 合约代码
   643→        price: 成交价格
   644→        volume: 成交手数
   645→        is_intraday: 是否为日内交易
   646→
   647→    返回:
   648→        往返手续费总额
   649→    """
   650→    return get_default_calculator().estimate_round_trip(
   651→        instrument, price, volume, is_intraday=is_intraday
   652→    )
   653→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
