     1→from __future__ import annotations
     2→
     3→from dataclasses import dataclass
     4→from enum import Enum
     5→
     6→
     7→class RiskMode(str, Enum):
     8→    INIT = "INIT"
     9→    NORMAL = "NORMAL"
    10→    COOLDOWN = "COOLDOWN"
    11→    RECOVERY = "RECOVERY"
    12→    LOCKED = "LOCKED"
    13→
    14→
    15→@dataclass
    16→class RiskConfig:
    17→    dd_limit: float = -0.03
    18→    cooldown_seconds: int = 600
    19→    max_margin_normal: float = 0.70
    20→    max_margin_recovery: float = 0.50
    21→    recovery_risk_multiplier: float = 0.30
    22→
    23→
    24→@dataclass
    25→class AccountSnapshot:
    26→    equity: float
    27→    margin_used: float
    28→
    29→    @property
    30→    def margin_ratio(self) -> float:
    31→        if self.equity <= 0:
    32→            return 1.0
    33→        return self.margin_used / self.equity
    34→
    35→
    36→@dataclass
    37→class RiskState:
    38→    e0: float | None = None
    39→    mode: RiskMode = RiskMode.INIT
    40→    kill_switch_fired_today: bool = False
    41→    cooldown_end_ts: float | None = None
    42→
    43→    # Highest-grade idempotency/anti-reentry for flatten
    44→    flatten_in_progress: bool = False
    45→    flatten_completed_today: bool = False
    46→
    47→    def dd(self, equity: float) -> float:
    48→        if self.e0 is None or self.e0 == 0:
    49→            return 0.0
    50→        return equity / self.e0 - 1.0
    51→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
