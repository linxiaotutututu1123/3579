     1→[project]
     2→name = "cn-futures-auto-trader"
     3→version = "0.1.0"
     4→requires-python = ">=3.11"
     5→
     6→# =============================================================================
     7→# Ruff - 军规级静态分析配置
     8→# =============================================================================
     9→[tool.ruff]
    10→line-length = 100
    11→target-version = "py311"
    12→
    13→[tool.ruff.lint]
    14→# 军规级规则集：严格覆盖主要错误类型
    15→select = [
    16→    "E",      # pycodestyle errors
    17→    "W",      # pycodestyle warnings
    18→    "F",      # pyflakes
    19→    "I",      # isort
    20→    "B",      # flake8-bugbear (严格)
    21→    "UP",     # pyupgrade
    22→    "SIM",    # flake8-simplify
    23→    "C4",     # flake8-comprehensions (推荐列表推导式)
    24→    "DTZ",    # flake8-datetimez (时区安全)
    25→    "T10",    # flake8-debugger (禁止 debugger)
    26→    "ICN",    # flake8-import-conventions
    27→    "PIE",    # flake8-pie (杂项改进)
    28→    "PT",     # flake8-pytest-style (测试规范)
    29→    "RSE",    # flake8-raise (异常规范)
    30→    "RET",    # flake8-return (返回值规范)
    31→    "SLF",    # flake8-self (私有成员访问)
    32→    "ARG",    # flake8-unused-arguments (未使用参数)
    33→    "PGH",    # pygrep-hooks
    34→    "PL",     # pylint 选择性规则
    35→    "TRY",    # tryceratops (异常处理规范)
    36→    "FLY",    # flynt (f-string 推荐)
    37→    "PERF",   # perflint (性能)
    38→    "RUF",    # ruff 专有规则
    39→]
    40→
    41→ignore = [
    42→    # 允许的例外（必须有理由）
    43→    "PLR0913",  # 允许函数参数超过 5 个（某些 API 需要）
    44→    "PLR0911",  # 允许多个 return 语句（复杂逻辑需要）
    45→    "PLR0912",  # 允许多个分支（复杂逻辑需要）
    46→    "TRY301",   # 允许 try 内 raise（CTP连接/认证需要）
    47→    "ARG001",   # 允许未使用参数（接口预留）
    48→    "ARG002",   # 允许未使用的方法参数（接口兼容）
    49→    "B008",     # 允许函数默认参数使用函数调用（FastAPI 依赖）
    50→    "RUF046",   # 允许 int(round(...))（明确意图）
    51→    "PLW0603",  # 允许 global 语句（状态管理需要）
    52→]
    53→
    54→# 各模块单独配置 最严格模式
    55→[tool.ruff.lint.per-file-ignores]
    56→"tests/*" = [
    57→    "PLR0124",  # 测试允许 NaN 检查 (qty == qty)
    58→    "DTZ001",   # 测试允许无时区的datetime（中国期货市场使用本地时间）
    59→    "DTZ005",   # 测试允许datetime.now()不带tz参数
    60→    "DTZ011",   # 测试允许date.today()（中国期货市场使用本地日期）
    61→]
    62→"scripts/*" = [
    63→    "T201",     # 脚本允许 print
    64→]
    65→"src/execution/mode2/*" = [
    66→    "DTZ005",   # 允许 datetime.now() 不带 tz(中国期货市场使用本地时间，业务需求)
    67→]
    68→
    69→[tool.ruff.lint.pylint]
    70→max-statements = 80  # 默认50，军规级验证函数需要更多语句
    71→
    72→[tool.ruff.lint.isort]
    73→known-first-party = ["src"]
    74→force-single-line = false
    75→lines-after-imports = 2
    76→
    77→[tool.ruff.lint.flake8-bugbear]
    78→extend-immutable-calls = ["fastapi.Depends", "fastapi.Query"]
    79→
    80→# =============================================================================
    81→# MyPy - 军规级类型检查配置
    82→# =============================================================================
    83→[tool.mypy]
    84→python_version = "3.11"
    85→pretty = true
    86→
    87→# 严格模式基础配置
    88→warn_return_any = true
    89→warn_unused_configs = true
    90→disallow_untyped_defs = true
    91→no_implicit_optional = true
    92→strict_equality = true
    93→
    94→# 军规级增强配置
    95→warn_redundant_casts = true
    96→warn_unused_ignores = true
    97→warn_unreachable = true
    98→disallow_any_generics = true
    99→disallow_untyped_calls = true
   100→disallow_incomplete_defs = true
   101→check_untyped_defs = true
   102→no_implicit_reexport = true
   103→strict_concatenate = true
   104→
   105→# 排除目录
   106→exclude = [
   107→
   108→]
   109→
   110→# 核心模块使用最严格模式
   111→[[tool.mypy.overrides]]
   112→module = [
   113→    "src.trading.*",
   114→    "src.execution.*",
   115→    "src.risk.*",
   116→    "src.market.*",
   117→]
   118→strict = true
   119→disallow_any_unimported = true
   120→
   121→# 测试模块最严格模式
   122→[[tool.mypy.overrides]]
   123→module = "tests.*"
   124→disallow_untyped_decorators = false
   125→warn_unreachable = false
   126→ignore_errors = true
   127→
   128→# 外部依赖类型桩（CTP SDK 和可选AI依赖）
   129→[[tool.mypy.overrides]]
   130→module = [
   131→    "ctp",
   132→    "ctp.*",
   133→    "thostmduserapi.*",
   134→    "thosttraderapi.*",
   135→    "shap",
   136→    "shap.*",
   137→]
   138→ignore_missing_imports = true
   139→
   140→# =============================================================================
   141→# Pytest 配置
   142→# =============================================================================
   143→[tool.pytest.ini_options]
   144→testpaths = ["tests"]
   145→addopts = [
   146→    "-q",
   147→    "--strict-markers",
   148→    "--strict-config",
   149→]
   150→markers = [
   151→    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
   152→    "integration: marks tests as integration tests",
   153→    "replay: marks tests as replay/sim tests",
   154→]
   155→
   156→# =============================================================================
   157→# Coverage 配置
   158→# =============================================================================
   159→[tool.coverage.run]
   160→source = ["src"]
   161→branch = true
   162→omit = [
   163→    "*/tests/*",
   164→    "*/__pycache__/*",
   165→    # 入口脚本（CLI glue，非核心逻辑）
   166→    "src/app/live_entry.py",
   167→    "src/app/paper_entry.py",
   168→]
   169→# 军规级：全部必须 100% 覆盖
   170→# - src/trading/**（包括 ci_gate.py, sim_gate.py）
   171→# - src/execution/**
   172→# - src/risk/**
   173→# - src/market/**
   174→# 不允许排除非核心模块！测试必须补齐
   175→
   176→[tool.coverage.report]
   177→# 核心域覆盖率阈值
   178→fail_under = 100
   179→show_missing = true
   180→skip_covered = true
   181→exclude_lines = [
   182→    "pragma: no cover",
   183→    "if TYPE_CHECKING:",
   184→    "if __name__ == .__main__.:",
   185→    "raise NotImplementedError",
   186→    "@abstractmethod",
   187→]

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
