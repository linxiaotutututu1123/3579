     1→# CI Gate 退出码约定 (军规级 v4.0)
     2→
     3→> **文档版本**: v4.0 军规级别标准
     4→> **更新日期**: 2025-12-17
     5→> **适用范围**: 3579 中国期货量化交易系统
     6→
     7→本文档定义 3579 系统 CI/CD 的标准退出码，确保本地与 CI 行为一致。
     8→**军规级要求**: 所有退出码必须严格遵守，违规将导致系统拒绝部署。
     9→
    10→---
    11→
    12→## 退出码总览
    13→
    14→```
    15→┌─────────────────────────────────────────────────────────────────────────┐
    16→│                    军规级退出码体系 (Exit Code System)                     │
    17→├─────────────────────────────────────────────────────────────────────────┤
    18→│  0     SUCCESS              全部通过                                     │
    19→│  1     GENERAL_ERROR        一般错误（未预期异常）                         │
    20→│  2     FORMAT_LINT_FAIL     格式/Lint 失败                               │
    21→│  3     TYPE_CHECK_FAIL      类型检查失败                                  │
    22→│  4     TEST_FAIL            测试失败                                     │
    23→│  5     COVERAGE_FAIL        覆盖率不足 (<85%)                            │
    24→│  6     RISK_CONFIG_FAIL     风控配置缺失                                  │
    25→│  7     BROKER_CREDS_FAIL    Broker 凭证无效                              │
    26→│  8     REPLAY_FAIL          Replay 验证失败                              │
    27→│  9     SIM_FAIL             Sim 验证失败                                 │
    28→│  10    MODEL_WEIGHTS_FAIL   模型权重缺失/无效                             │
    29→│  11    SCENARIO_MISSING     必需场景缺失                                  │
    30→│  12    POLICY_VIOLATION     军法处置（最高严重级别）                        │
    31→│  13    CAPABILITY_MISSING   平台能力缺失                                  │
    32→└─────────────────────────────────────────────────────────────────────────┘
    33→```
    34→
    35→---
    36→
    37→## 退出码详细表
    38→
    39→### 基础 CI 检查退出码 (0-5)
    40→
    41→| 退出码 | 名称 | 含义 | 触发条件 | 军规覆盖 |
    42→|:------:|------|------|---------|----------|
    43→| `0` | SUCCESS | 全部通过 | 所有检查通过 | - |
    44→| `1` | GENERAL_ERROR | 一般错误 | 未预期的异常 | M9 |
    45→| `2` | FORMAT_LINT_FAIL | 格式/Lint 失败 | `ruff format --check` 或 `ruff check` 失败 | - |
    46→| `3` | TYPE_CHECK_FAIL | 类型检查失败 | `mypy` 失败 | - |
    47→| `4` | TEST_FAIL | 测试失败 | `pytest` 有失败用例 | - |
    48→| `5` | COVERAGE_FAIL | 覆盖率不足 | 覆盖率 < 85% | - |
    49→
    50→### LIVE 模式部署检查退出码 (6-7)
    51→
    52→| 退出码 | 名称 | 含义 | 触发条件 | 军规覆盖 |
    53→|:------:|------|------|---------|----------|
    54→| `6` | RISK_CONFIG_FAIL | 风控配置缺失 | LIVE 模式缺少风控配置 | M6, M16 |
    55→| `7` | BROKER_CREDS_FAIL | Broker 凭证无效 | LIVE 模式凭证验证失败 | M8 |
    56→
    57→### Replay/Sim 验证退出码 (8-9)
    58→
    59→| 退出码 | 名称 | 含义 | 触发条件 | 军规覆盖 |
    60→|:------:|------|------|---------|----------|
    61→| `8` | REPLAY_FAIL | Replay 失败 | 回放测试有场景失败 | M7 |
    62→| `9` | SIM_FAIL | Sim 失败 | 模拟测试有场景失败 | M7 |
    63→
    64→### 高级验证退出码 (10-11)
    65→
    66→| 退出码 | 名称 | 含义 | 触发条件 | 军规覆盖 |
    67→|:------:|------|------|---------|----------|
    68→| `10` | MODEL_WEIGHTS_FAIL | 模型权重失败 | DL/RL 模型权重缺失或加载失败 | M18 |
    69→| `11` | SCENARIO_MISSING | 场景缺失 | v3pro_required_scenarios.yml 中的必需场景未执行 | M7 |
    70→
    71→### 军规级强制退出码 (12-13)
    72→
    73→| 退出码 | 名称 | 含义 | 触发条件 | 军规覆盖 |
    74→|:------:|------|------|---------|----------|
    75→| `12` | POLICY_VIOLATION | 军法处置 | Schema不符/绕开入口/CHECK_MODE未启用 | 全部 |
    76→| `13` | CAPABILITY_MISSING | 能力缺失 | 平台必需能力未实现 | M4, M5 |
    77→
    78→---
    79→
    80→## POLICY_VIOLATION (Exit 12) 详解
    81→
    82→**Exit 12 是军规级最高强制退出码**，表示严重违反系统纪律条款。
    83→
    84→### 触发条件
    85→
    86→| 违规类型 | 代码 | 描述 | 检测位置 |
    87→|---------|------|------|---------|
    88→| **Schema 版本错误** | `SCHEMA.VERSION_OUTDATED` | `schema_version < 3` | `validate_policy.py` |
    89→| **必填字段缺失** | `SCHEMA.MISSING_FIELDS` | 缺少 `type`, `overall`, `exit_code`, `check_mode` | `validate_report_schema()` |
    90→| **无效 JSON** | `SCHEMA.INVALID_JSON` | JSON 解析失败 | `validate_policy.py` |
    91→| **文件缺失** | `SCHEMA.FILE_MISSING` | 报告文件不存在 | `validate_policy.py` |
    92→| **CHECK_MODE 未启用** | `POLICY.CHECK_MODE_DISABLED` | Replay/Sim 报告中 `check_mode=false` | `sim_gate.py` |
    93→| **绕开统一入口** | `POLICY.COMMAND_BLACKLISTED` | 直接执行 `pytest`/`ruff`/`mypy` 而非通过 `make.ps1` | `check_command_whitelist()` |
    94→| **失败结构不完整** | `POLICY.FAILURE_INCOMPLETE` | 失败缺少 `rule_id`, `component`, `evidence` | `validate_failure_structure()` |
    95→| **工件路径错误** | `POLICY.ARTIFACT_PATH_INVALID` | 输出到非 D.1 约定路径 | `validate_artifact_path()` |
    96→
    97→### 违规报告结构
    98→
    99→触发 POLICY_VIOLATION 时，系统输出到 `artifacts/claude/policy_violation.json`:
   100→
   101→```json
   102→{
   103→  "timestamp": "2025-12-17T10:30:00Z",
   104→  "exit_code": 12,
   105→  "violation_count": 1,
   106→  "violations": [
   107→    {
   108→      "code": "SCHEMA.VERSION_OUTDATED",
   109→      "message": "Report schema version 2 is below minimum required version 3",
   110→      "file": "artifacts/check/report.json",
   111→      "evidence": {
   112→        "expected": "schema_version >= 3",
   113→        "actual": "schema_version: 2"
   114→      }
   115→    }
   116→  ]
   117→}
   118→```
   119→
   120→### 修复指南
   121→
   122→| 违规代码 | 修复方法 |
   123→|---------|---------|
   124→| `SCHEMA.VERSION_OUTDATED` | 更新代码使用 `CIJsonReportV3` 或 `SimReport` |
   125→| `SCHEMA.MISSING_FIELDS` | 确保报告包含所有必填字段 |
   126→| `POLICY.CHECK_MODE_DISABLED` | 使用 `make.ps1 replay-json` 而非直接调用 |
   127→| `POLICY.COMMAND_BLACKLISTED` | 只使用 `make.ps1` 入口命令 |
   128→| `POLICY.FAILURE_INCOMPLETE` | 调用 `add_failure()` 时传入 `rule_id`, `component`, `evidence` |
   129→
   130→---
   131→
   132→## CAPABILITY_MISSING (Exit 13) 详解
   133→
   134→**Exit 13** 表示平台必需能力未实现，通常在策略降级时触发。
   135→
   136→### 触发条件
   137→
   138→```
   139→platform_required.capability 中定义的能力未通过验证:
   140→- COST.* 成本模型缺失
   141→- PROT.* 执行保护层缺失
   142→- PAIR.* PairExecutor 能力缺失
   143→- AUDIT.* 审计层能力缺失
   144→```
   145→
   146→---
   147→
   148→## 门禁检查顺序
   149→
   150→按照军规级要求，门禁必须严格按以下顺序执行：
   151→
   152→```
   153→┌─────────────────────────────────────────────────────────────────────────┐
   154→│                        门禁检查顺序 (Gate Check Order)                    │
   155→├─────────────────────────────────────────────────────────────────────────┤
   156→│  Step 1: Ruff Format Check (格式检查)          → Exit 2 on failure      │
   157→│  Step 2: Ruff Lint Check   (代码风格)          → Exit 2 on failure      │
   158→│  Step 3: Mypy Type Check   (类型检查)          → Exit 3 on failure      │
   159→│  Step 4: Pytest Tests      (单元测试)          → Exit 4 on failure      │
   160→│  Step 5: Coverage Check    (覆盖率 ≥85%)       → Exit 5 on failure      │
   161→│  Step 6: Policy Validation (策略验证)          → Exit 12 on failure     │
   162→│  Step 7: Scenario Check    (场景验证)          → Exit 11 on failure     │
   163→└─────────────────────────────────────────────────────────────────────────┘
   164→```
   165→
   166→---
   167→
   168→## 使用方式
   169→
   170→### 统一入口命令 (推荐)
   171→
   172→```powershell
   173→# CI 检查（输出 JSON 到 artifacts/check/report.json）
   174→.\scripts\make.ps1 ci-json
   175→
   176→# Replay 检查（自动启用 CHECK_MODE，输出到 artifacts/replay/report.json）
   177→.\scripts\make.ps1 replay-json
   178→
   179→# Sim 检查（自动启用 CHECK_MODE，输出到 artifacts/sim/report.json）
   180→.\scripts\make.ps1 sim-json
   181→
   182→# 全量门禁检查
   183→.\scripts\make.ps1 gate-all
   184→```
   185→
   186→### 本地快速检查
   187→
   188→```powershell
   189→# Windows PowerShell 本地快速门禁检查
   190→$python = ".venv/Scripts/python.exe"
   191→
   192→# Step 1-2: 格式和Lint
   193→& $python -m ruff format --check . || exit 2
   194→& $python -m ruff check . || exit 2
   195→
   196→# Step 3: 类型检查
   197→& $python -m mypy . --ignore-missing-imports || exit 3
   198→
   199→# Step 4-5: 测试和覆盖率
   200→& $python -m pytest -q --cov=src --cov-fail-under=85 || exit 4
   201→
   202→# Step 6: 策略验证
   203→& $python scripts/validate_policy.py --all || exit 12
   204→```
   205→
   206→### Python 编程接口
   207→
   208→```python
   209→from src.trading.ci_gate import CIGate, get_exit_code, ExitCode
   210→
   211→gate = CIGate(target_mode="LIVE")
   212→report = gate.run_all_checks(
   213→    tests_passed=True,
   214→    lint_passed=True,
   215→    type_check_passed=True,
   216→    risk_limits_configured=True,
   217→    broker_credentials_valid=True,
   218→    model_weights_exist=True,
   219→)
   220→
   221→exit_code = get_exit_code(report)
   222→if exit_code != ExitCode.SUCCESS:
   223→    print(f"门禁失败: {exit_code}")
   224→    sys.exit(exit_code)
   225→```
   226→
   227→---
   228→
   229→## CHECK 模式
   230→
   231→当 `CHECK_MODE=True` 时，系统进入检查模式：
   232→
   233→- **禁止所有 broker 操作**（`place_order` 抛出 `RuntimeError`）
   234→- 用于 CI/CD 验证，不会产生真实交易
   235→- Replay/Sim 报告**必须**启用 CHECK_MODE
   236→
   237→```python
   238→from src.trading.ci_gate import enable_check_mode, assert_not_check_mode, is_check_mode
   239→
   240→# 启用 CHECK 模式
   241→enable_check_mode()
   242→assert is_check_mode()  # True
   243→
   244→# 在 broker 中使用
   245→def place_order(self, intent):
   246→    assert_not_check_mode("place_order")  # CHECK_MODE 下抛出 RuntimeError
   247→    # ... 实际下单逻辑
   248→```
   249→
   250→---
   251→
   252→## 报告格式 (Schema v3)
   253→
   254→### CI 报告 (`artifacts/check/report.json`)
   255→
   256→```json
   257→{
   258→  "schema_version": 3,
   259→  "type": "ci",
   260→  "overall": "PASS",
   261→  "exit_code": 0,
   262→  "check_mode": true,
   263→  "timestamp": "2025-12-17T10:30:00Z",
   264→  "run_id": "550e8400-e29b-41d4-a716-446655440000",
   265→  "exec_id": "abc123_20251217103000",
   266→  "artifacts": {
   267→    "report_path": "artifacts/check/report.json"
   268→  },
   269→  "steps": [
   270→    {"name": "format-check", "status": "PASS", "exit_code": 0, "duration_ms": 1234},
   271→    {"name": "lint", "status": "PASS", "exit_code": 0, "duration_ms": 2345},
   272→    {"name": "type-check", "status": "PASS", "exit_code": 0, "duration_ms": 3456},
   273→    {"name": "test", "status": "PASS", "exit_code": 0, "duration_ms": 45678}
   274→  ]
   275→}
   276→```
   277→
   278→### Replay/Sim 报告 (`artifacts/replay/report.json`)
   279→
   280→```json
   281→{
   282→  "schema_version": 3,
   283→  "type": "replay",
   284→  "overall": "PASS",
   285→  "exit_code": 0,
   286→  "check_mode": true,
   287→  "timestamp": "2025-12-17T10:30:00Z",
   288→  "run_id": "550e8400-e29b-41d4-a716-446655440000",
   289→  "exec_id": "abc123_20251217103000",
   290→  "artifacts": {
   291→    "report_path": "artifacts/replay/report.json",
   292→    "events_jsonl_path": "artifacts/replay/events.jsonl"
   293→  },
   294→  "scenarios": {
   295→    "total": 165,
   296→    "passed": 165,
   297→    "failed": 0,
   298→    "skipped": 0
   299→  },
   300→  "failures": [],
   301→  "metrics": {
   302→    "total_ticks": 10000,
   303→    "avg_tick_duration_ms": 1.5,
   304→    "pnl_total": 5000.0
   305→  }
   306→}
   307→```
   308→
   309→---
   310→
   311→## 与其他工具集成
   312→
   313→### GitHub Actions
   314→
   315→```yaml
   316→- name: Gate Check
   317→  run: |
   318→    python -m ruff format --check . || exit 2
   319→    python -m ruff check . || exit 2
   320→    python -m mypy . || exit 3
   321→    python -m pytest -q --cov=src --cov-fail-under=85 || exit 4
   322→    python scripts/validate_policy.py --all || exit 12
   323→```
   324→
   325→### Pre-commit Hook
   326→
   327→```bash
   328→#!/bin/bash
   329→# .git/hooks/pre-commit
   330→python -m ruff format --check . || exit 2
   331→python -m ruff check . || exit 2
   332→python -m mypy . || exit 3
   333→```
   334→
   335→### VS Code Task
   336→
   337→```json
   338→{
   339→  "label": "军规级门禁检查",
   340→  "type": "shell",
   341→  "command": ".venv/Scripts/python.exe",
   342→  "args": ["scripts/validate_policy.py", "--all"],
   343→  "problemMatcher": []
   344→}
   345→```
   346→
   347→---
   348→
   349→## 军规关联
   350→
   351→| 退出码 | 关联军规 | 说明 |
   352→|--------|----------|------|
   353→| Exit 4 | M7 回放一致 | 测试确保决策可重现 |
   354→| Exit 5 | M3 完整审计 | 覆盖率确保审计完整 |
   355→| Exit 6 | M6, M16 | 风控配置确保熔断保护 |
   356→| Exit 8 | M7 回放一致 | 回放验证确保一致性 |
   357→| Exit 10 | M18 实验性门禁 | 模型权重验证 |
   358→| Exit 11 | M7, M18 | 场景完整性验证 |
   359→| Exit 12 | M1-M20 全部 | 最高级别军法执行 |
   360→| Exit 13 | M4, M5 | 平台能力验证 |
   361→
   362→---
   363→
   364→**军规级别国家伟大工程 - 退出码规范文档**
   365→**版本 v4.0 | 严格执行 | 违规必究**
   366→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
