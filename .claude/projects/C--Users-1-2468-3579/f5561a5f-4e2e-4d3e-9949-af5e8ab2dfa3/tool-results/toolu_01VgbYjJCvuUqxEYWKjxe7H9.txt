     1â†’# Claude è‡ªåŠ¨é—­ç¯å¥‘çº¦ï¼ˆå†›è§„çº§ v3.0ï¼‰
     2â†’
     3â†’> **æœ¬æ–‡æ¡£æ˜¯ Claude Agent çš„å¼ºåˆ¶æ‰§è¡Œåè®®**
     4â†’> **è¿åä»»ä½•æ¡æ¬¾å°†è§¦å‘ POLICY_VIOLATIONï¼ˆexit 12ï¼‰**
     5â†’
     6â†’---
     7â†’
     8â†’## æ ¸å¿ƒåŸåˆ™ï¼ˆä»¤è¡Œç¦æ­¢ï¼‰
     9â†’
    10â†’```text
    11â†’â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    12â†’â•‘  å†›è§„çº§è‡ªåŠ¨é—­ç¯ = ç™½åå•å‘½ä»¤ + Schema æ ¡éªŒ + å®¡è®¡æ—¥å¿— + è¿è§„å³åœ           â•‘
    13â†’â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    14â†’```
    15â†’
    16â†’### ğŸš« ç»å¯¹ç¦æ­¢ï¼ˆè‡ªåŠ¨æ£€æµ‹ + ç«‹å³ FAILï¼‰
    17â†’
    18â†’| è¿è§„è¡Œä¸º | è¿è§„ä»£ç  | åæœ |
    19â†’|---------|---------|------|
    20â†’| ç›´æ¥è¿è¡Œ `pytest`/`ruff`/`mypy` | `POLICY.COMMAND_BLACKLISTED` | exit 12 |
    21â†’| ä¿®æ”¹ `.github/workflows/*.yml` | `POLICY.PROTECTED_FILE` | exit 12 |
    22â†’| ä¿®æ”¹ `coverage_exceptions.yml` æœªè¯´æ˜ç†ç”± | `POLICY.EXCEPTION_UNEXPLAINED` | exit 12 |
    23â†’| æœªåœ¨æ¯è½®å¾ªç¯å‰æ›´æ–° context | `POLICY.CONTEXT_STALE` | exit 12 |
    24â†’| report.json ç¼ºå¤±å¿…å¡«å­—æ®µ | `SCHEMA.MISSING_FIELDS` | exit 12 |
    25â†’| replay/sim æœªå¯ç”¨ CHECK_MODE | `POLICY.CHECK_MODE_DISABLED` | exit 12 |
    26â†’| schema_version < 3 | `SCHEMA.VERSION_OUTDATED` | exit 12 |
    27â†’| Failure ç¼ºå°‘ rule_id/component/evidence | `SCHEMA.FAILURE_INCOMPLETE` | exit 12 |
    28â†’
    29â†’### âœ… å¿…é¡»éµå®ˆ
    30â†’
    31â†’- âœ… **åªä½¿ç”¨ `make.ps1` å…¥å£** - æ‰€æœ‰æ£€æŸ¥å¿…é¡»é€šè¿‡ make.ps1 targets
    32â†’- âœ… **æ¯è½®åˆ·æ–° context** - `make.ps1 context-dev` åœ¨ä¿®æ”¹ä»£ç å‰æ‰§è¡Œ
    33â†’- âœ… **è§£æ JSON æŠ¥å‘Š** - ä¸ä¾èµ–ç»ˆç«¯è¾“å‡ºï¼Œåªä¿¡ä»» `report.json`
    34â†’- âœ… **æŒ‰ rule_id å®šä½é—®é¢˜** - ä½¿ç”¨ `V2_REQUIRED_SCENARIOS.yml` ä¸­çš„ rule_id
    35â†’- âœ… **æä¾› evidence** - å¤±è´¥æŠ¥å‘Šå¿…é¡»åŒ…å«çŠ¶æ€å¿«ç…§
    36â†’
    37â†’---
    38â†’
    39â†’## é€€å‡ºç çº¦å®š
    40â†’
    41â†’| é€€å‡ºç  | åç§° | å«ä¹‰ | Claude åº”å¯¹ |
    42â†’|-------|------|------|-------------|
    43â†’| 0 | SUCCESS | å…¨éƒ¨é€šè¿‡ | å®Œæˆä»»åŠ¡ |
    44â†’| 1 | GENERAL_ERROR | æœªçŸ¥é”™è¯¯ | æ£€æŸ¥æ—¥å¿—ï¼ŒæŠ¥å‘Šé—®é¢˜ |
    45â†’| 2 | FORMAT_LINT_FAIL | æ ¼å¼/lint å¤±è´¥ | è¿è¡Œ `make.ps1 format` |
    46â†’| 3 | TYPE_CHECK_FAIL | ç±»å‹æ£€æŸ¥å¤±è´¥ | æ ¹æ® mypy é”™è¯¯ä¿®æ”¹ç±»å‹ |
    47â†’| 4 | TEST_FAIL | æµ‹è¯•å¤±è´¥ | æ ¹æ® failures æ•°ç»„ä¿®æ”¹ä»£ç  |
    48â†’| 5 | COVERAGE_FAIL | è¦†ç›–ç‡ä¸è¶³ | æ·»åŠ æµ‹è¯• |
    49â†’| 6 | RISK_CONFIG_FAIL | é£é™©é…ç½®ç¼ºå¤± | æ£€æŸ¥é…ç½®æ–‡ä»¶ |
    50â†’| 7 | BROKER_CREDS_FAIL | Broker å‡­æ®æ— æ•ˆ | æ£€æŸ¥å‡­æ® |
    51â†’| 8 | REPLAY_FAIL | Replay å¤±è´¥ | æ ¹æ® rule_id ä¿®æ”¹ä»£ç  |
    52â†’| 9 | SIM_FAIL | Sim å¤±è´¥ | æ ¹æ® rule_id ä¿®æ”¹ä»£ç  |
    53â†’| **12** | **POLICY_VIOLATION** | **å†›æ³•å¤„ç½®** | **åœæ­¢æ“ä½œï¼Œæ£€æŸ¥è¿è§„æŠ¥å‘Š** |
    54â†’
    55â†’---
    56â†’
    57â†’## A. è‡ªåŠ¨ç¼–ç é—˜ç¯ï¼ˆCode Fix Loopï¼‰
    58â†’
    59â†’### æµç¨‹å›¾ï¼ˆå†›è§„çº§ï¼‰
    60â†’
    61â†’```text
    62â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    63â†’â”‚                    Claude è‡ªåŠ¨ç¼–ç é—­ç¯ï¼ˆå†›è§„çº§ v3.0ï¼‰                        â”‚
    64â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    65â†’â”‚                                                                             â”‚
    66â†’â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    67â†’â”‚   â”‚ 1. åˆ·æ–°ä¸Šä¸‹æ–‡ â”‚â”€â”€â”€â–¶â”‚ 2. è¯» context â”‚â”€â”€â”€â–¶â”‚ 3. ä¿®æ”¹ä»£ç   â”‚                  â”‚
    68â†’â”‚   â”‚ context-dev  â”‚    â”‚ + V2_SPEC    â”‚    â”‚ ç²¾ç¡®ç¼–è¾‘     â”‚                  â”‚
    69â†’â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
    70â†’â”‚          â–²                                       â”‚                          â”‚
    71â†’â”‚          â”‚                                       â–¼                          â”‚
    72â†’â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
    73â†’â”‚   â”‚ 6. å¤±è´¥?    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 4. CI + æ ¡éªŒ  â”‚                   â”‚
    74â†’â”‚   â”‚ è§£æ JSON   â”‚                        â”‚ ci-json      â”‚                   â”‚
    75â†’â”‚   â”‚ æ£€æŸ¥ schema â”‚                        â”‚ schema v3    â”‚                   â”‚
    76â†’â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
    77â†’â”‚          â”‚                                       â”‚                          â”‚
    78â†’â”‚          â”‚ schema ä¸ç¬¦åˆ                         â”‚                          â”‚
    79â†’â”‚          â–¼                                       â”‚                          â”‚
    80â†’â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚                          â”‚
    81â†’â”‚   â”‚ POLICY_VIOLATION â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
    82â†’â”‚   â”‚ exit 12      â”‚   schema_version < 3 / ç¼ºå¤±å­—æ®µ                          â”‚
    83â†’â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
    84â†’â”‚          â”‚                                                                  â”‚
    85â†’â”‚          â–¼ å…¨éƒ¨é€šè¿‡                                                          â”‚
    86â†’â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
    87â†’â”‚   â”‚ 7. è¿›å…¥ Replay â”‚                                                         â”‚
    88â†’â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
    89â†’â”‚                                                                             â”‚
    90â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    91â†’```
    92â†’
    93â†’### æ‰§è¡Œå‘½ä»¤ï¼ˆç™½åå•ï¼‰
    94â†’
    95â†’```powershell
    96â†’# ã€å”¯ä¸€å…è®¸çš„å‘½ä»¤å…¥å£ã€‘
    97â†’
    98â†’# Step 1: ç”Ÿæˆå¼€å‘ä¸Šä¸‹æ–‡ï¼ˆæ¯è½®å¿…é¡»ï¼‰
    99â†’.\scripts\make.ps1 context-dev
   100â†’
   101â†’# Step 2: è¯»å–ä¸Šä¸‹æ–‡ + V2_REQUIRED_SCENARIOS
   102â†’Get-Content artifacts\context\context.md
   103â†’Get-Content V2_REQUIRED_SCENARIOS.yml
   104â†’
   105â†’# Step 3: ä¿®æ”¹ä»£ç ï¼ˆä½¿ç”¨ç¼–è¾‘å™¨å·¥å…·ï¼‰
   106â†’
   107â†’# Step 4: è¿è¡Œ CI å¹¶è·å– JSON ç»“æœ
   108â†’.\scripts\make.ps1 ci-json
   109â†’
   110â†’# Step 5: è§£æ JSON æŠ¥å‘Šï¼ˆä¸¥æ ¼ schema æ ¡éªŒï¼‰
   111â†’Get-Content artifacts\check\report.json | ConvertFrom-Json
   112â†’
   113â†’# Step 6: å¦‚æœ CI é€šè¿‡ï¼Œè¿è¡Œ Replay
   114â†’.\scripts\make.ps1 replay-json
   115â†’
   116â†’# Step 7: è§£æ Replay æŠ¥å‘Š
   117â†’Get-Content artifacts\sim\report.json | ConvertFrom-Json
   118â†’```
   119â†’
   120â†’---
   121â†’
   122â†’## B. JSON æŠ¥å‘Šæ ¼å¼ï¼ˆv3.0 å†›è§„çº§ Schemaï¼‰
   123â†’
   124â†’### CI æŠ¥å‘Š (`artifacts/check/report.json`)
   125â†’
   126â†’```json
   127â†’{
   128â†’  "schema_version": 3,
   129â†’  "type": "ci",
   130â†’  "timestamp": "2025-01-15T10:30:00Z",
   131â†’  "check_mode": false,
   132â†’  "all_passed": false,
   133â†’  "failed_step": "lint",
   134â†’  "overall": "FAIL",
   135â†’  "exit_code": 2,
   136â†’  "steps": [
   137â†’    {
   138â†’      "name": "format-check",
   139â†’      "status": "PASS",
   140â†’      "exit_code": 0,
   141â†’      "duration_ms": 1234
   142â†’    },
   143â†’    {
   144â†’      "name": "lint",
   145â†’      "status": "FAIL",
   146â†’      "exit_code": 2,
   147â†’      "duration_ms": 2345,
   148â†’      "summary": "src/foo.py:42:1: E501 line too long...",
   149â†’      "failures": [
   150â†’        {
   151â†’          "file": "src/foo.py",
   152â†’          "line": 42,
   153â†’          "rule": "E501",
   154â†’          "message": "line too long (120 > 100)"
   155â†’        }
   156â†’      ],
   157â†’      "hints": [
   158â†’        "Line too long - break into multiple lines or use parentheses",
   159â†’        "Run: make lint-fix to auto-fix some issues"
   160â†’      ]
   161â†’    }
   162â†’  ]
   163â†’}
   164â†’```
   165â†’
   166â†’### Replay/Sim æŠ¥å‘Š (`artifacts/sim/report.json`)
   167â†’
   168â†’```json
   169â†’{
   170â†’  "schema_version": 3,
   171â†’  "type": "replay",
   172â†’  "timestamp": "2025-01-15T10:35:00Z",
   173â†’  "check_mode": true,
   174â†’  "overall": "FAIL",
   175â†’  "exit_code": 8,
   176â†’  "scenarios_total": 55,
   177â†’  "scenarios_passed": 52,
   178â†’  "scenarios_failed": 3,
   179â†’  "failures": [
   180â†’    {
   181â†’      "scenario": "universe_selector_roll_rules",
   182â†’      "rule_id": "UNIV.DOMINANT.ROLL.COOLDOWN",
   183â†’      "component": "market.universe_selector",
   184â†’      "tick": 42,
   185â†’      "expected": {"dominant": "rb2501"},
   186â†’      "actual": {"dominant": "rb2410"},
   187â†’      "error": "dominant contract violates cooldown rule",
   188â†’      "evidence": {
   189â†’        "volumes": {"rb2501": 12345, "rb2410": 23456},
   190â†’        "open_interest": {"rb2501": 888, "rb2410": 999},
   191â†’        "last_roll_tick": 10,
   192â†’        "cooldown_seconds": 300
   193â†’      }
   194â†’    }
   195â†’  ],
   196â†’  "metrics": {
   197â†’    "total_ticks": 1000,
   198â†’    "avg_tick_duration_ms": 1.5,
   199â†’    "max_drawdown_pct": 2.3,
   200â†’    "orders_placed": 50,
   201â†’    "orders_rejected": 2,
   202â†’    "orders_filled": 48,
   203â†’    "pnl_total": 1234.56
   204â†’  }
   205â†’}
   206â†’```
   207â†’
   208â†’---
   209â†’
   210â†’## C. å¿…å¡«å­—æ®µæ ¡éªŒè¡¨
   211â†’
   212â†’### CI Report å¿…å¡«å­—æ®µ
   213â†’
   214â†’| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
   215â†’|-----|------|------|
   216â†’| `schema_version` | int | å¿…é¡» >= 3 |
   217â†’| `type` | string | "ci" |
   218â†’| `overall` | string | "PASS" / "FAIL" |
   219â†’| `exit_code` | int | é€€å‡ºç  |
   220â†’| `check_mode` | bool | CI æŠ¥å‘Šå¯ä¸º false |
   221â†’
   222â†’### Sim/Replay Report å¿…å¡«å­—æ®µ
   223â†’
   224â†’| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
   225â†’|-----|------|------|
   226â†’| `schema_version` | int | å¿…é¡» >= 3 |
   227â†’| `type` | string | "replay" / "sim" |
   228â†’| `overall` | string | "PASS" / "FAIL" |
   229â†’| `exit_code` | int | é€€å‡ºç  |
   230â†’| `check_mode` | bool | **å¿…é¡»ä¸º true** |
   231â†’| `scenarios_total` | int | åœºæ™¯æ€»æ•° |
   232â†’| `scenarios_passed` | int | é€šè¿‡æ•° |
   233â†’| `scenarios_failed` | int | å¤±è´¥æ•° |
   234â†’
   235â†’### Failure å¿…å¡«å­—æ®µ
   236â†’
   237â†’| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
   238â†’|-----|------|------|
   239â†’| `rule_id` | string | åœºæ™¯æ ‡è¯†ï¼ˆå¦‚ UNIV.DOMINANT.BASICï¼‰ |
   240â†’| `component` | string | æ¨¡å—åï¼ˆå¦‚ market.universe_selectorï¼‰ |
   241â†’| `tick` | int | å¤±è´¥å‘ç”Ÿçš„ tick |
   242â†’| `expected` | object | æœŸæœ›å€¼ |
   243â†’| `actual` | object | å®é™…å€¼ |
   244â†’| `error` | string | é”™è¯¯æè¿° |
   245â†’| `evidence` | object | çŠ¶æ€å¿«ç…§ï¼ˆå¯é€‰ä½†å¼ºçƒˆå»ºè®®ï¼‰ |
   246â†’
   247â†’---
   248â†’
   249â†’## D. å®¡è®¡æ—¥å¿—ä¸äº§ç‰©è·¯å¾„
   250â†’
   251â†’### D.1 å›ºå®šäº§ç‰©è·¯å¾„ï¼ˆç»å¯¹ä¸å˜ï¼‰
   252â†’
   253â†’```text
   254â†’artifacts/
   255â†’â”œâ”€â”€ check/
   256â†’â”‚   â””â”€â”€ report.json          # CI æŠ¥å‘Š
   257â†’â”œâ”€â”€ sim/
   258â†’â”‚   â””â”€â”€ report.json          # Replay/Sim æŠ¥å‘Š
   259â†’â”œâ”€â”€ context/
   260â†’â”‚   â””â”€â”€ context.md           # å¼€å‘ä¸Šä¸‹æ–‡
   261â†’â””â”€â”€ claude/
   262â†’    â”œâ”€â”€ commands.log         # å‘½ä»¤å®¡è®¡æ—¥å¿—
   263â†’    â”œâ”€â”€ round_summary.json   # æ¯è½®ç»“æœæ‘˜è¦
   264â†’    â””â”€â”€ policy_violation.json # è¿è§„æŠ¥å‘Š
   265â†’```
   266â†’
   267â†’### D.2 å‘½ä»¤å®¡è®¡æ—¥å¿—æ ¼å¼
   268â†’
   269â†’```text
   270â†’========== Session Start: 2025-01-15 10:30:00 ==========
   271â†’Mode: full, MaxRounds: 5, Strict: True
   272â†’[2025-01-15 10:30:01] CMD: make.ps1 context-dev | EXIT: 0 | RESULT: 
   273â†’[2025-01-15 10:30:02] CMD: make.ps1 ci-json | EXIT: 0 | RESULT: 
   274â†’[2025-01-15 10:30:05] CMD: make.ps1 replay-json | EXIT: 8 | RESULT: 
   275â†’```
   276â†’
   277â†’### D.3 è¿è§„æŠ¥å‘Šæ ¼å¼
   278â†’
   279â†’```json
   280â†’{
   281â†’  "timestamp": "2025-01-15T10:35:00Z",
   282â†’  "has_violations": true,
   283â†’  "violation_count": 1,
   284â†’  "violations": [
   285â†’    {
   286â†’      "code": "POLICY.CHECK_MODE_DISABLED",
   287â†’      "message": "CHECK_MODE must be enabled for replay",
   288â†’      "evidence": {
   289â†’        "check_mode": false
   290â†’      }
   291â†’    }
   292â†’  ]
   293â†’}
   294â†’```
   295â†’
   296â†’---
   297â†’
   298â†’## E. V2 Required Scenarios é›†æˆ
   299â†’
   300â†’### E.1 åœºæ™¯æ¥æº
   301â†’
   302â†’æ‰€æœ‰å¿…é¡»é€šè¿‡çš„åœºæ™¯å®šä¹‰åœ¨ `V2_REQUIRED_SCENARIOS.yml`ï¼š
   303â†’
   304â†’```yaml
   305â†’phases:
   306â†’  A:
   307â†’    name: "æ¥å£å†»ç»“ + Replay-first"
   308â†’    scenarios:
   309â†’      - rule_id: "UNIV.DOMINANT.BASIC"
   310â†’        component: "market.universe_selector"
   311â†’        required: true
   312â†’        test_pattern: "test_universe_selector*dominant*"
   313â†’  B:
   314â†’    name: "æ‰§è¡Œå¯é æ€§"
   315â†’    scenarios:
   316â†’      - rule_id: "FSM.STRICT.TRANSITIONS"
   317â†’        component: "execution.fsm"
   318â†’        required: true
   319â†’```
   320â†’
   321â†’### E.2 å¤±è´¥å¤„ç†ç­–ç•¥
   322â†’
   323â†’| å¤±è´¥ç±»å‹ | rule_id å‰ç¼€ | åº”ä¿®æ”¹çš„æ¨¡å— |
   324â†’|---------|-------------|-------------|
   325â†’| ä¸»åŠ›é€‰æ‹© | `UNIV.*` | `src/market/universe_selector.py` |
   326â†’| FSM çŠ¶æ€æœº | `FSM.*` | `src/execution/fsm.py` |
   327â†’| æ‰§è¡Œå¼•æ“ | `EXEC.*` | `src/execution/auto_order_engine.py` |
   328â†’| æŒä»“å¯¹è´¦ | `POS.*` | `src/execution/position_tracker.py` |
   329â†’| å¸‚åœºè¿ç»­æ€§ | `MKT.*` | `src/market/` |
   330â†’| å¥—åˆ©æ‰§è¡Œ | `PAIR.*` | `src/execution/pair_executor.py` |
   331â†’| Guardian | `GUARD.*` | `src/guardian/` |
   332â†’| å®¡è®¡ | `AUDIT.*` | `src/audit/` |
   333â†’| å›æ”¾ | `REPLAY.*` | `src/replay/` |
   334â†’
   335â†’---
   336â†’
   337â†’## F. å†›è§„çº§é—­ç¯é©±åŠ¨å™¨ä½¿ç”¨
   338â†’
   339â†’### F.1 å®Œæ•´é—­ç¯ï¼ˆæ¨èï¼‰
   340â†’
   341â†’```powershell
   342â†’# ä¸¥æ ¼æ¨¡å¼ï¼šä»»ä½•è¿è§„ç«‹å³ exit 12
   343â†’.\scripts\claude_loop.ps1 -Mode full -Strict
   344â†’
   345â†’# éä¸¥æ ¼æ¨¡å¼ï¼šå…è®¸ schema æ ¡éªŒè­¦å‘Š
   346â†’.\scripts\claude_loop.ps1 -Mode full
   347â†’```
   348â†’
   349â†’### F.2 å•ç‹¬æ¨¡å¼
   350â†’
   351â†’```powershell
   352â†’# åªè¿è¡Œ CI
   353â†’.\scripts\claude_loop.ps1 -Mode ci -Strict
   354â†’
   355â†’# åªè¿è¡Œ Replayï¼ˆå‡è®¾ CI å·²é€šè¿‡ï¼‰
   356â†’.\scripts\claude_loop.ps1 -Mode replay -SkipContext
   357â†’
   358â†’# åªè¿è¡Œ Sim
   359â†’.\scripts\claude_loop.ps1 -Mode sim
   360â†’```
   361â†’
   362â†’### F.3 è‡ªåŠ¨åŒ–ç¯å¢ƒ
   363â†’
   364â†’```powershell
   365â†’# CI ç¯å¢ƒè‡ªåŠ¨ç»§ç»­ä¸‹ä¸€è½®
   366â†’$env:CLAUDE_AUTOMATED = "1"
   367â†’.\scripts\claude_loop.ps1 -Mode full -MaxRounds 10
   368â†’```
   369â†’
   370â†’---
   371â†’
   372â†’## G. è¿è§„æ£€æµ‹æ¸…å•
   373â†’
   374â†’### G.1 è‡ªåŠ¨æ£€æµ‹çš„è¿è§„
   375â†’
   376â†’| æ£€æµ‹ç‚¹ | è¿è§„ä»£ç  | æ£€æµ‹æ–¹å¼ |
   377â†’|-------|---------|---------|
   378â†’| report.json ä¸å­˜åœ¨ | `SCHEMA.FILE_MISSING` | æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ |
   379â†’| JSON è§£æå¤±è´¥ | `SCHEMA.INVALID_JSON` | JSON.parse |
   380â†’| schema_version < 3 | `SCHEMA.VERSION_OUTDATED` | å­—æ®µæ¯”è¾ƒ |
   381â†’| ç¼ºå°‘å¿…å¡«å­—æ®µ | `SCHEMA.MISSING_FIELDS` | å­—æ®µé›†åˆå·® |
   382â†’| CHECK_MODE=false (replay/sim) | `POLICY.CHECK_MODE_DISABLED` | å­—æ®µæ£€æŸ¥ |
   383â†’| Failure ç¼ºå°‘ rule_id | `SCHEMA.FAILURE_INCOMPLETE` | å­—æ®µæ£€æŸ¥ |
   384â†’| ç›´æ¥è¿è¡Œ pytest/ruff/mypy | `POLICY.COMMAND_BLACKLISTED` | å‘½ä»¤æ—¥å¿— |
   385â†’
   386â†’### G.2 éœ€è¦äººå·¥å®¡æŸ¥çš„è¿è§„
   387â†’
   388â†’| åœºæ™¯ | å»ºè®® |
   389â†’|-----|------|
   390â†’| ä¿®æ”¹ coverage_exceptions.yml | å¿…é¡»åœ¨ PR ä¸­è¯´æ˜ç†ç”± |
   391â†’| ä¿®æ”¹ V2_REQUIRED_SCENARIOS.yml | å¿…é¡»è¯´æ˜ä¸ºä½•è°ƒæ•´éªŒæ”¶æ ‡å‡† |
   392â†’| è·³è¿‡å¿…é¡»åœºæ™¯ | å¿…é¡»è¯´æ˜ä¸´æ—¶è±å…åŸå›  |
   393â†’
   394â†’---
   395â†’
   396â†’## H. æ•…éšœæ’é™¤
   397â†’
   398â†’### H.1 å¸¸è§ POLICY_VIOLATION
   399â†’
   400â†’**é—®é¢˜**: `SCHEMA.VERSION_OUTDATED`
   401â†’**åŸå› **: æ—§ç‰ˆä»£ç ç”Ÿæˆçš„æŠ¥å‘Š
   402â†’**è§£å†³**: æ›´æ–° `ci_gate.py` / `sim_gate.py` ä½¿ç”¨ v3 schema
   403â†’
   404â†’**é—®é¢˜**: `POLICY.CHECK_MODE_DISABLED`
   405â†’**åŸå› **: replay/sim æœªå¯ç”¨ CHECK_MODE
   406â†’**è§£å†³**: ä½¿ç”¨ `python -m src.trading.replay` å…¥å£ï¼ˆè‡ªåŠ¨å¯ç”¨ï¼‰
   407â†’
   408â†’**é—®é¢˜**: `SCHEMA.FAILURE_INCOMPLETE`
   409â†’**åŸå› **: å¤±è´¥æŠ¥å‘Šç¼ºå°‘ rule_id/component
   410â†’**è§£å†³**: æ›´æ–° `add_failure()` è°ƒç”¨ï¼Œæä¾›å®Œæ•´å‚æ•°
   411â†’
   412â†’### H.2 è°ƒè¯•å‘½ä»¤
   413â†’
   414â†’```powershell
   415â†’# æŸ¥çœ‹è¿è§„æŠ¥å‘Š
   416â†’Get-Content artifacts\claude\policy_violation.json | ConvertFrom-Json
   417â†’
   418â†’# æŸ¥çœ‹å‘½ä»¤æ—¥å¿—
   419â†’Get-Content artifacts\claude\commands.log -Tail 20
   420â†’
   421â†’# æŸ¥çœ‹è½®æ¬¡æ‘˜è¦
   422â†’Get-Content artifacts\claude\round_summary.json | ConvertFrom-Json
   423â†’```
   424â†’
   425â†’---
   426â†’
   427â†’## ç‰ˆæœ¬å†å²
   428â†’
   429â†’| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
   430â†’|-----|------|------|
   431â†’| 1.0 | 2025-01-14 | åˆå§‹ç‰ˆæœ¬ |
   432â†’| 2.0 | 2025-01-14 | æ·»åŠ  hintsã€50 è¡Œ summary |
   433â†’| **3.0** | **2025-01-15** | **å†›è§„çº§å‡çº§ï¼šschema v3ã€POLICY_VIOLATIONã€å®¡è®¡æ—¥å¿—** |
   434â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
