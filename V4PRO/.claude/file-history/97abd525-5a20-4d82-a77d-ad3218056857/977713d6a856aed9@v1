"""
market_gateway/config.py
网关配置模型定义。

设计原则：
- 使用 Pydantic v2 进行配置校验
- 所有配置从环境变量或配置文件读取
- 敏感信息（密码）使用 SecretStr
- 提供默认值与校验规则

# RISK: 配置错误可能导致连接失败或数据丢失
# 缓解措施: 启动时强制校验，失败则拒绝启动

Author: AI Quant Team
Version: 1.0.0
"""

from pydantic import (
    BaseModel,
    Field,
    SecretStr,
    field_validator,
    model_validator,
)
from pydantic_settings import BaseSettings, SettingsConfigDict
from typing import Final
from enum import Enum

__all__: list[str] = [
    "GatewayType",
    "GatewayConfig",
    "CtpConfig",
    "ReconnectConfig",
    "DataFilterConfig",
    "RedisConfig",
    "ClickHouseConfig",
]


class GatewayType(str, Enum):
    """网关类型枚举。"""
    CTP = "ctp"
    SIMNOW = "simnow"
    IB = "ib"  # WHY: 预留 IB 扩展


# WHY: 默认值常量集中管理
DEFAULT_CONNECT_TIMEOUT: Final[float] = 10.0
DEFAULT_MAX_RECONNECT_INTERVAL: Final[float] = 60.0
DEFAULT_MAX_SUBSCRIPTIONS: Final[int] = 1000
DEFAULT_TICK_CACHE_SECONDS: Final[int] = 30
DEFAULT_STALE_THRESHOLD_SECONDS: Final[int] = 3600


class ReconnectConfig(BaseModel):
    """
    重连配置。

    Attributes:
        initial_interval: 初始重连间隔（秒）
        max_interval: 最大重连间隔（秒）
        multiplier: 退避乘数
        max_attempts: 最大重连次数（0=无限）
        alert_threshold: 触发告警的失败次数
    """

    initial_interval: float = Field(
        default=1.0,
        ge=0.1,
        le=10.0,
        description="初始重连间隔（秒）",
    )
    max_interval: float = Field(
        default=DEFAULT_MAX_RECONNECT_INTERVAL,
        ge=1.0,
        le=300.0,
        description="最大重连间隔（秒）",
    )
    multiplier: float = Field(
        default=2.0,
        ge=1.1,
        le=5.0,
        description="指数退避乘数",
    )
    # WHY: 0 表示无限重连，符合用户需求
    max_attempts: int = Field(
        default=0,
        ge=0,
        description="最大重连次数（0=无限）",
    )
    alert_threshold: int = Field(
        default=10,
        ge=1,
        description="触发告警的连续失败次数",
    )

    def __repr__(self) -> str:
        return (
            f"ReconnectConfig(interval={self.initial_interval}-{self.max_interval}s, "
            f"multiplier={self.multiplier}, max={self.max_attempts or '∞'})"
        )
