"""
市场网关事件定义

提供统一的事件类型定义和事件数据类，用于网关组件之间的通信。
"""

from dataclasses import dataclass, field, asdict
from typing import Any, Dict, Optional, List
from datetime import datetime
from enum import Enum
import json


class EventType(Enum):
    """事件类型枚举

    定义网关系统中所有可能的事件类型。
    """
    # 连接事件
    CONNECTED = "connected"
    DISCONNECTED = "disconnected"
    RECONNECTING = "reconnecting"
    CONNECTION_ERROR = "connection_error"

    # 认证事件
    LOGIN_SUCCESS = "login_success"
    LOGIN_FAILED = "login_failed"
    LOGOUT = "logout"

    # 订阅事件
    SUBSCRIBED = "subscribed"
    UNSUBSCRIBED = "unsubscribed"
    SUBSCRIPTION_ERROR = "subscription_error"

    # 数据事件
    TICK_DATA = "tick_data"
    KLINE_DATA = "kline_data"
    ORDER_BOOK = "order_book"
    TRADE = "trade"

    # 系统事件
    CONFIG_UPDATED = "config_updated"
    ALERT = "alert"
    METRICS_UPDATE = "metrics_update"
    HEARTBEAT = "heartbeat"
    ERROR = "error"


class AlertLevel(Enum):
    """告警级别枚举"""
    DEBUG = "debug"
    INFO = "info"
    WARNING = "warning"
    ERROR = "error"
    CRITICAL = "critical"


@dataclass
class BaseEvent:
    """基础事件类

    所有事件的基类，提供通用的事件属性和方法。

    Attributes:
        event_type: 事件类型
        timestamp: 事件发生时间
        source: 事件来源
        data: 事件数据
        metadata: 事件元数据
    """
    event_type: EventType
    timestamp: datetime = field(default_factory=datetime.now)
    source: str = "unknown"
    data: Any = None
    metadata: Optional[Dict[str, Any]] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        """转换为字典格式

        Returns:
            Dict[str, Any]: 事件的字典表示
        """
        result = asdict(self)
        result['event_type'] = self.event_type.value
        result['timestamp'] = self.timestamp.isoformat()
        return result

    def to_json(self) -> str:
        """转换为JSON字符串

        Returns:
            str: 事件的JSON表示
        """
        return json.dumps(self.to_dict(), ensure_ascii=False, default=str)

    def __repr__(self) -> str:
        """返回事件的字符串表示"""
        return (f"{self.__class__.__name__}("
                f"event_type={self.event_type.value}, "
                f"source={self.source}, "
                f"timestamp={self.timestamp.strftime('%Y-%m-%d %H:%M:%S')})")


@dataclass
class ConnectionEvent(BaseEvent):
    """连接事件

    用于表示连接状态变化的事件。

    Attributes:
        reason: 连接/断开原因
        retry_count: 重连尝试次数
        remote_addr: 远程地址
    """
    reason: Optional[str] = None
    retry_count: int = 0
    remote_addr: Optional[str] = None

    def __post_init__(self):
        """初始化后处理"""
        if self.metadata is None:
            self.metadata = {}


@dataclass
class SubscriptionEvent(BaseEvent):
    """订阅事件

    用于表示订阅状态变化的事件。

    Attributes:
        symbols: 订阅的合约列表
        success_symbols: 成功订阅的合约
        failed_symbols: 失败的合约
        error_message: 错误消息
    """
    symbols: List[str] = field(default_factory=list)
    success_symbols: List[str] = field(default_factory=list)
    failed_symbols: List[str] = field(default_factory=list)
    error_message: Optional[str] = None

    @property
    def is_success(self) -> bool:
        """判断订阅是否完全成功"""
        return len(self.failed_symbols) == 0 and len(self.success_symbols) > 0

    @property
    def partial_success(self) -> bool:
        """判断是否部分成功"""
        return len(self.success_symbols) > 0 and len(self.failed_symbols) > 0


@dataclass
class TickDataEvent(BaseEvent):
    """Tick数据事件

    用于传递Tick行情数据的事件。

    Attributes:
        symbol: 合约代码
        tick_data: 标准化的Tick数据字典
    """
    symbol: str = ""
    tick_data: Dict[str, Any] = field(default_factory=dict)


@dataclass
class KLineDataEvent(BaseEvent):
    """K线数据事件

    用于传递K线数据的事件。

    Attributes:
        symbol: 合约代码
        period: K线周期（分钟）
        kline_data: K线数据字典
        is_closed: K线是否已闭合
    """
    symbol: str = ""
    period: int = 1
    kline_data: Dict[str, Any] = field(default_factory=dict)
    is_closed: bool = False


@dataclass
class AlertEvent(BaseEvent):
    """告警事件

    用于系统告警通知的事件。

    Attributes:
        level: 告警级别
        message: 告警消息
        details: 详细信息
        alert_id: 告警ID（用于去重）
    """
    level: AlertLevel = AlertLevel.INFO
    message: str = ""
    details: Optional[Dict[str, Any]] = None
    alert_id: Optional[str] = None

    def __post_init__(self):
        """初始化后处理"""
        if self.metadata is None:
            self.metadata = {}

    @property
    def is_critical(self) -> bool:
        """判断是否为严重告警"""
        return self.level in (AlertLevel.ERROR, AlertLevel.CRITICAL)


@dataclass
class ErrorEvent(BaseEvent):
    """错误事件

    用于报告系统错误的事件。

    Attributes:
        error_code: 错误代码
        error_message: 错误消息
        error_type: 错误类型名称
        stack_trace: 堆栈跟踪信息
    """
    error_code: int = 0
    error_message: str = ""
    error_type: str = ""
    stack_trace: Optional[str] = None


@dataclass
class HeartbeatEvent(BaseEvent):
    """心跳事件

    用于连接保活和状态检查的事件。

    Attributes:
        sequence: 心跳序列号
        latency_ms: 延迟毫秒数
    """
    sequence: int = 0
    latency_ms: Optional[float] = None


__all__ = [
    'EventType',
    'AlertLevel',
    'BaseEvent',
    'ConnectionEvent',
    'SubscriptionEvent',
    'TickDataEvent',
    'KLineDataEvent',
    'AlertEvent',
    'ErrorEvent',
    'HeartbeatEvent'
]
