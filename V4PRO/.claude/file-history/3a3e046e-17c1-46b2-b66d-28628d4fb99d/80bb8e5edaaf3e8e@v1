"""K线数据模型单元测试"""

import pytest
from decimal import Decimal
from datetime import datetime, timedelta

from src.models.kline_data import KLineData, KLinePeriod


class TestKLinePeriod:
    """KLinePeriod枚举测试"""

    def test_period_values(self):
        """测试周期枚举值"""
        assert KLinePeriod.MINUTE_1.value == 1
        assert KLinePeriod.MINUTE_5.value == 5
        assert KLinePeriod.HOUR_1.value == 60
        assert KLinePeriod.DAY_1.value == 1440

    def test_from_minutes(self):
        """测试从分钟数创建周期"""
        assert KLinePeriod.from_minutes(1) == KLinePeriod.MINUTE_1
        assert KLinePeriod.from_minutes(60) == KLinePeriod.HOUR_1

    def test_from_minutes_invalid(self):
        """测试无效的分钟数"""
        with pytest.raises(ValueError):
            KLinePeriod.from_minutes(7)

    def test_to_timedelta(self):
        """测试转换为timedelta"""
        td = KLinePeriod.MINUTE_5.to_timedelta()
        assert td == timedelta(minutes=5)

    def test_str_representation(self):
        """测试字符串表示"""
        assert str(KLinePeriod.MINUTE_1) == "1分钟"
        assert str(KLinePeriod.HOUR_1) == "1小时"
        assert str(KLinePeriod.DAY_1) == "日线"


class TestKLineData:
    """KLineData模型测试"""

    @pytest.fixture
    def valid_kline_data(self):
        """有效的K线数据fixture"""
        now = datetime.now()
        return {
            "symbol": "rb2401",
            "exchange": "SHFE",
            "period": KLinePeriod.MINUTE_1,
            "open_time": now,
            "close_time": now + timedelta(minutes=1),
            "open_price": Decimal("3000.0"),
            "high_price": Decimal("3010.0"),
            "low_price": Decimal("2990.0"),
            "close_price": Decimal("3005.0"),
            "volume": 1000,
            "turnover": Decimal("3000000.0"),
            "open_interest": 5000,
        }

    def test_create_kline_success(self, valid_kline_data):
        """测试成功创建K线"""
        kline = KLineData(**valid_kline_data)

        assert kline.symbol == "rb2401"
        assert kline.open_price == Decimal("3000.0")
        assert kline.high_price == Decimal("3010.0")

    def test_price_change(self, valid_kline_data):
        """测试价格变化计算"""
        kline = KLineData(**valid_kline_data)

        assert kline.price_change == Decimal("5.0")

    def test_price_change_rate(self, valid_kline_data):
        """测试价格变化率"""
        kline = KLineData(**valid_kline_data)

        # (3005 - 3000) / 3000 * 100 ≈ 0.167%
        rate = kline.price_change_rate
        assert rate > Decimal("0.16")
        assert rate < Decimal("0.17")

    def test_price_range(self, valid_kline_data):
        """测试价格振幅"""
        kline = KLineData(**valid_kline_data)

        assert kline.price_range == Decimal("20.0")

    def test_is_bullish(self, valid_kline_data):
        """测试阳线判断"""
        kline = KLineData(**valid_kline_data)

        assert kline.is_bullish is True
        assert kline.is_bearish is False

    def test_is_bearish(self, valid_kline_data):
        """测试阴线判断"""
        valid_kline_data["close_price"] = Decimal("2995.0")
        kline = KLineData(**valid_kline_data)

        assert kline.is_bearish is True
        assert kline.is_bullish is False

    def test_is_doji(self, valid_kline_data):
        """测试十字星判断"""
        valid_kline_data["close_price"] = Decimal("3000.0")  # 与开盘价相同
        kline = KLineData(**valid_kline_data)

        assert kline.is_doji is True

    def test_body_size(self, valid_kline_data):
        """测试实体大小"""
        kline = KLineData(**valid_kline_data)

        assert kline.body_size == Decimal("5.0")

    def test_upper_shadow(self, valid_kline_data):
        """测试上影线"""
        kline = KLineData(**valid_kline_data)

        # 最高价3010 - max(开盘3000, 收盘3005) = 5
        assert kline.upper_shadow == Decimal("5.0")

    def test_lower_shadow(self, valid_kline_data):
        """测试下影线"""
        kline = KLineData(**valid_kline_data)

        # min(开盘3000, 收盘3005) - 最低价2990 = 10
        assert kline.lower_shadow == Decimal("10.0")

    def test_average_price(self, valid_kline_data):
        """测试均价"""
        kline = KLineData(**valid_kline_data)

        # (3000 + 3010 + 2990 + 3005) / 4 = 3001.25
        assert kline.average_price == Decimal("3001.25")

    def test_typical_price(self, valid_kline_data):
        """测试典型价格"""
        kline = KLineData(**valid_kline_data)

        # (3010 + 2990 + 3005) / 3 ≈ 3001.67
        expected = (Decimal("3010.0") + Decimal("2990.0") + Decimal("3005.0")) / 3
        assert kline.typical_price == expected

    def test_invalid_ohlc_high_less_than_open(self, valid_kline_data):
        """测试无效OHLC关系：最高价<开盘价"""
        valid_kline_data["high_price"] = Decimal("2999.0")

        with pytest.raises(ValueError) as exc_info:
            KLineData(**valid_kline_data)

        assert "最高价" in str(exc_info.value)

    def test_invalid_ohlc_low_greater_than_open(self, valid_kline_data):
        """测试无效OHLC关系：最低价>开盘价"""
        valid_kline_data["low_price"] = Decimal("3001.0")

        with pytest.raises(ValueError) as exc_info:
            KLineData(**valid_kline_data)

        assert "最低价" in str(exc_info.value)

    def test_invalid_price_negative(self, valid_kline_data):
        """测试负价格"""
        valid_kline_data["open_price"] = Decimal("-100")

        with pytest.raises(ValueError) as exc_info:
            KLineData(**valid_kline_data)

        assert "正数" in str(exc_info.value)

    def test_invalid_volume_negative(self, valid_kline_data):
        """测试负成交量"""
        valid_kline_data["volume"] = -100

        with pytest.raises(ValueError) as exc_info:
            KLineData(**valid_kline_data)

        assert "负数" in str(exc_info.value)

    def test_to_dict(self, valid_kline_data):
        """测试转换为字典"""
        kline = KLineData(**valid_kline_data)
        data = kline.to_dict()

        assert isinstance(data, dict)
        assert data["symbol"] == "rb2401"
        assert data["period"] == 1

    def test_to_json(self, valid_kline_data):
        """测试转换为JSON"""
        kline = KLineData(**valid_kline_data)
        json_str = kline.to_json()

        assert isinstance(json_str, str)
        assert "rb2401" in json_str

    def test_to_ohlcv_tuple(self, valid_kline_data):
        """测试转换为OHLCV元组"""
        kline = KLineData(**valid_kline_data)
        ohlcv = kline.to_ohlcv_tuple()

        assert len(ohlcv) == 6
        assert ohlcv[1] == 3000.0  # open
        assert ohlcv[2] == 3010.0  # high
        assert ohlcv[3] == 2990.0  # low
        assert ohlcv[4] == 3005.0  # close
        assert ohlcv[5] == 1000    # volume

    def test_from_ticks(self):
        """测试从Tick数据聚合K线"""
        ticks = [
            {"last_price": 3000, "volume": 100, "turnover": 300000, "open_interest": 5000},
            {"last_price": 3010, "volume": 200, "turnover": 600000, "open_interest": 5100},
            {"last_price": 2990, "volume": 300, "turnover": 900000, "open_interest": 5050},
            {"last_price": 3005, "volume": 400, "turnover": 1200000, "open_interest": 5080},
        ]

        now = datetime.now()
        kline = KLineData.from_ticks(
            ticks=ticks,
            symbol="rb2401",
            exchange="SHFE",
            period=KLinePeriod.MINUTE_1,
            open_time=now
        )

        assert kline.open_price == Decimal("3000")
        assert kline.high_price == Decimal("3010")
        assert kline.low_price == Decimal("2990")
        assert kline.close_price == Decimal("3005")
        assert kline.tick_count == 4

    def test_from_ticks_empty(self):
        """测试空Tick列表"""
        with pytest.raises(ValueError):
            KLineData.from_ticks(
                ticks=[],
                symbol="rb2401",
                exchange="SHFE",
                period=KLinePeriod.MINUTE_1,
                open_time=datetime.now()
            )

    def test_update_with_tick(self, valid_kline_data):
        """测试使用Tick更新K线"""
        kline = KLineData(**valid_kline_data)

        new_tick = {"last_price": 3015, "volume": 1100}
        updated = kline.update_with_tick(new_tick)

        assert updated.close_price == Decimal("3015")
        assert updated.high_price == Decimal("3015")  # 新高
        assert updated.low_price == Decimal("2990")   # 保持不变
        assert updated.is_complete is False

    def test_repr(self, valid_kline_data):
        """测试字符串表示"""
        kline = KLineData(**valid_kline_data)
        repr_str = repr(kline)

        assert "KLineData" in repr_str
        assert "rb2401" in repr_str


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
