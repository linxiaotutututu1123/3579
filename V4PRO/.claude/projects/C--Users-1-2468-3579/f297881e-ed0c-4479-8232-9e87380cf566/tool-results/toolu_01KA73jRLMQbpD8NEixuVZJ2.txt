     1→"""中国期货手续费计算器模块测试 (军规级 v4.0).
     2→
     3→测试场景:
     4→- CHINA.FEE.BY_VOLUME_CALC: 按手收费计算
     5→- CHINA.FEE.BY_VALUE_CALC: 按金额收费计算
     6→- CHINA.FEE.CLOSE_TODAY_CALC: 平今手续费计算
     7→
     8→军规覆盖:
     9→- M5: 成本先行
    10→- M14: 平今平昨分离
    11→"""
    12→
    13→import pytest
    14→
    15→from src.cost.china_fee_calculator import (
    16→    ALL_FEE_CONFIGS,
    17→    CFFEX_FEE_CONFIGS,
    18→    ChinaFeeCalculator,
    19→    FeeConfig,
    20→    FeeResult,
    21→    FeeType,
    22→    TradeDirection,
    23→    calculate_fee,
    24→    estimate_cost,
    25→    get_default_calculator,
    26→)
    27→from src.market.exchange_config import Exchange
    28→
    29→
    30→class TestFeeTypeEnum:
    31→    """手续费类型枚举测试."""
    32→
    33→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
    34→
    35→    def test_fee_type_values(self) -> None:
    36→        """测试手续费类型枚举值."""
    37→        assert FeeType.FIXED.value == "按手"
    38→        assert FeeType.RATIO.value == "按金额"
    39→        assert FeeType.MIXED.value == "混合"
    40→
    41→
    42→class TestTradeDirectionEnum:
    43→    """交易方向枚举测试."""
    44→
    45→    RULE_ID = "CHINA.FEE.CLOSE_TODAY_CALC"
    46→
    47→    def test_trade_direction_values(self) -> None:
    48→        """测试交易方向枚举值."""
    49→        assert TradeDirection.OPEN.value == "开仓"
    50→        assert TradeDirection.CLOSE.value == "平仓"
    51→        assert TradeDirection.CLOSE_TODAY.value == "平今"
    52→
    53→
    54→class TestFeeConfig:
    55→    """手续费配置测试."""
    56→
    57→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
    58→
    59→    def test_fee_config_ratio(self) -> None:
    60→        """测试按金额收费配置."""
    61→        config = FeeConfig(
    62→            FeeType.RATIO,
    63→            open_ratio=0.0001,
    64→            close_ratio=0.0001,
    65→            close_today_ratio=0.0002,
    66→            multiplier=10,
    67→        )
    68→        assert config.fee_type == FeeType.RATIO
    69→        assert config.open_ratio == 0.0001
    70→        assert config.close_today_ratio == 0.0002
    71→
    72→    def test_fee_config_fixed(self) -> None:
    73→        """测试按手收费配置."""
    74→        config = FeeConfig(
    75→            FeeType.FIXED,
    76→            open_fixed=3.0,
    77→            close_fixed=3.0,
    78→            close_today_fixed=0.0,
    79→            multiplier=5,
    80→        )
    81→        assert config.fee_type == FeeType.FIXED
    82→        assert config.open_fixed == 3.0
    83→        assert config.close_today_fixed == 0.0
    84→
    85→    def test_fee_config_immutable(self) -> None:
    86→        """测试配置不可变."""
    87→        config = FeeConfig(FeeType.RATIO)
    88→        with pytest.raises(AttributeError):
    89→            config.open_ratio = 0.0002  # type: ignore[misc]
    90→
    91→
    92→class TestFeeResult:
    93→    """手续费结果测试."""
    94→
    95→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
    96→
    97→    def test_fee_result_creation(self) -> None:
    98→        """测试手续费结果创建."""
    99→        result = FeeResult(
   100→            fee=35.0,
   101→            fee_type=FeeType.RATIO,
   102→            direction=TradeDirection.OPEN,
   103→            volume=10,
   104→            price=3500,
   105→            value=350000,
   106→            product="rb",
   107→            exchange=Exchange.SHFE,
   108→        )
   109→        assert result.fee == 35.0
   110→        assert result.product == "rb"
   111→        assert result.exchange == Exchange.SHFE
   112→
   113→
   114→class TestFeeConfigs:
   115→    """费率配置数据测试."""
   116→
   117→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
   118→
   119→    def test_all_configs_not_empty(self) -> None:
   120→        """测试所有配置不为空."""
   121→        assert len(ALL_FEE_CONFIGS) > 0
   122→
   123→    def test_cffex_close_today_high(self) -> None:
   124→        """测试中金所平今费率极高."""
   125→        # IF平今费率是开仓的15倍
   126→        if_config = CFFEX_FEE_CONFIGS["IF"]
   127→        assert if_config.close_today_ratio == 0.000345
   128→        assert if_config.open_ratio == 0.000023
   129→        assert if_config.close_today_ratio / if_config.open_ratio == 15
   130→
   131→
   132→class TestChinaFeeCalculator:
   133→    """中国期货手续费计算器测试."""
   134→
   135→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
   136→
   137→    @pytest.fixture
   138→    def calculator(self) -> ChinaFeeCalculator:
   139→        """创建测试用计算器实例."""
   140→        return ChinaFeeCalculator()
   141→
   142→    def test_get_config_lowercase(self, calculator: ChinaFeeCalculator) -> None:
   143→        """测试小写品种代码获取配置."""
   144→        config = calculator.get_config("rb")
   145→        assert config is not None
   146→        assert config.fee_type == FeeType.RATIO
   147→
   148→    def test_get_config_uppercase(self, calculator: ChinaFeeCalculator) -> None:
   149→        """测试大写品种代码获取配置."""
   150→        config = calculator.get_config("IF")
   151→        assert config is not None
   152→        assert config.fee_type == FeeType.RATIO
   153→
   154→    def test_get_config_not_found(self, calculator: ChinaFeeCalculator) -> None:
   155→        """测试未知品种返回None."""
   156→        config = calculator.get_config("UNKNOWN")
   157→        assert config is None
   158→
   159→
   160→class TestByVolumeCalc:
   161→    """按手收费计算测试."""
   162→
   163→    RULE_ID = "CHINA.FEE.BY_VOLUME_CALC"
   164→
   165→    @pytest.fixture
   166→    def calculator(self) -> ChinaFeeCalculator:
   167→        """创建测试用计算器实例."""
   168→        return ChinaFeeCalculator()
   169→
   170→    def test_calc_fixed_fee_open(self, calculator: ChinaFeeCalculator) -> None:
   171→        """测试按手收费开仓."""
   172→        # 铝 (al) 按手收费 3元/手
   173→        result = calculator.calculate("al2501", 20000, 10, "open")
   174→        assert result.fee == 30.0  # 10手 × 3元
   175→        assert result.fee_type == FeeType.FIXED
   176→
   177→    def test_calc_fixed_fee_close(self, calculator: ChinaFeeCalculator) -> None:
   178→        """测试按手收费平仓."""
   179→        result = calculator.calculate("al2501", 20000, 10, "close")
   180→        assert result.fee == 30.0  # 10手 × 3元
   181→
   182→    def test_calc_fixed_fee_close_today_zero(self, calculator: ChinaFeeCalculator) -> None:
   183→        """测试按手收费平今免费."""
   184→        # 铝平今免费
   185→        result = calculator.calculate("al2501", 20000, 10, "close_today")
   186→        assert result.fee == 0.0
   187→
   188→
   189→class TestByValueCalc:
   190→    """按金额收费计算测试."""
   191→
   192→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
   193→
   194→    @pytest.fixture
   195→    def calculator(self) -> ChinaFeeCalculator:
   196→        """创建测试用计算器实例."""
   197→        return ChinaFeeCalculator()
   198→
   199→    def test_calc_ratio_fee_rb(self, calculator: ChinaFeeCalculator) -> None:
   200→        """测试螺纹钢按金额收费."""
   201→        # rb 费率 0.0001，乘数 10
   202→        # 3500 × 10 × 10 × 0.0001 = 35
   203→        result = calculator.calculate("rb2501", 3500, 10, "open")
   204→        assert result.fee == 35.0
   205→        assert result.fee_type == FeeType.RATIO
   206→
   207→    def test_calc_ratio_fee_au(self, calculator: ChinaFeeCalculator) -> None:
   208→        """测试黄金按金额收费."""
   209→        # au 费率 0.00002，乘数 1000
   210→        # 450 × 10 × 1000 × 0.00002 = 90
   211→        result = calculator.calculate("au2512", 450, 10, "open")
   212→        assert result.fee == 90.0
   213→
   214→    def test_calc_ratio_fee_i(self, calculator: ChinaFeeCalculator) -> None:
   215→        """测试铁矿石按金额收费."""
   216→        # i 费率 0.0001，乘数 100
   217→        # 900 × 10 × 100 × 0.0001 = 90
   218→        result = calculator.calculate("i2501", 900, 10, "open")
   219→        assert result.fee == 90.0
   220→
   221→
   222→class TestCloseTodayCalc:
   223→    """平今手续费计算测试."""
   224→
   225→    RULE_ID = "CHINA.FEE.CLOSE_TODAY_CALC"
   226→
   227→    @pytest.fixture
   228→    def calculator(self) -> ChinaFeeCalculator:
   229→        """创建测试用计算器实例."""
   230→        return ChinaFeeCalculator()
   231→
   232→    def test_cffex_close_today_high(self, calculator: ChinaFeeCalculator) -> None:
   233→        """测试中金所平今费率极高."""
   234→        # IF 平今费率 0.000345，乘数 300
   235→        # 4000 × 1 × 300 × 0.000345 = 414
   236→        result = calculator.calculate("IF2501", 4000, 1, "close_today")
   237→        assert result.fee == 414.0
   238→        assert result.fee_type == FeeType.RATIO
   239→
   240→    def test_cffex_open_vs_close_today(self, calculator: ChinaFeeCalculator) -> None:
   241→        """测试中金所开仓与平今费率差异."""
   242→        open_result = calculator.calculate("IF2501", 4000, 1, "open")
   243→        close_today_result = calculator.calculate("IF2501", 4000, 1, "close_today")
   244→        # 平今是开仓的15倍
   245→        assert close_today_result.fee == open_result.fee * 15
   246→
   247→    def test_ma_close_today_higher(self, calculator: ChinaFeeCalculator) -> None:
   248→        """测试甲醇平今费率更高."""
   249→        # MA 开仓2元，平今6元
   250→        open_result = calculator.calculate("MA2501", 2500, 10, "open")
   251→        close_today_result = calculator.calculate("MA2501", 2500, 10, "close_today")
   252→        assert open_result.fee == 20.0
   253→        assert close_today_result.fee == 60.0
   254→
   255→    def test_close_vs_close_today(self, calculator: ChinaFeeCalculator) -> None:
   256→        """测试平仓与平今费率差异."""
   257→        # rb 平仓和平今费率相同
   258→        close_result = calculator.calculate("rb2501", 3500, 10, "close")
   259→        close_today_result = calculator.calculate("rb2501", 3500, 10, "close_today")
   260→        assert close_result.fee == close_today_result.fee
   261→
   262→
   263→class TestExtractProduct:
   264→    """品种代码提取测试."""
   265→
   266→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
   267→
   268→    @pytest.fixture
   269→    def calculator(self) -> ChinaFeeCalculator:
   270→        """创建测试用计算器实例."""
   271→        return ChinaFeeCalculator()
   272→
   273→    def test_extract_product_lower(self, calculator: ChinaFeeCalculator) -> None:
   274→        """测试小写合约代码."""
   275→        assert calculator._extract_product("rb2501") == "rb"
   276→
   277→    def test_extract_product_upper(self, calculator: ChinaFeeCalculator) -> None:
   278→        """测试大写合约代码."""
   279→        assert calculator._extract_product("IF2501") == "IF"
   280→
   281→    def test_extract_product_mixed(self, calculator: ChinaFeeCalculator) -> None:
   282→        """测试混合大小写合约代码."""
   283→        assert calculator._extract_product("MA2501") == "MA"
   284→
   285→    def test_extract_product_no_number(self, calculator: ChinaFeeCalculator) -> None:
   286→        """测试无数字的合约代码."""
   287→        assert calculator._extract_product("rb") == "rb"
   288→
   289→
   290→class TestParseDirection:
   291→    """方向解析测试."""
   292→
   293→    RULE_ID = "CHINA.FEE.CLOSE_TODAY_CALC"
   294→
   295→    @pytest.fixture
   296→    def calculator(self) -> ChinaFeeCalculator:
   297→        """创建测试用计算器实例."""
   298→        return ChinaFeeCalculator()
   299→
   300→    def test_parse_direction_open(self, calculator: ChinaFeeCalculator) -> None:
   301→        """测试解析开仓."""
   302→        assert calculator._parse_direction("open") == TradeDirection.OPEN
   303→        assert calculator._parse_direction("开仓") == TradeDirection.OPEN
   304→        assert calculator._parse_direction("buy") == TradeDirection.OPEN
   305→
   306→    def test_parse_direction_close(self, calculator: ChinaFeeCalculator) -> None:
   307→        """测试解析平仓."""
   308→        assert calculator._parse_direction("close") == TradeDirection.CLOSE
   309→        assert calculator._parse_direction("平仓") == TradeDirection.CLOSE
   310→
   311→    def test_parse_direction_close_today(self, calculator: ChinaFeeCalculator) -> None:
   312→        """测试解析平今."""
   313→        assert calculator._parse_direction("close_today") == TradeDirection.CLOSE_TODAY
   314→        assert calculator._parse_direction("平今") == TradeDirection.CLOSE_TODAY
   315→        assert calculator._parse_direction("closetoday") == TradeDirection.CLOSE_TODAY
   316→
   317→
   318→class TestRoundTrip:
   319→    """往返交易成本测试."""
   320→
   321→    RULE_ID = "CHINA.FEE.CLOSE_TODAY_CALC"
   322→
   323→    @pytest.fixture
   324→    def calculator(self) -> ChinaFeeCalculator:
   325→        """创建测试用计算器实例."""
   326→        return ChinaFeeCalculator()
   327→
   328→    def test_round_trip_intraday(self, calculator: ChinaFeeCalculator) -> None:
   329→        """测试日内往返交易成本."""
   330→        # rb 开仓35 + 平今35 = 70
   331→        cost = calculator.estimate_round_trip("rb2501", 3500, 10, is_intraday=True)
   332→        assert cost == 70.0
   333→
   334→    def test_round_trip_overnight(self, calculator: ChinaFeeCalculator) -> None:
   335→        """测试隔夜往返交易成本."""
   336→        # rb 开仓35 + 平仓35 = 70
   337→        cost = calculator.estimate_round_trip("rb2501", 3500, 10, is_intraday=False)
   338→        assert cost == 70.0
   339→
   340→    def test_round_trip_cffex_intraday_expensive(self, calculator: ChinaFeeCalculator) -> None:
   341→        """测试中金所日内交易成本极高."""
   342→        # IF 开仓27.6 + 平今414 = 441.6
   343→        intraday_cost = calculator.estimate_round_trip("IF2501", 4000, 1, is_intraday=True)
   344→        overnight_cost = calculator.estimate_round_trip("IF2501", 4000, 1, is_intraday=False)
   345→        # 日内成本远高于隔夜
   346→        assert intraday_cost > overnight_cost * 5
   347→
   348→
   349→class TestFeeRateInfo:
   350→    """费率信息测试."""
   351→
   352→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
   353→
   354→    @pytest.fixture
   355→    def calculator(self) -> ChinaFeeCalculator:
   356→        """创建测试用计算器实例."""
   357→        return ChinaFeeCalculator()
   358→
   359→    def test_get_fee_rate_info_known(self, calculator: ChinaFeeCalculator) -> None:
   360→        """测试获取已知品种费率信息."""
   361→        info = calculator.get_fee_rate_info("rb")
   362→        assert info["product"] == "rb"
   363→        assert info["fee_type"] == "按金额"
   364→        assert info["multiplier"] == 10
   365→
   366→    def test_get_fee_rate_info_unknown(self, calculator: ChinaFeeCalculator) -> None:
   367→        """测试获取未知品种费率信息."""
   368→        info = calculator.get_fee_rate_info("UNKNOWN")
   369→        assert info["fee_type"] == "默认"
   370→        assert info["open_rate"] == 0.0001
   371→
   372→
   373→class TestConvenienceFunctions:
   374→    """便捷函数测试."""
   375→
   376→    RULE_ID = "CHINA.FEE.BY_VALUE_CALC"
   377→
   378→    def test_get_default_calculator(self) -> None:
   379→        """测试获取默认计算器."""
   380→        calc1 = get_default_calculator()
   381→        calc2 = get_default_calculator()
   382→        assert calc1 is calc2  # 单例
   383→
   384→    def test_calculate_fee_function(self) -> None:
   385→        """测试calculate_fee便捷函数."""
   386→        fee = calculate_fee("rb2501", 3500, 10, "open")
   387→        assert fee == 35.0
   388→
   389→    def test_estimate_cost_function(self) -> None:
   390→        """测试estimate_cost便捷函数."""
   391→        cost = estimate_cost("rb2501", 3500, 10, is_intraday=True)
   392→        assert cost == 70.0
   393→
   394→
   395→class TestMilitaryRuleM5:
   396→    """军规M5: 成本先行测试."""
   397→
   398→    RULE_ID = "M5.COST_FIRST"
   399→
   400→    @pytest.fixture
   401→    def calculator(self) -> ChinaFeeCalculator:
   402→        """创建测试用计算器实例."""
   403→        return ChinaFeeCalculator()
   404→
   405→    def test_fee_calculation_accurate(self, calculator: ChinaFeeCalculator) -> None:
   406→        """测试手续费计算精确性."""
   407→        # 验证多个品种的计算准确性
   408→        result_rb = calculator.calculate("rb2501", 3500, 10, "open")
   409→        result_if = calculator.calculate("IF2501", 4000, 1, "open")
   410→        result_al = calculator.calculate("al2501", 20000, 10, "open")
   411→
   412→        # 结果应该是精确到分
   413→        assert result_rb.fee == 35.0
   414→        assert result_if.fee == 27.6
   415→        assert result_al.fee == 30.0
   416→
   417→
   418→class TestMilitaryRuleM14:
   419→    """军规M14: 平今平昨分离测试."""
   420→
   421→    RULE_ID = "M14.CLOSE_TODAY_SEPARATION"
   422→
   423→    @pytest.fixture
   424→    def calculator(self) -> ChinaFeeCalculator:
   425→        """创建测试用计算器实例."""
   426→        return ChinaFeeCalculator()
   427→
   428→    def test_close_today_different_from_close(self, calculator: ChinaFeeCalculator) -> None:
   429→        """测试平今与平昨费率区分."""
   430→        # CFFEX平今费率是平昨的15倍
   431→        close_result = calculator.calculate("IF2501", 4000, 1, "close")
   432→        close_today_result = calculator.calculate("IF2501", 4000, 1, "close_today")
   433→
   434→        assert close_today_result.direction == TradeDirection.CLOSE_TODAY
   435→        assert close_result.direction == TradeDirection.CLOSE
   436→        assert close_today_result.fee != close_result.fee
   437→
   438→    def test_direction_correctly_recorded(self, calculator: ChinaFeeCalculator) -> None:
   439→        """测试交易方向正确记录."""
   440→        open_result = calculator.calculate("rb2501", 3500, 10, "open")
   441→        close_result = calculator.calculate("rb2501", 3500, 10, "close")
   442→        close_today_result = calculator.calculate("rb2501", 3500, 10, "close_today")
   443→
   444→        assert open_result.direction == TradeDirection.OPEN
   445→        assert close_result.direction == TradeDirection.CLOSE
   446→        assert close_today_result.direction == TradeDirection.CLOSE_TODAY
   447→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
