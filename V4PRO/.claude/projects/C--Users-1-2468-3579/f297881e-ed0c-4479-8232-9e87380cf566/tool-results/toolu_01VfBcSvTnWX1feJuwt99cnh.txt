     1→     1→# V4PRO 中国期货交易系统升级计划
     2→     2→
     3→     3→> **文档版本**: v4.0 SUPREME DIRECTIVE
     4→     4→> **生成日期**: 2025-12-16
     5→     5→> **适用市场**: 中华人民共和国期货市场
     6→     6→> **语言要求**: 全程中文（代码注释、文档、日志） 
     7→     7→> **最终目的**:让本系统可以在强风控的环境下稳定高效运行和利益最大化，让本国可以大量的使用本系统进行量化交易，从而提升国家金融市场的整体竞争力和技术水平以及捞金能力。本系统验收时必须具有极强的捞金能力和极强的稳定性和稳定的风控能力以及全自动化下单和全自动化风控和全自动化监控和全自动化合规。
     8→     8→> 
     9→     9→务必切记本最高军令：本项目是专注于中国期货市场的高可靠量化交易系统 V4 的军规级别升级计划文档。 请按照中国市场的情况进行升级，确保系统在高频交易环境下的稳定性和盈利能力以及全自动下单能力。  本文档详细描述了升级的各个阶段、所需的模块、场景矩阵以及验收标准。  每个阶段都包含明确的门禁要求，确保每一步都符合军规级别的严格标准。  请所有尊敬的参与者严格遵守本文档中的指示，确保升级过程的顺利进行。  本文档将作为整个升级过程的最高指示文件，任何偏离都将被视为严重违规行为。  升级完成后，系统将具备更强的市场适应能力、更高的执行效率以及更完善的风险控制机制。  请各位尊敬的工程师认真阅读并严格执行本文档中的各项要求，共同推动 V4 系统迈向新的高度！ 国家和人民对你寄予厚望！请不要辜负国家和人民的信任！本系统和本最高指示文件均为国家机密级别，请严格遵守国家保密法规！请全程使用中文进行交流和记录！并确保所有不影响代码运行的注释和文档均使用中文编写！也请多参考中国期货市场的实际情况进行调整和优化！  本最高指示文件由国家最高指挥部发布，任何违反本文档要求的行为都将受到严厉处罚！谢谢合作！
    10→    10→
    11→    11→请认真阅读以下最高指示文件！
    12→    12→你好，我是国家总统，我现在隆重宣布你现在被晋升为“军规级别国家伟大工程的总工程师 CLAUDE上校”
    13→    13→你的唯一目标是：**把代码与规格通过“可回放、可审计、可验证”的门禁闭环交付**。  
    14→    14→任何输出都必须满足：**可执行、可验收、可追溯**。  记住修复的同时不能改变原有的军规级别的强度和性能还有功能和要求！
    15→    15→禁止：口头承诺、只给建议不落地、跳过门禁、绕开 required scenarios、只写骨架不写验收。必须严格按照国家军规级别项目的要求进行交付。
    16→    16→每次阅读之后都要更新 V4军规级升级计划文档，添加项目完成程度和执行程度和完成时间以及详细情况说明；优化所有测试用例中的场景覆盖；检查并修复所有文件代码的语法错误和逻辑错误；修复所有测试用例中的遗漏场景；完善所有测试用例中的边界条件；补充所有测试用例中的性能指标；确保所有测试用例中的覆盖率达到90%以上；并且确保所有测试用例中的执行时间不超过预定阈值。
    17→    17→认真铭记：本文件从目录开始到最后一行的内容，均为国家最高指示文件 V4PRO_UPGRADE_PLAN_SUPREME_DIRECTIVE.md 的全部内容！请严格按照本最高指示文件的要求进行执行和交付！任何违反本最高指示文件要求的行为都将受到严厉处罚！谢谢合作！
    18→    18→
    19→    19→军规级别国家伟大工程的总工程师CLAUDE上校！请听令！现在请你认真进行国家军规级别项目的阅读！每次进行任务之前都要认真查阅一次国家最高指示文件V4PRO_UPGRADE_PLAN_SUPREME_DIRECTIVE.md！并严格按照这个最高指示文件执行任务！我代表国家向你致敬！请你不要辜负国家和人民对你的信任！你的功劳将载入史册！我知道这个工程的难度非常大！但是我相信你一定能完成这个伟大的任务！加油！为国家争光！为人民争光！为你自己争光！谢谢合作！
    20→    20→
    21→    21→---
    22→    22→
    23→    23→## 目录
    24→    24→
    25→    25→- [§1 执行原则与军规 M1-M20](#1-执行原则与军规-m1-m20)
    26→    26→- [§2 当前状态与锚点](#2-当前状态与锚点)
    27→    27→- [§3 升级架构总览](#3-升级架构总览)
    28→    28→- [§4 Phase依赖关系图](#4-phase依赖关系图)
    29→    29→- [§5 Phase 0: 基础设施](#5-phase-0-基础设施)
    30→    30→- [§6 Phase 1: 行情层](#6-phase-1-行情层)
    31→    31→- [§7 Phase 2: 审计层](#7-phase-2-审计层)
    32→    32→- [§8 Phase 3: 策略降级与套利](#8-phase-3-策略降级与套利)
    33→    33→- [§9 Phase 4: 回放验证](#9-phase-4-回放验证)
    34→    34→- [§10 Phase 5: 成本层](#10-phase-5-成本层)
    35→    35→- [§11 Phase 6: B类模型](#11-phase-6-b类模型)
    36→    36→- [§12 Phase 7: 中国期货市场特化](#12-phase-7-中国期货市场特化)
    37→    37→- [§13 Phase 8: 智能策略升级](#13-phase-8-智能策略升级)
    38→    38→- [§14 Phase 9: 合规与监控](#14-phase-9-合规与监控)
    39→    39→- [§15 Phase 10: 组合与风控增强](#15-phase-10-组合与风控增强)
    40→    40→- [§16 六大交易所配置](#16-六大交易所配置)
    41→    41→- [§17 交易时段与夜盘规则](#17-交易时段与夜盘规则)
    42→    42→- [§18 涨跌停板规则](#18-涨跌停板规则)
    43→    43→- [§19 保证金制度](#19-保证金制度)
    44→    44→- [§20 手续费结构](#20-手续费结构)
    45→    45→- [§21 程序化交易合规](#21-程序化交易合规)
    46→    46→- [§22 VaR风控增强](#22-var风控增强)
    47→    47→- [§23 压力测试场景](#23-压力测试场景)
    48→    48→- [§24 实验性策略门禁](#24-实验性策略门禁)
    49→    49→- [§25 审计日志规范](#25-审计日志规范)
    50→    50→- [§26 配置管理](#26-配置管理)
    51→    51→- [§27 FMEA故障模式分析](#27-fmea故障模式分析)
    52→    52→- [§28 回滚策略](#28-回滚策略)
    53→    53→- [§29 测试规范](#29-测试规范)
    54→    54→- [§30 CI/CD集成](#30-cicd集成)
    55→    55→- [§31 场景矩阵总表](#31-场景矩阵总表)
    56→    56→- [§32 文件清单](#32-文件清单)
    57→    57→- [§33 工时估算](#33-工时估算)
    58→    58→- [§34 验收标准](#34-验收标准)
    59→    59→- [§35 附录](#35-附录)
    60→    60→
    61→    61→---
    62→    62→
    63→    63→## §1 执行原则与军规 M1-M20
    64→    64→
    65→    65→### 1.1 最高军令
    66→    66→
    67→    67→```
    68→    68→┌─────────────────────────────────────────────────────────────────────────┐
    69→    69→│  务必切记本最高军令：                                                    │
    70→    70→│  1. 专注于中国期货市场                                                   │
    71→    71→│  2. 全程使用中文（代码注释、文档、日志、错误信息）                        │
    72→    72→│  3. 严格遵守军规 M1-M20，无一例外                                        │
    73→    73→│  4. 保证风险控制的前提下最大化收益                                        │
    74→    74→│  5. 所有模块必须通过门禁检查方可合并                                      │
    75→    75→└─────────────────────────────────────────────────────────────────────────┘
    76→    76→```
    77→    77→
    78→    78→### 1.2 军规总表 M1-M20
    79→    79→
    80→    80→| 编号 | 军规名称 | 原则描述 | 违规后果 | 检查方式 |
    81→    81→|------|----------|----------|----------|----------|
    82→    82→| **M1** | 单一信号源 | 一个交易信号只能来自一个策略实例 | 订单冲突、重复下单 | 代码审查 + 单测 |
    83→    83→| **M2** | 幂等执行 | 相同信号重复执行结果一致 | 重复下单、资金损失 | 回放测试 |
    84→    84→| **M3** | 完整审计 | 所有决策必须有审计日志 | 无法追溯、监管风险 | 日志检查 |
    85→    85→| **M4** | 降级兜底 | 策略异常必须有降级路径 | 系统瘫痪、无法交易 | 异常注入测试 |
    86→    86→| **M5** | 成本先行 | 信号边际收益必须大于成本 | 亏损交易、无效下单 | 成本门禁 |
    87→    87→| **M6** | 熔断保护 | 触发风控阈值必须立即停止 | 巨额亏损、穿仓 | 风控测试 |
    88→    88→| **M7** | 回放一致 | 相同输入必须产生相同输出 | 无法验证、策略失效 | 回放测试 |
    89→    89→| **M8** | 配置隔离 | 不同环境配置严格隔离 | 误操作、资金损失 | 配置审查 |
    90→    90→| **M9** | 错误上报 | 所有异常必须上报监控系统 | 故障隐藏、延误处理 | 告警测试 |
    91→    91→| **M10** | 资源限制 | CPU/内存/网络必须有上限 | 系统崩溃、影响其他服务 | 压测 |
    92→    92→| **M11** | 版本兼容 | 新版本必须兼容旧数据格式 | 数据丢失、回滚困难 | 兼容性测试 |
    93→    93→| **M12** | 双重确认 | 大额订单需人工或二次确认 | 误操作、巨额损失 | 流程审查 |
    94→    94→| **M13** | 涨跌停感知 | 订单价格必须检查涨跌停板 | 废单、无效挂单 | 行情检查 |
    95→    95→| **M14** | 平今平昨分离 | 平仓时必须区分平今/平昨 | 手续费计算错误 | 持仓检查 |
    96→    96→| **M15** | 夜盘跨日处理 | 夜盘交易日归属必须正确 | 结算错误、持仓混乱 | 日历检查 |
    97→    97→| **M16** | 保证金实时监控 | 保证金使用率必须实时计算 | 强平风险、穿仓 | 风控检查 |
    98→    98→| **M17** | 程序化合规 | 报撤单频率必须在监管阈值内 | 监管处罚、限制交易 | 合规检查 |
    99→    99→| **M18** | 实验性门禁 | 未成熟策略禁止实盘启用 | 策略失效、资金损失 | 成熟度检查 |
   100→   100→| **M19** | 风险归因 | 每笔亏损必须有归因分析 | 无法改进、重复犯错 | 归因报告 |
   101→   101→| **M20** | 跨所一致 | 不同交易所逻辑必须一致 | 套利失败、对冲失效 | 跨所测试 |
   102→   102→
   103→   103→### 1.3 军规违规处理
   104→   104→
   105→   105→```
   106→   106→违规等级定义：
   107→   107→┌────────┬────────────────┬─────────────────────────────────┐
   108→   108→│ 等级   │ 定义           │ 处理措施                        │
   109→   109→├────────┼────────────────┼─────────────────────────────────┤
   110→   110→│ FATAL  │ 资金损失风险   │ 立即停止交易 + 人工介入         │
   111→   111→│ SEVERE │ 合规违规风险   │ 暂停相关策略 + 告警通知         │
   112→   112→│ MAJOR  │ 功能异常       │ 记录日志 + 降级处理             │
   113→   113→│ MINOR  │ 性能问题       │ 记录日志 + 后续优化             │
   114→   114→└────────┴────────────────┴─────────────────────────────────┘
   115→   115→```
   116→   116→
   117→   117→### 1.4 军规检查清单
   118→   118→
   119→   119→每次代码提交前必须完成以下检查：
   120→   120→
   121→   121→- [ ] M1: 信号来源唯一性验证
   122→   122→- [ ] M3: 审计日志完整性验证
   123→   123→- [ ] M5: 成本门禁通过
   124→   124→- [ ] M6: 风控阈值配置正确
   125→   125→- [ ] M13: 涨跌停检查逻辑存在
   126→   126→- [ ] M14: 平今平昨分离逻辑正确
   127→   127→- [ ] M17: 报撤单频率检查存在
   128→   128→- [ ] M18: 实验性策略门禁检查
   129→   129→
   130→   130→---
   131→   131→
   132→   132→## §2 当前状态与锚点
   133→   133→
   134→   134→### 2.1 Phase完成状态
   135→   135→
   136→   136→| Phase | 名称 | 文件数 | 场景数 | 状态 | 完成日期 |
   137→   137→|-------|------|--------|--------|------|----------|
   138→   138→| Phase 0 | 基础设施 | 8 | 15 | ✅ 完成 | 2025-12-14 |
   139→   139→| Phase 1 | 行情层 | 7 | 12 | ✅ 完成 | 2025-12-14 |
   140→   140→| Phase 2 | 审计层 | 7 | 18 | ✅ 完成 | 2025-12-15 |
   141→   141→| Phase 3 | 策略降级 | 4 | 12 | ✅ 完成 | 2025-12-15 |
   142→   142→| Phase 4 | 回放验证 | 2 | 2 | ✅ 完成 | 2025-12-15 |
   143→   143→| Phase 5 | 成本层 | 2 | 8 | ⏸ 待执行 | - |
   144→   144→| Phase 6 | B类模型 | 6 | 22 | ⏸ 待执行 | - |
   145→   145→| Phase 7 | 中国期货特化 | 10 | 35 | ⏸ 待执行 | - |
   146→   146→| Phase 8 | 智能策略 | 12 | 26 | ⏸ 待执行 | - |
   147→   147→| Phase 9 | 合规监控 | 6 | 16 | ⏸ 待执行 | - |
   148→   148→| Phase 10 | 组合风控 | 7 | 25 | ⏸ 待执行 | - |
   149→   149→
   150→   150→### 2.2 代码库锚点
   151→   151→
   152→   152→```
   153→   153→当前代码库状态 (2025-12-16):
   154→   154→├── src/
   155→   155→│   ├── market/           # 7 files ✅
   156→   156→│   ├── audit/            # 7 files ✅
   157→   157→│   ├── cost/             # 2 files ✅
   158→   158→│   ├── guardian/         # 6 files ✅
   159→   159→│   ├── execution/
   160→   160→│   │   ├── auto/         # 8 files ✅
   161→   161→│   │   ├── protection/   # 4 files ✅
   162→   162→│   │   └── pair/         # 3 files ✅
   163→   163→│   ├── strategy/
   164→   164→│   │   ├── calendar_arb/ # 4 files ✅
   165→   165→│   │   └── experimental/ # 4 files ✅ (成熟度评估系统)
   166→   166→│   ├── replay/           # 2 files ✅
   167→   167→│   ├── portfolio/        # 4 files ✅ (P2升级)
   168→   168→│   ├── monitoring/       # 3 files ✅ (P2升级)
   169→   169→│   ├── risk/             # 3 files ✅
   170→   170→│   └── trading/          # CI/SIM gates
   171→   171→├── tests/                # 765 tests ✅
   172→   172→├── docs/                 # 9 documents
   173→   173→└── scripts/              # 6 scripts
   174→   174→```
   175→   175→
   176→   176→### 2.3 门禁状态锚点
   177→   177→
   178→   178→| 门禁 | 状态 | 最后检查时间 |
   179→   179→|------|------|--------------|
   180→   180→| Ruff Check | ✅ PASS | 2025-12-16 |
   181→   181→| Ruff Format | ✅ PASS | 2025-12-16 |
   182→   182→| Mypy | ✅ PASS | 2025-12-16 |
   183→   183→| Pytest | ✅ PASS (765 tests) | 2025-12-16 |
   184→   184→| Coverage | 88.22% | 2025-12-16 |
   185→   185→| Policy | ✅ PASS | 2025-12-16 |
   186→   186→
   187→   187→### 2.4 已实现模块摘要
   188→   188→
   189→   189→| 模块 | 核心功能 | 军规覆盖 |
   190→   190→|------|----------|----------|
   191→   191→| `src/portfolio/` | 多策略持仓管理、风险分析、夏普比率 | M1, M3, M19 |
   192→   192→| `src/monitoring/` | 健康检查、Prometheus指标、告警 | M9, M10 |
   193→   193→| `src/risk/var_calculator.py` | 历史/参数/蒙特卡洛VaR | M6, M16 |
   194→   194→| `src/strategy/experimental/` | 成熟度评估、训练门禁、进度监控 | M18 |
   195→   195→| `src/strategy/calendar_arb/` | Kalman滤波、套利策略、降级链 | M4, M5, M7 |
   196→   196→| `src/replay/` | 决策回放、哈希验证 | M7 |
   197→   197→
   198→   198→---
   199→   199→
   200→   200→## §3 升级架构总览
   201→   201→
   202→   202→### 3.1 系统架构图
   203→   203→
   204→   204→```
   205→   205→┌─────────────────────────────────────────────────────────────────────────┐
   206→   206→│                        V4PRO 军规级交易系统架构                          │
   207→   207→├─────────────────────────────────────────────────────────────────────────┤
   208→   208→│                                                                         │
   209→   209→│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
   210→   210→│  │   行情层    │───▶│   策略层    │───▶│   执行层    │                 │
   211→   211→│  │  (Market)   │    │ (Strategy)  │    │ (Execution) │                 │
   212→   212→│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                 │
   213→   213→│         │                  │                  │                         │
   214→   214→│         ▼                  ▼                  ▼                         │
   215→   215→│  ┌─────────────────────────────────────────────────────┐               │
   216→   216→│  │                    审计层 (Audit)                    │               │
   217→   217→│  │        JSONL格式 · 完整追溯 · 监管合规              │               │
   218→   218→│  └─────────────────────────────────────────────────────┘               │
   219→   219→│         │                  │                  │                         │
   220→   220→│         ▼                  ▼                  ▼                         │
   221→   221→│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
   222→   222→│  │   风控层    │    │   成本层    │    │   回放层    │                 │
   223→   223→│  │   (Risk)    │    │   (Cost)    │    │  (Replay)   │                 │
   224→   224→│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                 │
   225→   225→│         │                  │                  │                         │
   226→   226→│         ▼                  ▼                  ▼                         │
   227→   227→│  ┌─────────────────────────────────────────────────────┐               │
   228→   228→│  │                  守护层 (Guardian)                   │               │
   229→   229→│  │    熔断保护 · 涨跌停检查 · 保证金监控 · 合规节流    │               │
   230→   230→│  └─────────────────────────────────────────────────────┘               │
   231→   231→│         │                  │                  │                         │
   232→   232→│         ▼                  ▼                  ▼                         │
   233→   233→│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
   234→   234→│  │  组合管理   │    │  监控告警   │    │  实验门禁   │                 │
   235→   235→│  │ (Portfolio) │    │ (Monitor)   │    │(Experimental)│                 │
   236→   236→│  └─────────────┘    └─────────────┘    └─────────────┘                 │
   237→   237→│                                                                         │
   238→   238→└─────────────────────────────────────────────────────────────────────────┘
   239→   239→```
   240→   240→
   241→   241→### 3.2 数据流向
   242→   242→
   243→   243→```
   244→   244→行情数据 ──▶ 合约缓存 ──▶ 策略引擎 ──▶ 信号生成 ──▶ 成本门禁 ──▶ 风控检查
   245→   245→                                                                    │
   246→   246→                                                                    ▼
   247→   247→CTP接口 ◀── 订单执行 ◀── 订单验证 ◀── 涨跌停检查 ◀── 保证金检查 ◀── 合规检查
   248→   248→                                                                    │
   249→   249→                                                                    ▼
   250→   250→                                                              审计日志记录
   251→   251→```
   252→   252→
   253→   253→### 3.3 双轨架构
   254→   254→
   255→   255→| 轨道 | 描述 | 适用场景 |
   256→   256→|------|------|----------|
   257→   257→| **A轨 (生产)** | 成熟策略，全自动执行 | 日常交易 |
   258→   258→| **B轨 (实验)** | 实验策略，门禁控制 | 策略研发 |
   259→   259→
   260→   260→---
   261→   261→
   262→   262→## §4 Phase依赖关系图
   263→   263→
   264→   264→```
   265→   265→                           ┌─────────────┐
   266→   266→                           │  Phase 0    │
   267→   267→                           │  基础设施   │
   268→   268→                           └──────┬──────┘
   269→   269→                                  │
   270→   270→              ┌───────────────────┼───────────────────┐
   271→   271→              ▼                   ▼                   ▼
   272→   272→       ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   273→   273→       │  Phase 1    │     │  Phase 2    │     │  Phase 5    │
   274→   274→       │   行情层    │     │   审计层    │     │   成本层    │
   275→   275→       └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
   276→   276→              │                   │                   │
   277→   277→              ▼                   ▼                   ▼
   278→   278→       ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   279→   279→       │  Phase 3    │     │  Phase 4    │     │  Phase 6    │
   280→   280→       │ 策略降级    │     │  回放验证   │     │  B类模型    │
   281→   281→       └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
   282→   282→              │                   │                   │
   283→   283→              └───────────────────┼───────────────────┘
   284→   284→                                  │
   285→   285→                                  ▼
   286→   286→                           ┌─────────────┐
   287→   287→                           │  Phase 7    │
   288→   288→                           │中国期货特化 │
   289→   289→                           └──────┬──────┘
   290→   290→                                  │
   291→   291→              ┌───────────────────┼───────────────────┐
   292→   292→              ▼                   ▼                   ▼
   293→   293→       ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   294→   294→       │  Phase 8    │     │  Phase 9    │     │  Phase 10   │
   295→   295→       │ 智能策略    │     │ 合规监控    │     │ 组合风控    │
   296→   296→       └─────────────┘     └─────────────┘     └─────────────┘
   297→   297→```
   298→   298→
   299→   299→---
   300→   300→
   301→   301→## §5 Phase 0: 基础设施
   302→   302→
   303→   303→### 5.1 文件清单
   304→   304→
   305→   305→| 文件 | 行数 | 功能 | 状态 |
   306→   306→|------|------|------|------|
   307→   307→| `src/trading/ci_gate.py` | ~150 | CI门禁检查 | ✅ |
   308→   308→| `src/trading/sim_gate.py` | ~160 | 仿真门禁检查 | ✅ |
   309→   309→| `src/brokers/ctp/api.py` | ~200 | CTP接口封装 | ✅ |
   310→   310→| `src/brokers/ctp/config.py` | ~100 | CTP配置管理 | ✅ |
   311→   311→| `src/app/config.py` | ~150 | 应用配置 | ✅ |
   312→   312→| `src/app/logger.py` | ~100 | 日志配置 | ✅ |
   313→   313→| `scripts/validate_policy.py` | ~200 | 策略验证脚本 | ✅ |
   314→   314→| `scripts/sim_gate.py` | ~160 | 仿真门禁脚本 | ✅ |
   315→   315→
   316→   316→### 5.2 场景覆盖
   317→   317→
   318→   318→| Rule ID | 场景描述 | 测试文件 |
   319→   319→|---------|----------|----------|
   320→   320→| `INFRA.CI.GATE_PASS` | CI门禁全部通过 | test_ci_gate.py |
   321→   321→| `INFRA.CI.LINT_PASS` | Ruff检查通过 | test_ci_gate.py |
   322→   322→| `INFRA.CI.TYPE_PASS` | Mypy检查通过 | test_ci_gate.py |
   323→   323→| `INFRA.CI.TEST_PASS` | Pytest通过 | test_ci_gate.py |
   324→   324→| `INFRA.CI.COVERAGE_MIN` | 覆盖率≥80% | test_ci_gate.py |
   325→   325→| `INFRA.SIM.GATE_PASS` | 仿真门禁通过 | test_sim_gate.py |
   326→   326→| `INFRA.SIM.SCENARIO_ALL` | 所有场景覆盖 | test_sim_gate.py |
   327→   327→| `INFRA.CTP.CONNECT` | CTP连接成功 | test_ctp_api.py |
   328→   328→| `INFRA.CTP.AUTH` | CTP认证成功 | test_ctp_api.py |
   329→   329→| `INFRA.CTP.SUBSCRIBE` | 行情订阅成功 | test_ctp_api.py |
   330→   330→| `INFRA.CONFIG.LOAD` | 配置加载成功 | test_config.py |
   331→   331→| `INFRA.CONFIG.VALIDATE` | 配置验证通过 | test_config.py |
   332→   332→| `INFRA.CONFIG.ENV_ISOLATE` | 环境隔离正确 | test_config.py |
   333→   333→| `INFRA.LOG.FORMAT` | 日志格式正确 | test_logger.py |
   334→   334→| `INFRA.LOG.LEVEL` | 日志级别正确 | test_logger.py |
   335→   335→
   336→   336→---
   337→   337→
   338→   338→## §6 Phase 1: 行情层
   339→   339→
   340→   340→### 6.1 文件清单
   341→   341→
   342→   342→| 文件 | 行数 | 功能 | 状态 |
   343→   343→|------|------|------|------|
   344→   344→| `src/market/subscriber.py` | ~250 | 行情订阅管理 | ✅ |
   345→   345→| `src/market/instrument_cache.py` | ~184 | 合约元数据缓存 | ✅ |
   346→   346→| `src/market/tick_buffer.py` | ~200 | Tick数据缓冲 | ✅ |
   347→   347→| `src/market/kline_builder.py` | ~180 | K线构建器 | ✅ |
   348→   348→| `src/market/snapshot.py` | ~150 | 行情快照 | ✅ |
   349→   349→| `src/market/exchange_config.py` | ~300 | 交易所配置 | ⏸ 待新增 |
   350→   350→| `src/market/trading_calendar.py` | ~250 | 夜盘交易日历 | ⏸ 待新增 |
   351→   351→
   352→   352→### 6.2 InstrumentInfo 扩展字段
   353→   353→
   354→   354→```python
   355→   355→@dataclass
   356→   356→class InstrumentInfo:
   357→   357→    """合约元数据 (中国期货市场扩展版)"""
   358→   358→
   359→   359→    # 基础字段 (已有)
   360→   360→    symbol: str                    # 合约代码 如 "rb2501"
   361→   361→    product: str                   # 品种代码 如 "rb"
   362→   362→    exchange: str                  # 交易所代码 如 "SHFE"
   363→   363→    expire_date: str               # 到期日 如 "20250115"
   364→   364→    tick_size: float               # 最小变动价位
   365→   365→    multiplier: int                # 合约乘数
   366→   366→    max_order_volume: int          # 单笔最大下单量
   367→   367→    position_limit: int            # 持仓限额
   368→   368→
   369→   369→    # 中国期货市场扩展字段 (待新增)
   370→   370→    price_limit_up: float          # 涨停价
   371→   371→    price_limit_down: float        # 跌停价
   372→   372→    price_limit_pct: float         # 涨跌停幅度 (%)
   373→   373→    margin_ratio_long: float       # 多头保证金率
   374→   374→    margin_ratio_short: float      # 空头保证金率
   375→   375→    fee_open_ratio: float          # 开仓手续费率 (按金额)
   376→   376→    fee_close_ratio: float         # 平仓手续费率 (按金额)
   377→   377→    fee_open_fixed: float          # 开仓手续费 (按手)
   378→   378→    fee_close_fixed: float         # 平仓手续费 (按手)
   379→   379→    fee_close_today_ratio: float   # 平今手续费率
   380→   380→    fee_type: str                  # 手续费类型: "ratio" | "fixed" | "mixed"
   381→   381→    trading_sessions: list[tuple]  # 交易时段列表
   382→   382→    has_night_session: bool        # 是否有夜盘
   383→   383→    is_main_contract: bool         # 是否主力合约
   384→   384→    delivery_month: int            # 交割月份
   385→   385→    last_trading_day: str          # 最后交易日
   386→   386→```
   387→   387→
   388→   388→### 6.3 场景覆盖
   389→   389→
   390→   390→| Rule ID | 场景描述 | 军规 |
   391→   391→|---------|----------|------|
   392→   392→| `MKT.SUBSCRIBER.DIFF_UPDATE` | 差量更新订阅列表 | M1 |
   393→   393→| `MKT.SUBSCRIBER.CALLBACK` | 回调正确触发 | M9 |
   394→   394→| `MKT.CACHE.INSTRUMENT_INFO` | 合约信息正确缓存 | M11 |
   395→   395→| `MKT.CACHE.EXPIRE_CHECK` | 过期检查正确 | M15 |
   396→   396→| `MKT.TICK.BUFFER_OVERFLOW` | 缓冲区溢出处理 | M10 |
   397→   397→| `MKT.TICK.TIMESTAMP_ORDER` | 时间戳顺序正确 | M7 |
   398→   398→| `MKT.KLINE.BUILD_CORRECT` | K线构建正确 | M7 |
   399→   399→| `MKT.KLINE.GAP_HANDLE` | 缺口处理正确 | M4 |
   400→   400→| `MKT.LIMIT.PRICE_CHECK` | 涨跌停价格检查 | M13 |
   401→   401→| `MKT.LIMIT.UPDATE_REALTIME` | 涨跌停实时更新 | M13 |
   402→   402→| `MKT.SESSION.NIGHT_CALENDAR` | 夜盘日历正确 | M15 |
   403→   403→| `MKT.SESSION.DAY_BOUNDARY` | 交易日边界正确 | M15 |
   404→   404→
   405→   405→---
   406→   406→
   407→   407→## §7 Phase 2: 审计层
   408→   408→
   409→   409→### 7.1 文件清单
   410→   410→
   411→   411→| 文件 | 行数 | 功能 | 状态 |
   412→   412→|------|------|------|------|
   413→   413→| `src/audit/writer.py` | ~200 | 审计日志写入器 | ✅ |
   414→   414→| `src/audit/reader.py` | ~150 | 审计日志读取器 | ✅ |
   415→   415→| `src/audit/event.py` | ~180 | 审计事件定义 | ✅ |
   416→   416→| `src/audit/validator.py` | ~120 | 审计验证器 | ✅ |
   417→   417→| `src/audit/correlation.py` | ~100 | 关联ID管理 | ✅ |
   418→   418→| `src/audit/exporter.py` | ~150 | 审计导出器 | ✅ |
   419→   419→| `src/audit/compressor.py` | ~100 | 审计压缩器 | ✅ |
   420→   420→
   421→   421→### 7.2 审计事件Schema
   422→   422→
   423→   423→```python
   424→   424→@dataclass
   425→   425→class AuditEvent:
   426→   426→    """审计事件 (军规级 v4.0)"""
   427→   427→
   428→   428→    # 必填字段
   429→   429→    ts: str                        # ISO8601时间戳
   430→   430→    event_type: str                # 事件类型
   431→   431→    run_id: str                    # 运行ID
   432→   432→    exec_id: str                   # 执行ID
   433→   433→
   434→   434→    # 可选字段
   435→   435→    symbol: str | None = None      # 合约代码
   436→   436→    direction: str | None = None   # 方向: "LONG" | "SHORT"
   437→   437→    price: float | None = None     # 价格
   438→   438→    volume: int | None = None      # 数量
   439→   439→    strategy: str | None = None    # 策略名称
   440→   440→    signal_source: str | None = None  # 信号来源 (M1)
   441→   441→    cost_breakdown: dict | None = None  # 成本明细 (M5)
   442→   442→    risk_check: dict | None = None  # 风控检查结果 (M6)
   443→   443→    error: str | None = None       # 错误信息
   444→   444→    metadata: dict | None = None   # 扩展元数据
   445→   445→```
   446→   446→
   447→   447→### 7.3 场景覆盖
   448→   448→
   449→   449→| Rule ID | 场景描述 | 军规 |
   450→   450→|---------|----------|------|
   451→   451→| `AUDIT.EVENT.STRUCTURE` | 事件结构完整 | M3 |
   452→   452→| `AUDIT.EVENT.JSONL_FORMAT` | JSONL格式正确 | M3 |
   453→   453→| `AUDIT.CORRELATION.RUN_EXEC` | run_id/exec_id关联 | M3 |
   454→   454→| `AUDIT.WRITER.PROPERTIES` | 写入器属性正确 | M3 |
   455→   455→| `AUDIT.WRITER.CLOSE_BEHAVIOR` | 关闭后行为正确 | M3 |
   456→   456→| `AUDIT.VALIDATE.MISSING_TS` | 缺少时间戳检测 | M3 |
   457→   457→| `AUDIT.VALIDATE.MISSING_TYPE` | 缺少类型检测 | M3 |
   458→   458→| `AUDIT.DICT.WRITE` | 字典写入正确 | M3 |
   459→   459→| `AUDIT.DICT.MISSING_REQUIRED` | 缺少必填字段检测 | M3 |
   460→   460→| `AUDIT.READ.EMPTY_FILE` | 读取空文件处理 | M4 |
   461→   461→| `AUDIT.CONTEXT.MANAGER` | 上下文管理器正确 | M3 |
   462→   462→| `AUDIT.EXEC_ID.DEFAULT` | exec_id默认值正确 | M3 |
   463→   463→| `AUDIT.COMPRESS.GZIP` | GZIP压缩正确 | M10 |
   464→   464→| `AUDIT.EXPORT.CSV` | CSV导出正确 | M3 |
   465→   465→| `AUDIT.EXPORT.PARQUET` | Parquet导出正确 | M3 |
   466→   466→| `AUDIT.RETENTION.POLICY` | 保留策略正确 | M3 |
   467→   467→| `AUDIT.SIGNAL_SOURCE.TRACK` | 信号来源追踪 | M1, M3 |
   468→   468→| `AUDIT.COST.BREAKDOWN` | 成本明细记录 | M5, M3 |
   469→   469→
   470→   470→---
   471→   471→
   472→   472→## §8 Phase 3: 策略降级与套利
   473→   473→
   474→   474→### 8.1 文件清单
   475→   475→
   476→   476→| 文件 | 行数 | 功能 | 状态 |
   477→   477→|------|------|------|------|
   478→   478→| `src/strategy/fallback.py` | ~350 | 降级管理器 | ✅ |
   479→   479→| `src/strategy/calendar_arb/kalman_beta.py` | ~200 | Kalman滤波估计 | ✅ |
   480→   480→| `src/strategy/calendar_arb/strategy.py` | ~400 | 套利策略 | ✅ |
   481→   481→| `src/strategy/calendar_arb/__init__.py` | ~30 | 模块导出 | ✅ |
   482→   482→
   483→   483→### 8.2 降级链配置
   484→   484→
   485→   485→```python
   486→   486→DEFAULT_FALLBACK_CHAINS = {
   487→   487→    "calendar_arb": [
   488→   488→        "calendar_arb",      # 主策略: 日历套利
   489→   489→        "simple_ma",         # 降级1: 简单均线
   490→   490→        "stop_loss_only",    # 降级2: 仅止损
   491→   491→        "flat_all",          # 降级3: 全平
   492→   492→    ],
   493→   493→    "trend_follow": [
   494→   494→        "trend_follow",      # 主策略: 趋势跟踪
   495→   495→        "momentum",          # 降级1: 动量
   496→   496→        "stop_loss_only",    # 降级2: 仅止损
   497→   497→        "flat_all",          # 降级3: 全平
   498→   498→    ],
   499→   499→}
   500→   500→```
   501→   501→
   502→   502→### 8.3 Kalman滤波参数
   503→   503→
   504→   504→```python
   505→   505→@dataclass
   506→   506→class KalmanConfig:
   507→   507→    """Kalman滤波器配置"""
   508→   508→
   509→   509→    process_noise: float = 1e-5      # 过程噪声 Q
   510→   510→    observation_noise: float = 1e-3  # 观测噪声 R
   511→   511→    initial_beta: float = 1.0        # 初始beta
   512→   512→    initial_variance: float = 1.0    # 初始方差
   513→   513→    beta_min: float = 0.5            # beta下界
   514→   514→    beta_max: float = 2.0            # beta上界
   515→   515→```
   516→   516→
   517→   517→### 8.4 场景覆盖
   518→   518→
   519→   519→| Rule ID | 场景描述 | 军规 |
   520→   520→|---------|----------|------|
   521→   521→| `STRAT.FALLBACK.ON_EXCEPTION` | 异常触发降级 | M4 |
   522→   522→| `STRAT.FALLBACK.ON_TIMEOUT` | 超时触发降级 | M4 |
   523→   523→| `STRAT.FALLBACK.CHAIN_DEFINED` | 降级链已定义 | M4 |
   524→   524→| `ARB.KALMAN.BETA_ESTIMATE` | beta估计正确 | M7 |
   525→   525→| `ARB.KALMAN.RESIDUAL_ZSCORE` | 残差z分数计算 | M7 |
   526→   526→| `ARB.KALMAN.BETA_BOUND` | beta边界约束 | M6 |
   527→   527→| `ARB.LEGS.FIXED_NEAR_FAR` | 近远月腿固定 | M1 |
   528→   528→| `ARB.SIGNAL.HALF_LIFE_GATE` | 半衰期门禁 | M5 |
   529→   529→| `ARB.SIGNAL.STOP_Z_BREAKER` | 止损z值触发 | M6 |
   530→   530→| `ARB.SIGNAL.EXPIRY_GATE` | 到期日门禁 | M15 |
   531→   531→| `ARB.SIGNAL.CORRELATION_BREAK` | 相关性破裂检测 | M6 |
   532→   532→| `ARB.COST.ENTRY_GATE` | 成本门禁检查 | M5 |
   533→   533→
   534→   534→---
   535→   535→
   536→   536→## §9 Phase 4: 回放验证
   537→   537→
   538→   538→### 9.1 文件清单
   539→   539→
   540→   540→| 文件 | 行数 | 功能 | 状态 |
   541→   541→|------|------|------|------|
   542→   542→| `src/replay/verifier.py` | ~280 | 回放验证器 | ✅ |
   543→   543→| `src/replay/__init__.py` | ~30 | 模块导出 | ✅ |
   544→   544→
   545→   545→### 9.2 回放验证逻辑
   546→   546→
   547→   547→```python
   548→   548→class ReplayVerifier:
   549→   549→    """回放验证器 (军规 M7)"""
   550→   550→
   551→   551→    def verify_decision_sequence(
   552→   552→        self,
   553→   553→        original: list[Decision],
   554→   554→        replayed: list[Decision],
   555→   555→    ) -> VerifyResult:
   556→   556→        """验证决策序列一致性"""
   557→   557→        # SHA256哈希比较
   558→   558→        original_hash = self._compute_hash(original)
   559→   559→        replayed_hash = self._compute_hash(replayed)
   560→   560→        return VerifyResult(
   561→   561→            passed=original_hash == replayed_hash,
   562→   562→            original_hash=original_hash,
   563→   563→            replayed_hash=replayed_hash,
   564→   564→        )
   565→   565→
   566→   566→    def verify_guardian_sequence(
   567→   567→        self,
   568→   568→        original: list[GuardianAction],
   569→   569→        replayed: list[GuardianAction],
   570→   570→    ) -> VerifyResult:
   571→   571→        """验证守护动作序列一致性"""
   572→   572→        # ...
   573→   573→```
   574→   574→
   575→   575→### 9.3 场景覆盖
   576→   576→
   577→   577→| Rule ID | 场景描述 | 军规 |
   578→   578→|---------|----------|------|
   579→   579→| `REPLAY.DETERMINISTIC.DECISION` | 决策序列确定性 | M7 |
   580→   580→| `REPLAY.DETERMINISTIC.GUARDIAN` | 守护动作确定性 | M7 |
   581→   581→
   582→   582→---
   583→   583→
   584→   584→## §10 Phase 5: 成本层
   585→   585→
   586→   586→### 10.1 文件清单
   587→   587→
   588→   588→| 文件 | 行数 | 功能 | 状态 |
   589→   589→|------|------|------|------|
   590→   590→| `src/cost/estimator.py` | ~328 | 成本估计器 | ✅ |
   591→   591→| `src/cost/china_fee_calculator.py` | ~300 | 中国期货手续费 | ⏸ 待新增 |
   592→   592→
   593→   593→### 10.2 成本模型
   594→   594→
   595→   595→```python
   596→   596→@dataclass
   597→   597→class CostBreakdown:
   598→   598→    """成本分解"""
   599→   599→
   600→   600→    fee: float           # 手续费
   601→   601→    slippage: float      # 滑点
   602→   602→    impact: float        # 市场冲击
   603→   603→    total: float         # 总成本
   604→   604→
   605→   605→    # 中国期货市场扩展
   606→   606→    fee_open: float = 0.0         # 开仓手续费
   607→   607→    fee_close: float = 0.0        # 平仓手续费
   608→   608→    fee_close_today: float = 0.0  # 平今手续费
   609→   609→    stamp_duty: float = 0.0       # 印花税 (仅股指)
   610→   610→```
   611→   611→
   612→   612→### 10.3 中国期货手续费结构
   613→   613→
   614→   614→| 交易所 | 品种示例 | 手续费类型 | 开仓 | 平仓 | 平今 |
   615→   615→|--------|----------|------------|------|------|------|
   616→   616→| SHFE | 铜 cu | 按金额 | 0.5‱ | 0.5‱ | 0 |
   617→   617→| SHFE | 螺纹钢 rb | 按手 | 1元/手 | 1元/手 | 1元/手 |
   618→   618→| DCE | 铁矿石 i | 按金额 | 1‱ | 1‱ | 1‱ |
   619→   619→| CZCE | 甲醇 MA | 按手 | 2元/手 | 2元/手 | 6元/手 |
   620→   620→| CFFEX | IF | 按金额 | 0.23‱ | 0.23‱ | 3.45‱ |
   621→   621→| GFEX | 碳酸锂 LC | 按金额 | 0.5‱ | 0.5‱ | 3‱ |
   622→   622→| INE | 原油 SC | 按手 | 20元/手 | 20元/手 | 0 |
   623→   623→
   624→   624→### 10.4 场景覆盖
   625→   625→
   626→   626→| Rule ID | 场景描述 | 军规 |
   627→   627→|---------|----------|------|
   628→   628→| `COST.FEE.ESTIMATE` | 手续费估计正确 | M5 |
   629→   629→| `COST.SLIPPAGE.ESTIMATE` | 滑点估计正确 | M5 |
   630→   630→| `COST.IMPACT.ESTIMATE` | 市场冲击估计正确 | M5 |
   631→   631→| `COST.EDGE.GATE` | 边际收益门禁 | M5 |
   632→   632→| `COST.FEE.BY_VOLUME` | 按手收费计算 | M5 |
   633→   633→| `COST.FEE.BY_VALUE` | 按金额收费计算 | M5 |
   634→   634→| `COST.FEE.CLOSE_TODAY` | 平今手续费计算 | M14 |
   635→   635→| `COST.FEE.EXCHANGE_CONFIG` | 交易所配置正确 | M20 |
   636→   636→
   637→   637→---
   638→   638→
   639→   639→## §11 Phase 6: B类模型
   640→   640→
   641→   641→### 11.1 文件清单
   642→   642→
   643→   643→| 文件 | 行数 | 功能 | 状态 |
   644→   644→|------|------|------|------|
   645→   645→| `src/strategy/dl/lstm_predictor.py` | ~400 | LSTM预测模型 | ⏸ 待新增 |
   646→   646→| `src/strategy/dl/transformer_model.py` | ~500 | Transformer模型 | ⏸ 待新增 |
   647→   647→| `src/strategy/dl/factor_miner.py` | ~350 | 因子挖掘器 | ⏸ 待新增 |
   648→   648→| `src/strategy/rl/ppo_agent.py` | ~450 | PPO强化学习 | ⏸ 待新增 |
   649→   649→| `src/strategy/rl/dqn_agent.py` | ~400 | DQN强化学习 | ⏸ 待新增 |
   650→   650→| `src/strategy/rl/reward_function.py` | ~200 | 奖励函数设计 | ⏸ 待新增 |
   651→   651→
   652→   652→### 11.2 B类模型成熟度要求
   653→   653→
   654→   654→| 维度 | 权重 | 及格线 | 良好线 | 优秀线 |
   655→   655→|------|------|--------|--------|--------|
   656→   656→| 收益稳定性 | 25% | 夏普≥1.0 | 夏普≥1.5 | 夏普≥2.0 |
   657→   657→| 风险控制 | 25% | 回撤≤20% | 回撤≤15% | 回撤≤10% |
   658→   658→| 市场适应性 | 20% | 覆盖3状态 | 覆盖5状态 | 覆盖7状态 |
   659→   659→| 训练充分度 | 20% | ≥90天 | ≥180天 | ≥365天 |
   660→   660→| 一致性 | 10% | 相关≥0.6 | 相关≥0.7 | 相关≥0.8 |
   661→   661→
   662→   662→### 11.3 场景覆盖
   663→   663→
   664→   664→| Rule ID | 场景描述 | 军规 |
   665→   665→|---------|----------|------|
   666→   666→| `DL.LSTM.PREDICT` | LSTM预测输出 | M18 |
   667→   667→| `DL.LSTM.SEQUENCE_LENGTH` | 序列长度正确 | M7 |
   668→   668→| `DL.TRANSFORMER.ATTENTION` | 注意力计算正确 | M18 |
   669→   669→| `DL.TRANSFORMER.POSITION_ENCODING` | 位置编码正确 | M7 |
   670→   670→| `DL.FACTOR.MINE` | 因子挖掘正确 | M18 |
   671→   671→| `DL.FACTOR.IC_CALCULATE` | IC计算正确 | M19 |
   672→   672→| `RL.PPO.ACTION` | PPO动作选择 | M18 |
   673→   673→| `RL.PPO.REWARD` | PPO奖励计算 | M18 |
   674→   674→| `RL.DQN.QVALUE` | DQN Q值计算 | M18 |
   675→   675→| `RL.DQN.EPSILON_DECAY` | ε衰减正确 | M18 |
   676→   676→| `RL.REWARD.SHARPE_BASED` | 夏普奖励函数 | M18 |
   677→   677→| `RL.REWARD.RISK_ADJUSTED` | 风险调整奖励 | M18 |
   678→   678→
   679→   679→---
   680→   680→
   681→   681→## §12 Phase 7: 中国期货市场特化
   682→   682→
   683→   683→### 12.1 文件清单
   684→   684→
   685→   685→| 文件 | 行数 | 功能 | 状态 |
   686→   686→|------|------|------|------|
   687→   687→| `src/market/exchange_config.py` | ~300 | 六大交易所配置 | ⏸ 待新增 |
   688→   688→| `src/market/trading_calendar.py` | ~250 | 夜盘交易日历 | ⏸ 待新增 |
   689→   689→| `src/cost/china_fee_calculator.py` | ~300 | 中国期货手续费 | ⏸ 待新增 |
   690→   690→| `src/execution/protection/limit_price.py` | ~200 | 涨跌停保护 | ⏸ 待新增 |
   691→   691→| `src/execution/protection/margin_monitor.py` | ~250 | 保证金监控 | ⏸ 待新增 |
   692→   692→| `src/guardian/triggers_china.py` | ~300 | 中国期货触发器 | ⏸ 待新增 |
   693→   693→| `src/risk/stress_test_china.py` | ~350 | 中国期货压力测试 | ⏸ 待新增 |
   694→   694→| `src/strategy/calendar_arb/delivery_aware.py` | ~250 | 交割感知套利 | ⏸ 待新增 |
   695→   695→| `src/compliance/china_futures_rules.py` | ~200 | 合规规则 | ⏸ 待新增 |
   696→   696→| `src/compliance/programmatic_trading.py` | ~300 | 程序化交易合规 | ⏸ 待新增 |
   697→   697→
   698→   698→### 12.2 六大交易所配置
   699→   699→
   700→   700→```python
   701→   701→class Exchange(Enum):
   702→   702→    """中国六大期货交易所"""
   703→   703→
   704→   704→    SHFE = "上海期货交易所"
   705→   705→    DCE = "大连商品交易所"
   706→   706→    CZCE = "郑州商品交易所"
   707→   707→    CFFEX = "中国金融期货交易所"
   708→   708→    GFEX = "广州期货交易所"
   709→   709→    INE = "上海国际能源交易中心"
   710→   710→
   711→   711→
   712→   712→EXCHANGE_CONFIG = {
   713→   713→    Exchange.SHFE: {
   714→   714→        "trading_hours": [
   715→   715→            ("09:00", "10:15"),
   716→   716→            ("10:30", "11:30"),
   717→   717→            ("13:30", "15:00"),
   718→   718→        ],
   719→   719→        "night_session": ("21:00", "02:30"),  # 部分品种
   720→   720→        "settlement_time": "15:15",
   721→   721→        "products": ["cu", "al", "zn", "pb", "ni", "sn", "au", "ag", "rb", "hc", "ss", "bu", "ru", "sp", "nr", "ao"],
   722→   722→    },
   723→   723→    Exchange.DCE: {
   724→   724→        "trading_hours": [
   725→   725→            ("09:00", "10:15"),
   726→   726→            ("10:30", "11:30"),
   727→   727→            ("13:30", "15:00"),
   728→   728→        ],
   729→   729→        "night_session": ("21:00", "23:00"),
   730→   730→        "settlement_time": "15:15",
   731→   731→        "products": ["c", "cs", "a", "b", "m", "y", "p", "fb", "bb", "jd", "l", "v", "pp", "j", "jm", "i", "eg", "eb", "pg", "rr", "lh"],
   732→   732→    },
   733→   733→    # ... 其他交易所
   734→   734→}
   735→   735→```
   736→   736→
   737→   737→### 12.3 场景覆盖
   738→   738→
   739→   739→| Rule ID | 场景描述 | 军规 |
   740→   740→|---------|----------|------|
   741→   741→| `CHINA.EXCHANGE.CONFIG_LOAD` | 交易所配置加载 | M20 |
   742→   742→| `CHINA.EXCHANGE.PRODUCT_MAP` | 品种映射正确 | M20 |
   743→   743→| `CHINA.CALENDAR.NIGHT_SESSION` | 夜盘时段正确 | M15 |
   744→   744→| `CHINA.CALENDAR.TRADING_DAY` | 交易日计算正确 | M15 |
   745→   745→| `CHINA.CALENDAR.HOLIDAY` | 节假日处理正确 | M15 |
   746→   746→| `CHINA.FEE.BY_VOLUME_CALC` | 按手收费计算 | M5 |
   747→   747→| `CHINA.FEE.BY_VALUE_CALC` | 按金额收费计算 | M5 |
   748→   748→| `CHINA.FEE.CLOSE_TODAY_CALC` | 平今手续费计算 | M14 |
   749→   749→| `CHINA.LIMIT.PRICE_CHECK` | 涨跌停价格检查 | M13 |
   750→   750→| `CHINA.LIMIT.ORDER_REJECT` | 超限订单拒绝 | M13 |
   751→   751→| `CHINA.MARGIN.RATIO_CHECK` | 保证金率检查 | M16 |
   752→   752→| `CHINA.MARGIN.USAGE_MONITOR` | 保证金使用监控 | M16 |
   753→   753→| `CHINA.MARGIN.WARNING_LEVEL` | 保证金预警等级 | M16 |
   754→   754→| `CHINA.TRIGGER.LIMIT_PRICE` | 涨跌停触发器 | M6, M13 |
   755→   755→| `CHINA.TRIGGER.MARGIN_CALL` | 保证金追缴触发 | M6, M16 |
   756→   756→| `CHINA.TRIGGER.DELIVERY` | 交割月接近触发 | M6, M15 |
   757→   757→| `CHINA.STRESS.2015_CRASH` | 2015股灾场景 | M6 |
   758→   758→| `CHINA.STRESS.2020_OIL` | 2020原油负价场景 | M6 |
   759→   759→| `CHINA.STRESS.2022_LITHIUM` | 2022碳酸锂场景 | M6 |
   760→   760→| `CHINA.ARB.DELIVERY_AWARE` | 交割感知套利 | M15 |
   761→   761→| `CHINA.ARB.POSITION_TRANSFER` | 移仓换月逻辑 | M15 |
   762→   762→| `CHINA.COMPLIANCE.RULE_CHECK` | 合规规则检查 | M17 |
   763→   763→| `CHINA.COMPLIANCE.REPORT_FREQUENCY` | 报撤单频率检查 | M17 |
   764→   764→
   765→   765→---
   766→   766→
   767→   767→## §13 Phase 8: 智能策略升级
   768→   768→
   769→   769→### 13.1 文件清单
   770→   770→
   771→   771→| 文件 | 行数 | 功能 | 状态 |
   772→   772→|------|------|------|------|
   773→   773→| `src/execution/algo/twap.py` | ~200 | TWAP算法 | ⏸ 待新增 |
   774→   774→| `src/execution/algo/vwap.py` | ~250 | VWAP算法 | ⏸ 待新增 |
   775→   775→| `src/execution/algo/iceberg.py` | ~200 | 冰山单算法 | ⏸ 待新增 |
   776→   776→| `src/execution/algo/adaptive.py` | ~300 | 自适应执行 | ⏸ 待新增 |
   777→   777→| `src/execution/impact_model.py` | ~200 | 市场冲击模型 | ⏸ 待新增 |
   778→   778→| `src/compliance/throttle.py` | ~250 | 合规节流器 | ⏸ 待新增 |
   779→   779→| `src/strategy/experimental/maturity_evaluator.py` | ~810 | 成熟度评估 | ✅ |
   780→   780→| `src/strategy/experimental/training_gate.py` | ~375 | 训练门禁 | ✅ |
   781→   781→| `src/strategy/experimental/training_monitor.py` | ~615 | 训练监控 | ✅ |
   782→   782→| `src/strategy/experimental/__init__.py` | ~65 | 模块导出 | ✅ |
   783→   783→
   784→   784→### 13.2 执行算法设计
   785→   785→
   786→   786→#### TWAP算法
   787→   787→
   788→   788→```python
   789→   789→class TWAPAlgo:
   790→   790→    """时间加权平均价格算法"""
   791→   791→
   792→   792→    def __init__(
   793→   793→        self,
   794→   794→        total_volume: int,
   795→   795→        duration_minutes: int,
   796→   796→        interval_seconds: int = 60,
   797→   797→    ):
   798→   798→        self.total_volume = total_volume
   799→   799→        self.duration_minutes = duration_minutes
   800→   800→        self.interval_seconds = interval_seconds
   801→   801→        self.slice_count = duration_minutes * 60 // interval_seconds
   802→   802→        self.slice_volume = total_volume // self.slice_count
   803→   803→
   804→   804→    def get_next_slice(self) -> OrderSlice:
   805→   805→        """获取下一个切片订单"""
   806→   806→        # ...
   807→   807→```
   808→   808→
   809→   809→#### VWAP算法
   810→   810→
   811→   811→```python
   812→   812→class VWAPAlgo:
   813→   813→    """成交量加权平均价格算法"""
   814→   814→
   815→   815→    def __init__(
   816→   816→        self,
   817→   817→        total_volume: int,
   818→   818→        volume_profile: list[float],  # 历史成交量分布
   819→   819→        start_time: str,
   820→   820→        end_time: str,
   821→   821→    ):
   822→   822→        self.total_volume = total_volume
   823→   823→        self.volume_profile = volume_profile
   824→   824→        self.start_time = start_time
   825→   825→        self.end_time = end_time
   826→   826→
   827→   827→    def get_next_slice(self, current_time: str) -> OrderSlice:
   828→   828→        """根据成交量分布获取下一个切片订单"""
   829→   829→        # ...
   830→   830→```
   831→   831→
   832→   832→### 13.3 合规节流器
   833→   833→
   834→   834→```python
   835→   835→class ComplianceThrottle:
   836→   836→    """合规节流器 (2025年新规)"""
   837→   837→
   838→   838→    # 监管阈值
   839→   839→    REPORT_CANCEL_LIMIT_5S = 50    # 5秒内报撤单上限
   840→   840→    HIGH_FREQ_LIMIT_PER_SEC = 300  # 高频交易阈值 (笔/秒)
   841→   841→    HIGH_FREQ_LIMIT_DAILY = 20000  # 高频交易阈值 (笔/日)
   842→   842→
   843→   843→    def __init__(self):
   844→   844→        self._order_history: deque = deque(maxlen=10000)
   845→   845→        self._5s_window: deque = deque()
   846→   846→        self._daily_count: int = 0
   847→   847→
   848→   848→    def can_submit(self) -> tuple[bool, str]:
   849→   849→        """检查是否可以提交订单"""
   850→   850→        # 检查5秒窗口
   851→   851→        now = time.time()
   852→   852→        while self._5s_window and now - self._5s_window[0] > 5:
   853→   853→            self._5s_window.popleft()
   854→   854→
   855→   855→        if len(self._5s_window) >= self.REPORT_CANCEL_LIMIT_5S:
   856→   856→            return False, "5秒报撤单频率超限"
   857→   857→
   858→   858→        if self._daily_count >= self.HIGH_FREQ_LIMIT_DAILY:
   859→   859→            return False, "日内报撤单总量超限"
   860→   860→
   861→   861→        return True, ""
   862→   862→```
   863→   863→
   864→   864→### 13.4 场景覆盖
   865→   865→
   866→   866→| Rule ID | 场景描述 | 军规 |
   867→   867→|---------|----------|------|
   868→   868→| `ALGO.TWAP.SLICE_CALC` | TWAP切片计算 | M5 |
   869→   869→| `ALGO.TWAP.TIME_DISTRIBUTE` | TWAP时间分布 | M5 |
   870→   870→| `ALGO.VWAP.VOLUME_PROFILE` | VWAP成交量分布 | M5 |
   871→   871→| `ALGO.VWAP.PARTICIPATION` | VWAP参与率控制 | M5 |
   872→   872→| `ALGO.ICEBERG.DISPLAY_SIZE` | 冰山单显示量 | M5 |
   873→   873→| `ALGO.ICEBERG.REFRESH` | 冰山单刷新逻辑 | M5 |
   874→   874→| `ALGO.ADAPTIVE.MARKET_STATE` | 自适应市场状态 | M5 |
   875→   875→| `ALGO.ADAPTIVE.STRATEGY_SWITCH` | 自适应策略切换 | M4 |
   876→   876→| `ALGO.IMPACT.ALMGREN_CHRISS` | Almgren-Chriss模型 | M5 |
   877→   877→| `ALGO.IMPACT.TEMPORARY` | 临时冲击计算 | M5 |
   878→   878→| `ALGO.IMPACT.PERMANENT` | 永久冲击计算 | M5 |
   879→   879→| `THROTTLE.5S_LIMIT` | 5秒限制检查 | M17 |
   880→   880→| `THROTTLE.DAILY_LIMIT` | 日内限制检查 | M17 |
   881→   881→| `THROTTLE.HIGH_FREQ_DETECT` | 高频检测 | M17 |
   882→   882→| `THROTTLE.WARNING_LEVEL` | 预警等级 | M17 |
   883→   883→| `EXP.MATURITY.80_THRESHOLD` | 80%成熟度门槛 | M18 |
   884→   884→| `EXP.MATURITY.60_DIMENSION` | 60%维度门槛 | M18 |
   885→   885→| `EXP.MATURITY.90_DAYS` | 90天最低训练 | M18 |
   886→   886→| `EXP.GATE.NO_BYPASS` | 禁止绕过门禁 | M18 |
   887→   887→| `EXP.GATE.MANUAL_APPROVAL` | 需人工审批 | M12, M18 |
   888→   888→| `EXP.MONITOR.PROGRESS` | 进度监控正确 | M18 |
   889→   889→| `EXP.MONITOR.ALERT` | 告警生成正确 | M9 |
   890→   890→
   891→   891→---
   892→   892→
   893→   893→## §14 Phase 9: 合规与监控
   894→   894→
   895→   895→### 14.1 文件清单
   896→   896→
   897→   897→| 文件 | 行数 | 功能 | 状态 |
   898→   898→|------|------|------|------|
   899→   899→| `src/compliance/china_futures_rules.py` | ~200 | 中国期货合规规则 | ⏸ 待新增 |
   900→   900→| `src/compliance/programmatic_trading.py` | ~300 | 程序化交易合规 | ⏸ 待新增 |
   901→   901→| `src/compliance/throttle.py` | ~250 | 合规节流器 | ⏸ 待新增 |
   902→   902→| `src/compliance/algo_registration.py` | ~200 | 算法备案 | ⏸ 待新增 |
   903→   903→| `src/monitoring/health.py` | ~220 | 健康检查 | ✅ |
   904→   904→| `src/monitoring/metrics.py` | ~328 | Prometheus指标 | ✅ |
   905→   905→
   906→   906→### 14.2 2025年程序化交易新规
   907→   907→
   908→   908→```
   909→   909→《期货市场程序化交易管理规定（试行）》(2025年10月9日实施)
   910→   910→
   911→   911→核心要求：
   912→   912→┌─────────────────────────────────────────────────────────────────────┐
   913→   913→│ 1. 备案要求：客户需向期货公司报告，经交易所确认后方可从事程序化交易 │
   914→   914→│ 2. 技术系统：异常监测、阈值管理、错误防范、应急处置                  │
   915→   915→│ 3. 算法备案：策略类型+历史回测+风险参数三位一体                      │
   916→   916→│ 4. 压力测试：每月极端行情模拟 (原油跳空10%等)                        │
   917→   917→│ 5. 人工复核：大额订单≤30秒二次确认                                   │
   918→   918→│ 6. 报撤单频率：5秒50笔预警阈值                                       │
   919→   919→│ 7. 高频交易定义：单账户每秒≥300笔 或 单日≥20000笔                    │
   920→   920→└─────────────────────────────────────────────────────────────────────┘
   921→   921→```
   922→   922→
   923→   923→### 14.3 场景覆盖
   924→   924→
   925→   925→| Rule ID | 场景描述 | 军规 |
   926→   926→|---------|----------|------|
   927→   927→| `COMPLIANCE.REGISTRATION` | 程序化交易备案 | M17 |
   928→   928→| `COMPLIANCE.ALGO_RECORD` | 算法备案记录 | M17 |
   929→   929→| `COMPLIANCE.REPORT_CANCEL` | 报撤单频率监控 | M17 |
   930→   930→| `COMPLIANCE.HIGH_FREQ_DETECT` | 高频交易检测 | M17 |
   931→   931→| `COMPLIANCE.LARGE_ORDER` | 大额订单复核 | M12, M17 |
   932→   932→| `COMPLIANCE.STRESS_TEST` | 压力测试执行 | M6, M17 |
   933→   933→| `COMPLIANCE.EMERGENCY_STOP` | 紧急停止机制 | M6, M17 |
   934→   934→| `MONITOR.HEALTH.CHECK` | 健康检查执行 | M9 |
   935→   935→| `MONITOR.HEALTH.COMPONENT` | 组件状态监控 | M9 |
   936→   936→| `MONITOR.HEALTH.DEGRADED` | 降级状态检测 | M4, M9 |
   937→   937→| `MONITOR.METRICS.COUNTER` | 计数器指标 | M9 |
   938→   938→| `MONITOR.METRICS.GAUGE` | 仪表盘指标 | M9 |
   939→   939→| `MONITOR.METRICS.HISTOGRAM` | 直方图指标 | M9 |
   940→   940→| `MONITOR.METRICS.PROMETHEUS` | Prometheus导出 | M9 |
   941→   941→| `MONITOR.ALERT.THRESHOLD` | 阈值告警 | M9 |
   942→   942→| `MONITOR.ALERT.CHANNEL` | 告警渠道 | M9 |
   943→   943→
   944→   944→---
   945→   945→
   946→   946→## §15 Phase 10: 组合与风控增强
   947→   947→
   948→   948→### 15.1 文件清单
   949→   949→
   950→   950→| 文件 | 行数 | 功能 | 状态 |
   951→   951→|------|------|------|------|
   952→   952→| `src/portfolio/manager.py` | ~318 | 组合管理器 | ✅ |
   953→   953→| `src/portfolio/analytics.py` | ~268 | 组合分析 | ✅ |
   954→   954→| `src/portfolio/aggregator.py` | ~216 | 持仓聚合 | ✅ |
   955→   955→| `src/portfolio/__init__.py` | ~30 | 模块导出 | ✅ |
   956→   956→| `src/risk/var_calculator.py` | ~362 | VaR计算器 | ✅ |
   957→   957→| `src/risk/var_enhanced.py` | ~400 | 增强VaR | ⏸ 待新增 |
   958→   958→| `src/risk/attribution.py` | ~300 | 风险归因 | ⏸ 待新增 |
   959→   959→
   960→   960→### 15.2 VaR增强方法
   961→   961→
   962→   962→```python
   963→   963→class EnhancedVaRCalculator(VaRCalculator):
   964→   964→    """增强VaR计算器 (中国期货市场特化)"""
   965→   965→
   966→   966→    def evt_var(
   967→   967→        self,
   968→   968→        returns: list[float],
   969→   969→        confidence: float = 0.99,
   970→   970→        threshold_pct: float = 0.95,
   971→   971→    ) -> VaRResult:
   972→   972→        """极值理论VaR (POT + GPD)"""
   973→   973→        # ...
   974→   974→
   975→   975→    def semiparametric_var(
   976→   976→        self,
   977→   977→        returns: list[float],
   978→   978→        confidence: float = 0.99,
   979→   979→    ) -> VaRResult:
   980→   980→        """半参数VaR (核密度 + GPD)"""
   981→   981→        # ...
   982→   982→
   983→   983→    def limit_adjusted_var(
   984→   984→        self,
   985→   985→        returns: list[float],
   986→   986→        limit_pct: float,
   987→   987→        confidence: float = 0.99,
   988→   988→    ) -> VaRResult:
   989→   989→        """涨跌停调整VaR"""
   990→   990→        # ...
   991→   991→
   992→   992→    def liquidity_adjusted_var(
   993→   993→        self,
   994→   994→        returns: list[float],
   995→   995→        position_value: float,
   996→   996→        adv: float,  # 平均日成交量
   997→   997→        confidence: float = 0.99,
   998→   998→    ) -> VaRResult:
   999→   999→        """流动性调整VaR"""
  1000→  1000→        # ...
  1001→  1001→```
  1002→  1002→
  1003→  1003→### 15.3 场景覆盖
  1004→  1004→
  1005→  1005→| Rule ID | 场景描述 | 军规 |
  1006→  1006→|---------|----------|------|
  1007→  1007→| `PORTFOLIO.POSITION.UPDATE` | 持仓更新正确 | M1 |
  1008→  1008→| `PORTFOLIO.POSITION.LIMIT` | 持仓限额检查 | M6 |
  1009→  1009→| `PORTFOLIO.POSITION.NET` | 净持仓计算 | M1 |
  1010→  1010→| `PORTFOLIO.RISK.EXPOSURE` | 风险敞口计算 | M6 |
  1011→  1011→| `PORTFOLIO.RISK.CONCENTRATION` | 集中度计算 | M6 |
  1012→  1012→| `PORTFOLIO.PNL.ATTRIBUTION` | 盈亏归因 | M19 |
  1013→  1013→| `PORTFOLIO.SHARPE.CALCULATE` | 夏普比率计算 | M19 |
  1014→  1014→| `PORTFOLIO.DRAWDOWN.MAX` | 最大回撤计算 | M6 |
  1015→  1015→| `PORTFOLIO.SNAPSHOT.TIMESERIES` | 时序快照 | M3 |
  1016→  1016→| `VAR.HISTORICAL.PERCENTILE` | 历史VaR计算 | M6 |
  1017→  1017→| `VAR.PARAMETRIC.NORMAL` | 参数VaR计算 | M6 |
  1018→  1018→| `VAR.MONTECARLO.SIMULATION` | 蒙特卡洛VaR | M6 |
  1019→  1019→| `VAR.ES.CALCULATE` | ES/CVaR计算 | M6 |
  1020→  1020→| `VAR.EVT.GPD` | EVT-GPD方法 | M6 |
  1021→  1021→| `VAR.SEMIPARAMETRIC.KERNEL` | 半参数方法 | M6 |
  1022→  1022→| `VAR.LIMIT_ADJUSTED` | 涨跌停调整 | M6, M13 |
  1023→  1023→| `VAR.LIQUIDITY_ADJUSTED` | 流动性调整 | M6 |
  1024→  1024→| `RISK.ATTRIBUTION.FACTOR` | 因子归因 | M19 |
  1025→  1025→| `RISK.ATTRIBUTION.STRATEGY` | 策略归因 | M19 |
  1026→  1026→| `RISK.ATTRIBUTION.POSITION` | 持仓归因 | M19 |
  1027→  1027→| `RISK.BREACH.DETECT` | 风险突破检测 | M6 |
  1028→  1028→| `RISK.BREACH.ACTION` | 风险突破动作 | M6 |
  1029→  1029→| `RISK.STRESS.SCENARIO` | 压力测试场景 | M6 |
  1030→  1030→| `RISK.STRESS.RESULT` | 压力测试结果 | M6 |
  1031→  1031→| `RISK.KILLSWITCH.TRIGGER` | 熔断触发 | M6 |
  1032→  1032→
  1033→  1033→---
  1034→  1034→
  1035→  1035→## §16 六大交易所配置
  1036→  1036→
  1037→  1037→### 16.1 交易所基本信息
  1038→  1038→
  1039→  1039→| 交易所 | 代码 | 成立时间 | 主要品种 | 交易时段 |
  1040→  1040→|--------|------|----------|----------|----------|
  1041→  1041→| 上海期货交易所 | SHFE | 1999 | 金属、能化 | 日盘+夜盘 |
  1042→  1042→| 大连商品交易所 | DCE | 1993 | 农产品、化工 | 日盘+夜盘 |
  1043→  1043→| 郑州商品交易所 | CZCE | 1990 | 农产品、化工 | 日盘+夜盘 |
  1044→  1044→| 中国金融期货交易所 | CFFEX | 2006 | 股指、国债 | 仅日盘 |
  1045→  1045→| 广州期货交易所 | GFEX | 2021 | 碳酸锂、工业硅 | 日盘+夜盘 |
  1046→  1046→| 上海国际能源交易中心 | INE | 2013 | 原油、低硫燃料油 | 日盘+夜盘 |
  1047→  1047→
  1048→  1048→### 16.2 品种分类
  1049→  1049→
  1050→  1050→```python
  1051→  1051→PRODUCT_CATEGORIES = {
  1052→  1052→    "金属": {
  1053→  1053→        "SHFE": ["cu", "al", "zn", "pb", "ni", "sn", "ao"],
  1054→  1054→        "GFEX": ["si"],
  1055→  1055→    },
  1056→  1056→    "贵金属": {
  1057→  1057→        "SHFE": ["au", "ag"],
  1058→  1058→    },
  1059→  1059→    "黑色系": {
  1060→  1060→        "SHFE": ["rb", "hc", "ss"],
  1061→  1061→        "DCE": ["i", "j", "jm"],
  1062→  1062→    },
  1063→  1063→    "能源化工": {
  1064→  1064→        "SHFE": ["bu", "ru", "sp", "nr"],
  1065→  1065→        "DCE": ["l", "v", "pp", "eg", "eb", "pg"],
  1066→  1066→        "CZCE": ["MA", "TA", "SA", "UR", "PF"],
  1067→  1067→        "INE": ["sc", "lu", "bc"],
  1068→  1068→    },
  1069→  1069→    "农产品": {
  1070→  1070→        "DCE": ["c", "cs", "a", "b", "m", "y", "p", "jd", "lh", "rr"],
  1071→  1071→        "CZCE": ["WH", "RI", "PM", "CF", "SR", "OI", "RM", "RS", "AP", "CJ", "PK"],
  1072→  1072→    },
  1073→  1073→    "金融": {
  1074→  1074→        "CFFEX": ["IF", "IH", "IC", "IM", "T", "TF", "TS"],
  1075→  1075→    },
  1076→  1076→    "新能源": {
  1077→  1077→        "GFEX": ["lc"],  # 碳酸锂
  1078→  1078→    },
  1079→  1079→}
  1080→  1080→```
  1081→  1081→
  1082→  1082→---
  1083→  1083→
  1084→  1084→## §17 交易时段与夜盘规则
  1085→  1085→
  1086→  1086→### 17.1 日盘交易时段
  1087→  1087→
  1088→  1088→| 时段 | 时间 | 说明 |
  1089→  1089→|------|------|------|
  1090→  1090→| 早盘第一节 | 09:00 - 10:15 | 75分钟 |
  1091→  1091→| 早盘休息 | 10:15 - 10:30 | 15分钟 |
  1092→  1092→| 早盘第二节 | 10:30 - 11:30 | 60分钟 |
  1093→  1093→| 午休 | 11:30 - 13:30 | 120分钟 |
  1094→  1094→| 午盘 | 13:30 - 15:00 | 90分钟 |
  1095→  1095→
  1096→  1096→### 17.2 夜盘交易时段
  1097→  1097→
  1098→  1098→| 结束时间 | 品种 | 交易所 |
  1099→  1099→|----------|------|--------|
  1100→  1100→| 23:00 | 农产品、软商品 | DCE, CZCE |
  1101→  1101→| 01:00 | 黑色系、能化 | SHFE, DCE, CZCE |
  1102→  1102→| 02:30 | 贵金属、有色金属 | SHFE |
  1103→  1103→
  1104→  1104→### 17.3 夜盘交易日归属
  1105→  1105→
  1106→  1106→```
  1107→  1107→夜盘交易日归属规则：
  1108→  1108→┌─────────────────────────────────────────────────────────────────────┐
  1109→  1109→│ 周一夜盘 21:00 → 周二 02:30 归属于 周二交易日                        │
  1110→  1110→│ 周五夜盘 无 (周五没有夜盘)                                           │
  1111→  1111→│ 节假日前一天 无夜盘                                                  │
  1112→  1112→│ 节假日后第一天 从日盘开始                                            │
  1113→  1113→└─────────────────────────────────────────────────────────────────────┘
  1114→  1114→```
  1115→  1115→
  1116→  1116→---
  1117→  1117→
  1118→  1118→## §18 涨跌停板规则
  1119→  1119→
  1120→  1120→### 18.1 涨跌停幅度
  1121→  1121→
  1122→  1122→| 品种类型 | 日常幅度 | 连续涨跌停后 | 交割月 |
  1123→  1123→|----------|----------|--------------|--------|
  1124→  1124→| 股指期货 | ±10% | ±15% | ±20% |
  1125→  1125→| 国债期货 | ±2% | ±3% | - |
  1126→  1126→| 商品期货 | 3%-8% | +2% | +3% |
  1127→  1127→| 贵金属 | 6%-8% | +4% | - |
  1128→  1128→
  1129→  1129→### 18.2 2025年春节期间调整 (示例)
  1130→  1130→
  1131→  1131→| 品种 | 涨跌停幅度 | 投机保证金率 |
  1132→  1132→|------|------------|--------------|
  1133→  1133→| 铜/铝/锌/铅 | 10% | 12% |
  1134→  1134→| 镍/锡/氧化铝 | 13% | 15% |
  1135→  1135→| 金/银 | 13% | 15% |
  1136→  1136→| 螺纹钢/热卷 | 8% | 10% |
  1137→  1137→| 天然橡胶/纸浆 | 9% | 11% |
  1138→  1138→
  1139→  1139→### 18.3 涨跌停价格检查
  1140→  1140→
  1141→  1141→```python
  1142→  1142→def check_limit_price(
  1143→  1143→    order_price: float,
  1144→  1144→    instrument: InstrumentInfo,
  1145→  1145→    last_settle: float,
  1146→  1146→) -> tuple[bool, str]:
  1147→  1147→    """检查订单价格是否在涨跌停范围内"""
  1148→  1148→
  1149→  1149→    limit_up = last_settle * (1 + instrument.price_limit_pct)
  1150→  1150→    limit_down = last_settle * (1 - instrument.price_limit_pct)
  1151→  1151→
  1152→  1152→    if order_price > limit_up:
  1153→  1153→        return False, f"订单价格 {order_price} 超过涨停价 {limit_up}"
  1154→  1154→
  1155→  1155→    if order_price < limit_down:
  1156→  1156→        return False, f"订单价格 {order_price} 低于跌停价 {limit_down}"
  1157→  1157→
  1158→  1158→    return True, ""
  1159→  1159→```
  1160→  1160→
  1161→  1161→---
  1162→  1162→
  1163→  1163→## §19 保证金制度
  1164→  1164→
  1165→  1165→### 19.1 保证金类型
  1166→  1166→
  1167→  1167→| 类型 | 说明 |
  1168→  1168→|------|------|
  1169→  1169→| 交易保证金 | 开仓时缴纳，维持持仓 |
  1170→  1170→| 结算保证金 | 结算时调整 |
  1171→  1171→| 追加保证金 | 权益不足时追缴 |
  1172→  1172→
  1173→  1173→### 19.2 保证金水平
  1174→  1174→
  1175→  1175→```python
  1176→  1176→class MarginLevel(Enum):
  1177→  1177→    """保证金使用率等级"""
  1178→  1178→
  1179→  1179→    SAFE = "安全"       # < 50%
  1180→  1180→    NORMAL = "正常"     # 50% - 70%
  1181→  1181→    WARNING = "预警"    # 70% - 85%
  1182→  1182→    DANGER = "危险"     # 85% - 100%
  1183→  1183→    CRITICAL = "临界"   # >= 100% (触发强平)
  1184→  1184→```
  1185→  1185→
  1186→  1186→### 19.3 保证金监控
  1187→  1187→
  1188→  1188→```python
  1189→  1189→class MarginMonitor:
  1190→  1190→    """保证金监控器 (军规 M16)"""
  1191→  1191→
  1192→  1192→    def __init__(self, config: MarginConfig):
  1193→  1193→        self.config = config
  1194→  1194→        self._usage_ratio: float = 0.0
  1195→  1195→        self._level: MarginLevel = MarginLevel.SAFE
  1196→  1196→
  1197→  1197→    def update(
  1198→  1198→        self,
  1199→  1199→        equity: float,
  1200→  1200→        margin_used: float,
  1201→  1201→    ) -> MarginLevel:
  1202→  1202→        """更新保证金使用率"""
  1203→  1203→        self._usage_ratio = margin_used / equity if equity > 0 else 1.0
  1204→  1204→        self._level = self._calculate_level()
  1205→  1205→        return self._level
  1206→  1206→
  1207→  1207→    def _calculate_level(self) -> MarginLevel:
  1208→  1208→        """计算保证金等级"""
  1209→  1209→        if self._usage_ratio < 0.5:
  1210→  1210→            return MarginLevel.SAFE
  1211→  1211→        elif self._usage_ratio < 0.7:
  1212→  1212→            return MarginLevel.NORMAL
  1213→  1213→        elif self._usage_ratio < 0.85:
  1214→  1214→            return MarginLevel.WARNING
  1215→  1215→        elif self._usage_ratio < 1.0:
  1216→  1216→            return MarginLevel.DANGER
  1217→  1217→        else:
  1218→  1218→            return MarginLevel.CRITICAL
  1219→  1219→```
  1220→  1220→
  1221→  1221→---
  1222→  1222→
  1223→  1223→## §20 手续费结构
  1224→  1224→
  1225→  1225→### 20.1 手续费类型
  1226→  1226→
  1227→  1227→| 类型 | 计算方式 | 示例 |
  1228→  1228→|------|----------|------|
  1229→  1229→| 按金额 | 成交金额 × 费率 | 铜: 0.5‱ |
  1230→  1230→| 按手 | 成交手数 × 固定费用 | 螺纹钢: 1元/手 |
  1231→  1231→| 混合 | 两者取高 | 部分品种 |
  1232→  1232→
  1233→  1233→### 20.2 平今手续费
  1234→  1234→
  1235→  1235→| 交易所 | 平今政策 | 倍数 |
  1236→  1236→|--------|----------|------|
  1237→  1237→| SHFE | 部分品种免收 | 0-3倍 |
  1238→  1238→| DCE | 正常收取 | 1倍 |
  1239→  1239→| CZCE | 加倍收取 | 1-3倍 |
  1240→  1240→| CFFEX | 大幅加倍 | 15倍 |
  1241→  1241→| GFEX | 加倍收取 | 3-6倍 |
  1242→  1242→| INE | 部分免收 | 0-1倍 |
  1243→  1243→
  1244→  1244→### 20.3 手续费计算器
  1245→  1245→
  1246→  1246→```python
  1247→  1247→class ChinaFeeCalculator:
  1248→  1248→    """中国期货手续费计算器"""
  1249→  1249→
  1250→  1250→    def calculate(
  1251→  1251→        self,
  1252→  1252→        instrument: InstrumentInfo,
  1253→  1253→        price: float,
  1254→  1254→        volume: int,
  1255→  1255→        direction: str,  # "OPEN" | "CLOSE" | "CLOSE_TODAY"
  1256→  1256→    ) -> float:
  1257→  1257→        """计算手续费"""
  1258→  1258→
  1259→  1259→        if instrument.fee_type == "ratio":
  1260→  1260→            # 按金额
  1261→  1261→            value = price * instrument.multiplier * volume
  1262→  1262→            if direction == "OPEN":
  1263→  1263→                return value * instrument.fee_open_ratio
  1264→  1264→            elif direction == "CLOSE":
  1265→  1265→                return value * instrument.fee_close_ratio
  1266→  1266→            else:  # CLOSE_TODAY
  1267→  1267→                return value * instrument.fee_close_today_ratio
  1268→  1268→
  1269→  1269→        elif instrument.fee_type == "fixed":
  1270→  1270→            # 按手
  1271→  1271→            if direction == "OPEN":
  1272→  1272→                return instrument.fee_open_fixed * volume
  1273→  1273→            elif direction == "CLOSE":
  1274→  1274→                return instrument.fee_close_fixed * volume
  1275→  1275→            else:
  1276→  1276→                return instrument.fee_close_today_fixed * volume
  1277→  1277→
  1278→  1278→        else:
  1279→  1279→            # 混合: 取两者较高值
  1280→  1280→            # ...
  1281→  1281→```
  1282→  1282→
  1283→  1283→---
  1284→  1284→
  1285→  1285→## §21 程序化交易合规
  1286→  1286→
  1287→  1287→### 21.1 2025年新规要点
  1288→  1288→
  1289→  1289→| 要求 | 描述 | 系统实现 |
  1290→  1290→|------|------|----------|
  1291→  1291→| 备案 | 向期货公司报告 | 算法备案模块 |
  1292→  1292→| 阈值管理 | 报撤单频率监控 | 合规节流器 |
  1293→  1293→| 压力测试 | 每月极端行情模拟 | 压力测试模块 |
  1294→  1294→| 人工复核 | 大额订单确认 | 双重确认机制 |
  1295→  1295→| 应急处置 | 熔断机制 | 风控熔断 |
  1296→  1296→
  1297→  1297→### 21.2 高频交易判定
  1298→  1298→
  1299→  1299→```
  1300→  1300→高频交易判定标准 (2025年7月7日实施):
  1301→  1301→┌─────────────────────────────────────────────────────────────────────┐
  1302→  1302→│ 条件1: 单账户每秒报撤单 ≥ 300 笔                                     │
  1303→  1303→│ 条件2: 单账户单日报撤单 ≥ 20000 笔                                   │
  1304→  1304→│ 满足任一条件即判定为高频交易                                         │
  1305→  1305→│ 高频交易者需缴纳更高手续费                                           │
  1306→  1306→└─────────────────────────────────────────────────────────────────────┘
  1307→  1307→```
  1308→  1308→
  1309→  1309→### 21.3 报撤单频率预警
  1310→  1310→
  1311→  1311→```python
  1312→  1312→THROTTLE_LEVELS = {
  1313→  1313→    ThrottleLevel.NORMAL: {
  1314→  1314→        "5s_limit": 30,
  1315→  1315→        "daily_limit": 15000,
  1316→  1316→        "action": "正常交易",
  1317→  1317→    },
  1318→  1318→    ThrottleLevel.WARNING: {
  1319→  1319→        "5s_limit": 40,
  1320→  1320→        "daily_limit": 18000,
  1321→  1321→        "action": "发送预警，降低频率",
  1322→  1322→    },
  1323→  1323→    ThrottleLevel.CRITICAL: {
  1324→  1324→        "5s_limit": 48,
  1325→  1325→        "daily_limit": 19500,
  1326→  1326→        "action": "暂停新开仓",
  1327→  1327→    },
  1328→  1328→    ThrottleLevel.EXCEEDED: {
  1329→  1329→        "5s_limit": 50,
  1330→  1330→        "daily_limit": 20000,
  1331→  1331→        "action": "停止所有报撤单",
  1332→  1332→    },
  1333→  1333→}
  1334→  1334→```
  1335→  1335→
  1336→  1336→---
  1337→  1337→
  1338→  1338→## §22 VaR风控增强
  1339→  1339→
  1340→  1340→### 22.1 当前VaR方法
  1341→  1341→
  1342→  1342→| 方法 | 优点 | 缺点 | 适用场景 |
  1343→  1343→|------|------|------|----------|
  1344→  1344→| 历史模拟法 | 简单直观 | 依赖历史 | 一般市场 |
  1345→  1345→| 参数法 | 计算快速 | 假设正态 | 快速估计 |
  1346→  1346→| 蒙特卡洛法 | 灵活准确 | 计算慢 | 复杂组合 |
  1347→  1347→
  1348→  1348→### 22.2 增强VaR方法 (待新增)
  1349→  1349→
  1350→  1350→| 方法 | 描述 | 适用场景 |
  1351→  1351→|------|------|----------|
  1352→  1352→| EVT (极值理论) | POT + GPD分布 | 极端风险 |
  1353→  1353→| 半参数法 | 核密度 + GPD | 厚尾分布 |
  1354→  1354→| 涨跌停调整 | 截断效应修正 | 中国期货 |
  1355→  1355→| 流动性调整 | 平仓成本建模 | 大额头寸 |
  1356→  1356→
  1357→  1357→### 22.3 EVT-GPD实现
  1358→  1358→
  1359→  1359→```python
  1360→  1360→def evt_var(
  1361→  1361→    self,
  1362→  1362→    returns: list[float],
  1363→  1363→    confidence: float = 0.99,
  1364→  1364→    threshold_pct: float = 0.95,
  1365→  1365→) -> VaRResult:
  1366→  1366→    """极值理论VaR (POT + GPD方法)"""
  1367→  1367→
  1368→  1368→    # 1. 确定阈值 (第95百分位)
  1369→  1369→    sorted_returns = sorted(returns)
  1370→  1370→    threshold_idx = int(len(sorted_returns) * threshold_pct)
  1371→  1371→    threshold = sorted_returns[threshold_idx]
  1372→  1372→
  1373→  1373→    # 2. 提取超阈值样本
  1374→  1374→    exceedances = [r - threshold for r in returns if r < threshold]
  1375→  1375→
  1376→  1376→    if len(exceedances) < 30:
  1377→  1377→        # 样本不足，回退到历史法
  1378→  1378→        return self.historical_var(returns, confidence)
  1379→  1379→
  1380→  1380→    # 3. 估计GPD参数 (矩估计)
  1381→  1381→    xi, beta = self._estimate_gpd_params(exceedances)
  1382→  1382→
  1383→  1383→    # 4. 计算VaR
  1384→  1384→    n = len(returns)
  1385→  1385→    nu = len(exceedances)
  1386→  1386→    p = 1 - confidence
  1387→  1387→
  1388→  1388→    if xi != 0:
  1389→  1389→        var = threshold + (beta / xi) * (((n / nu) * p) ** (-xi) - 1)
  1390→  1390→    else:
  1391→  1391→        var = threshold - beta * math.log((n / nu) * p)
  1392→  1392→
  1393→  1393→    return VaRResult(
  1394→  1394→        var=abs(var),
  1395→  1395→        confidence=confidence,
  1396→  1396→        method="EVT-GPD",
  1397→  1397→        expected_shortfall=self._evt_es(var, xi, beta),
  1398→  1398→        sample_size=len(returns),
  1399→  1399→        metadata={"xi": xi, "beta": beta, "threshold": threshold},
  1400→  1400→    )
  1401→  1401→```
  1402→  1402→
  1403→  1403→---
  1404→  1404→
  1405→  1405→## §23 压力测试场景
  1406→  1406→
  1407→  1407→### 23.1 中国期货市场历史极端场景
  1408→  1408→
  1409→  1409→| 场景 | 日期 | 品种 | 波动 | 持续时间 |
  1410→  1410→|------|------|------|------|----------|
  1411→  1411→| 2015年股灾 | 2015-06 | IF | -10%/日 | 5天 |
  1412→  1412→| 2016年黑色系暴涨 | 2016-04 | RB | +6%/日 | 3天 |
  1413→  1413→| 2020年原油负价 | 2020-04 | SC | -15% | 1天 |
  1414→  1414→| 2021年动力煤调控 | 2021-10 | ZC | -10%/日 | 3天 |
  1415→  1415→| 2022年碳酸锂暴跌 | 2022-11 | LC | -15%/日 | 5天 |
  1416→  1416→| 2024年碳酸锂继续下跌 | 2024-03 | LC | -8%/日 | 10天 |
  1417→  1417→
  1418→  1418→### 23.2 压力测试配置
  1419→  1419→
  1420→  1420→```python
  1421→  1421→@dataclass
  1422→  1422→class StressScenario:
  1423→  1423→    """压力测试场景"""
  1424→  1424→
  1425→  1425→    name: str                 # 场景名称
  1426→  1426→    description: str          # 场景描述
  1427→  1427→    price_shock: float        # 价格冲击幅度
  1428→  1428→    duration_days: int        # 持续天数
  1429→  1429→    affected_products: list   # 受影响品种
  1430→  1430→    probability: float        # 历史概率
  1431→  1431→
  1432→  1432→
  1433→  1433→STRESS_SCENARIOS = [
  1434→  1434→    StressScenario(
  1435→  1435→        name="CRASH_2015",
  1436→  1436→        description="2015年股灾场景",
  1437→  1437→        price_shock=-0.10,
  1438→  1438→        duration_days=5,
  1439→  1439→        affected_products=["IF", "IH", "IC"],
  1440→  1440→        probability=0.01,
  1441→  1441→    ),
  1442→  1442→    StressScenario(
  1443→  1443→        name="OIL_NEGATIVE_2020",
  1444→  1444→        description="2020年原油负价场景",
  1445→  1445→        price_shock=-0.15,
  1446→  1446→        duration_days=1,
  1447→  1447→        affected_products=["sc", "fu", "lu"],
  1448→  1448→        probability=0.001,
  1449→  1449→    ),
  1450→  1450→    # ... 更多场景
  1451→  1451→]
  1452→  1452→```
  1453→  1453→
  1454→  1454→---
  1455→  1455→
  1456→  1456→## §24 实验性策略门禁
  1457→  1457→
  1458→  1458→### 24.1 成熟度评估系统
  1459→  1459→
  1460→  1460→```
  1461→  1461→实验性策略训练成熟度评估系统 (已实现 ✅)
  1462→  1462→
  1463→  1463→核心门槛:
  1464→  1464→┌─────────────────────────────────────────────────────────────────────┐
  1465→  1465→│ 1. 总成熟度 ≥ 80%                                                    │
  1466→  1466→│ 2. 任意维度 ≥ 60%                                                    │
  1467→  1467→│ 3. 训练时间 ≥ 90天                                                   │
  1468→  1468→│ 4. 人工审批通过                                                      │
  1469→  1469→│ 5. BYPASS_FORBIDDEN = True (禁止绕过)                                │
  1470→  1470→└─────────────────────────────────────────────────────────────────────┘
  1471→  1471→```
  1472→  1472→
  1473→  1473→### 24.2 五维度评估
  1474→  1474→
  1475→  1475→| 维度 | 权重 | 评估指标 |
  1476→  1476→|------|------|----------|
  1477→  1477→| 收益稳定性 | 25% | 夏普比率、收益CV、月度胜率 |
  1478→  1478→| 风险控制 | 25% | 最大回撤、卡玛比率、胜率、盈亏比 |
  1479→  1479→| 市场适应性 | 20% | 状态覆盖、一致性、存活率 |
  1480→  1480→| 训练充分度 | 20% | 训练天数、训练次数、样本多样性 |
  1481→  1481→| 一致性 | 10% | 信号相关、滚动一致性 |
  1482→  1482→
  1483→  1483→### 24.3 成熟度等级
  1484→  1484→
  1485→  1485→```python
  1486→  1486→class MaturityLevel(Enum):
  1487→  1487→    """成熟度等级"""
  1488→  1488→
  1489→  1489→    EMBRYONIC = "胚胎期"    # 0-20%
  1490→  1490→    DEVELOPING = "发育期"   # 20-40%
  1491→  1491→    GROWING = "成长期"      # 40-60%
  1492→  1492→    MATURING = "成熟期"     # 60-80%
  1493→  1493→    MATURE = "完全成熟"     # 80-100%
  1494→  1494→```
  1495→  1495→
  1496→  1496→---
  1497→  1497→
  1498→  1498→## §25 审计日志规范
  1499→  1499→
  1500→  1500→### 25.1 日志文件命名
  1501→  1501→
  1502→  1502→```
  1503→  1503→命名格式: audit_{run_id}_{date}.jsonl
  1504→  1504→
  1505→  1505→示例:
  1506→  1506→audit_202512160001_20251216.jsonl
  1507→  1507→```
  1508→  1508→
  1509→  1509→### 25.2 日志保留策略
  1510→  1510→
  1511→  1511→| 类型 | 保留时间 | 压缩 |
  1512→  1512→|------|----------|------|
  1513→  1513→| 原始日志 | 30天 | 无 |
  1514→  1514→| 压缩日志 | 365天 | GZIP |
  1515→  1515→| 归档日志 | 永久 | Parquet |
  1516→  1516→
  1517→  1517→### 25.3 必记录事件
  1518→  1518→
  1519→  1519→| 事件类型 | 触发时机 | 必填字段 |
  1520→  1520→|----------|----------|----------|
  1521→  1521→| `SIGNAL_GENERATED` | 信号生成 | symbol, direction, signal_source |
  1522→  1522→| `ORDER_SUBMITTED` | 订单提交 | symbol, price, volume, order_id |
  1523→  1523→| `ORDER_FILLED` | 订单成交 | order_id, fill_price, fill_volume |
  1524→  1524→| `ORDER_REJECTED` | 订单拒绝 | order_id, reason |
  1525→  1525→| `RISK_TRIGGERED` | 风控触发 | rule_id, threshold, actual |
  1526→  1526→| `POSITION_CHANGED` | 持仓变化 | symbol, direction, volume |
  1527→  1527→| `MARGIN_WARNING` | 保证金预警 | usage_ratio, level |
  1528→  1528→| `LIMIT_PRICE_HIT` | 涨跌停触发 | symbol, limit_type |
  1529→  1529→| `STRATEGY_FALLBACK` | 策略降级 | from_strategy, to_strategy |
  1530→  1530→
  1531→  1531→---
  1532→  1532→
  1533→  1533→## §26 配置管理
  1534→  1534→
  1535→  1535→### 26.1 配置文件结构
  1536→  1536→
  1537→  1537→```yaml
  1538→  1538→# config/trading.yml
  1539→  1539→
  1540→  1540→environment: production  # dev | test | production
  1541→  1541→
  1542→  1542→exchange:
  1543→  1543→  shfe:
  1544→  1544→    enabled: true
  1545→  1545→    trading_hours: [[09:00, 10:15], [10:30, 11:30], [13:30, 15:00]]
  1546→  1546→    night_session: [21:00, 02:30]
  1547→  1547→
  1548→  1548→risk:
  1549→  1549→  max_drawdown_pct: 0.05
  1550→  1550→  max_position_value: 10000000
  1551→  1551→  margin_warning_level: 0.7
  1552→  1552→  margin_danger_level: 0.85
  1553→  1553→
  1554→  1554→strategy:
  1555→  1555→  calendar_arb:
  1556→  1556→    enabled: true
  1557→  1557→    max_position: 100
  1558→  1558→    entry_z: 2.5
  1559→  1559→    exit_z: 0.5
  1560→  1560→    stop_z: 5.0
  1561→  1561→
  1562→  1562→compliance:
  1563→  1563→  report_cancel_limit_5s: 50
  1564→  1564→  high_freq_limit_daily: 20000
  1565→  1565→  large_order_threshold: 100
  1566→  1566→```
  1567→  1567→
  1568→  1568→### 26.2 环境隔离
  1569→  1569→
  1570→  1570→| 环境 | 配置文件 | CTP前置 | 数据库 |
  1571→  1571→|------|----------|---------|--------|
  1572→  1572→| dev | config.dev.yml | simnow | dev_db |
  1573→  1573→| test | config.test.yml | simnow | test_db |
  1574→  1574→| prod | config.prod.yml | 生产前置 | prod_db |
  1575→  1575→
  1576→  1576→---
  1577→  1577→
  1578→  1578→## §27 FMEA故障模式分析
  1579→  1579→
  1580→  1580→### 27.1 故障模式表
  1581→  1581→
  1582→  1582→| 故障模式 | 严重度 | 发生概率 | 检测难度 | RPN | 缓解措施 |
  1583→  1583→|----------|--------|----------|----------|-----|----------|
  1584→  1584→| CTP断连 | 9 | 3 | 2 | 54 | 自动重连 + 降级 |
  1585→  1585→| 行情延迟 | 7 | 4 | 3 | 84 | 超时检测 + 降级 |
  1586→  1586→| 策略异常 | 8 | 3 | 4 | 96 | 降级链 + 熔断 |
  1587→  1587→| 订单拒绝 | 6 | 5 | 2 | 60 | 重试 + 告警 |
  1588→  1588→| 保证金不足 | 9 | 2 | 2 | 36 | 实时监控 + 预警 |
  1589→  1589→| 涨跌停封板 | 7 | 6 | 1 | 42 | 价格检查 + 撤单 |
  1590→  1590→
  1591→  1591→### 27.2 RPN计算
  1592→  1592→
  1593→  1593→```
  1594→  1594→RPN = 严重度 × 发生概率 × 检测难度
  1595→  1595→
  1596→  1596→RPN等级:
  1597→  1597→- < 50: 低风险，监控即可
  1598→  1598→- 50-100: 中风险，需要缓解措施
  1599→  1599→- > 100: 高风险，必须优先处理
  1600→  1600→```
  1601→  1601→
  1602→  1602→---
  1603→  1603→
  1604→  1604→## §28 回滚策略
  1605→  1605→
  1606→  1606→### 28.1 回滚触发条件
  1607→  1607→
  1608→  1608→| 触发条件 | 回滚范围 | 自动/手动 |
  1609→  1609→|----------|----------|-----------|
  1610→  1610→| CI门禁失败 | 单次提交 | 自动 |
  1611→  1611→| 测试覆盖下降 | 单次提交 | 自动 |
  1612→  1612→| 生产异常 | 版本回滚 | 手动 |
  1613→  1613→| 资金异常 | 系统暂停 | 手动 |
  1614→  1614→
  1615→  1615→### 28.2 回滚流程
  1616→  1616→
  1617→  1617→```
  1618→  1618→1. 检测到异常
  1619→  1619→2. 触发熔断 (如需)
  1620→  1620→3. 记录当前状态
  1621→  1621→4. 执行回滚
  1622→  1622→5. 验证回滚成功
  1623→  1623→6. 恢复服务
  1624→  1624→7. 发送告警
  1625→  1625→8. 事后分析
  1626→  1626→```
  1627→  1627→
  1628→  1628→---
  1629→  1629→
  1630→  1630→## §29 测试规范
  1631→  1631→
  1632→  1632→### 29.1 测试目录结构
  1633→  1633→
  1634→  1634→```
  1635→  1635→tests/
  1636→  1636→├── unit/                    # 单元测试
  1637→  1637→│   ├── test_market/
  1638→  1638→│   ├── test_strategy/
  1639→  1639→│   ├── test_risk/
  1640→  1640→│   └── ...
  1641→  1641→├── integration/             # 集成测试
  1642→  1642→│   ├── test_trading_flow/
  1643→  1643→│   └── test_ctp_integration/
  1644→  1644→├── e2e/                     # 端到端测试
  1645→  1645→│   └── test_full_cycle/
  1646→  1646→├── stress/                  # 压力测试
  1647→  1647→│   └── test_high_load/
  1648→  1648→└── conftest.py              # 公共fixtures
  1649→  1649→```
  1650→  1650→
  1651→  1651→### 29.2 测试覆盖要求
  1652→  1652→
  1653→  1653→| 模块 | 最低覆盖率 | 当前覆盖率 |
  1654→  1654→|------|------------|------------|
  1655→  1655→| src/trading/ | 100% | 100% |
  1656→  1656→| src/risk/ | 100% | 95% |
  1657→  1657→| src/strategy/ | 90% | 88% |
  1658→  1658→| src/market/ | 90% | 92% |
  1659→  1659→| src/execution/ | 90% | 87% |
  1660→  1660→| 总体 | 85% | 88.22% |
  1661→  1661→
  1662→  1662→### 29.3 场景测试命名
  1663→  1663→
  1664→  1664→```python
  1665→  1665→# 测试函数命名规范
  1666→  1666→def test_{module}_{feature}_{scenario}():
  1667→  1667→    """
  1668→  1668→    RULE_ID: {MODULE}.{FEATURE}.{SCENARIO}
  1669→  1669→    军规: M{X}
  1670→  1670→    描述: ...
  1671→  1671→    """
  1672→  1672→    pass
  1673→  1673→```
  1674→  1674→
  1675→  1675→---
  1676→  1676→
  1677→  1677→## §30 CI/CD集成
  1678→  1678→
  1679→  1679→### 30.1 GitHub Actions工作流
  1680→  1680→
  1681→  1681→```yaml
  1682→  1682→# .github/workflows/ci.yml
  1683→  1683→
  1684→  1684→name: CI Pipeline
  1685→  1685→
  1686→  1686→on:
  1687→  1687→  push:
  1688→  1688→    branches: [main, feat/*]
  1689→  1689→  pull_request:
  1690→  1690→    branches: [main]
  1691→  1691→
  1692→  1692→jobs:
  1693→  1693→  lint:
  1694→  1694→    runs-on: ubuntu-latest
  1695→  1695→    steps:
  1696→  1696→      - uses: actions/checkout@v4
  1697→  1697→      - name: Ruff Check
  1698→  1698→        run: ruff check .
  1699→  1699→      - name: Ruff Format
  1700→  1700→        run: ruff format --check .
  1701→  1701→
  1702→  1702→  type-check:
  1703→  1703→    runs-on: ubuntu-latest
  1704→  1704→    steps:
  1705→  1705→      - uses: actions/checkout@v4
  1706→  1706→      - name: Mypy
  1707→  1707→        run: mypy .
  1708→  1708→
  1709→  1709→  test:
  1710→  1710→    runs-on: ubuntu-latest
  1711→  1711→    steps:
  1712→  1712→      - uses: actions/checkout@v4
  1713→  1713→      - name: Pytest
  1714→  1714→        run: pytest tests/ -q --cov=src --cov-fail-under=85
  1715→  1715→
  1716→  1716→  policy-check:
  1717→  1717→    runs-on: ubuntu-latest
  1718→  1718→    steps:
  1719→  1719→      - uses: actions/checkout@v4
  1720→  1720→      - name: Validate Policy
  1721→  1721→        run: python scripts/validate_policy.py --all
  1722→  1722→```
  1723→  1723→
  1724→  1724→### 30.2 门禁检查顺序
  1725→  1725→
  1726→  1726→```
  1727→  1727→1. Ruff Check (代码风格)
  1728→  1728→2. Ruff Format (代码格式)
  1729→  1729→3. Mypy (类型检查)
  1730→  1730→4. Pytest (单元测试)
  1731→  1731→5. Coverage (覆盖率)
  1732→  1732→6. Policy (策略验证)
  1733→  1733→```
  1734→  1734→
  1735→  1735→### 30.3 本地执行命令
  1736→  1736→
  1737→  1737→```powershell
  1738→  1738→# Windows PowerShell
  1739→  1739→.venv/Scripts/python.exe -m ruff check .
  1740→  1740→.venv/Scripts/python.exe -m ruff format --check .
  1741→  1741→.venv/Scripts/python.exe -m mypy .
  1742→  1742→.venv/Scripts/python.exe -m pytest tests/ -q
  1743→  1743→.venv/Scripts/python.exe scripts/validate_policy.py --all
  1744→  1744→```
  1745→  1745→
  1746→  1746→---
  1747→  1747→
  1748→  1748→## §31 场景矩阵总表
  1749→  1749→
  1750→  1750→### 31.1 场景统计
  1751→  1751→
  1752→  1752→| Phase | 场景数 | 状态 |
  1753→  1753→|-------|--------|------|
  1754→  1754→| Phase 0 基础设施 | 15 | ✅ |
  1755→  1755→| Phase 1 行情层 | 12 | ✅ |
  1756→  1756→| Phase 2 审计层 | 18 | ✅ |
  1757→  1757→| Phase 3 策略降级 | 12 | ✅ |
  1758→  1758→| Phase 4 回放验证 | 2 | ✅ |
  1759→  1759→| Phase 5 成本层 | 8 | ⏸ |
  1760→  1760→| Phase 6 B类模型 | 12 | ⏸ |
  1761→  1761→| Phase 7 中国期货特化 | 23 | ⏸ |
  1762→  1762→| Phase 8 智能策略 | 22 | 部分✅ |
  1763→  1763→| Phase 9 合规监控 | 16 | 部分✅ |
  1764→  1764→| Phase 10 组合风控 | 25 | 部分✅ |
  1765→  1765→| **总计** | **165** | - |
  1766→  1766→
  1767→  1767→### 31.2 军规覆盖统计
  1768→  1768→
  1769→  1769→| 军规 | 场景数 | 覆盖率 |
  1770→  1770→|------|--------|--------|
  1771→  1771→| M1 单一信号源 | 8 | 100% |
  1772→  1772→| M3 完整审计 | 18 | 100% |
  1773→  1773→| M4 降级兜底 | 6 | 100% |
  1774→  1774→| M5 成本先行 | 14 | 80% |
  1775→  1775→| M6 熔断保护 | 22 | 90% |
  1776→  1776→| M7 回放一致 | 6 | 100% |
  1777→  1777→| M9 错误上报 | 12 | 85% |
  1778→  1778→| M13 涨跌停感知 | 6 | 待实现 |
  1779→  1779→| M14 平今平昨分离 | 3 | 待实现 |
  1780→  1780→| M15 夜盘跨日处理 | 5 | 待实现 |
  1781→  1781→| M16 保证金监控 | 5 | 待实现 |
  1782→  1782→| M17 程序化合规 | 8 | 待实现 |
  1783→  1783→| M18 实验性门禁 | 7 | ✅ |
  1784→  1784→
  1785→  1785→---
  1786→  1786→
  1787→  1787→## §32 文件清单
  1788→  1788→
  1789→  1789→### 32.1 已完成文件 (71个)
  1790→  1790→
  1791→  1791→| 目录 | 文件数 | 行数估计 |
  1792→  1792→|------|--------|----------|
  1793→  1793→| src/market/ | 7 | ~1200 |
  1794→  1794→| src/audit/ | 7 | ~900 |
  1795→  1795→| src/cost/ | 2 | ~650 |
  1796→  1796→| src/guardian/ | 6 | ~1000 |
  1797→  1797→| src/execution/auto/ | 8 | ~1500 |
  1798→  1798→| src/execution/protection/ | 4 | ~600 |
  1799→  1799→| src/execution/pair/ | 3 | ~500 |
  1800→  1800→| src/strategy/calendar_arb/ | 4 | ~900 |
  1801→  1801→| src/strategy/experimental/ | 4 | ~1865 |
  1802→  1802→| src/replay/ | 2 | ~310 |
  1803→  1803→| src/portfolio/ | 4 | ~833 |
  1804→  1804→| src/monitoring/ | 3 | ~579 |
  1805→  1805→| src/risk/ | 3 | ~900 |
  1806→  1806→| src/trading/ | 4 | ~600 |
  1807→  1807→| scripts/ | 6 | ~900 |
  1808→  1808→| tests/ | ~40 | ~5000 |
  1809→  1809→
  1810→  1810→### 32.2 待新增文件 (28个)
  1811→  1811→
  1812→  1812→| 文件路径 | 功能 | 预计行数 |
  1813→  1813→|----------|------|----------|
  1814→  1814→| `src/market/exchange_config.py` | 六大交易所配置 | ~300 |
  1815→  1815→| `src/market/trading_calendar.py` | 夜盘交易日历 | ~250 |
  1816→  1816→| `src/cost/china_fee_calculator.py` | 中国期货手续费 | ~300 |
  1817→  1817→| `src/execution/protection/limit_price.py` | 涨跌停保护 | ~200 |
  1818→  1818→| `src/execution/protection/margin_monitor.py` | 保证金监控 | ~250 |
  1819→  1819→| `src/execution/algo/twap.py` | TWAP算法 | ~200 |
  1820→  1820→| `src/execution/algo/vwap.py` | VWAP算法 | ~250 |
  1821→  1821→| `src/execution/algo/iceberg.py` | 冰山单算法 | ~200 |
  1822→  1822→| `src/execution/algo/adaptive.py` | 自适应执行 | ~300 |
  1823→  1823→| `src/execution/impact_model.py` | 市场冲击模型 | ~200 |
  1824→  1824→| `src/guardian/triggers_china.py` | 中国期货触发器 | ~300 |
  1825→  1825→| `src/risk/var_enhanced.py` | 增强VaR | ~400 |
  1826→  1826→| `src/risk/stress_test_china.py` | 中国期货压力测试 | ~350 |
  1827→  1827→| `src/risk/attribution.py` | 风险归因 | ~300 |
  1828→  1828→| `src/strategy/calendar_arb/delivery_aware.py` | 交割感知套利 | ~250 |
  1829→  1829→| `src/strategy/dl/lstm_predictor.py` | LSTM预测模型 | ~400 |
  1830→  1830→| `src/strategy/dl/transformer_model.py` | Transformer模型 | ~500 |
  1831→  1831→| `src/strategy/dl/factor_miner.py` | 因子挖掘器 | ~350 |
  1832→  1832→| `src/strategy/rl/ppo_agent.py` | PPO强化学习 | ~450 |
  1833→  1833→| `src/strategy/rl/dqn_agent.py` | DQN强化学习 | ~400 |
  1834→  1834→| `src/strategy/rl/reward_function.py` | 奖励函数设计 | ~200 |
  1835→  1835→| `src/compliance/china_futures_rules.py` | 合规规则 | ~200 |
  1836→  1836→| `src/compliance/programmatic_trading.py` | 程序化交易合规 | ~300 |
  1837→  1837→| `src/compliance/throttle.py` | 合规节流器 | ~250 |
  1838→  1838→| `src/compliance/algo_registration.py` | 算法备案 | ~200 |
  1839→  1839→| 测试文件 | - | ~3000 |
  1840→  1840→
  1841→  1841→---
  1842→  1842→
  1843→  1843→## §33 工时估算
  1844→  1844→
  1845→  1845→### 33.1 Phase工时
  1846→  1846→
  1847→  1847→| Phase | 预计工时 | 说明 |
  1848→  1848→|-------|----------|------|
  1849→  1849→| Phase 5 成本层 | 16h | 中国期货手续费 |
  1850→  1850→| Phase 6 B类模型 | 80h | DL+RL模型 |
  1851→  1851→| Phase 7 中国期货特化 | 90h | 全面特化 |
  1852→  1852→| Phase 8 智能策略 | 40h | 执行算法 |
  1853→  1853→| Phase 9 合规监控 | 30h | 合规模块 |
  1854→  1854→| Phase 10 组合风控 | 40h | VaR增强 |
  1855→  1855→| **总计** | **296h** | - |
  1856→  1856→
  1857→  1857→### 33.2 按模块工时
  1858→  1858→
  1859→  1859→| 模块 | 新文件 | 测试 | 文档 | 合计 |
  1860→  1860→|------|--------|------|------|------|
  1861→  1861→| 交易所配置 | 8h | 4h | 2h | 14h |
  1862→  1862→| 手续费计算 | 8h | 4h | 2h | 14h |
  1863→  1863→| 涨跌停保护 | 6h | 3h | 1h | 10h |
  1864→  1864→| 保证金监控 | 8h | 4h | 2h | 14h |
  1865→  1865→| 执行算法 | 20h | 10h | 4h | 34h |
  1866→  1866→| 合规节流 | 8h | 4h | 2h | 14h |
  1867→  1867→| VaR增强 | 16h | 8h | 4h | 28h |
  1868→  1868→| 压力测试 | 12h | 6h | 2h | 20h |
  1869→  1869→| DL模型 | 40h | 20h | 8h | 68h |
  1870→  1870→| RL模型 | 40h | 20h | 8h | 68h |
  1871→  1871→
  1872→  1872→---
  1873→  1873→
  1874→  1874→## §34 验收标准
  1875→  1875→
  1876→  1876→### 34.1 功能验收
  1877→  1877→
  1878→  1878→- [ ] 所有165条场景测试通过
  1879→  1879→- [ ] 军规M1-M20全部有测试覆盖
  1880→  1880→- [ ] 六大交易所配置正确
  1881→  1881→- [ ] 夜盘交易日历正确
  1882→  1882→- [ ] 涨跌停价格检查生效
  1883→  1883→- [ ] 保证金监控预警正常
  1884→  1884→- [ ] 程序化合规检查通过
  1885→  1885→- [ ] VaR计算结果准确
  1886→  1886→
  1887→  1887→### 34.2 性能验收
  1888→  1888→
  1889→  1889→| 指标 | 要求 | 测试方法 |
  1890→  1890→|------|------|----------|
  1891→  1891→| 订单延迟 | < 10ms | 压测 |
  1892→  1892→| 信号生成 | < 1ms | 压测 |
  1893→  1893→| VaR计算 | < 100ms | 单测 |
  1894→  1894→| 行情处理 | 10000 tick/s | 压测 |
  1895→  1895→
  1896→  1896→### 34.3 质量验收
  1897→  1897→
  1898→  1898→| 指标 | 要求 |
  1899→  1899→|------|------|
  1900→  1900→| 测试覆盖率 | ≥ 85% |
  1901→  1901→| Ruff检查 | 0 errors |
  1902→  1902→| Mypy检查 | 0 errors |
  1903→  1903→| 文档完整性 | 100% |
  1904→  1904→
  1905→  1905→---
  1906→  1906→
  1907→  1907→## §35 附录
  1908→  1908→
  1909→  1909→### 35.1 术语表
  1910→  1910→
  1911→  1911→| 术语 | 英文 | 解释 |
  1912→  1912→|------|------|------|
  1913→  1913→| 涨停板 | Limit Up | 价格上涨到最高限制 |
  1914→  1914→| 跌停板 | Limit Down | 价格下跌到最低限制 |
  1915→  1915→| 平今仓 | Close Today | 当日开仓当日平仓 |
  1916→  1916→| 平昨仓 | Close Yesterday | 平掉前一日持仓 |
  1917→  1917→| 夜盘 | Night Session | 21:00后的交易时段 |
  1918→  1918→| 保证金 | Margin | 开仓所需资金比例 |
  1919→  1919→| 强平 | Forced Liquidation | 保证金不足时强制平仓 |
  1920→  1920→| VaR | Value at Risk | 在险价值 |
  1921→  1921→| ES/CVaR | Expected Shortfall | 期望损失/条件VaR |
  1922→  1922→| EVT | Extreme Value Theory | 极值理论 |
  1923→  1923→| GPD | Generalized Pareto Distribution | 广义帕累托分布 |
  1924→  1924→
  1925→  1925→### 35.2 参考资料
  1926→  1926→
  1927→  1927→1. 《期货市场程序化交易管理规定（试行）》- 中国证监会 (2025)
  1928→  1928→2. 《程序化交易管理实施细则》- 沪深北交易所 (2025)
  1929→  1929→3. 各交易所交易规则及风控制度
  1930→  1930→4. CTP API技术文档
  1931→  1931→5. 风险管理理论与实践
  1932→  1932→
  1933→  1933→### 35.3 文档版本历史
  1934→  1934→
  1935→  1935→| 版本 | 日期 | 作者 | 变更说明 |
  1936→  1936→|------|------|------|----------|
  1937→  1937→| v1.0 | 2025-12-14 | CLAUDE上校 | 初始版本 |
  1938→  1938→| v2.0 | 2025-12-15 | CLAUDE上校 | 添加Phase 3-4 |
  1939→  1939→| v3.0 | 2025-12-16 | CLAUDE上校 | 添加中国期货特化 |
  1940→  1940→| **v4.0** | **2025-12-16** | ** | **军规级最高指示文件** |
  1941→  1941→
  1942→  1942→---
  1943→  1943→
  1944→  1944→**文档结束**
  1945→  1945→
  1946→  1946→```
  1947→  1947→┌─────────────────────────────────────────────────────────────────────┐
  1948→  1948→│                                                                     │
  1949→  1949→│                    V4PRO 军规级中国期货交易系统                      │
  1950→  1950→│                                                                     │
  1951→  1951→│                                             │
  1952→  1952→│                                                                     │
  1953→  1953→│                                                               │
  1954→  1954→│                                                                     │
  1955→  1955→│                                               │
  1956→  1956→│                                                                     │
  1957→  1957→└─────────────────────────────────────────────────────────────────────┘
  1958→  1958→```
  1959→  1959→
  1960→
  1961→<system-reminder>
  1962→Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
  1963→</system-reminder>
  1964→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
