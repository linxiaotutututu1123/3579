     1→"""Tests for CTP broker with lazy import."""
     2→
     3→from __future__ import annotations
     4→
     5→import pytest
     6→
     7→from src.execution.ctp_broker import (
     8→    CtpBroker,
     9→    CtpConfig,
    10→    CtpConfigError,
    11→    CtpNotAvailableError,
    12→    validate_ctp_env,
    13→)
    14→from src.execution.order_types import Offset, OrderIntent, Side
    15→from src.trading.controls import TradeMode
    16→
    17→
    18→def _make_config() -> CtpConfig:
    19→    """Create test CTP config."""
    20→    return CtpConfig(
    21→        front_addr="tcp://127.0.0.1:10130",
    22→        broker_id="9999",
    23→        user_id="test",
    24→        password="test123",
    25→    )
    26→
    27→
    28→class TestCtpBroker:
    29→    """Tests for CtpBroker."""
    30→
    31→    def test_init_without_sdk(self) -> None:
    32→        """Broker initializes in mock mode when SDK not available."""
    33→        config = _make_config()
    34→        broker = CtpBroker(config)
    35→        # Should not raise, just log warning
    36→        assert broker.is_sdk_available is False
    37→        assert broker.is_connected is False
    38→
    39→    def test_connect_without_sdk_raises(self) -> None:
    40→        """connect() raises CtpNotAvailableError when SDK not available."""
    41→        config = _make_config()
    42→        broker = CtpBroker(config)
    43→        with pytest.raises(CtpNotAvailableError):
    44→            broker.connect()
    45→
    46→    def test_disconnect_safe(self) -> None:
    47→        """disconnect() is safe to call even when not connected."""
    48→        config = _make_config()
    49→        broker = CtpBroker(config)
    50→        # Should not raise
    51→        broker.disconnect()
    52→        assert broker.is_connected is False
    53→
    54→    def test_init_live_mode_without_sdk_raises(self) -> None:
    55→        """LIVE mode without SDK raises CtpNotAvailableError at init."""
    56→        config = _make_config()
    57→        with pytest.raises(CtpNotAvailableError) as exc_info:
    58→            CtpBroker(config, trade_mode=TradeMode.LIVE)
    59→        assert "LIVE mode requires it" in str(exc_info.value)
    60→
    61→    def test_place_order_paper_mode_mock(self) -> None:
    62→        """place_order() works in PAPER mock mode without SDK."""
    63→        config = _make_config()
    64→        broker = CtpBroker(config, trade_mode=TradeMode.PAPER)
    65→        intent = OrderIntent(
    66→            symbol="au2412",
    67→            side=Side.BUY,
    68→            offset=Offset.OPEN,
    69→            qty=1,
    70→            price=500.0,
    71→        )
    72→        ack = broker.place_order(intent)
    73→        assert ack.order_id.startswith("MOCK_")
    74→
    75→    def test_place_order_increments_ref(self) -> None:
    76→        """Order refs increment on each order."""
    77→        config = _make_config()
    78→        broker = CtpBroker(config, trade_mode=TradeMode.PAPER)
    79→        intent = OrderIntent(
    80→            symbol="au2412",
    81→            side=Side.BUY,
    82→            offset=Offset.OPEN,
    83→            qty=1,
    84→            price=500.0,
    85→        )
    86→        ack1 = broker.place_order(intent)
    87→        ack2 = broker.place_order(intent)
    88→        assert ack1.order_id != ack2.order_id
    89→
    90→    def test_place_order_uses_ctp_mapping(self) -> None:
    91→        """place_order uses F18 mapping for Side/Offset conversion."""
    92→        config = _make_config()
    93→        broker = CtpBroker(config, trade_mode=TradeMode.PAPER)
    94→        # Test with different Side/Offset combinations
    95→        for side in Side:
    96→            for offset in Offset:
    97→                intent = OrderIntent(
    98→                    symbol="au2412",
    99→                    side=side,
   100→                    offset=offset,
   101→                    qty=1,
   102→                    price=500.0,
   103→                )
   104→                # Should not raise - mapping is valid for all known values
   105→                ack = broker.place_order(intent)
   106→                assert ack.order_id.startswith("MOCK_")
   107→
   108→    def test_repr(self) -> None:
   109→        """__repr__ returns useful string."""
   110→        config = _make_config()
   111→        broker = CtpBroker(config, trade_mode=TradeMode.PAPER)
   112→        s = repr(broker)
   113→        assert "CtpBroker" in s
   114→        assert "9999" in s
   115→
   116→
   117→class TestValidateCtpEnv:
   118→    """Tests for validate_ctp_env function."""
   119→
   120→    def test_paper_mode_returns_none(self, monkeypatch: pytest.MonkeyPatch) -> None:
   121→        """PAPER mode does not require CTP config and returns None."""
   122→        # Even with no env vars set, PAPER should return None
   123→        for var in ("CTP_FRONT_ADDR", "CTP_BROKER_ID", "CTP_USER_ID", "CTP_PASSWORD"):
   124→            monkeypatch.delenv(var, raising=False)
   125→
   126→        result = validate_ctp_env(TradeMode.PAPER)
   127→        assert result is None
   128→
   129→    def test_live_mode_missing_vars_raises(
   130→        self, monkeypatch: pytest.MonkeyPatch
   131→    ) -> None:
   132→        """LIVE mode with missing vars raises CtpConfigError with clear message."""
   133→        # Clear all CTP env vars
   134→        for var in ("CTP_FRONT_ADDR", "CTP_BROKER_ID", "CTP_USER_ID", "CTP_PASSWORD"):
   135→            monkeypatch.delenv(var, raising=False)
   136→
   137→        with pytest.raises(CtpConfigError) as exc_info:
   138→            validate_ctp_env(TradeMode.LIVE)
   139→
   140→        error_msg = str(exc_info.value)
   141→        assert "CTP_FRONT_ADDR" in error_msg
   142→        assert "CTP_BROKER_ID" in error_msg
   143→        assert "CTP_USER_ID" in error_msg
   144→        assert "CTP_PASSWORD" in error_msg
   145→        assert "LIVE mode" in error_msg
   146→
   147→    def test_live_mode_partial_vars_raises(
   148→        self, monkeypatch: pytest.MonkeyPatch
   149→    ) -> None:
   150→        """LIVE mode with partial vars raises and lists only missing ones."""
   151→        monkeypatch.setenv("CTP_FRONT_ADDR", "tcp://127.0.0.1:10130")
   152→        monkeypatch.setenv("CTP_BROKER_ID", "9999")
   153→        monkeypatch.delenv("CTP_USER_ID", raising=False)
   154→        monkeypatch.delenv("CTP_PASSWORD", raising=False)
   155→
   156→        with pytest.raises(CtpConfigError) as exc_info:
   157→            validate_ctp_env(TradeMode.LIVE)
   158→
   159→        error_msg = str(exc_info.value)
   160→        assert "CTP_FRONT_ADDR" not in error_msg  # This one is set
   161→        assert "CTP_BROKER_ID" not in error_msg  # This one is set
   162→        assert "CTP_USER_ID" in error_msg
   163→        assert "CTP_PASSWORD" in error_msg
   164→
   165→    def test_live_mode_all_required_vars_returns_config(
   166→        self, monkeypatch: pytest.MonkeyPatch
   167→    ) -> None:
   168→        """LIVE mode with all required vars returns valid CtpConfig."""
   169→        monkeypatch.setenv("CTP_FRONT_ADDR", "tcp://180.168.146.187:10130")
   170→        monkeypatch.setenv("CTP_BROKER_ID", "9999")
   171→        monkeypatch.setenv("CTP_USER_ID", "testuser")
   172→        monkeypatch.setenv("CTP_PASSWORD", "testpass")
   173→        monkeypatch.delenv("CTP_APP_ID", raising=False)
   174→        monkeypatch.delenv("CTP_AUTH_CODE", raising=False)
   175→
   176→        result = validate_ctp_env(TradeMode.LIVE)
   177→
   178→        assert result is not None
   179→        assert result.front_addr == "tcp://180.168.146.187:10130"
   180→        assert result.broker_id == "9999"
   181→        assert result.user_id == "testuser"
   182→        assert result.password == "testpass"
   183→        assert result.app_id == ""  # Optional, defaults to empty
   184→        assert result.auth_code == ""  # Optional, defaults to empty
   185→
   186→    def test_live_mode_optional_vars_included(
   187→        self, monkeypatch: pytest.MonkeyPatch
   188→    ) -> None:
   189→        """LIVE mode includes optional vars when set."""
   190→        monkeypatch.setenv("CTP_FRONT_ADDR", "tcp://180.168.146.187:10130")
   191→        monkeypatch.setenv("CTP_BROKER_ID", "9999")
   192→        monkeypatch.setenv("CTP_USER_ID", "testuser")
   193→        monkeypatch.setenv("CTP_PASSWORD", "testpass")
   194→        monkeypatch.setenv("CTP_APP_ID", "simnow_client")
   195→        monkeypatch.setenv("CTP_AUTH_CODE", "auth123")
   196→
   197→        result = validate_ctp_env(TradeMode.LIVE)
   198→
   199→        assert result is not None
   200→        assert result.app_id == "simnow_client"
   201→        assert result.auth_code == "auth123"
   202→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
