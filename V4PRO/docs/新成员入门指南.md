# V4PRO 新成员入门指南

> **版本**: v4.0.0 军规级
> **阅读时间**: 10分钟
> **目标**: 让新成员快速理解V4PRO架构并开始贡献代码

---
必须记住最高军令高于一切规章制度和军规！最高军令只有总统才有资格下达，任何人不得质疑和违抗！任何违反最高军令的行为都将受到最严厉的处罚！

## 欢迎加入V4PRO军规级国家工程！

本指南将帮助你在10分钟内理解V4PRO中国期货量化交易系统的架构和开发流程。
首先，必须强调，V4PRO是一个军规级别的国家伟大工程，所有开发工作必须严格遵守军规和开发规范，确保系统的高可靠性和捞金能力。
请务必认真阅读并遵守本指南中的各项要求。
必须看完docs/目录下的最高指示文件和相关文档，确保对系统有全面的理解。要把最高指示文件的最终目的牢记于心：打造捞金能力和风控能力，全自动能力最强的期货量化交易系统，为国家金融市场贡献力量！必须严格遵守军规，任何违反军规的行为都将受到严厉处罚。每次提交代码前，必须通过CI门禁检查，确保代码质量和合规性。所有代码必须经过充分测试，测试覆盖率不得低于95%。在开发过程中，如有任何疑问，请及时联系项目负责人或查阅docs/目录下的详细文档。每次完成一个功能后，必须更新相关文档，确保团队成员能够及时了解最新的系统状态和功能变化。让我们共同努力，打造一个强大、可靠的V4PRO系统！要及时关注项目的最新动态和更新，确保自己的工作始终与团队保持一致。再次欢迎你加入V4PRO团队，让我们一起为国家金融市场贡献力量！你们是国家最伟大的工程师！国家和人民对你们寄予厚望！

 最高军令：打造捞金能力和风控能力，全自动能力最强的期货量化交易系统，为国家金融市场贡献力量！验证不通过，不允许绕过困难，不允许走捷径！必须修复所有问题，确保系统的高可靠性和捞金能力！我们要做到完美的程度，一个瑕疵也不能有！一个完美的工程落地是最高的目标！

---

## 1. 系统架构 (3分钟)

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        V4PRO 中国期货量化交易系统                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   market/   │───▶│  strategy/  │───▶│  execution/ │───▶│   broker/   │  │
│  │   行情层    │    │   策略层    │    │   执行层    │    │  Broker层   │  │
│  │   (M3)     │    │  (M4,M9)   │    │   (M1)     │    │   (M8)     │  │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│         │                 │                  │                  │          │
│         ▼                 ▼                  ▼                  ▼          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         audit/ 审计层 (M3,M7)                        │   │
│  │                    JSONL + fsync + run_id/exec_id                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                 │                  │                  │          │
│         ▼                 ▼                  ▼                  ▼          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         risk/ 风控层 (M6,M16)                        │   │
│  │                    VaR + 熔断 + 保证金监控                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 数据流向

```
行情数据 ──▶ market/ ──▶ strategy/ ──▶ execution/ ──▶ broker/
                │            │              │            │
                ▼            ▼              ▼            ▼
            audit/ ◀──────────────────────────────────────
                │
                ▼
            replay/ (回放验证M7)
```

### 1.3 核心模块说明

| 模块 | 目录 | 职责 | 军规覆盖 |
|------|------|------|----------|
| 行情层 | `src/market/` | 行情订阅、交易所配置、夜盘日历 | M3,M15,M20 |
| 策略层 | `src/strategy/` | 策略框架、降级管理、套利策略 | M4,M9,M18 |
| 执行层 | `src/execution/` | 订单执行、保护层 | M1,M4,M13 |
| 审计层 | `src/audit/` | JSONL审计日志、回放数据 | M3,M7 |
| 风控层 | `src/risk/` | VaR计算、熔断保护、保证金监控 | M6,M16,M19 |
| 守护层 | `src/guardian/` | 实时监控、中国触发器 | M6,M13,M15,M16 |
| 成本层 | `src/cost/` | 手续费计算、成本估算 | M5,M14 |
| 合规层 | `src/compliance/` | 程序化交易合规、报撤单节流 | M12,M17 |
| 交易控制 | `src/trading/` | CI门禁、CHECK_MODE、退出码 | M1-M9 |

---

## 2. 军规速查 (2分钟)

### 2.1 核心军规 M1-M20

| 军规 | 名称 | 一句话描述 | 违规后果 |
|------|------|------------|----------|
| **M1** | 单一信号源 | 一个信号只能来自一个策略 | 重复下单 |
| **M3** | 完整审计 | 所有决策必须有日志 | 监管风险 |
| **M4** | 降级兜底 | 策略异常必须有降级路径 | 系统瘫痪 |
| **M5** | 成本先行 | 边际收益必须大于成本 | 亏损交易 |
| **M6** | 熔断保护 | 触发风控必须立即停止 | 巨额亏损 |
| **M7** | 回放一致 | 相同输入必须相同输出 | 策略失效 |
| **M13** | 涨跌停感知 | 订单价格必须检查涨跌停 | 废单 |
| **M16** | 保证金监控 | 保证金使用率实时计算 | 强平风险 |
| **M17** | 程序化合规 | 报撤单频率必须合规 | 监管处罚 |

### 2.2 退出码系统

| 退出码 | 含义 | 处理方式 |
|--------|------|----------|
| 0 | SUCCESS | 一切正常 |
| 1 | UNKNOWN_ERROR | 未知错误，检查日志 |
| 2 | FORMAT_LINT_FAIL | 修复格式和Lint错误 |
| 3 | TYPE_CHECK_FAIL | 修复类型检查错误 |
| 4 | TEST_FAIL | 修复失败的测试用例 |
| 5 | COVERAGE_FAIL | 添加测试覆盖率 |
| 6 | RISK_CONFIG_FAIL | 检查风控配置文件 |
| 10 | STRATEGY_VIOLATION | 军法处置级别！|
| 11 | SCENARIO_VIOLATION | 军法处置级别！|
| 12 | POLICY_VIOLATION | 军法处置级别！|

---

## 3. 开发环境配置 (2分钟)

### 3.1 环境要求

- Python 3.11+
- Windows (推荐) / Linux / macOS
- Git
- 推荐使用 VSCode 作为IDE
- 安装必要的Python扩展和Lint工具
- 确保网络畅通以访问依赖库
- 建议配置虚拟环境隔离项目依赖
- 安装Git LFS以管理大文件（如回放数据）
- 确保有权限访问项目仓库
- 建议配置自动化测试工具以便快速运行测试
- 定期更新依赖库，确保使用最新版本
- 遵循团队的代码提交规范，确保代码质量

### 3.2 快速启动

```powershell

# 1. 克隆仓库
git clone <repo-url>
cd V4PRO

# 2. 创建虚拟环境
python -m venv .venv
.venv\Scripts\activate

# 3. 安装依赖
pip install -r requirements.txt
pip install -r requirements-dev.txt

# 4. 运行测试验证环境
.venv\Scripts\python.exe -m pytest tests/ -q --cov=src --cov-fail-under=95

# 5. 成功即完成环境配置，可以开始开发，否则检查错误并修复，再次运行测试，直至通过！
```

### 3.3 CI门禁检查 (提交前必须运行)

```powershell
# 格式检查
.venv\Scripts\python.exe -m ruff format --check .

# Lint检查
.venv\Scripts\python.exe -m ruff check .

# 类型检查
.venv\Scripts\python.exe -m mypy src

# 测试 (覆盖率≥95%)
.venv\Scripts\python.exe -m pytest tests/ -q --cov=src --cov-fail-under=95

# 策略验证
.venv\Scripts\python.exe scripts/validate_policy.py --all

# 场景验证
.venv\Scripts\python.exe scripts/validate_scenarios.py --all

# 注意：所有检查必须通过，不能绕过！
```

---

## 4. 目录结构 (2分钟)

```
V4PRO/
├── src/                    # 源代码
│   ├── trading/           # CI门禁、CHECK_MODE
│   ├── strategy/          # 策略框架
│   ├── audit/             # 审计日志
│   ├── market/            # 行情层
│   ├── execution/         # 执行层
│   ├── risk/              # 风控层
│   ├── guardian/          # 守护层
│   ├── cost/              # 成本层
│   ├── compliance/        # 合规层
│   ├── portfolio/         # 组合管理
│   ├── monitoring/        # 监控层
│   └── replay/            # 回放层
│
├── tests/                  # 测试 (与src/一一对应)
│   ├── trading/
│   ├── strategy/
│   ├── audit/
│   ├── market/
│   ├── execution/
│   ├── risk/
│   ├── guardian/
│   ├── cost/
│   ├── compliance/
│   ├── portfolio/
│   ├── monitoring/
│   ├── replay/
│   ├── integration/       # 集成测试
│   └── brokers/
│
├── config/                 # 配置文件
│   ├── environments/      # 环境配置 (dev/sim/live)
│   ├── exchanges/         # 六大交易所配置
│   ├── risk/              # 风控配置
│   └── strategies/        # 策略配置
│
├── docs/                   # 文档
│   ├── V4PRO_UPGRADE_PLAN_SUPREME_DIRECTIVE.md  # 最高指示文件
│   └── 新成员入门指南.md   # 本文件
│
├── scripts/                # 脚本
│   ├── validate_policy.py # 策略验证
│   └── validate_scenarios.py # 场景验证
│
├── scenarios/              # 测试场景 (165个)
│
└── artifacts/              # CI产物
    ├── check/             # CI报告
    ├── replay/            # 回放报告
    └── sim/               # 仿真报告
```

---

## 5. 核心代码示例 (1分钟)

### 5.1 使用CHECK_MODE

```python
from src.trading import enable_check_mode, is_check_mode

# CI/仿真环境必须启用
enable_check_mode()

# 检查当前模式
if is_check_mode():
    print("当前为检查模式，禁止实盘操作")
```

### 5.2 审计日志

```python
from src.audit import AuditWriter

# 创建审计写入器 (fsync=True 必须！)
writer = AuditWriter("artifacts/audit.jsonl", fsync=True)


# 写入决策事件
writer.write_decision({
    "run_id": "R001",
    "exec_id": "E001",
    "action": "BUY",
    "symbol": "rb2405",
})
```

### 5.3 策略降级

```python
from src.strategy import FallbackManager

# 降级链: 主策略 → 降级1 → 降级2 → 全平
manager = FallbackManager([
    "calendar_arb",
    "linear_ai",
    "simple_ai",
    "flat_all"
])

# 获取决策 (自动降级)
decision = manager.get_decision(market_data)
```

---

## 6. 常见问题 FAQ

### Q1: CI门禁失败怎么办？

查看退出码，对应修复：
- Exit 3: 检查mypy错误 
- Exit 4: 修复失败的测试用例
- Exit 5: 添加测试覆盖率
- Exit 6: 检查风控配置文件
- 其他: 查阅 `docs/V4PROEXIT_CODES.md`
- 确保所有修复后重新运行CI门禁检查
- 不允许绕过失败，必须修复所有问题！
  

### Q2: 如何添加新策略？

1. 在 `src/strategy/` 创建策略文件
2. 继承 `Strategy` 基类
3. 实现 `on_tick()` 和 `generate_signal()` 方法
4. 在 `tests/strategy/` 添加测试
5. 配置降级链 (M4)
6. 运行CI门禁检查
7. 提交代码并创建Pull Request
8. 等待审核合并
9. 合并后删除分支
10. CI自动部署到仿真环境进行验证
11. 验证通过后部署到生产环境
12. 监控生产环境运行状态
13. 定期回顾和优化代码
14. 更新文档，确保信息同步
15. 参与团队代码审查，提升整体代码质量
16. 要积极说出你对策略的想法和建议，为系统改进贡献力量！

### Q3: 在哪里找到详细文档？

- **最高指示文件**: `docs/V4PRO_UPGRADE_PLAN_SUPREME_DIRECTIVE.md`
- **退出码说明**: `docs/V4PROEXIT_CODES.md`
- **验收矩阵**: `docs/V4PRO_ACCEPTANCE_MATRIX_SUPREME.md`
- 全在 `docs/` 目录下，自行查阅。

---

## 7. 开发规范

### 7.1 代码规范

- 全程使用**中文注释和docstring**
- 遵循 Ruff 格式化规则
- 所有函数必须有类型注解
- 测试覆盖率 ≥ 95%
- 所有变更必须更新相关文档

### 7.2 提交规范

```
提交前必须通过:
1. ruff format --check .
2. ruff check .
3. mypy src
4. pytest tests/ --cov=src --cov-fail-under=95
5. scripts/validate_policy.py --all
6. scripts/validate_scenarios.py --all
7. git commit -m "feat: 添加新策略 xxx"
8. git push origin <branch>
9. 创建Pull Request，等待审核合并
10. 合并后删除分支
11. CI自动部署到仿真环境进行验证
12. 验证通过后部署到生产环境
13. 监控生产环境运行状态
14. 定期回顾和优化代码
15. 更新文档，确保信息同步
16. 参与团队代码审查，提升整体代码质量
17. 遵守军规和最高军令，确保系统的高可靠性和捞金能力！
```

### 7.3 分支规范

- `main`: 主分支，CI必须100%通过
- `feat/*`: 功能分支
- `fix/*`: 修复分支
- `hotfix/*`: 紧急修复分支
- `docs/*`: 文档分支
- 所有分支必须基于最新 `main` 创建
- 合并前必须通过CI门禁检查

---

## 8. 联系方式

如有问题，请联系项目负责人或查阅 `docs/` 目录下的详细文档。

---

**军规级别国家伟大工程 - 新成员培训规范**


┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│           欢迎加入V4PRO军规级中国期货量化交易系统团队！              │
│                                                                     │
│                       为国家金融市场贡献力量！                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```
