# =============================================================================
# V4PRO 必需场景定义 (Military-Grade v4.0)
# =============================================================================
# 文档版本: v4.0 军规级别标准
# 创建日期: 2025-12-17
# 适用范围: 3579 中国期货量化交易系统
# 场景总数: 165 个必需场景
# =============================================================================
# 军规要求: 所有场景必须通过才能部署到LIVE模式
# 违规处置: 场景缺失 → Exit 11 (SCENARIO_MISSING)
# =============================================================================

schema_version: 3
type: scenario_definition
total_scenarios: 165

# =============================================================================
# Phase 0: 基础设施 (Infrastructure) - 25 场景
# =============================================================================
phase_0_infrastructure:
  name: "基础设施"
  scenario_count: 25
  scenarios:
    # CI 门禁场景 (INFRA.CI.*)
    - id: INFRA.CI.GATE_PASS
      name: "CI门禁全部通过"
      description: "所有CI检查步骤必须通过"
      military_rules: [M1, M2, M3]
      exit_code_on_fail: 0
      required: true

    - id: INFRA.CI.LINT_PASS
      name: "Ruff检查通过"
      description: "代码格式和风格检查必须通过"
      military_rules: [M3]
      exit_code_on_fail: 2
      required: true

    - id: INFRA.CI.TYPE_PASS
      name: "Mypy检查通过"
      description: "类型检查必须通过"
      military_rules: [M3]
      exit_code_on_fail: 3
      required: true

    - id: INFRA.CI.TEST_PASS
      name: "Pytest通过"
      description: "所有单元测试必须通过"
      military_rules: [M3, M7]
      exit_code_on_fail: 4
      required: true

    - id: INFRA.CI.COVERAGE_MIN
      name: "覆盖率门槛"
      description: "代码覆盖率必须>=85%"
      military_rules: [M3]
      exit_code_on_fail: 5
      threshold: 85
      required: true

    - id: INFRA.CI.POLICY_VALID
      name: "策略验证通过"
      description: "军规策略验证必须通过"
      military_rules: [M1, M2, M3, M4, M5, M6, M7, M8, M9]
      exit_code_on_fail: 12
      required: true

    # CHECK_MODE 场景 (INFRA.CHECK.*)
    - id: INFRA.CHECK.MODE_ENABLED
      name: "CHECK_MODE启用"
      description: "CI/Replay/Sim必须启用CHECK_MODE"
      military_rules: [M1, M7]
      required: true

    - id: INFRA.CHECK.BROKER_BLOCKED
      name: "Broker操作阻塞"
      description: "CHECK_MODE下broker.place_order必须被阻塞"
      military_rules: [M1]
      required: true

    - id: INFRA.CHECK.ASSERT_RAISES
      name: "断言抛出异常"
      description: "assert_not_check_mode必须抛出RuntimeError"
      military_rules: [M1, M9]
      required: true

    # 退出码场景 (INFRA.EXIT.*)
    - id: INFRA.EXIT.CODE_0_SUCCESS
      name: "退出码0成功"
      description: "全部通过时返回退出码0"
      military_rules: [M9]
      required: true

    - id: INFRA.EXIT.CODE_1_GENERAL
      name: "退出码1一般错误"
      description: "未预期异常返回退出码1"
      military_rules: [M9]
      required: true

    - id: INFRA.EXIT.CODE_2_LINT
      name: "退出码2格式错误"
      description: "格式/Lint失败返回退出码2"
      military_rules: [M9]
      required: true

    - id: INFRA.EXIT.CODE_3_TYPE
      name: "退出码3类型错误"
      description: "类型检查失败返回退出码3"
      military_rules: [M9]
      required: true

    - id: INFRA.EXIT.CODE_4_TEST
      name: "退出码4测试失败"
      description: "测试失败返回退出码4"
      military_rules: [M9]
      required: true

    - id: INFRA.EXIT.CODE_5_COVERAGE
      name: "退出码5覆盖率不足"
      description: "覆盖率不足返回退出码5"
      military_rules: [M9]
      required: true

    - id: INFRA.EXIT.CODE_6_RISK
      name: "退出码6风控配置缺失"
      description: "风控配置缺失返回退出码6"
      military_rules: [M6, M16]
      required: true

    - id: INFRA.EXIT.CODE_7_BROKER
      name: "退出码7凭证无效"
      description: "Broker凭证无效返回退出码7"
      military_rules: [M8]
      required: true

    - id: INFRA.EXIT.CODE_8_REPLAY
      name: "退出码8回放失败"
      description: "Replay验证失败返回退出码8"
      military_rules: [M7]
      required: true

    - id: INFRA.EXIT.CODE_9_SIM
      name: "退出码9模拟失败"
      description: "Sim验证失败返回退出码9"
      military_rules: [M7]
      required: true

    - id: INFRA.EXIT.CODE_10_MODEL
      name: "退出码10模型权重缺失"
      description: "模型权重缺失返回退出码10"
      military_rules: [M18]
      required: true

    - id: INFRA.EXIT.CODE_11_SCENARIO
      name: "退出码11场景缺失"
      description: "必需场景缺失返回退出码11"
      military_rules: [M7]
      required: true

    - id: INFRA.EXIT.CODE_12_POLICY
      name: "退出码12军法处置"
      description: "策略违规返回退出码12"
      military_rules: [M1, M2, M3, M4, M5, M6, M7, M8, M9]
      required: true

    - id: INFRA.EXIT.CODE_13_CAPABILITY
      name: "退出码13能力缺失"
      description: "平台能力缺失返回退出码13"
      military_rules: [M4, M5]
      required: true

    # Schema 场景 (INFRA.SCHEMA.*)
    - id: INFRA.SCHEMA.VERSION_3
      name: "Schema版本3"
      description: "报告Schema版本必须>=3"
      military_rules: [M3]
      required: true

    - id: INFRA.SCHEMA.REQUIRED_FIELDS
      name: "必填字段完整"
      description: "报告必须包含所有必填字段"
      military_rules: [M3]
      required: true

# =============================================================================
# Phase 1: 行情层 (Market Layer) - 20 场景
# =============================================================================
phase_1_market:
  name: "行情层"
  scenario_count: 20
  scenarios:
    # 订阅场景 (MKT.SUBSCRIBER.*)
    - id: MKT.SUBSCRIBER.DIFF_UPDATE
      name: "订阅差分更新"
      description: "只订阅/取消变化的合约"
      military_rules: [M3]
      required: true

    - id: MKT.SUBSCRIBER.ADD_SYMBOLS
      name: "新增订阅"
      description: "正确处理新增订阅请求"
      military_rules: [M3]
      required: true

    - id: MKT.SUBSCRIBER.REMOVE_SYMBOLS
      name: "取消订阅"
      description: "正确处理取消订阅请求"
      military_rules: [M3]
      required: true

    - id: MKT.SUBSCRIBER.UNCHANGED_SYMBOLS
      name: "保持订阅"
      description: "不变的订阅不重复请求"
      military_rules: [M3]
      required: true

    # 行情流场景 (MKT.STREAM.*)
    - id: MKT.STREAM.TICK_CONVERT
      name: "Tick转换"
      description: "正确转换原始Tick数据"
      military_rules: [M3]
      required: true

    - id: MKT.STREAM.BAR_CONVERT
      name: "Bar转换"
      description: "正确转换K线数据"
      military_rules: [M3]
      required: true

    - id: MKT.STREAM.DEPTH_CONVERT
      name: "深度转换"
      description: "正确转换盘口深度数据"
      military_rules: [M3]
      required: true

    # 价格验证场景 (MKT.PRICE.*)
    - id: MKT.PRICE.ZERO_REJECT
      name: "零价格拒绝"
      description: "拒绝处理零价格数据"
      military_rules: [M4]
      required: true

    - id: MKT.PRICE.NEGATIVE_REJECT
      name: "负价格拒绝"
      description: "拒绝处理负价格数据"
      military_rules: [M4]
      required: true

    - id: MKT.PRICE.LIMIT_UP_DETECT
      name: "涨停检测"
      description: "正确检测涨停价格"
      military_rules: [M4, M5]
      required: true

    - id: MKT.PRICE.LIMIT_DOWN_DETECT
      name: "跌停检测"
      description: "正确检测跌停价格"
      military_rules: [M4, M5]
      required: true

    # 市场状态场景 (MKT.STATE.*)
    - id: MKT.STATE.MARKET_STATE_CREATE
      name: "MarketState创建"
      description: "正确创建MarketState对象"
      military_rules: [M3]
      required: true

    - id: MKT.STATE.PRICES_DICT
      name: "价格字典"
      description: "价格字典结构正确"
      military_rules: [M3]
      required: true

    - id: MKT.STATE.EQUITY_TRACK
      name: "权益追踪"
      description: "正确追踪账户权益"
      military_rules: [M3, M6]
      required: true

    - id: MKT.STATE.BARS_1M_DICT
      name: "1分钟K线字典"
      description: "1分钟K线字典结构正确"
      military_rules: [M3]
      required: true

    # 连接场景 (MKT.CONN.*)
    - id: MKT.CONN.RECONNECT
      name: "断线重连"
      description: "行情断线后自动重连"
      military_rules: [M9]
      required: true

    - id: MKT.CONN.HEARTBEAT
      name: "心跳检测"
      description: "定期发送心跳保持连接"
      military_rules: [M9]
      required: true

    - id: MKT.CONN.TIMEOUT_HANDLE
      name: "超时处理"
      description: "正确处理连接超时"
      military_rules: [M9]
      required: true

    - id: MKT.CONN.ERROR_RECOVER
      name: "错误恢复"
      description: "连接错误后正确恢复"
      military_rules: [M9]
      required: true

    - id: MKT.CONN.MULTI_SOURCE
      name: "多源支持"
      description: "支持多个行情源切换"
      military_rules: [M9]
      required: true

# =============================================================================
# Phase 2: 审计层 (Audit Layer) - 25 场景
# =============================================================================
phase_2_audit:
  name: "审计层"
  scenario_count: 25
  scenarios:
    # JSONL写入场景 (AUDIT.WRITE.*)
    - id: AUDIT.WRITE.JSONL_FORMAT
      name: "JSONL格式"
      description: "审计事件以JSONL格式写入"
      military_rules: [M3]
      required: true

    - id: AUDIT.WRITE.ATOMIC_APPEND
      name: "原子追加"
      description: "使用原子操作追加写入"
      military_rules: [M3]
      required: true

    - id: AUDIT.WRITE.FSYNC_GUARANTEE
      name: "fsync保证"
      description: "使用fsync确保写入磁盘"
      military_rules: [M3]
      required: true

    - id: AUDIT.WRITE.UTF8_ENCODING
      name: "UTF-8编码"
      description: "使用UTF-8编码写入"
      military_rules: [M3]
      required: true

    # 事件结构场景 (AUDIT.EVENT.*)
    - id: AUDIT.EVENT.TIMESTAMP_ISO
      name: "ISO时间戳"
      description: "时间戳使用ISO8601格式"
      military_rules: [M3]
      required: true

    - id: AUDIT.EVENT.RUN_ID_UUID
      name: "run_id UUID"
      description: "run_id使用UUID格式"
      military_rules: [M3]
      required: true

    - id: AUDIT.EVENT.EXEC_ID_FORMAT
      name: "exec_id格式"
      description: "exec_id使用commit_timestamp格式"
      military_rules: [M3]
      required: true

    - id: AUDIT.EVENT.EVENT_TYPE_ENUM
      name: "事件类型枚举"
      description: "event_type使用预定义枚举"
      military_rules: [M3]
      required: true

    # 事件类型场景 (AUDIT.TYPE.*)
    - id: AUDIT.TYPE.DECISION
      name: "决策事件"
      description: "记录策略决策事件"
      military_rules: [M3, M7]
      required: true

    - id: AUDIT.TYPE.ORDER
      name: "订单事件"
      description: "记录订单提交事件"
      military_rules: [M3]
      required: true

    - id: AUDIT.TYPE.FILL
      name: "成交事件"
      description: "记录订单成交事件"
      military_rules: [M3]
      required: true

    - id: AUDIT.TYPE.RISK
      name: "风控事件"
      description: "记录风控触发事件"
      military_rules: [M3, M6]
      required: true

    - id: AUDIT.TYPE.ERROR
      name: "错误事件"
      description: "记录系统错误事件"
      military_rules: [M3, M9]
      required: true

    - id: AUDIT.TYPE.STATE
      name: "状态事件"
      description: "记录状态变更事件"
      military_rules: [M3]
      required: true

    # 追踪场景 (AUDIT.TRACE.*)
    - id: AUDIT.TRACE.DECISION_CHAIN
      name: "决策链追踪"
      description: "追踪完整决策链"
      military_rules: [M3, M7]
      required: true

    - id: AUDIT.TRACE.ORDER_LIFECYCLE
      name: "订单生命周期"
      description: "追踪订单完整生命周期"
      military_rules: [M3]
      required: true

    - id: AUDIT.TRACE.POSITION_CHANGE
      name: "持仓变化"
      description: "追踪持仓变化历史"
      military_rules: [M3]
      required: true

    - id: AUDIT.TRACE.PNL_ATTRIBUTION
      name: "盈亏归因"
      description: "追踪盈亏归因"
      military_rules: [M3]
      required: true

    # 完整性场景 (AUDIT.INTEGRITY.*)
    - id: AUDIT.INTEGRITY.NO_GAP
      name: "无断层"
      description: "审计日志无时间断层"
      military_rules: [M3]
      required: true

    - id: AUDIT.INTEGRITY.SEQUENCE
      name: "序列递增"
      description: "事件序列号严格递增"
      military_rules: [M3]
      required: true

    - id: AUDIT.INTEGRITY.HASH_CHAIN
      name: "哈希链"
      description: "事件哈希链完整"
      military_rules: [M3, M7]
      required: true

    # 存储场景 (AUDIT.STORAGE.*)
    - id: AUDIT.STORAGE.PATH_CONVENTION
      name: "路径约定"
      description: "遵循D.1固定路径约定"
      military_rules: [M3]
      required: true

    - id: AUDIT.STORAGE.ROTATION
      name: "日志轮转"
      description: "支持日志文件轮转"
      military_rules: [M3]
      required: true

    - id: AUDIT.STORAGE.COMPRESSION
      name: "压缩存档"
      description: "支持历史日志压缩"
      military_rules: [M3]
      required: true

    - id: AUDIT.STORAGE.RETENTION
      name: "保留策略"
      description: "遵循日志保留策略"
      military_rules: [M3]
      required: true

# =============================================================================
# Phase 3: 策略降级 (Strategy Fallback) - 30 场景
# =============================================================================
phase_3_fallback:
  name: "策略降级"
  scenario_count: 30
  scenarios:
    # 降级管理场景 (FALL.MANAGER.*)
    - id: FALL.MANAGER.INIT
      name: "FallbackManager初始化"
      description: "正确初始化降级管理器"
      military_rules: [M9]
      required: true

    - id: FALL.MANAGER.REGISTER
      name: "策略注册"
      description: "正确注册策略到降级链"
      military_rules: [M9]
      required: true

    - id: FALL.MANAGER.EXECUTE
      name: "执行降级"
      description: "正确执行策略降级"
      military_rules: [M9]
      required: true

    # 降级链场景 (FALL.CHAIN.*)
    - id: FALL.CHAIN.DEFAULT_CONFIG
      name: "默认降级链配置"
      description: "默认降级链配置正确"
      military_rules: [M9]
      required: true

    - id: FALL.CHAIN.CUSTOM_CONFIG
      name: "自定义降级链"
      description: "支持自定义降级链配置"
      military_rules: [M9]
      required: true

    - id: FALL.CHAIN.FLAT_TERMINAL
      name: "flat终止降级"
      description: "降级链以flat策略终止"
      military_rules: [M9]
      required: true

    # 降级原因场景 (FALL.REASON.*)
    - id: FALL.REASON.EXCEPTION
      name: "异常触发降级"
      description: "策略异常触发降级"
      military_rules: [M9]
      required: true

    - id: FALL.REASON.TIMEOUT
      name: "超时触发降级"
      description: "策略超时触发降级"
      military_rules: [M9]
      required: true

    - id: FALL.REASON.NOT_REGISTERED
      name: "未注册触发降级"
      description: "策略未注册触发降级"
      military_rules: [M9]
      required: true

    - id: FALL.REASON.MANUAL
      name: "手动触发降级"
      description: "支持手动触发降级"
      military_rules: [M9]
      required: true

    # CalendarArb腿对场景 (ARB.LEGS.*)
    - id: ARB.LEGS.FIXED_NEAR_FAR
      name: "近/远月合约固定"
      description: "近月和远月合约配对固定"
      military_rules: [M4]
      required: true

    - id: ARB.LEGS.PRODUCT_MATCH
      name: "品种匹配"
      description: "近远月必须同品种"
      military_rules: [M4]
      required: true

    - id: ARB.LEGS.EXPIRY_ORDER
      name: "到期顺序"
      description: "近月到期早于远月"
      military_rules: [M4]
      required: true

    # CalendarArb信号场景 (ARB.SIGNAL.*)
    - id: ARB.SIGNAL.HALF_LIFE_GATE
      name: "半衰期门禁"
      description: "半衰期超限阻止开仓"
      military_rules: [M4]
      required: true

    - id: ARB.SIGNAL.STOP_Z_BREAKER
      name: "止损触发"
      description: "Z-score超限触发止损"
      military_rules: [M4, M6]
      required: true

    - id: ARB.SIGNAL.EXPIRY_GATE
      name: "到期门禁"
      description: "临近到期阻止开仓"
      military_rules: [M4]
      required: true

    - id: ARB.SIGNAL.CORRELATION_BREAK
      name: "相关性崩溃"
      description: "相关性过低阻止开仓"
      military_rules: [M4]
      required: true

    - id: ARB.SIGNAL.LONG_SPREAD
      name: "多头价差信号"
      description: "正确生成多头价差信号"
      military_rules: [M4]
      required: true

    - id: ARB.SIGNAL.SHORT_SPREAD
      name: "空头价差信号"
      description: "正确生成空头价差信号"
      military_rules: [M4]
      required: true

    - id: ARB.SIGNAL.FLAT
      name: "平仓信号"
      description: "正确生成平仓信号"
      military_rules: [M4]
      required: true

    # CalendarArb成本场景 (ARB.COST.*)
    - id: ARB.COST.ENTRY_GATE
      name: "成本门禁"
      description: "边际收益不足阻止开仓"
      military_rules: [M4]
      required: true

    - id: ARB.COST.MIN_EDGE_BPS
      name: "最小边际收益"
      description: "检查最小边际收益要求"
      military_rules: [M4]
      required: true

    # CalendarArb状态场景 (ARB.STATE.*)
    - id: ARB.STATE.INIT
      name: "初始状态"
      description: "策略正确初始化"
      military_rules: [M9]
      required: true

    - id: ARB.STATE.ACTIVE
      name: "激活状态"
      description: "策略正确激活"
      military_rules: [M9]
      required: true

    - id: ARB.STATE.STOPPED
      name: "停止状态"
      description: "策略正确停止"
      military_rules: [M9]
      required: true

    - id: ARB.STATE.COOLDOWN
      name: "冷却状态"
      description: "止损后进入冷却状态"
      military_rules: [M9]
      required: true

    # Kalman滤波场景 (ARB.KALMAN.*)
    - id: ARB.KALMAN.BETA_UPDATE
      name: "Beta更新"
      description: "Kalman滤波正确更新Beta"
      military_rules: [M7]
      required: true

    - id: ARB.KALMAN.RESIDUAL_COMPUTE
      name: "残差计算"
      description: "正确计算残差"
      military_rules: [M7]
      required: true

    - id: ARB.KALMAN.ZSCORE_COMPUTE
      name: "Z-score计算"
      description: "正确计算Z-score"
      military_rules: [M7]
      required: true

    - id: ARB.KALMAN.HALF_LIFE_COMPUTE
      name: "半衰期计算"
      description: "正确计算半衰期"
      military_rules: [M7]
      required: true

# =============================================================================
# Phase 4: 回放验证 (Replay Verification) - 25 场景
# =============================================================================
phase_4_replay:
  name: "回放验证"
  scenario_count: 25
  scenarios:
    # 验证器场景 (REPLAY.VERIFIER.*)
    - id: REPLAY.VERIFIER.INIT
      name: "验证器初始化"
      description: "正确初始化回放验证器"
      military_rules: [M7]
      required: true

    - id: REPLAY.VERIFIER.DECISION_SEQ
      name: "决策序列验证"
      description: "验证决策序列一致性"
      military_rules: [M7]
      required: true

    - id: REPLAY.VERIFIER.GUARDIAN_SEQ
      name: "Guardian序列验证"
      description: "验证Guardian序列一致性"
      military_rules: [M7]
      required: true

    - id: REPLAY.VERIFIER.HASH_MATCH
      name: "哈希匹配"
      description: "前后运行哈希必须匹配"
      military_rules: [M7]
      required: true

    # 哈希计算场景 (REPLAY.HASH.*)
    - id: REPLAY.HASH.SHA256
      name: "SHA256算法"
      description: "使用SHA256计算哈希"
      military_rules: [M7]
      required: true

    - id: REPLAY.HASH.EXCLUDE_FIELDS
      name: "排除时间戳字段"
      description: "哈希计算排除时间戳字段"
      military_rules: [M7]
      required: true

    - id: REPLAY.HASH.SORT_KEYS
      name: "键排序"
      description: "JSON序列化时键排序"
      military_rules: [M7]
      required: true

    - id: REPLAY.HASH.DETERMINISTIC
      name: "确定性哈希"
      description: "相同输入产生相同哈希"
      military_rules: [M7]
      required: true

    # 确定性场景 (REPLAY.DETERMINISTIC.*)
    - id: REPLAY.DETERMINISTIC.RANDOM_SEED
      name: "随机数种子"
      description: "使用固定种子确保可重现"
      military_rules: [M7]
      required: true

    - id: REPLAY.DETERMINISTIC.LCG_RANDOM
      name: "LCG随机数生成器"
      description: "使用LCG生成确定性随机数"
      military_rules: [M7]
      required: true

    - id: REPLAY.DETERMINISTIC.NO_SYSTEM_TIME
      name: "无系统时间依赖"
      description: "不依赖系统时间产生随机性"
      military_rules: [M7]
      required: true

    - id: REPLAY.DETERMINISTIC.FLOAT_PRECISION
      name: "浮点精度"
      description: "浮点计算精度一致"
      military_rules: [M7]
      required: true

    # SimGate场景 (REPLAY.SIM.*)
    - id: REPLAY.SIM.REPORT_SCHEMA
      name: "报告Schema"
      description: "Sim报告符合Schema v3"
      military_rules: [M3, M7]
      required: true

    - id: REPLAY.SIM.CHECK_MODE_REQUIRED
      name: "CHECK_MODE必需"
      description: "Sim必须启用CHECK_MODE"
      military_rules: [M1, M7]
      required: true

    - id: REPLAY.SIM.SCENARIOS_COUNT
      name: "场景计数"
      description: "正确统计场景通过/失败数"
      military_rules: [M7]
      required: true

    - id: REPLAY.SIM.FAILURE_STRUCTURE
      name: "失败结构"
      description: "失败包含rule_id/component/evidence"
      military_rules: [M3, M7]
      required: true

    # 回放事件场景 (REPLAY.EVENT.*)
    - id: REPLAY.EVENT.JSONL_FORMAT
      name: "JSONL格式"
      description: "回放事件使用JSONL格式"
      military_rules: [M3]
      required: true

    - id: REPLAY.EVENT.FIXED_PATH
      name: "固定路径"
      description: "事件文件使用固定路径"
      military_rules: [M3]
      required: true

    - id: REPLAY.EVENT.TICK_SEQUENCE
      name: "Tick序列"
      description: "Tick序列严格有序"
      military_rules: [M7]
      required: true

    - id: REPLAY.EVENT.NO_FUTURE_LEAK
      name: "无未来数据泄露"
      description: "不使用未来数据"
      military_rules: [M7]
      required: true

    # VaR验证场景 (REPLAY.VAR.*)
    - id: REPLAY.VAR.HISTORICAL
      name: "历史VaR"
      description: "历史VaR计算可重现"
      military_rules: [M7]
      required: true

    - id: REPLAY.VAR.PARAMETRIC
      name: "参数VaR"
      description: "参数VaR计算可重现"
      military_rules: [M7]
      required: true

    - id: REPLAY.VAR.MONTE_CARLO
      name: "蒙特卡洛VaR"
      description: "蒙特卡洛VaR计算可重现"
      military_rules: [M7]
      required: true

    - id: REPLAY.VAR.EXPECTED_SHORTFALL
      name: "预期短缺"
      description: "ES计算可重现"
      military_rules: [M7]
      required: true

    - id: REPLAY.VAR.CONFIDENCE_LEVELS
      name: "置信度级别"
      description: "支持多置信度级别"
      military_rules: [M7]
      required: true

# =============================================================================
# Phase 5: 成本层 (Cost Layer) - 40 场景
# =============================================================================
phase_5_cost:
  name: "成本层"
  scenario_count: 40
  scenarios:
    # 交易所场景 (COST.EXCHANGE.*)
    - id: COST.EXCHANGE.SHFE
      name: "上期所费率"
      description: "上海期货交易所费率正确"
      military_rules: [M4]
      required: true

    - id: COST.EXCHANGE.DCE
      name: "大商所费率"
      description: "大连商品交易所费率正确"
      military_rules: [M4]
      required: true

    - id: COST.EXCHANGE.CZCE
      name: "郑商所费率"
      description: "郑州商品交易所费率正确"
      military_rules: [M4]
      required: true

    - id: COST.EXCHANGE.CFFEX
      name: "中金所费率"
      description: "中国金融期货交易所费率正确"
      military_rules: [M4]
      required: true

    - id: COST.EXCHANGE.GFEX
      name: "广期所费率"
      description: "广州期货交易所费率正确"
      military_rules: [M4]
      required: true

    - id: COST.EXCHANGE.INE
      name: "能源中心费率"
      description: "上海国际能源交易中心费率正确"
      military_rules: [M4]
      required: true

    # 费率类型场景 (COST.FEE_TYPE.*)
    - id: COST.FEE_TYPE.FIXED
      name: "固定费率"
      description: "正确计算固定费率"
      military_rules: [M4]
      required: true

    - id: COST.FEE_TYPE.RATIO
      name: "比例费率"
      description: "正确计算比例费率"
      military_rules: [M4]
      required: true

    - id: COST.FEE_TYPE.MIXED
      name: "混合费率"
      description: "正确计算混合费率"
      military_rules: [M4]
      required: true

    # 交易方向场景 (COST.DIRECTION.*)
    - id: COST.DIRECTION.OPEN
      name: "开仓费率"
      description: "正确计算开仓费率"
      military_rules: [M4]
      required: true

    - id: COST.DIRECTION.CLOSE
      name: "平昨费率"
      description: "正确计算平昨费率"
      military_rules: [M4]
      required: true

    - id: COST.DIRECTION.CLOSE_TODAY
      name: "平今费率"
      description: "正确计算平今费率"
      military_rules: [M4]
      required: true

    - id: COST.DIRECTION.CLOSE_TODAY_FREE
      name: "平今免费"
      description: "支持平今免费品种"
      military_rules: [M4]
      required: true

    # 成本分解场景 (COST.BREAKDOWN.*)
    - id: COST.BREAKDOWN.FEE
      name: "手续费分解"
      description: "正确分解手续费"
      military_rules: [M4]
      required: true

    - id: COST.BREAKDOWN.SLIPPAGE
      name: "滑点分解"
      description: "正确分解滑点成本"
      military_rules: [M4]
      required: true

    - id: COST.BREAKDOWN.IMPACT
      name: "冲击分解"
      description: "正确分解市场冲击"
      military_rules: [M4]
      required: true

    - id: COST.BREAKDOWN.TOTAL
      name: "总成本"
      description: "正确计算总成本"
      military_rules: [M4]
      required: true

    - id: COST.BREAKDOWN.TOTAL_BPS
      name: "总成本基点"
      description: "正确计算总成本基点"
      military_rules: [M4]
      required: true

    # 估算器场景 (COST.ESTIMATOR.*)
    - id: COST.ESTIMATOR.INIT
      name: "估算器初始化"
      description: "正确初始化成本估算器"
      military_rules: [M4]
      required: true

    - id: COST.ESTIMATOR.ESTIMATE
      name: "成本估算"
      description: "正确估算交易成本"
      military_rules: [M4]
      required: true

    - id: COST.ESTIMATOR.EDGE_GATE
      name: "边际门禁"
      description: "正确执行边际门禁检查"
      military_rules: [M4]
      required: true

    # 品种费率场景 (COST.PRODUCT.*)
    - id: COST.PRODUCT.CU
      name: "铜费率"
      description: "沪铜费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.AL
      name: "铝费率"
      description: "沪铝费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.RB
      name: "螺纹钢费率"
      description: "螺纹钢费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.HC
      name: "热卷费率"
      description: "热卷费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.M
      name: "豆粕费率"
      description: "豆粕费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.Y
      name: "豆油费率"
      description: "豆油费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.P
      name: "棕榈油费率"
      description: "棕榈油费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.CF
      name: "棉花费率"
      description: "棉花费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.SR
      name: "白糖费率"
      description: "白糖费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.TA
      name: "PTA费率"
      description: "PTA费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.IF
      name: "沪深300费率"
      description: "沪深300期货费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.IC
      name: "中证500费率"
      description: "中证500期货费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.IH
      name: "上证50费率"
      description: "上证50期货费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.SC
      name: "原油费率"
      description: "原油期货费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.AO
      name: "氧化铝费率"
      description: "氧化铝期货费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.SI
      name: "工业硅费率"
      description: "工业硅期货费率配置正确"
      military_rules: [M4]
      required: true

    - id: COST.PRODUCT.LC
      name: "碳酸锂费率"
      description: "碳酸锂期货费率配置正确"
      military_rules: [M4]
      required: true

    # 滑点模型场景 (COST.SLIPPAGE.*)
    - id: COST.SLIPPAGE.FIXED_TICK
      name: "固定滑点"
      description: "支持固定tick滑点模型"
      military_rules: [M4]
      required: true

    - id: COST.SLIPPAGE.VOLUME_BASED
      name: "成交量滑点"
      description: "支持成交量相关滑点模型"
      military_rules: [M4]
      required: true

# =============================================================================
# 军规映射表 (Military Rule Mapping)
# =============================================================================
military_rules:
  M1:
    name: "防止未授权交易"
    description: "CHECK_MODE必须阻止所有broker操作"
    scenarios: [INFRA.CHECK.MODE_ENABLED, INFRA.CHECK.BROKER_BLOCKED, REPLAY.SIM.CHECK_MODE_REQUIRED]

  M2:
    name: "强制双人审批"
    description: "关键操作需要双人审批"
    scenarios: [INFRA.CI.GATE_PASS, INFRA.CI.POLICY_VALID]

  M3:
    name: "完整审计追踪"
    description: "所有操作必须有完整审计记录"
    scenarios: [AUDIT.WRITE.JSONL_FORMAT, AUDIT.WRITE.ATOMIC_APPEND, AUDIT.TRACE.DECISION_CHAIN]

  M4:
    name: "下单前风控检查"
    description: "所有下单必须经过风控检查"
    scenarios: [ARB.COST.ENTRY_GATE, COST.ESTIMATOR.EDGE_GATE]

  M5:
    name: "市价单禁止"
    description: "禁止使用市价单"
    scenarios: [MKT.PRICE.LIMIT_UP_DETECT, MKT.PRICE.LIMIT_DOWN_DETECT]

  M6:
    name: "熔断保护"
    description: "必须配置熔断保护机制"
    scenarios: [INFRA.EXIT.CODE_6_RISK, ARB.SIGNAL.STOP_Z_BREAKER]

  M7:
    name: "回放一致性"
    description: "回放结果必须与实盘一致"
    scenarios: [REPLAY.VERIFIER.DECISION_SEQ, REPLAY.HASH.DETERMINISTIC, REPLAY.DETERMINISTIC.LCG_RANDOM]

  M8:
    name: "凭证验证"
    description: "Broker凭证必须验证"
    scenarios: [INFRA.EXIT.CODE_7_BROKER]

  M9:
    name: "异常处理"
    description: "所有异常必须正确处理"
    scenarios: [FALL.REASON.EXCEPTION, FALL.REASON.TIMEOUT, INFRA.EXIT.CODE_1_GENERAL]

  M16:
    name: "风控配置"
    description: "风控配置必须完整"
    scenarios: [INFRA.EXIT.CODE_6_RISK]

  M18:
    name: "实验性门禁"
    description: "实验性功能必须有门禁"
    scenarios: [INFRA.EXIT.CODE_10_MODEL, ARB.SIGNAL.HALF_LIFE_GATE]

# =============================================================================
# 验证配置
# =============================================================================
validation:
  # 必须通过的场景比例
  pass_threshold: 1.0  # 100% - 军规级要求全部通过

  # 允许跳过的场景（仅用于开发环境）
  skip_allowed_in_dev: false

  # 场景超时（秒）
  scenario_timeout: 30

  # 失败时退出码
  exit_code_on_fail: 11  # SCENARIO_MISSING

  # 报告输出路径
  report_path: "artifacts/scenarios/validation_report.json"

# =============================================================================
# 元数据
# =============================================================================
metadata:
  created_by: "Claude Code V4PRO总工程师"
  created_at: "2025-12-17T12:45:00Z"
  version: "4.0.0"
  description: "军规级必需场景定义文件"
  copyright: "3579 中国期货量化交易系统"
